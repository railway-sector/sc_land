import{Y as I,_ as o,e as r,g as M,rd as F,ap as H,ou as T,jK as v,a4 as y,f as g,dd as b}from"./index-BrQW8HOS.js";import{p as L}from"./utils-BvM7qP9G.js";import{l as O}from"./HighlightHelper-RFagfZex.js";import{J as x,l as $,b as S}from"./customElement-aPQS1Oaw.js";import{w as C}from"./UtilityNetworkAssociationAddAssociationViewModel-BWqsjJ9M.js";import{t as P}from"./getFeatureTitle-Mrr3SXNI.js";import"./FeatureService-DdnMPQJQ.js";import"./applyEditsUtils-Bdi3ieC8.js";import"./MeshTransform-wQhxY5y6.js";import"./editingSupport-5GkCZdaM.js";import"./layerUtils-CdCZXuDJ.js";import"./SketchOptions-CHLlByzL.js";import"./SketchLabelOptions-BPF5xZLI.js";import"./Attachments-_aarC56Q.js";import"./AttachmentsViewModel-BorO2JWS.js";import"./AttachmentInfo-Be-qgHMP.js";import"./featureUtils-D2UmGJHI.js";import"./utils-BJ7fw6dI.js";import"./attachmentUtils-CREavg3W.js";import"./legacyIcon-BpbXCnGp.js";import"./featureFormUtils-NJdl1KAp.js";import"./dateUtils-DCwqoPkL.js";import"./substitute-D-eLZ17Q.js";import"./arcade-BYoSEge4.js";import"./arcadeEnvironment-Dyzp2elj.js";import"./ImmutableArray-BPVd6ESQ.js";import"./FeatureForm-ek6TUJN1.js";import"./FieldInput-BRbP2Bp9.js";import"./Heading-Bx03M7LB.js";import"./FeatureRelationshipViewModel-BmyR0OK6.js";import"./vmEvent-CsrnYMSK.js";import"./FeatureTemplates-Y1q8_xKC.js";import"./utils-D5_eym7P.js";import"./symbolUtils-C3MaPSzp.js";import"./gfxUtils-DDSu4Luj.js";import"./cimSymbolUtils-CmFYUdpV.js";import"./svgUtils-BB2umWtg.js";import"./mat2df32-Dpt2CT5P.js";import"./mat2d-BbBq4Byx.js";import"./utils-6_NAbAK3.js";import"./Spinner-Csmzl8Du.js";import"./AnchorElementViewModel-Djy63Zpd.js";import"./GraphicsLayer-CtVknZ1a.js";import"./SnappingManager-BWOfKl0d.js";import"./euclideanLengthMeasurementUtils-B8AL_WaV.js";import"./utils-D_VO_1nP.js";import"./geodesicUtils-BJZXB7Hp.js";import"./geometry2dUtils-kADrF-iP.js";import"./geodeticLengthOperator-DifrZujk.js";import"./geodeticCurveType-CirnHLSB.js";import"./geodesicMeasurementUtils-CQw8IWGR.js";import"./helpMessageUtils-2XpUG8Xk.js";import"./GraphicState-C2r3pgB3.js";import"./DrawingMode-Cvvf0VVz.js";import"./SketchViewModel-NRhuw9HA.js";import"./isSupportedObject-DknMXN_6.js";import"./automaticAreaMeasurementUtils-dI3X5owW.js";import"./geodesicAreaMeasurementUtils-CPlOyDe5.js";import"./earcut-D9gy186-.js";import"./automaticLengthMeasurementUtils-Cr-y0OEN.js";import"./splitCurveAtPoint-DXLcvmHe.js";import"./coordinateHelper-DrvFu3jL.js";import"./SelectionToolbar-CmU2zF-u.js";import"./directionModeIcons-Br5woIHu.js";import"./layerListUtils-CrO8uhQ1.js";import"./LayerListViewModel-VEwfK75C.js";import"./utils-BQBvadb7.js";import"./ListItem-BTKwElC0.js";import"./widget-lSGAz9tN.js";import"./uploadAssetErrors-CCLQcdnt.js";import"./useWidget-CYtf2hFT.js";import"./useView-Cya0Zpns.js";import"./Association-BGd3HRsE.js";import"./typeUtils-Dszw1S4V.js";import"./NetworkElement-te1zus-P.js";import"./TelecomNetworkElement-CwMWpoWJ.js";var h;let n=h=class extends I{constructor(c){super(c),this.editorItem=null,this.feature=null,this.utilityNetwork=null,this.associationType=null,this.parent=null,this.associationInput=null,this.viewModel=null}static async create(c){const{feature:e,parent:t,viewModel:s,utilityNetwork:i,associationType:d,associationInput:m}=c,u=x(s.editorItems,e.sourceLayer);return new h({editorItem:u,feature:e,parent:t,viewModel:s,utilityNetwork:i,associationType:d,associationInput:m})}};o([r({constructOnly:!0})],n.prototype,"editorItem",void 0),o([r()],n.prototype,"feature",void 0),o([r({constructOnly:!0})],n.prototype,"utilityNetwork",void 0),o([r({constructOnly:!0})],n.prototype,"associationType",void 0),o([r()],n.prototype,"parent",void 0),o([r()],n.prototype,"associationInput",void 0),o([r()],n.prototype,"viewModel",void 0),n=h=o([M("esri.widgets.Editor.AddAssociationWorkflowData")],n);var A;const k={exit:Symbol()};var l;let a=(l=class extends ${constructor(e){super(e),this._utilityNetworkAssociationAddAssociationViewModel=new C,this._highlightHelper=null,this.sourceFeatureItem=null,this.type="add-association"}initialize(){const{data:e}=this,{view:t}=e.viewModel;t&&(this._highlightHelper=new O({view:t,highlightName:F}),this.addHandles(H(()=>this._highlightHelper?.removeAll())));const s=new AbortController;this.addHandles(T(s)),this._updatingHandles.addPromise(this._setup(s))}get editorItem(){return this.data.editorItem}get formViewModel(){return this._formViewModel}get utilityNetworkAssociationAddAssociationViewModel(){return this._utilityNetworkAssociationAddAssociationViewModel}get hasPendingEdits(){return!!this._utilityNetworkAssociationAddAssociationViewModel.selectedFeature}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get reliesOnOwnerAdminPrivileges(){return this.editorItem.capabilities.create.reliesOnOwnerAdminPrivileges}async enter(){this._addHandles()}exit(){this.removeHandles(k.exit)}async start(){return await super.start(),null}async _setup(e){const{data:t}=this,{feature:s}=t;try{const[i]=await S([s],s.sourceLayer,t.viewModel.view.spatialReference,e.signal);if(v(e))return;const d=i.sourceLayer&&"getFeatureTitle"in i.sourceLayer?await i.sourceLayer.getFeatureTitle(i):P(i);if(v(e))return;this.sourceFeatureItem={feature:s,label:d},this._initializeUtilityNetworkAssociationAddAssociationViewModel()}catch(i){await this.cancel({force:!0,error:new y("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:i}})})}}_initializeUtilityNetworkAssociationAddAssociationViewModel(){const{viewModel:{view:e},utilityNetwork:t,associationType:s}=this.data,i=this._utilityNetworkAssociationAddAssociationViewModel;i.graphic=this.sourceFeatureItem.feature,i.map=e?.map,i.utilityNetwork=t,i.layer=this.layer,i.associationType=s,i.highlightHelper=this._highlightHelper,t.networkSystemLayers.loadAssociationsTable()}_addHandles(){const e=this._utilityNetworkAssociationAddAssociationViewModel;this.addHandles([g(()=>e.selectedLayer,t=>{t&&this.go("add-association-select-feature")}),g(()=>e.selectedFeature,t=>{t&&this.go("add-association-create-association")})],k.exit)}static async create(e){const t=new A({data:await n.create(e),onCommit:this._onCommitFactory(e.applyEditsFeatureService)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){return[{id:"add-association-select-layer",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedLayer=null,t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-select-feature",async setUp(){const{utilityNetworkAssociationAddAssociationViewModel:t}=e.data.viewModel;t&&(t.selectedFeature=null,t.association=null)},async tearDown(){}},{id:"add-association-create-association",async setUp(){},async tearDown(){}}]}},A=l,l._onCommitFactory=e=>async t=>{const{feature:s,utilityNetwork:i,associationInput:d}=t,{utilityNetworkAssociationAddAssociationViewModel:m}=t.viewModel,{association:u}=m;await i.networkSystemLayers.loadAssociationsTable();const f=i?.generateAddAssociations([u]);if(!f)throw new y("editor:failed-to-add-association","Could not create payload needed to add association");const p=s.sourceLayer,_=b(p)&&p.parent?p.parent:p,N=L([_]),w=N.values().next().value?.featureService;if(!w)throw new y("editor:failed-to-delete-association","Could not retrieve feature service needed to delete association");await w?.load();const V=i?.gdbVersion??void 0;await e(w,[f],{gdbVersion:V}),await d.refresh()},l);o([r()],a.prototype,"_utilityNetworkAssociationAddAssociationViewModel",void 0),o([r()],a.prototype,"_formViewModel",void 0),o([r()],a.prototype,"editorItem",null),o([r()],a.prototype,"formViewModel",null),o([r()],a.prototype,"utilityNetworkAssociationAddAssociationViewModel",null),o([r()],a.prototype,"sourceFeatureItem",void 0),o([r()],a.prototype,"hasPendingEdits",null),o([r()],a.prototype,"layer",null),o([r()],a.prototype,"parent",null),o([r()],a.prototype,"reliesOnOwnerAdminPrivileges",null),a=A=o([M("esri.widgets.Editor.AddAssociationWorkflow")],a);export{a as AddAssociationWorkflow};
