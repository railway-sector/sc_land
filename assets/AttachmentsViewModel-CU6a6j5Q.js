import{a2 as v,Q as w,k as I,by as _,bz as n,bG as A,Z as r,$ as c,bF as q,aj as L,bH as j,a0 as F}from"./index-CVzGOCNQ.js";import{d as O}from"./AttachmentInfo-QjQb7hJP.js";import{getSourceLayer as $}from"./featureUtils-CRixeKPJ.js";const g={editing:!1,operations:{add:!0,update:!0,delete:!0}},b=w.ofType(O);let s=class extends v{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.attachmentKeywords=null,this.attachmentTypes=null,this.capabilities={...g},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new b,this.fileInfos=new w,this.graphic=null,this.mode="view",this.orderByFields=null,this.filesEnabled=!1,this.addHandles(I(()=>this.graphic,()=>this._graphicChanged(),_))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(e){return{...g,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:e}=this;if(!e)return!1;const t=e.sourceLayer??e.layer;return t?.loaded&&"capabilities"in t&&t.capabilities&&"attachment"in t.capabilities&&t.capabilities.attachment&&"supportsResize"in t.capabilities.attachment&&t.capabilities.attachment.supportsResize||!1}get supportsTypeWildcard(){const{graphic:e}=this;if(!e)return!1;const t=e.sourceLayer??e.layer;return t?.loaded&&"capabilities"in t&&t.capabilities&&"attachment"in t.capabilities&&t.capabilities.attachment&&"supportsResize"in t.capabilities.attachment&&t.capabilities.attachment.supportsTypeWildcard||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t,orderByFields:a,attachmentTypes:i,attachmentKeywords:h,supportsTypeWildcard:d}=this;if(!e||typeof e.queryAttachments!="function")throw new n("invalid-layer","getAttachments(): A valid layer is required.");const o=this._getObjectId();if(typeof o!="number")throw new n("invalid-object-id","getAttachments(): Numeric object id is required");const p=a?.map(l=>`${l.field} ${l.order==="descending"?"DESC":"ASC"}`),m=new A({objectIds:[o],returnMetadata:!0,orderByFields:p,attachmentTypes:d?i?.filter(Boolean).map(l=>`${l}/*`):void 0,keywords:h}),u=[],f=e.queryAttachments(m).then(l=>l[o]||u).catch(()=>u);this._getAttachmentsPromise=f,this.notifyChange("state");const y=await f;return t.destroyAll(),y.length&&t.addMany(y),this._getAttachmentsPromise=null,this.notifyChange("state"),y}async addAttachment(e,t=this.graphic){const{_attachmentLayer:a,attachmentInfos:i,capabilities:h}=this;if(!t)throw new n("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:t});if(!e)throw new n("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!h.operations?.add)throw new n("invalid-capabilities","addAttachment(): add capabilities are required.");if(!a||typeof a.addAttachment!="function")throw new n("invalid-layer","addAttachment(): A valid layer is required.");const d=a.addAttachment(t,e).then(p=>this._queryAttachment(p.objectId,t)),o=await d;return i.add(o),o}async deleteAttachment(e){const{_attachmentLayer:t,attachmentInfos:a,graphic:i,capabilities:h}=this;if(!e)throw new n("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!h.operations?.delete)throw new n("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new n("invalid-layer","deleteAttachment(): A valid layer is required.");if(!i)throw new n("invalid-graphic","deleteAttachment(): A graphic is required.");const d=t.deleteAttachments(i,[e.id]).then(()=>e),o=await d;return a.remove(o),o.destroy(),o}async updateAttachment(e,t=this.activeAttachmentInfo){const{_attachmentLayer:a,attachmentInfos:i,graphic:h,capabilities:d}=this;if(!e)throw new n("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new n("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!d.operations?.update)throw new n("invalid-capabilities","updateAttachment(): Update capabilities are required.");const o=i.indexOf(t);if(!a||typeof a.updateAttachment!="function")throw new n("invalid-layer","updateAttachment(): A valid layer is required.");if(!h)throw new n("invalid-graphic","updateAttachment(): A graphic is required.");const p=a.updateAttachment(h,t.id,e).then(u=>this._queryAttachment(u.objectId)),m=await p;return i.splice(o,1,m),m}async commitFiles(){return await Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(e,t){if(!e||!t)return null;const a={file:e,form:t};return this.fileInfos.add(a),a}updateFile(e,t,a=this.activeFileInfo){if(!e||!t||!a)return null;const i=this.fileInfos.indexOf(a);return i>-1&&this.fileInfos.splice(i,1,{file:e,form:t}),this.fileInfos.items[i]}deleteFile(e){const t=this.fileInfos.find(a=>a.file===e);return t?(this.fileInfos.remove(t),t):null}async _queryAttachment(e,t){const{_attachmentLayer:a}=this;if(!e||!a?.queryAttachments)throw new n("invalid-attachment-id","Could not query attachment.");const i=this._getObjectId(t);if(typeof i!="number")throw new n("invalid-object-id","getAttachments(): Numeric object id is required");const h=new A({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return a.queryAttachments(h).then(d=>d[i][0])}_getObjectId(e=this.graphic){return e?.getObjectId()??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>this.attachmentInfos.destroyAll()))}_setAttachmentLayer(){const{graphic:e}=this,t=$(e);this._attachmentLayer=t?t.type==="scene"&&t.associatedLayer!=null?t.associatedLayer:t:null}};r([c({type:[String]})],s.prototype,"attachmentKeywords",void 0),r([c({type:[["application","audio","image","model","text","video"]]})],s.prototype,"attachmentTypes",void 0),r([c()],s.prototype,"capabilities",void 0),r([q("capabilities")],s.prototype,"castCapabilities",null),r([c()],s.prototype,"activeAttachmentInfo",void 0),r([c()],s.prototype,"activeFileInfo",void 0),r([c({readOnly:!0,type:b})],s.prototype,"attachmentInfos",void 0),r([c()],s.prototype,"fileInfos",void 0),r([c({type:L})],s.prototype,"graphic",void 0),r([c()],s.prototype,"mode",void 0),r([c({type:[j]})],s.prototype,"orderByFields",void 0),r([c({readOnly:!0})],s.prototype,"state",null),r([c()],s.prototype,"filesEnabled",void 0),r([c({readOnly:!0})],s.prototype,"supportsResizeAttachments",null),r([c({readOnly:!0})],s.prototype,"supportsTypeWildcard",null),s=r([F("esri.widgets.Attachments.AttachmentsViewModel")],s);export{s as y};
