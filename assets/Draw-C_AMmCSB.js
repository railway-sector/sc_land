const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/LegacyDrawTool-lTP_7oZM.js","assets/index-BrQW8HOS.js","assets/index-lUE0m221.css","assets/drawSurfaces-Dk7dFDxx.js","assets/dehydratedFeatureComparison-3eJNk6Ap.js","assets/DrawingMode-Cvvf0VVz.js","assets/coordinateHelper-DrvFu3jL.js","assets/dragEventPipeline-DNpVWaws.js","assets/EditGeometryOperations-vGO-F4bG.js","assets/geometry2dUtils-kADrF-iP.js","assets/rotate-BhR0-nSl.js","assets/curveOperationUtils-DH-ids6k.js","assets/euclideanLengthMeasurementUtils-B8AL_WaV.js","assets/utils-D_VO_1nP.js","assets/geodesicUtils-BJZXB7Hp.js","assets/geodeticLengthOperator-DifrZujk.js","assets/geodeticCurveType-CirnHLSB.js","assets/geodesicMeasurementUtils-CQw8IWGR.js","assets/angularMeasurementUtils-C6IEZQKT.js","assets/SketchLabelOptions-BPF5xZLI.js","assets/SnappingContext-lR2hMWGP.js","assets/SnappingDragPipelineStep-Bkdf_3gf.js","assets/SnappingOperation-C2jjQrkg.js","assets/InteractiveToolBase-BmMFG_WL.js"])))=>i.map(i=>d[i]);
import{jN as R,d8 as Z,j4 as $,aP as F,kA as D,jc as z,b1 as N,_ as n,e as d,g as y,ot as s,pj as h,rN as a,al as V,U as H,Y as j}from"./index-BrQW8HOS.js";import{n as K}from"./GraphicsLayer-CtVknZ1a.js";import{f as Y}from"./SnappingVisualizer2D-D8AbMCG0.js";import{w as B}from"./coordinateHelper-DrvFu3jL.js";import{g as U,w as E,V as k}from"./EditGeometryOperations-vGO-F4bG.js";import{e as W}from"./SnappingContext-lR2hMWGP.js";import{p as q}from"./SnappingOperation-C2jjQrkg.js";import{c as C}from"./automaticLengthMeasurementUtils-Cr-y0OEN.js";import{c as G,e as M}from"./DrawingMode-Cvvf0VVz.js";import{W as J}from"./surfaceCoordinateSystems-BrNYf00T.js";var S,m;let p=(m=class extends R(Z){constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=B(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new U(new E(e.editGeometryType??"polygon",this._coordinateHelper),2),this._snappingGraphicsLayer=new K({id:S.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0,title:"Snapping graphics"}),this._snappingContext=new W({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new Y(this._snappingGraphicsLayer)}),this._activeComponent=new k(e.view.spatialReference,2),this._editGeometryOperations.data.parts.push(this._activeComponent)}normalizeCtorArgs(e){const t={...e};return delete t.editGeometryType,delete t.snappingManager,t}initialize(){this._snappingOperation=new q({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this._snappingOperation=$(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.parts[0].vertices.map(e=>e.pos)}get vertices(){return this._stagedVertex!=null?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return this._hasZ!=null?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation?.stagedPoint}set _stagedVertex(e){this._snappingOperation&&(this._snappingOperation.stagedPoint=F(e))}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){const t=e&&this.screenToMap(e);return t==null?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return t==null?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){const o=this.elevationInfo??Q;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(D(e.x,e.y),o,this._getGeometryZValue())}else{const o=this.elevationInfo??X;t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(D(e.x,e.y),o,0),t!=null&&(t.z=void 0)}else t=this.view.toMap(e),t!=null&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){const o=z(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=o;const r=this._snappingManager;if(r==null)return this._stagedVertex=o,void t();N(this._snappingOperation.snap({point:o},r,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){const t=this._editGeometryOperations.data.parts[0].getLastVertex()?.pos;if(t&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:o,y:r}=this._coordinateHelper.vectorToDehydratedPoint(e);return this._lastVertexUnsnapped!=null&&o===this._lastVertexUnsnapped.x&&r===this._lastVertexUnsnapped.y}_shouldHandlePointerEvent(e){return ee(e)&&(this._activePointerId==null||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=this._stagedVertex!=null?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);t!=null&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}},S=m,m.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",m);n([d({readOnly:!0})],p.prototype,"vertices",null),n([d({type:Boolean,nonNullable:!0})],p.prototype,"interactiveUndoDisabled",void 0),n([d({readOnly:!0})],p.prototype,"history",void 0),n([d({readOnly:!0})],p.prototype,"redoHistory",void 0),n([d()],p.prototype,"snapToScene",void 0),n([d()],p.prototype,"view",void 0),n([d()],p.prototype,"elevationInfo",void 0),n([d({nonNullable:!0})],p.prototype,"defaultZ",void 0),n([d()],p.prototype,"hasZ",null),n([d()],p.prototype,"_snappingOperation",void 0),n([d()],p.prototype,"_stagedVertex",null),p=S=n([y("esri.views.draw.DrawAction")],p);const Q={mode:"absolute-height",offset:0},X={mode:"on-the-ground",offset:0};function ee(i){return i.pointerType!=="mouse"||i.button===0}const T=p;class l{constructor(e,t,o){this.view=e,this.defaultPrevented=!1,this.type="vertex-add",this.vertexIndex=t,this.vertices=o}preventDefault(){this.defaultPrevented=!0}}class g{constructor(e,t,o){this.view=e,this.defaultPrevented=!1,this.type="vertex-remove",this.vertexIndex=t,this.vertices=o}preventDefault(){this.defaultPrevented=!0}}class u{constructor(e,t,o,r=null){this.view=e,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=o.length===1?o[0]:null,this.vertexIndex=t,this.vertices=o,this.mapPoint=r}preventDefault(){this.defaultPrevented=!0}}class w{constructor(e){this.vertices=e,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=e.length===1?e[0]:null}preventDefault(){this.defaultPrevented=!0}}const L=Symbol("view-handles"),I=Symbol("undo-redo-handles");let b=class extends T{constructor(i){super(i),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this.addHandles([this.view.on("click",i=>{i.stopPropagation()},s.TOOL),this.view.on("pointer-down",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._activePointerId=i.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(i),i.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",i=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=h(i),i.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",i=>{if(this._shouldHandlePointerEvent(i)){if(this._abortSnapping(),this._activePointerId=null,!this._addVertexOnPointerUp){const e=i.pointerType==="touch";return void this._updateCursor(e)}this._vertexAddHandler(i)}},s.TOOL),this.view.on("drag",["Shift"],i=>{i.stopPropagation()},s.TOOL),this.view.on("double-click",i=>{i.stopPropagation(),this._drawCompleteHandler(i)},s.TOOL),this.view.on("double-click",["Control"],i=>{i.stopPropagation(),this._drawCompleteHandler(i)},s.TOOL),this.view.on("key-down",i=>{const{key:e,repeat:t}=i;e===a.vertexAdd&&!t&&this._cursorScreenPoint?(i.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(i)):e!==a.complete||t?e!==a.undo||this.interactiveUndoDisabled||t?e!==a.redo||this.interactiveUndoDisabled||t?e!==a.pan||t||i.stopPropagation():(i.stopPropagation(),this.redo()):(i.stopPropagation(),this.undo()):(i.stopPropagation(),this._drawCompleteHandler(i))},s.TOOL),this.view.on("key-up",i=>{i.key===a.pan&&i.stopPropagation()},s.TOOL)],L)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this.addHandles([this._editGeometryOperations.on("vertex-remove",i=>{if(this.notifyChange("vertices"),i.operation==="undo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new g(this.view,i.vertices[0].index,e))}}),this._editGeometryOperations.on("vertex-add",i=>{if(this.notifyChange("vertices"),i.operation==="apply"){const e=this._committedVertices.length-1,t=new l(this.view,e,this.vertices);this.emit("vertex-add",t),t.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(i.operation==="redo"){const e=[...this._committedVertices];this._stagedVertex!=null&&e.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new l(this.view,i.vertices[0].index,e))}})],I)}_removeViewHandles(){this.removeHandles(L)}_removeUndoRedoHandles(){this.removeHandles(I)}_addVertex(i){const e=this._coordinateHelper.arrayToVector(i);this._isDuplicateOfLastVertex(e)||this._editGeometryOperations.appendVertexToFirstPart(e)}_updateCursor(i=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const e=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);e==null||i||this._pushCursorVertex(e.vertex,()=>this.emit("cursor-update",new u(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new V(this._stagedVertex):null)))}_completeDrawing(){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const i=new w(this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this._removeViewHandles()}};b=n([y("esri.views.draw.MultipointDrawAction")],b);const te=b;let A=class extends T{constructor(e){super(e),this._addVertexOnPointerUp=!1,this._drawTool=null}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{e.key===a.complete&&(this._drawTool?this.complete():(this._abortSnapping(),this._vertexAddHandler(e)))},s.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&this.addHandles([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(e),e.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=h(e),e.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e)){if(this._abortSnapping(),this._activePointerId=null,!this._addVertexOnPointerUp){const t=e.pointerType==="touch";return void this._updateCursor(t)}e.stopPropagation(),this._vertexAddHandler(e)}},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL)])}async _addDrawTool(){const[{LegacyDrawTool:e},t]=await Promise.all([H(()=>import("./LegacyDrawTool-lTP_7oZM.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])),C()]),o=new e({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click",automaticLengthMeasurementUtils:t});this.destroyed?o.destroy():(this._drawTool=o,this.view.addAndActivateTool(o),this.addHandles([o.on("cursor-update",r=>{r.vertices.length===1&&this.emit("cursor-update",new u(this.view,r.vertices[0].vertexIndex,o.getVertexCoords()))}),o.on("complete",r=>{this.emit("draw-complete",new w(o.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertexToFirstPart(t),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new u(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new V(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new w(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};A=n([y("esri.views.draw.PointDrawAction")],A);const ie=A;let x=class extends T{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=M}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles(this.view.on("key-down",e=>{const{key:t,repeat:o}=e;t!==a.vertexAdd||o?t!==a.complete||o?t!==a.undo||this.interactiveUndoDisabled||o?t!==a.redo||this.interactiveUndoDisabled||o||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},s.TOOL))}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(e),e.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=h(e),e.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=h(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e)){if(this._abortSnapping(),this._activePointerId=null,!this._addVertexOnPointerUp){const t=e.pointerType==="touch";return void this._updateCursor(t)}if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}},s.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:o}=e;t!==a.pan||o||(e.stopPropagation(),this._panEnabled=!0)},s.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},s.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new g(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._committedVertices.length-1,o=new l(this.view,t,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new l(this.view,e.vertices[0].index,t))}})])}async _addDrawTool(){const[{LegacyDrawTool:e},t]=await Promise.all([H(()=>import("./LegacyDrawTool-lTP_7oZM.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])),C()]),o=new e({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode,automaticLengthMeasurementUtils:t});this.destroyed?o.destroy():(this._drawTool=o,this.view.addAndActivateTool(o),o.on("vertex-add",r=>{if(r.vertices.length===1){const{view:c}=this,_=r.vertices[0].vertexIndex,v=o.getVertexCoords();this.emit("vertex-add",new l(c,_,v)),r.operation!=="undo"&&r.operation!=="redo"||this.emit(r.operation,new l(c,_,v))}}),o.on("vertex-remove",r=>{if(r.vertices.length===1){const{view:c}=this,_=r.vertices[0].vertexIndex,v=o.getVertexCoords();this.emit("vertex-remove",new g(c,_,v)),r.operation!=="undo"&&r.operation!=="redo"||this.emit(r.operation,new g(c,_,v))}}),o.on("cursor-update",r=>{r.vertices.length===1&&this.emit("cursor-update",new u(this.view,r.vertices[0].vertexIndex,o.getVertexCoords()))}),o.on("complete",r=>{this.emit("draw-complete",new w(o.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()}))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertexToFirstPart(t))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new u(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new V(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new w(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};n([d()],x.prototype,"_dragEnabled",null),n([d()],x.prototype,"_clickEnabled",null),n([d({type:G})],x.prototype,"mode",void 0),x=n([y("esri.views.draw.PolygonDrawAction")],x);const oe=x;let P=class extends T{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.mode=M}initialize(){this._addViewHandles(),this.view.type==="3d"&&this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){this._drawTool?this._drawTool.undo():(super.undo(),this.notifyChange("vertices"))}redo(){this._drawTool?this._drawTool.redo():(super.redo(),this.notifyChange("vertices"))}canUndo(){return this._drawTool?.canUndo()??super.canUndo()}canRedo(){return this._drawTool?.canRedo()??super.canRedo()}complete(){this._completeDrawing()}_addViewHandles(){this._addViewHandles2DOnly(),this.addHandles([this.view.on("key-down",e=>{const{key:t,repeat:o}=e;t!==a.vertexAdd||o?t!==a.complete||o?t!==a.undo||this.interactiveUndoDisabled||o?t!==a.redo||this.interactiveUndoDisabled||o||(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e)):(e.stopPropagation(),this._handleVertexAddKey(e))},s.TOOL)])}_addViewHandles2DOnly(){this.view.type==="2d"&&(this.addHandles([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(e),e.pointerType==="touch"&&this._updateCursor())},s.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=h(e),e.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=h(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e)){if(this._abortSnapping(),this._activePointerId=null,!this._addVertexOnPointerUp){const t=e.pointerType==="touch";return void this._updateCursor(t)}if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}},s.TOOL),this.view.on("drag",e=>{this._dragEnabled&&this._activePointerId!=null&&!this._panEnabled&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:o}=e;t!==a.pan||o||(e.stopPropagation(),this._panEnabled=!0)},s.TOOL),this.view.on("key-up",e=>{e.key===a.pan&&(e.stopPropagation(),this._panEnabled=!1)},s.TOOL)]),this._addUndoRedoHandles())}_handleVertexAddKey(e){this._drawTool?this._drawTool.drawOperation.commitStagedVertex():this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))}_addUndoRedoHandles(){this.addHandles([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new g(this.view,e.vertices[0].index,t))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._committedVertices.length-1,o=new l(this.view,t,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=[...this._committedVertices];this._stagedVertex!=null&&t.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new l(this.view,e.vertices[0].index,t))}})])}async _addDrawTool(){const[{LegacyDrawTool:e},t]=await Promise.all([H(()=>import("./LegacyDrawTool-lTP_7oZM.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])),C()]),o=new e({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode,automaticLengthMeasurementUtils:t});this.destroyed?o.destroy():(this._drawTool=o,this.view.addAndActivateTool(o),this.addHandles([o.on("vertex-add",r=>{if(r.vertices.length!==1)return;const{view:c}=this,_=r.vertices[0].vertexIndex,v=o.getVertexCoords();this.emit("vertex-add",new l(c,_,v)),r.operation!=="undo"&&r.operation!=="redo"||this.emit(r.operation,new l(c,_,v))}),o.on("vertex-remove",r=>{if(r.vertices.length!==1)return;const{view:c}=this,_=r.vertices[0].vertexIndex,v=o.getVertexCoords();this.emit("vertex-remove",new g(c,_,v)),r.operation!=="undo"&&r.operation!=="redo"||this.emit(r.operation,new g(c,_,v))}),o.on("cursor-update",r=>{r.vertices.length===1&&this.emit("cursor-update",new u(this.view,r.vertices[0].vertexIndex,o.getVertexCoords()))}),o.on("complete",r=>{this.emit("draw-complete",new w(o.getVertexCoords())),this._removeDrawTool(),this.removeAllHandles()})]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertexToFirstPart(t))}_updateCursor(e=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);t==null||e||this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new u(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new V(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return void this._drawTool.completeCreateOperation();if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping();const e=new w(this.vertices);this.emit("draw-complete",e),e.defaultPrevented||this.removeAllHandles()}};n([d()],P.prototype,"_clickEnabled",null),n([d()],P.prototype,"_dragEnabled",null),n([d({type:G})],P.prototype,"mode",void 0),P=n([y("esri.views.draw.PolylineDrawAction")],P);const se=P,re=["freehand","click"];let f=class extends T{constructor(i){super(i),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this._drawTool=null,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this.addResolvingPromise(this._addDrawTool())}destroy(){this._removeDrawTool(),this.emit("destroy")}complete(){this._completeDrawing()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this.mode==="click"?this.addHandles(this._getClickModeViewHandles()):this.addHandles(this._getDragModeViewHandles())}_getDragModeViewHandles(){return[this.view.on("immediate-click",i=>{i.stopPropagation(),i.mapPoint&&!this._panEnabled&&this.getCoordsFromScreenPoint(h(i))!=null&&(this._vertexAddHandler(i),this._drawCompleteHandler(i))},s.TOOL),this.view.on("pointer-down",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=h(i),this._activePointerId=i.pointerId,this._vertexAddHandler(i),this._isDragging=!1,i.pointerType==="touch"&&this._updateCursor()))},s.TOOL),this.view.on("pointer-move",i=>{this._abortSnapping(),this._activePointerId==null&&i.pointerType!=="touch"&&(this._cursorScreenPoint=h(i),this._updateCursor())},s.TOOL),this.view.on("pointer-drag",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=h(i),this._updateCursor())},s.TOOL),this.view.on("pointer-up",i=>{this._shouldHandlePointerEvent(i)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(i),this._committedVertices.length===2&&this._drawCompleteHandler(i),this._isDragging=!1)},s.TOOL),this.view.on("key-down",i=>{i.key===a.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(i),this._drawCompleteHandler(i)):i.key===a.pan&&(this._panEnabled=!0)},s.TOOL),this.view.on("key-up",i=>{i.key===a.pan&&(this._panEnabled=!1)},s.TOOL),this.view.on("drag",i=>{this._activePointerId!=null&&i.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],i=>{i.stopPropagation()},s.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",i=>{this._abortSnapping(),this._cursorScreenPoint=h(i),this._activePointerId=i.pointerId,this._isDragging=!1,i.pointerType==="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-move",i=>{this._abortSnapping(),this._cursorScreenPoint=h(i),this._activePointerId==null&&i.pointerType!=="touch"&&this._updateCursor()},s.TOOL),this.view.on("pointer-drag",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._isDragging=!0)},s.TOOL),this.view.on("pointer-up",i=>{this._shouldHandlePointerEvent(i)&&(this._abortSnapping(),this._activePointerId=null,i.stopPropagation(),this._isDragging||this._vertexAddHandler(i),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(i),this._isDragging=!1)},s.TOOL),this.view.on("key-down",i=>{i.key===a.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(i),this.vertices.length===2&&this._drawCompleteHandler(i)),i.key===a.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(i),this._drawCompleteHandler(i))},s.TOOL)]}async _addDrawTool(){const[{LegacyDrawTool:i},e]=await Promise.all([H(()=>import("./LegacyDrawTool-lTP_7oZM.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23])),C()]),t=new i({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode,automaticLengthMeasurementUtils:e});this.destroyed?t.destroy():(this._drawTool=t,this.view.addAndActivateTool(t),this.addHandles([t.on("vertex-add",o=>{o.vertices.length===1&&this.emit("vertex-add",new l(this.view,o.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("cursor-update",o=>{o.vertices.length===1&&this.emit("cursor-update",new u(this.view,o.vertices[0].vertexIndex,t.getVertexCoords()))}),t.on("complete",o=>{this.emit("draw-complete",new w(t.getVertexCoords())),this._removeDrawTool()}),this.view.on("key-down",o=>{o.key!==a.vertexAdd||o.repeat||this.mode!=="click"?o.key!==a.complete||o.repeat||t.completeCreateOperation():t.drawOperation.numCommittedVertices>0?t.completeCreateOperation():t.drawOperation.commitStagedVertex()},s.TOOL)]))}_removeDrawTool(){this._drawTool&&(this.view.tools.remove(this._drawTool),this._drawTool=null)}_addVertex(i){const e=this._coordinateHelper.arrayToVector(i);if(this._isDuplicateOfLastVertex(e))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertexToFirstPart(e),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=J(this.view,this._committedVertices[0]));const t=this._committedVertices.length-1,o=new l(this.view,t,this.vertices);this.emit("vertex-add",o)}_updateCursor(){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);i!=null&&this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new u(this.view,this._activeComponent.vertices.length,this.vertices,this._stagedVertex!=null?new V(this._stagedVertex):null)))}_completeDrawing(){if(this._drawTool)return this._drawTool.completeCreateOperation(),void this.removeAllHandles();if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),this._snappingManager!=null&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const i=new w(this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this.removeAllHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new U(new E("polygon",this._coordinateHelper),2),this._activeComponent=new k(this._coordinateHelper.spatialReference,2),this._editGeometryOperations.data.parts.push(this._activeComponent)}};n([d({type:re})],f.prototype,"mode",void 0),f=n([y("esri.views.draw.SegmentDrawAction")],f);const ne=f;let O=class extends j{constructor(i){super(i),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(i,e){this.reset();const t={view:this.view,...e};switch(i){case"point":t.editGeometryType="point",this.activeAction=new ie(t);break;case"polyline":t.editGeometryType="polyline",this.activeAction=new se(t);break;case"multipoint":t.editGeometryType="polygon",this.activeAction=new te(t);break;case"polygon":t.editGeometryType="polygon",this.activeAction=new oe(t);break;case"rectangle":case"circle":case"ellipse":case"triangle":t.editGeometryType="polygon",this.activeAction=new ne(t)}return this.activeAction}complete(){this.activeAction?.complete(),this.activeAction=null}reset(){this.activeAction?.destroy(),this.activeAction=null}};n([d()],O.prototype,"activeAction",void 0),n([d({readOnly:!0})],O.prototype,"type",void 0),n([d()],O.prototype,"view",void 0),O=n([y("esri.views.draw.Draw")],O);const xe=O;export{xe as l};
