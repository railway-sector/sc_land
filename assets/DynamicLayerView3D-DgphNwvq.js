import{pP as v,pO as R,sd as z,jQ as F,i3 as q,pu as W,pq as k,pr as I,ap as B,se as N,eR as V,ez as G,a9 as b,b3 as O,sf as Q,s3 as U,aZ as P,gl as Z,d1 as _,jJ as J,gn as K,sg as $,sh as X,si as Y,i2 as ee,sj as te,N as ie,a5 as g,x as w,y as T,b2 as re,ki as se,kh as ae,hQ as ne,jG as oe}from"./index-Brd6-W-v.js";import{p as le}from"./SubView3D-bLTYz8B7.js";import{g as he}from"./ImageMaterial.glsl-CQW7ppLY.js";import{l as de}from"./LayerView3D-DUu8aT-w.js";import{d as ue}from"./LayerView-D9jNDLF4.js";import{i as ce}from"./RefreshableLayerView-CxNDNB_D.js";function ge(t,e,i){const s=v(t)/R(t),r={width:i,height:i};return s>1.0001?r.height=i/s:s<.9999&&(r.width=i*s),r.width=Math.round(r.width/(v(t)/v(e))),r.height=Math.round(r.height/(R(t)/R(e))),r}function H(t,e){return z(t,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function me(t,e,i){if(!F(e,i))return H(t,i);const s=[e[1]-i[1],Math.min(e[3],i[3])-Math.max(e[1],i[1]),i[3]-e[3],123456],r=[e[0]-i[0],Math.min(e[2],i[2])-Math.max(e[0],i[0]),i[2]-e[2],123456],n=i[2]-i[0],l=i[3]-i[1],a=r[0]>0&&r[2]>0?3:2,h=s[0]>0&&s[2]>0?3:2,o=(h+1)*(a+1),d=q(3*o),u=W(2*o),c=new Array(6*(h*a-1));let S=0,A=0,D=0,p=0,y=0;for(let f=0;f<4;f++){const C=s[f];if(C<=0)continue;let E=0;for(let x=0;x<4;x++){const L=r[x];L<=0||(d[A++]=i[0]+E,d[A++]=i[1]+S,d[A++]=-1,u[D++]=E/n,u[D++]=S/l,x<3&&f<3&&(x!==1||f!==1)&&(c[y++]=p,c[y++]=p+1,c[y++]=p+a+1,c[y++]=p+1,c[y++]=p+a+2,c[y++]=p+a+1),p++,E+=L)}S+=C}const j=new Array(c.length);return new k(t,[["position",new I(d,c,3,!0)],["normal",new I(pe,j,3,!0)],["uv0",new I(u,c,2,!0)]])}const pe=[0,0,1];let M=class extends le{constructor(t){super(t),this.drapeSourceType=0,this.updatePolicy=1,this.type="draped",this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this._drapeSourceRenderer=null}initialize(){this._drapeSourceRenderer=this.view.overlayManager.registerGeometryDrapeSource(this),this.addHandles(B(()=>this.view.overlayManager.unregisterDrapeSource(this)))}setDrapingExtent(t,e){this._spatialReference=e,t.forEach((i,s)=>{this._overlays[s]=i,this._updateImageExtent(i,s)})}destroy(){this.clear()}get spatialReference(){return this._spatialReference}_updateImageExtent(t,e){const i=this._clippedExtent(t.extent,we);if(i==null)return;const s=ge(t.extent,i,t.resolution);let r=t.pixelRatio*this.view.state.pixelRatio;const{layer:n}=this;if("imageMaxWidth"in n&&n.imageMaxWidth!=null||"imageMaxHeight"in n&&n.imageMaxHeight!=null){const a=n.imageMaxWidth,h=n.imageMaxHeight;if(s.width>a){const o=a/s.width;s.height=Math.floor(s.height*o),s.width=a,r*=o}if(s.height>h){const o=h/s.height;s.width=Math.floor(s.width*o),s.height=h,r*=o}}const l=this._extents[e];l&&N(l.extent,i)&&this._imageSizeEquals(i,l.imageSize,s)||(this._extents[e]={extent:V(i),imageSize:s,pixelRatio:r},this.suspended||this._fetch(e).catch(a=>{G(a)||b.getLogger(this).error(a)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(t){const e=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&e.push(this._fetch(i,t));await Promise.allSettled(e)}async processResult(t,e,i){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(const e of this._extents){const i=e.extent;if(new O(i[0],i[1],i[2],i[3],this._spatialReference).contains(t))return e}return null}async redraw(t,e){await Q(this._images,async(i,s)=>{i&&(await t(i,e),await this._createStageObjects(s,i.image,e))})}_imageSizeEquals(t,e,i){if(!this.maximumDataResolution)return!1;const s=v(t)/this.maximumDataResolution.x,r=R(t)/this.maximumDataResolution.y,n=s/e.width,l=r/e.height,a=s/i.width,h=r/i.height,o=Math.abs(n-a),d=Math.abs(l-h),u=U.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return o<=u&&d<=u}async _fetch(t,e){if(this.suspended)return;const i=this._extents[t],s=i.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:V(s)});const r=this._images[t];r.loadingAbortController=P(r.loadingAbortController);const n=new O(s[0],s[1],s[2],s[3],this._spatialReference);if(n.width===0||n.height===0)return void this._clearImage(t);const l=new AbortController;r.loadingAbortController=l,Z(e,()=>l.abort());const a=l.signal,h=this._waitFetchReady(a).then(async()=>{_(a);const o={requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio,...this.layerView.getFetchOptions(),signal:a},{height:d,width:u}=i.imageSize;return this.layer?this.layer.type==="imagery"?this.layer.internalFetchImage(n,u,d,o):this.layer.fetchImage(n,u,d,o):null}).then(o=>{if(J(a))throw b.getLogger(this).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),K();return this.processResult(r,o)}).then(()=>{$(r.renderExtent,s)});r.loadingPromise=h,await this.updatingHandles.addPromise(h.then(async()=>{_(a),await this._createStageObjects(t,r.image,a)}).catch(o=>{throw o&&!G(o)&&b.getLogger(this).error(o),o}).finally(()=>{h===r.loadingPromise&&(r.loadingPromise=null,r.loadingAbortController=null)}))}_clearImage(t){const e=this._images[t];if(e){e.renderGeometry!=null&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],1),e.renderGeometry=null);const i=this.view.stage,s=e.texture;s?.unload(),i.removeTexture(s),e.texture=null,e.material=null,e.loadingAbortController=P(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,i){const s=this.view.stage,r=this._images[t],n=()=>{r.texture?.unload(),s.removeTexture(r.texture),r.texture=null,r.renderGeometry&&(this._drapeSourceRenderer.removeGeometries([r.renderGeometry],1),r.renderGeometry=null)};if(e){const l=new X(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}});if(await Y(this._images[t===0?1:0].loadingPromise),_(i),n(),await s.schedule(()=>l.load(s.renderView.renderingContext),i),!l.loaded)return void n();let a;if(s.addTexture(l),r.texture=l,r.material??=new he({draped:!0,texture:l}),r.material.setParameters({texture:l}),t===0)a=H(r.material,r.renderExtent);else{const h=this._images[0].renderExtent;if(!h)return void n();a=me(r.material,h,r.renderExtent)}r.renderGeometry=new ee(a),r.renderGeometry.localOrigin=this._overlays[t].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([r.renderGeometry],1)}else n(),r.material=null}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return $(e,t);const i=this.view.basemapTerrain;return i.ready?te(t,i.extent,e):$(e,t)}async _waitFetchReady(t){await ie(()=>this.view.stationary,t),_(t)}get usedMemory(){return this._images.reduce((t,e)=>t+(e.texture?.usedMemory??0),0)}};g([w()],M.prototype,"type",void 0),M=g([T("esri.views.3d.layers.DrapedSubView3D")],M);const we=V();let m=class extends ce(de(ue)){constructor(){super(...arguments),this.fullExtentInLocalViewSpatialReference=null,this.refreshDebounced=re(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{G(e)||b.getLogger(this).error(e)})},2e3),this.ignoresMemoryFactor=!1,this.unloadedMemory=0}get visibleAtCurrentScale(){const t=this.layer,e="effectiveScaleRange"in t?t.effectiveScaleRange:null;return se(e,this.view.scale)}isUpdating(){return super.isUpdating()||this.subView?.updating}initialize(){this._initSubView(),this.view.viewingMode==="local"&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await ae(this.layer.fullExtent,this.view.spatialReference))()),this._updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler())}destroy(){this.subView=ne(this.subView)}_initSubView(){this.subView=new M({layerView:this})}async doRefresh(){return this._doRefresh()}async _doRefresh(t){this.suspended||await this.subView.doRefresh(t)}getFetchOptions(){}_suspendedChangeHandler(){this.suspended?this.subView.clear():this.refreshDebounced()}get test(){}get usedMemory(){return this.subView.usedMemory}get performanceInfo(){return new oe(this.usedMemory)}};g([w()],m.prototype,"layer",void 0),g([w()],m.prototype,"suspended",void 0),g([w()],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),g([w({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),g([w()],m.prototype,"updating",void 0),g([w()],m.prototype,"subView",void 0),m=g([T("esri.views.3d.layers.DynamicLayerView3D")],m);export{M as A,m};
