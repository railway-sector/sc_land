const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/containsOperator-CQYyML-M.js","assets/ProjectionTransformation-CfbkWcJt.js","assets/Envelope2D-DQ3Tn1o-.js","assets/Point2D-8Py_srEd.js","assets/Transformation2D-Ckyhe4wc.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/index-Brd6-W-v.js","assets/index-ni9qn0ie.css","assets/OperatorDefinitions-DP7_WWTp.js","assets/jsonConverter-C7-7hi8T.js","assets/apiConverter-CH50OwTE.js","assets/intersectsOperator-CnRdOJlB.js","assets/OperatorIntersects-DKd2MBN0.js","assets/intersectionOperator-BKYNpJpe.js","assets/operatorIntersection-B5xxihVn.js","assets/simplifyOperator-CuJaEDXS.js","assets/operatorSimplify-CJeXdbKY.js"])))=>i.map(i=>d[i]);
import{a3 as P,jJ as L,l3 as j,b3 as q,bI as M,fC as G,jI as S,pW as V,a9 as I,a5 as x,x as R,y as U}from"./index-Brd6-W-v.js";import{s as z,a as F}from"./LercDecoder-Dq-2uiu6.js";import{l as k}from"./LayerView3D-DUu8aT-w.js";import{p as J}from"./TiledLayerView3D-CDKfA91h.js";import{d as W}from"./LayerView-D9jNDLF4.js";class Z{constructor(){this.modifications=[]}async apply(o,e,t){if(this.modifications.length!==0&&(b??=Promise.all([P(()=>import("./containsOperator-CQYyML-M.js").then(i=>i.c),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),P(()=>import("./intersectsOperator-CnRdOJlB.js").then(i=>i.i),__vite__mapDeps([11,1,2,3,4,5,6,7,8,9,12,10])),P(()=>import("./intersectionOperator-BKYNpJpe.js").then(i=>i.a),__vite__mapDeps([13,6,7,3,1,2,4,5,8,9,14,10]))]),O=await b,!L(t)))for(const i of this.modifications)i.apply(o,e)}}class B{constructor(o,e){this.type=o,this.polygon=e}apply(o,e){if(this.type!=="replace")return;const{polygon:t}=this,[i,s,f]=O,{extent:v,spatialReference:u}=e,g=j(v,u);if(s.accelerateGeometry(t),!s.execute(t,g))return;i.accelerateGeometry(t),f.accelerateGeometry(t);const{width:n,height:c,values:d}=o,p=t.hasZ?t.rings.reduce((r,y)=>y.reduce((l,m)=>Math.min(l,m[2]??1/0),r),1/0):1/0,h=p===1/0?0:p;if(i.execute(t,g))d.fill(h);else{const r=H(e,t,[n,c]);if(!r||r.rings.every(l=>l.length===0))return;const y=K(e,r,n,c);for(let l=c-1;l>=0;--l)for(let m=0;m<n;++m){const T=(l+1)*(n+2)+(m+1);let _=0;for(let E=-1;E<=1;++E){const C=T+E*(n+2);for(let $=-1;$<=1;++$)_=Math.max(_,y[C+$])}const D=l*n+m;d[D]=_===0?d[D]:h}}}}let b,O;function H(a,o,e){const[t,i,s,f]=a.extent,{spatialReference:v}=a,[u,g]=e,n=2,c=(s-t)/(u-1),d=(f-i)/(g-1),p=new q({xmin:t-n*c,ymin:i-n*d,xmax:s+n*c,ymax:f+n*d,spatialReference:v}),h=O[2].execute(o,p);return h?.type==="polygon"?h:null}function K(a,o,e,t){const i=new OffscreenCanvas(e+2,t+2).getContext("2d",{willReadFrequently:!0});if(!i)throw new Error("failed to create canvas");const[s,f,v,u]=a.extent,g=v-s,n=u-f;i.fillStyle="black",i.clearRect(0,0,e,t);const c=new Path2D;for(const r of o.rings)if(r.length>0){const y=new Path2D;let l=!0;for(const[m,T]of r){const _=(m-s)/g*(e-1)+1+A,D=(u-T)/n*(t-1)+1+A;l?(l=!1,y.moveTo(_,D)):y.lineTo(_,D)}y.closePath(),c.addPath(y)}i.fillStyle="white",i.fill(c,"evenodd");const d=i.getImageData(0,0,e+2,t+2),p=(e+2)*(t+2),h=new Uint8Array(p);for(let r=0;r<p;++r)h[r]=d.data[4*r+0]>0?1:0;return h}const A=.5;let w=class extends J(k(W)){constructor(){super(...arguments),this.type="elevation-3d",this.modifications=new Z}get tileInfo(){return this.layer.tileInfo}initialize(){const a=this.view,o=a.map?.allLayers,e=o&&o.includes(this.layer),t=a.map?.ground?.layers,i=t&&t.includes(this.layer);if(e&&!i){const s=new M("layerview:elevation-layer-only",`3D elevation layer '${this.layer.id}' can only be added to layers in map.ground`);this.addResolvingPromise(Promise.reject(s))}this._lercDecoder=z(a.resourceController),this._addTilingSchemeMatchPromise()}destroy(){this._lercDecoder=G(this._lercDecoder)}async fetchElevationTile(a,o){const e=await this._fetchTileData(a.lij,o);if(!L(o))return e&&await this.modifications.apply(e,a,o.signal),e}async _fetchTileData(a,o){const e=this.layer;if(S(e)){const f=await e.fetchTile(a[0],a[1],a[2],{noDataValue:V,signal:o.signal});return L(o)?void I.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."):f}const t=this.getTileUrl(a),i=await o.requester.request(t,1,o),s=await this._lercDecoder.decode(i,{noDataValue:V},o.signal);if(s)return new F(s);throw new Error("LERC decoding failed")}async setModifications(a){if(this.modifications.modifications.length=0,!a||a.length===0)return;this._simplifyOperatorPromise??=P(()=>import("./simplifyOperator-CuJaEDXS.js").then(e=>e.s),__vite__mapDeps([15,3,1,2,4,5,6,7,8,9,16,10]));const o=await this._simplifyOperatorPromise;for(const e of a){const t=e.geometry;if(t?.type==="polygon"){const i=o.execute(t);if(i?.type==="polygon"){const s=new B(e.type,i);this.modifications.modifications.push(s)}else I.getLogger(this).warn("Failed to simplify modification polygon")}else I.getLogger(this).warn("Invalid modification added to elevation layer: "+(t?`non polygon geometry ${t.type}`:"no geometry"))}}};x([R()],w.prototype,"layer",void 0),x([R()],w.prototype,"tileInfo",null),x([R()],w.prototype,"modifications",void 0),w=x([U("esri.views.3d.layers.ElevationLayerView3D")],w);const te=w;export{te as default};
