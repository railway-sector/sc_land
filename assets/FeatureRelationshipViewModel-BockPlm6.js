const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/uniqueValues-g0t_yrlE.js","assets/index-CVzGOCNQ.js","assets/index-ni9qn0ie.css","assets/utils-OgGOC5tu.js","assets/utils-Xa_kA8Bw.js","assets/ClassBreaksDefinition-CdcUv9v4.js","assets/executeQueryJSON-DiO9m10y.js","assets/query-OZm1hF48.js","assets/pbfQueryUtils-DXVC6Arf.js","assets/pbf-DD3xtqYr.js","assets/PivotQuery-zEVPbLwa.js","assets/statsWorker-FyzzsHkp.js","assets/AttributeBinsQuery-B6Y0CTaM.js","assets/queryUtils-8j48OmpW.js","assets/FixedIntervalBinParameters-DrjBJ2jp.js"])))=>i.map(i=>d[i]);
import{dg as D,cR as B,a2 as x,aY as v,aZ as I,k as L,by as H,Q as M,aK as j,_ as N,dh as $,Z as l,$ as a,aj as k,a0 as W}from"./index-CVzGOCNQ.js";import{getFixedFieldName as S,isRelatableFeatureSupportedLayer as G,findRelatedLayer as Y}from"./featureUtils-CRixeKPJ.js";import{R as Z}from"./featureFormUtils-DZCGk7i8.js";const O=100;let r=class extends D(B(x)){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.activeCategory=null,this.allCategories=null,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await v(this._query()),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await v(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const t=new AbortController;this._queryPageAbortController=t,await v(this._queryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)},this._queryDebounced=I(this._queryController,O),this._queryFeatureCountDebounced=I(this._queryFeatureCountController,O),this._queryPageDebounced=I(this._queryPageController,O),this._query=async()=>{const{_queryAbortController:t,relatedFeatures:o}=this;this.featureCount&&(this.relatedLayer?.type!=="subtype-group"||this.activeCategory)&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,o.destroyAll(),this.destroyed||o.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:t?.signal}))))},this.addHandles([L(()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount,this.activeCategory],()=>this._queryDebounced(),H),L(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),L(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery,this.activeCategory],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:o}=this,i=1,s=Math.ceil(o/t)||1;this._set("featurePage",Math.min(Math.max(e,i),s))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map(o=>{const i=o.clone();return i.field=S(o.field,t),i}):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&this.relationshipId!=null&&typeof this.objectId=="number"}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&this.relationshipId!=null&&this.objectId!=null&&e?.supportsCount&&e?.supportsPagination)}get allCategoriesCount(){return this.allCategories?.length??0}get categories(){const{allCategories:e}=this;return this.showAllEnabled?e:e?.slice(0,this.displayCount)??null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e??3,0),10))}get displayCount(){return this._get("displayCount")}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new M}get relatedLayer(){const{layer:e,map:t,relationship:o}=this;if(!e?.loaded||!t||!o)return null;const i=e.type==="subtype-sublayer"&&e.parent&&G(e.parent)?e.parent:e;return Y(t,i,o)??null}get relatedLayerKeyField(){const{relatedLayer:e,relationshipId:t}=this;return e?.loaded&&t!=null?e.relationships?.find(o=>o.id===t)?.keyField:null}get relatedLayerKeyFields(){const{relatedLayer:e}=this;return e?.loaded?e.relationships?.map(t=>t.keyField).filter(j)??[]:[]}get relationship(){const{relationshipId:e,layer:t}=this;return e!=null&&t?.loaded?t.relationships?.find(({id:o})=>o===e)??null:null}get relationshipKey(){const{relationshipKeyField:e}=this;return(e&&this.graphic?.attributes?.[e])??null}get relationshipKeyField(){return this.relationship?.keyField||null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new M}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:o,canQuery:i,_loaded:s,canLoad:n}=this;return t||n&&!s?"loading":e||o?"querying":i?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find(t=>t.getObjectId()===e)}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.destroyAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:t}=this;await e?.load(),await t?.load();const{_queryFeatureCountAbortController:o,activeCategory:i,canQuery:s,objectId:n,relatedLayerKeyField:y,relationshipId:u,relationshipKey:g,supportsCacheHint:b}=this;if(!s||!e||!t||n==null)return this._set("featureCount",0),void this._set("allCategories",null);if(t?.type==="subtype-group"&&!i){if(this._set("featureCount",0),this._destroyRelatedFeatureViewModels(),this.featurePage=1,this.relatedFeatures.destroyAll(),y&&g!=null){const{default:q}=await N(()=>import("./uniqueValues-g0t_yrlE.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14])),{uniqueValueInfos:A}=await q({layer:t,sqlWhere:`${y} = '${g}'`,field:t.subtypeField,signal:o?.signal}),P=A.map(({count:p,value:c})=>{const _=t.subtypes?.find(w=>w.code===c)?.name;return c!=null&&_?{count:p,value:c,name:_}:void 0}).filter(j);this._set("allCategories",P)}return}const{historicMoment:C,gdbVersion:F}=e,f=new $({cacheHint:b,gdbVersion:F,historicMoment:C,relationshipId:u,returnGeometry:!1,objectIds:[n],where:this._getRelationshipWhereClause(t)}),h=await e.queryRelatedFeaturesCount(f,{signal:o?.signal});this._set("allCategories",null),this._set("featureCount",h[n]||0)}_getRelationshipWhereClause(e){const{activeCategory:t}=this,o=e.createQuery(),i="subtypeField"in e?e.subtypeField:void 0,s=t&&i?`${i} = ${t.value}`:void 0,n=o.where;return n&&s?`(${n}) AND (${s})`:n??s}_sliceFeatures(e){const{showAllEnabled:t,displayCount:o}=this;return t?e:o?e.slice(0,o):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:o,_queryPageAbortController:i,featureCount:s}=this;!o||t<2||!s||this.relatedLayer?.type==="subtype-group"&&!this.activeCategory||e.addMany(await this._queryRelatedFeatures({signal:i?.signal}))}async _queryRelatedFeatures(e){const{displayCount:t,featureCount:o,featurePage:i,featuresPerPage:s,layer:n,orderByFieldsFixedCasing:y,relatedLayer:u,relatedLayerKeyFields:g,relationshipId:b,showAllEnabled:C,supportsCacheHint:F}=this,{canQuery:f,objectId:h}=this;if(!f||!n||!u||h==null)return[];const q=C?((i-1)*s+o)%o:0,A=C?s:t,P=u.objectIdField,p="subtypeField"in u?u.subtypeField:void 0,c=[...y.map(d=>d.field),...Z(u),...g,P,p].filter(z),_=y.map(d=>`${d.field} ${d.order}`),{historicMoment:w,gdbVersion:Q}=n,V=new $({orderByFields:_,start:q,num:A,outFields:c,cacheHint:F,historicMoment:w,gdbVersion:Q,relationshipId:b,returnGeometry:!1,objectIds:[h],where:this._getRelationshipWhereClause(u)}),K=await n.queryRelatedFeatures(V,{signal:e?.signal}),m=K[h]?.features||[];return u.type==="subtype-group"&&p?m.forEach(d=>{const E=d.attributes[p],R=u.findSublayerForSubtypeCode?.(E);d.sourceLayer=R,d.layer=R}):m.forEach(d=>{d.sourceLayer=u,d.layer=u}),m}};function z(e){return e!=null&&e!==""}l([a()],r.prototype,"_loaded",void 0),l([a()],r.prototype,"_queryAbortController",void 0),l([a()],r.prototype,"_queryPageAbortController",void 0),l([a()],r.prototype,"_queryFeatureCountAbortController",void 0),l([a({value:1})],r.prototype,"featurePage",null),l([a()],r.prototype,"featuresPerPage",void 0),l([a({readOnly:!0})],r.prototype,"orderByFieldsFixedCasing",null),l([a({readOnly:!0})],r.prototype,"supportsCacheHint",null),l([a({readOnly:!0})],r.prototype,"canLoad",null),l([a({readOnly:!0})],r.prototype,"canQuery",null),l([a()],r.prototype,"activeCategory",void 0),l([a({readOnly:!0})],r.prototype,"allCategories",void 0),l([a({readOnly:!0})],r.prototype,"allCategoriesCount",null),l([a({readOnly:!0})],r.prototype,"categories",null),l([a()],r.prototype,"description",void 0),l([a({value:3})],r.prototype,"displayCount",null),l([a({type:k})],r.prototype,"graphic",void 0),l([a({readOnly:!0})],r.prototype,"itemDescriptionFieldName",null),l([a()],r.prototype,"layer",void 0),l([a()],r.prototype,"map",void 0),l([a({readOnly:!0})],r.prototype,"objectId",null),l([a({readOnly:!0})],r.prototype,"objectIdField",null),l([a()],r.prototype,"orderByFields",void 0),l([a({readOnly:!0})],r.prototype,"relatedFeatures",null),l([a({readOnly:!0})],r.prototype,"relatedLayer",null),l([a({readOnly:!0})],r.prototype,"relatedLayerKeyField",null),l([a({readOnly:!0})],r.prototype,"relatedLayerKeyFields",null),l([a({readOnly:!0})],r.prototype,"relationship",null),l([a({readOnly:!0})],r.prototype,"relationshipKey",null),l([a({readOnly:!0})],r.prototype,"relationshipKeyField",null),l([a({readOnly:!0})],r.prototype,"featureCount",void 0),l([a({readOnly:!0})],r.prototype,"relatedFeatureViewModels",null),l([a()],r.prototype,"relationshipId",void 0),l([a()],r.prototype,"showAllEnabled",void 0),l([a()],r.prototype,"state",null),l([a()],r.prototype,"title",void 0),r=l([W("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],r);export{r as _};
