import{cQ as x,cR as Q,cS as M,cT as L,aQ as $,cU as J,cV as W,cW as q,cX as g,cY as H,cZ as z,c7 as B,c_ as Z,c$ as K,ag as k,aK as V,d0 as X,d1 as Y,d2 as ee,d3 as O,d4 as te,d5 as se,d6 as ae,c6 as v,bz as ie,d7 as G,d8 as y,d9 as D,Z as p,$ as h,b$ as I,a0 as re}from"./index-Bp3GeDhQ.js";import{m as P,b as ne,f as le,j as oe,y as de,I as ue}from"./applyEditsUtils-W-o5CTP2.js";import{checkEditingCapabilities as pe,normalizeEdits as ce,normalizeGeometries as ye}from"./editingSupport-DzHnEVys.js";function S(e,a){const s=a.id;return{id:s,name:a.name,url:`${e}/${s}`,type:a.type||"Table"}}function he(e){return{data:me(e),sync:ve(e),operations:fe(e.capabilities,e),query:be(e),editing:ge(e)}}function me(e){return{isDataVersioned:y(e,"hasVersionedData",!1),isDataBranchVersioned:y(e,"hasBranchVersionedData",!1)}}function fe(e,a){const s=e?e.toLowerCase().split(",").map(i=>i.trim()):[],t=s.includes("query"),n=s.includes("editing")&&!a.datesInUnknownTimezone;let l=n&&s.includes("create"),r=n&&s.includes("delete"),o=n&&s.includes("update");return n&&!(l||r||o)&&(l=r=o=!0),{supportsAdd:l,supportsDelete:r,supportsEditing:n,supportsChangeTracking:s.includes("changetracking"),supportsQuery:t,supportsQueryDataElements:y(a,"supportsQueryDataElements",!1),supportsQueryDomains:y(a,"supportsQueryDomains",!1),supportsQueryContingentValues:y(a,"supportsQueryContingentValues",!1),supportsSync:s.includes("sync"),supportsUpdate:o}}function be(e){return{maxRecordCountFactor:D(e,"maxRecordCountFactor",void 0),maxRecordCount:D(e,"maxRecordCount",void 0)}}function ge(e){const a=e?.advancedEditingCapabilities;return{supportsAsyncApplyEdits:y(a,"supportsAsyncApplyEdits",!1),supportsGlobalId:y(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:y(a,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:y(e,"supportsSharedTemplates",!1)||y(e,"hasSharedTemplates",!1),supportsSplit:y(a,"supportsSplit",!1)}}function ve(e){const a=e?.syncCapabilities,s=a?.supportedSyncDataOptions;return{supportsAsync:y(a,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~s),dimensions:!(2&~s),contingentValues:!(4&~s),attributeRules:!(8&~s),utilityNetworkSystem:!(16&~s),annotationFullModel:!(32&~s),include3DObjects:!(64&~s),utilityNetworkMissingLayers:!(128&~s),preserveTrueCurves:!(256&~s)}}}let d=class extends x(Q(M)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null,this._layerTableIndex=new Map}read(e,a){this.sourceJSON=e,super.read(e,a)}get utilityNetworkUrl(){if(this.sourceJSON){for(const e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`}return null}get versionManagementServiceUrl(){return this.sourceJSON?.hasBranchVersionedData&&!L(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,a){return(a.layers||[]).map(s=>{const{type:t,geometryType:n}=s;return{...S(this.url,s),type:t||"Feature Layer",geometryType:n}})}readTableInfos(e,a){return(a.tables||[]).map(s=>S(this.url,s))}readCapabilities(e,a){return he(a)}get effectiveCapabilities(){const e=this.capabilities;if(!e)return null;const a=$(e),{operations:s}=a;return this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=!0,a):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=!0),a)}get loaded(){return super.loaded}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then(()=>this._setUserPrivileges(e))),Promise.resolve(this)}async fetchAllLayersAndTables(e){return await this.load(e),this._fetchLayersAndTablesPromise||=this._fetchLayersAndTables(this.url),J(e),this._fetchLayersAndTablesPromise}async applyEdits(e,a){let s=null;try{const{results:t,edits:n,editedFeatures:l}=await this._internalApplyEdits(e,a),r=i=>i.filter(c=>!c.error).map($);let o=0;return t.map(i=>{s=W(this.url,i.id,a?.gdbVersion,!0);const c={edits:n[o],addedFeatures:r(i.addFeatureResults),updatedFeatures:r(i.updateFeatureResults),deletedFeatures:r(i.deleteFeatureResults),addedAttachments:r(i.addAttachmentResults),updatedAttachments:r(i.updateAttachmentResults),deletedAttachments:r(i.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:i.editMoment?new Date(i.editMoment):null};o+=1,l.length>0&&(c.editedFeatures=l),s.resolve(c),s=null}),t}catch(t){throw s&&s.reject(t),t}}async _setUserPrivileges(e){if(q.userPrivilegesApplied)try{const{features:{fullEdit:a},content:{updateItem:s}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",a),this._set("userHasUpdateItemPrivileges",s)}catch(a){g(a)}}async _fetchUserPrivileges(e,a){if(!e)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let l,r,o;try{l=await H(this.url,a)}catch(i){g(i)}try{const i=a!=null?a.signal:null;r=await z?.getCredential(`${l}/sharing`,{prompt:!1,signal:i})}catch(i){g(i)}if(!r)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(o=new B({id:e,portal:{url:l}}),await o.load(a),o.portal.user)return Z(o)}catch(i){g(i)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}}async _internalApplyEdits(e,a){await K(this.url);const s=a?.globalIdUsed??!1,t=k.fromJSON(this.sourceJSON.spatialReference),{edits:n,options:l}=await this._processApplyEditsParams(e,a),r=await Promise.all(n.map(async u=>{const _=u.addFeatures?.map(F=>P({spatialReference:t},F,null))??[],R=(await Promise.all(_)).filter(V),A=R.length>0?R:null,U=u.updateFeatures?.map(F=>P({spatialReference:t},F,null))??[],w=(await Promise.all(U)).filter(V),T=w.length>0?w:null,j=ne(u.identifierFields,u.deleteFeatures,s),N=j.length>0?j:null;X(A,T,t);const f=await le(u.identifierFields,u);let C=null;f&&(C={adds:f.adds.length>0?f.adds:void 0,updates:f.updates.length>0?f.updates:void 0,deletes:f.deletes.length>0?f.deletes:void 0});const b={};return u.deleteAssociations&&(b.deleteAssociations=u.deleteAssociations),u.combineGroupedObjects&&(b.combineGroupedObjects=u.combineGroupedObjects),u.divideGroupedObjects&&(b.divideGroupedObjects=u.divideGroupedObjects),{id:u.id,adds:A,updates:T,deletes:N,attachments:C,...b}})),o={gdbVersion:l?.gdbVersion,rollbackOnFailure:!0,useGlobalIds:s,returnEditMoment:!0,honorSequenceOfEdits:l?.honorSequenceOfEdits,trueCurveClient:l?.trueCurveClient,usePreviousEditMoment:l?.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await Y(this.url,a?.gdbVersion,!0);const i=ee(this.url,a?.gdbVersion||null);o.edits=JSON.stringify(r);const c=O(this.url),m=te(c.query,{query:se({...o,f:"json"}),method:"post"});let E;i&&(m.authMode="immediate",m.query.sessionId=ae);try{E=await v(this.url+"/applyEdits",m)}catch(u){if(!oe(u))throw u;m.authMode="immediate",E=await v(this.url+"/applyEdits",m)}return{...Se(E),edits:n}}async _processApplyEditsParams(e,a){const s={...a,usingFeatureServiceEndpoint:!0,usingTelecomOperations:e.some(t=>t.deleteAssociations||t.combineGroupedObjects||t.divideGroupedObjects)};return{edits:await Promise.all(e.map(async t=>{const n=this.effectiveCapabilities,l=t&&(t.addFeatures||t.updateFeatures||t.deleteFeatures),r=t&&(t.addAttachments||t.updateAttachments||t.deleteAttachments);if(pe(t,n,s,!!l,!!r,"feature-service"),!n.data.isDataVersioned&&s?.gdbVersion)throw new ie("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");const o=ce(t,n,"feature-service"),i={};if(t.deleteAssociations&&(i.deleteAssociations=t.deleteAssociations),t.combineGroupedObjects&&(i.combineGroupedObjects=t.combineGroupedObjects),t.divideGroupedObjects&&(i.divideGroupedObjects=t.divideGroupedObjects),!t.identifierFields){await this.fetchAllLayersAndTables();const m=this._layerTableIndex.get(t.id);m&&(t.identifierFields={globalIdField:m.globalIdField,objectIdField:m.objectIdField})}const c=await ye(o);return{id:t.id,...c,...i,identifierFields:t.identifierFields}})),options:s}}async _fetchService(e,a){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:O(e)});const s=await v(e,{responseType:"json",query:{f:"json"},...a});this.read(s.data,{url:O(e)})}async _fetchLayersAndTables(e){const a=`${e}/layers`,s=await v(a,{responseType:"json",query:{f:"json"}});return{layers:s.data.layers.map(t=>{const{type:n,geometryType:l}=t,r=S(this.url,t),o=G(t,r.url);return this._layerTableIndex.set(t.id,t),{...r,type:n||"Feature Layer",geometryType:l,capabilities:o}}),tables:s.data.tables.map(t=>{const n=S(this.url,t),l=G(t,n.url);return this._layerTableIndex.set(t.id,t),{...n,capabilities:l}})}}};function Se(e){const a=e.data,s=[];return{results:a.map(t=>{const n={addResults:t.addResults??[],updateResults:t.updateResults??[],deleteResults:t.deleteResults??[],attachments:t.attachments,editMoment:t.editMoment},l=de(n),r=t.editedFeatures,o=r?.spatialReference?new k({wkid:r?.spatialReference.wkid,wkt:r?.spatialReference.wkt,latestWkid:r?.spatialReference.latestWkid,latestVcsWkid:r?.spatialReference.latestVcsWkid,vcsWkid:r?.spatialReference.vcsWkid}):null,i=r?ue(r,o):null;i&&s.push({layerId:t.id,editedFeatures:i});const c={};return t.divideGroupedObjectResults&&(c.divideGroupedObjectResults=t.divideGroupedObjectResults),t.combineGroupedObjectResults&&(c.combineGroupedObjectResults=t.combineGroupedObjectResults),{id:t.id,editedFeatures:i,...l,...c}}),editedFeatures:s}}p([h()],d.prototype,"url",void 0),p([h()],d.prototype,"sourceJSON",void 0),p([h()],d.prototype,"userHasFullEditingPrivileges",void 0),p([h()],d.prototype,"userHasUpdateItemPrivileges",void 0),p([h({readOnly:!0})],d.prototype,"utilityNetworkUrl",null),p([h({readOnly:!0})],d.prototype,"versionManagementServiceUrl",null),p([h()],d.prototype,"userTypeExtensions",void 0),p([h({json:{read:{source:["layers"]}}})],d.prototype,"layerInfos",void 0),p([I("layerInfos",["layers"])],d.prototype,"readLayerInfos",null),p([h({json:{read:{source:["tables"]}}})],d.prototype,"tableInfos",void 0),p([I("tableInfos",["tables"])],d.prototype,"readTableInfos",null),p([h({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],d.prototype,"capabilities",void 0),p([I("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],d.prototype,"readCapabilities",null),p([h({readOnly:!0})],d.prototype,"effectiveCapabilities",null),d=p([re("esri.rest.featureService.FeatureService")],d);const Ie=d;export{Ie as Z};
