import{bE as x,bG as M,dn as Q,dp as L,aQ as $,dq as J,dr as q,d3 as H,ds as v,dt as W,du as B,cw as z,dv as Z,dw as K,ab as k,aR as G,dx as X,dy as Y,dz as ee,dA as O,dB as te,dC as se,dD as ae,cv as g,a5 as ie,dE as D,_ as p,e as h,cm as w,g as re,dF as y,dG as V}from"./index-CgzAF5Ey.js";import{m as P,b as ne,f as de,j as le,y as oe,I as ue}from"./applyEditsUtils-Dnse8Gdk.js";import{checkEditingCapabilities as pe,normalizeEdits as ce,normalizeGeometries as ye}from"./editingSupport-DJtUgSza.js";function E(e,a){const s=a.id;return{id:s,name:a.name,url:`${e}/${s}`,type:a.type||"Table"}}function he(e){return{data:me(e),sync:ge(e),operations:fe(e.capabilities,e),query:be(e),editing:ve(e)}}function me(e){return{isDataVersioned:y(e,"hasVersionedData",!1),isDataBranchVersioned:y(e,"hasBranchVersionedData",!1)}}function fe(e,a){const s=e?e.toLowerCase().split(",").map(i=>i.trim()):[],t=s.includes("query"),n=s.includes("editing")&&!a.datesInUnknownTimezone;let d=n&&s.includes("create"),r=n&&s.includes("delete"),l=n&&s.includes("update");return n&&!(d||r||l)&&(d=r=l=!0),{supportsAdd:d,supportsDelete:r,supportsEditing:n,supportsChangeTracking:s.includes("changetracking"),supportsQuery:t,supportsQueryDataElements:y(a,"supportsQueryDataElements",!1),supportsQueryDomains:y(a,"supportsQueryDomains",!1),supportsQueryContingentValues:y(a,"supportsQueryContingentValues",!1),supportsSync:s.includes("sync"),supportsUpdate:l}}function be(e){return{maxRecordCountFactor:V(e,"maxRecordCountFactor",void 0),maxRecordCount:V(e,"maxRecordCount",void 0)}}function ve(e){const a=e?.advancedEditingCapabilities;return{supportsAsyncApplyEdits:y(a,"supportsAsyncApplyEdits",!1),supportsGlobalId:y(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:y(a,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:y(e,"supportsSharedTemplates",!1)||y(e,"hasSharedTemplates",!1),supportsSplit:y(a,"supportsSplit",!1)}}function ge(e){const a=e?.syncCapabilities,s=a?.supportedSyncDataOptions;return{supportsAsync:y(a,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~s),dimensions:!(2&~s),contingentValues:!(4&~s),attributeRules:!(8&~s),utilityNetworkSystem:!(16&~s),annotationFullModel:!(32&~s),include3DObjects:!(64&~s),utilityNetworkMissingLayers:!(128&~s),preserveTrueCurves:!(256&~s)}}}let o=class extends x(M(Q)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null,this._layerTableIndex=new Map}read(e,a){this.sourceJSON=e,super.read(e,a)}get utilityNetworkUrl(){if(this.sourceJSON){for(const e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`}return null}get versionManagementServiceUrl(){return this.sourceJSON?.hasBranchVersionedData&&!L(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,a){return(a.layers||[]).map(s=>{const{type:t,geometryType:n}=s;return{...E(this.url,s),type:t||"Feature Layer",geometryType:n}})}readTableInfos(e,a){return(a.tables||[]).map(s=>E(this.url,s))}readCapabilities(e,a){return he(a)}get effectiveCapabilities(){const e=this.capabilities;if(!e)return null;const a=$(e),{operations:s}=a;return this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=!0,a):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=!0),a)}get loaded(){return super.loaded}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then(()=>this._setUserPrivileges(e))),Promise.resolve(this)}async fetchAllLayersAndTables(e){return await this.load(e),this._fetchLayersAndTablesPromise||=this._fetchLayersAndTables(this.url),J(e),this._fetchLayersAndTablesPromise}async applyEdits(e,a){let s=null;try{const{results:t,edits:n,editedFeatures:d}=await this._internalApplyEdits(e,a),r=i=>i.filter(c=>!c.error).map($);let l=0;return t.map(i=>{s=q(this.url,i.id,a?.gdbVersion,!0);const c={edits:n[l],addedFeatures:r(i.addFeatureResults),updatedFeatures:r(i.updateFeatureResults),deletedFeatures:r(i.deleteFeatureResults),addedAttachments:r(i.addAttachmentResults),updatedAttachments:r(i.updateAttachmentResults),deletedAttachments:r(i.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:i.editMoment?new Date(i.editMoment):null};l+=1,d.length>0&&(c.editedFeatures=d),s.resolve(c),s=null}),t}catch(t){throw s&&s.reject(t),t}}async _setUserPrivileges(e){if(H.userPrivilegesApplied)try{const{features:{fullEdit:a},content:{updateItem:s}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",a),this._set("userHasUpdateItemPrivileges",s)}catch(a){v(a)}}async _fetchUserPrivileges(e,a){if(!e)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let d,r,l;try{d=await W(this.url,a)}catch(i){v(i)}try{const i=a!=null?a.signal:null;r=await B?.getCredential(`${d}/sharing`,{prompt:!1,signal:i})}catch(i){v(i)}if(!r)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(l=new z({id:e,portal:{url:d}}),await l.load(a),l.portal.user)return Z(l)}catch(i){v(i)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}}async _internalApplyEdits(e,a){await K(this.url);const s=a?.globalIdUsed??!1,t=k.fromJSON(this.sourceJSON.spatialReference),{edits:n,options:d}=await this._processApplyEditsParams(e,a),r=await Promise.all(n.map(async u=>{const _=u.addFeatures?.map(S=>P({spatialReference:t},S,null))??[],A=(await Promise.all(_)).filter(G),I=A.length>0?A:null,N=u.updateFeatures?.map(S=>P({spatialReference:t},S,null))??[],R=(await Promise.all(N)).filter(G),C=R.length>0?R:null,j=ne(u.identifierFields,u.deleteFeatures,s),U=j.length>0?j:null;X(I,C,t);const f=await de(u.identifierFields,u);let T=null;f&&(T={adds:f.adds.length>0?f.adds:void 0,updates:f.updates.length>0?f.updates:void 0,deletes:f.deletes.length>0?f.deletes:void 0});const b={};return u.deleteAssociations&&(b.deleteAssociations=u.deleteAssociations),u.combineGroupedObjects&&(b.combineGroupedObjects=u.combineGroupedObjects),u.divideGroupedObjects&&(b.divideGroupedObjects=u.divideGroupedObjects),{id:u.id,adds:I,updates:C,deletes:U,attachments:T,...b}})),l={gdbVersion:d?.gdbVersion,rollbackOnFailure:!0,useGlobalIds:s,returnEditMoment:!0,honorSequenceOfEdits:d?.honorSequenceOfEdits,trueCurveClient:d?.trueCurveClient,usePreviousEditMoment:d?.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await Y(this.url,a?.gdbVersion,!0);const i=ee(this.url,a?.gdbVersion||null);l.edits=JSON.stringify(r);const c=O(this.url),m=te(c.query,{query:se({...l,f:"json"}),method:"post"});let F;i&&(m.authMode="immediate",m.query.sessionId=ae);try{F=await g(this.url+"/applyEdits",m)}catch(u){if(!le(u))throw u;m.authMode="immediate",F=await g(this.url+"/applyEdits",m)}return{...Ee(F),edits:n}}async _processApplyEditsParams(e,a){const s={...a,usingFeatureServiceEndpoint:!0,usingTelecomOperations:e.some(t=>t.deleteAssociations||t.combineGroupedObjects||t.divideGroupedObjects)};return{edits:await Promise.all(e.map(async t=>{const n=this.effectiveCapabilities,d=t&&(t.addFeatures||t.updateFeatures||t.deleteFeatures),r=t&&(t.addAttachments||t.updateAttachments||t.deleteAttachments);if(pe(t,n,s,!!d,!!r,"feature-service"),!n.data.isDataVersioned&&s?.gdbVersion)throw new ie("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");const l=ce(t,n,"feature-service"),i={};if(t.deleteAssociations&&(i.deleteAssociations=t.deleteAssociations),t.combineGroupedObjects&&(i.combineGroupedObjects=t.combineGroupedObjects),t.divideGroupedObjects&&(i.divideGroupedObjects=t.divideGroupedObjects),!t.identifierFields){await this.fetchAllLayersAndTables();const m=this._layerTableIndex.get(t.id);m&&(t.identifierFields={globalIdField:m.globalIdField,objectIdField:m.objectIdField})}const c=await ye(l);return{id:t.id,...c,...i,identifierFields:t.identifierFields}})),options:s}}async _fetchService(e,a){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:O(e)});const s=await g(e,{responseType:"json",query:{f:"json"},...a});this.read(s.data,{url:O(e)})}async _fetchLayersAndTables(e){const a=`${e}/layers`,s=await g(a,{responseType:"json",query:{f:"json"}});return{layers:s.data.layers.map(t=>{const{type:n,geometryType:d}=t,r=E(this.url,t),l=D(t,r.url);return this._layerTableIndex.set(t.id,t),{...r,type:n||"Feature Layer",geometryType:d,capabilities:l}}),tables:s.data.tables.map(t=>{const n=E(this.url,t),d=D(t,n.url);return this._layerTableIndex.set(t.id,t),{...n,capabilities:d}})}}};function Ee(e){const a=e.data,s=[];return{results:a.map(t=>{const n={addResults:t.addResults??[],updateResults:t.updateResults??[],deleteResults:t.deleteResults??[],attachments:t.attachments,editMoment:t.editMoment},d=oe(n),r=t.editedFeatures,l=r?.spatialReference?new k({wkid:r?.spatialReference.wkid,wkt:r?.spatialReference.wkt,latestWkid:r?.spatialReference.latestWkid,latestVcsWkid:r?.spatialReference.latestVcsWkid,vcsWkid:r?.spatialReference.vcsWkid}):null,i=r?ue(r,l):null;i&&s.push({layerId:t.id,editedFeatures:i});const c={};return t.divideGroupedObjectResults&&(c.divideGroupedObjectResults=t.divideGroupedObjectResults),t.combineGroupedObjectResults&&(c.combineGroupedObjectResults=t.combineGroupedObjectResults),{id:t.id,editedFeatures:i,...d,...c}}),editedFeatures:s}}p([h()],o.prototype,"url",void 0),p([h()],o.prototype,"sourceJSON",void 0),p([h()],o.prototype,"userHasFullEditingPrivileges",void 0),p([h()],o.prototype,"userHasUpdateItemPrivileges",void 0),p([h({readOnly:!0})],o.prototype,"utilityNetworkUrl",null),p([h({readOnly:!0})],o.prototype,"versionManagementServiceUrl",null),p([h()],o.prototype,"userTypeExtensions",void 0),p([h({json:{read:{source:["layers"]}}})],o.prototype,"layerInfos",void 0),p([w("layerInfos",["layers"])],o.prototype,"readLayerInfos",null),p([h({json:{read:{source:["tables"]}}})],o.prototype,"tableInfos",void 0),p([w("tableInfos",["tables"])],o.prototype,"readTableInfos",null),p([h({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],o.prototype,"capabilities",void 0),p([w("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],o.prototype,"readCapabilities",null),p([h({readOnly:!0})],o.prototype,"effectiveCapabilities",null),o=p([re("esri.rest.featureService.FeatureService")],o);const we=o;export{we as Z};
