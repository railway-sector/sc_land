import{bF as O,bG as S,Z as E,b2 as f,b3 as I,f as v,bJ as k,db as q,O as m,f6 as j,eX as L,dL as $,f7 as Q,pe as M,f8 as B,fa as D,_ as r,e as a,ap as P,g as U}from"./index-CgzAF5Ey.js";import{s as G}from"./NetworkElement-DfHgqL1f.js";import{findUtilityNetwork as V}from"./featureUtils-DbghMAA3.js";import{t as H}from"./getFeatureTitle-Mrr3SXNI.js";const T={assetGroup:"assetgroup",assetType:"assettype"},N=100;let s=class extends O(S(E)){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._queryController=async e=>{this._cancelQuery();const o=new AbortController;this._queryAbortController=o,await f(this._query(e)),this._queryAbortController===o&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await f(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=I(this._queryController,N),this._queryFeatureCountDebounced=I(this._queryFeatureCountController,N)}initialize(){this.addHandles([v(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>{this.refresh()},k),v(()=>this.activeAssociationType,t=>{this._queryDebounced(t)},k)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&typeof this.globalId=="string"}get canQuery(){const t=this.layer?.capabilities?.query;return!!this.associationTypes&&typeof this.globalId=="string"&&!!t?.supportsPagination}set displayCount(t){this._set("displayCount",Math.max(t??3,0))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:t}=this;return t?.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(t){t&&!this.associationTypes.includes(t)||this._set("activeAssociationType",t)}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:o,canQuery:i,_loaded:n,canLoad:l,source:y}=this;return e||l&&!n?"loading":t||o?"querying":!i||y==="popup"&&this.featureCount===0?"disabled":"ready"}get utilityNetwork(){const{layer:t,map:e}=this;if(!t?.loaded||!e)return null;const o=q(t)?t.parent:t;return V(e,o)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new m}get structureAssociations(){return this._get("structureAssociations")||new m}get contentAssociations(){return this._get("contentAssociations")||new m}get containerAssociations(){return this._get("containerAssociations")||new m}get connectivityAssociations(){return this._get("connectivityAssociations")||new m}get associationFeatures(){return this._get("associationFeatures")||new j}get associationViewModels(){return this._get("associationViewModels")||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(t){switch(t){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(t=>t.destroyAll())}async _loadUtiltyNetworks(){const t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map(async o=>{await o.load()})??[]);const e=this.utilityNetwork;if(e){const o=i=>{if("layerId"in i&&e.isUtilityLayer(i)){const n=i.layerId!=null?e.getSourceIdByLayerId(i.layerId):null;n!=null&&this.networkSourceIdsInUse.add(n)}};this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(o),t.allTables.forEach(o)}}async _findLayersBySourceId(t){const{utilityNetwork:e,map:o}=this,i=u=>{const w=u;return u.url&&w.layerId===n?u.url.replace(/\/\d+$/,"")===e?.featureServiceUrl:!1};await e?.load();const n=e.getLayerIdBySourceId(t),l=o.allLayers.filter(i),y=o.allTables.filter(i),h=l.concat(y).toArray();return await Promise.allSettled(h.map(u=>u.load())),h}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(t=>t.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}async _queryLayer(t,e,o,i,n){const l=this._getFeatureQueryWhereClause(t,e,o,i),y=new L({where:l,outFields:["*"],cacheHint:this.supportsCacheHint}),h=$.fromJSON(await Q(t,y,n));return h.features.forEach(u=>{u.layer=u.sourceLayer=M(t)?t.findSublayerForFeature(u):t}),h.features}async _createAssociationFeatureObjects(t,e,o,i,n,l){if(t.length===0)return[];const y=new Map;for(const[u,w]of e){const g=await this._findLayersBySourceId(u);for(const d of g)(await this._queryLayer(d,w,i,n,l)).forEach(b=>{if(this.source==="popup"?b.sourceLayer&&b.getEffectivePopupTemplate():b.sourceLayer){const c=y.get(b.attributes[d.globalIdField])??[];c.push(b),y.set(b.attributes[d.globalIdField],c)}})}const h=[];return await Promise.all(t.toArray().map(async u=>{const{fromNetworkElement:w,toNetworkElement:g}=u,d=w.globalId===o?g:w,b=y.get(d.globalId)??[];await Promise.all(b.map(async c=>{const _=this.utilityNetwork?.getTerminalById(d?.terminalId)?.name,p=c.sourceLayer&&"getFeatureTitle"in c.sourceLayer&&await c.sourceLayer.getFeatureTitle(c)||H(c);h.push({title:p,feature:c,association:u,terminalName:_})}))})),h}_parseFeatureObjects(t,e){const o=new Map;t.forEach(i=>{const n=i?.feature,l=n.sourceLayer;B(o,l,()=>new m).add(i)});for(const[i,n]of o)this._sortFeatureObjectsByTitle(n),e.set(i,n)}_sortFeatureObjectsByTitle(t){t.sort(this._compareByFeatureTitle)}_compareByFeatureTitle(t,e){return t.title.localeCompare(e.title,void 0,{numeric:!0})}async _queryAssociations(t){const{layer:e,globalId:o,associationTypes:i,utilityNetwork:n,canQuery:l}=this;if(await Promise.allSettled([e?.load(),n?.load()]),this._clearAssociations(),!(l&&e&&i&&n&&o))return;const y=q(e)?e.parent:e,h=new G({globalId:o,networkSourceId:n.getSourceIdByLayerId(y.layerId)}),u=new Set;i.forEach(c=>{switch(c.type){case"attachment":case"structure":u.add("attachment");break;case"container":case"content":u.add("containment");break;case"connectivity":u.add("connectivity"),u.add("junction-junction-connectivity"),u.add("junction-edge-from-connectivity"),u.add("junction-edge-midspan-connectivity"),u.add("junction-edge-to-connectivity")}});const w=await n?.queryAssociations({elements:[h],types:Array.from(u)},{signal:t?.signal}),g=new Map,d=new Map;i.forEach(c=>{d.set(c.type,c),g.set(c.type,[])}),w.forEach(c=>{const{toNetworkElement:_,fromNetworkElement:p}=c;switch(c.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if(p?.globalId===o){if(this._shouldDiscardNetworkElement(_,"connectivity",d))break;g.get("connectivity")?.push(_.globalId)}else{if(this._shouldDiscardNetworkElement(p,"connectivity",d))break;g.get("connectivity")?.push(p.globalId)}this.connectivityAssociations.add(c);break;case"containment":if(p?.globalId===o){if(this._shouldDiscardNetworkElement(_,"content",d))break;g.get("content")?.push(_.globalId),this.contentAssociations.add(c)}else{if(this._shouldDiscardNetworkElement(p,"container",d))break;g.get("container")?.push(p.globalId),this.containerAssociations.add(c)}break;case"attachment":if(p?.globalId===o){if(this._shouldDiscardNetworkElement(_,"attachment",d))break;g.get("attachment")?.push(_.globalId),this.attachmentsAssociations.add(c)}else{if(this._shouldDiscardNetworkElement(p,"structure",d))break;g.get("structure")?.push(p.globalId),this.structureAssociations.add(c)}}});const b=i.map(async c=>{const{associatedNetworkSourceId:_,associatedAssetGroup:p,associatedAssetType:F}=c,C=g.get(c.type),A=p!=null?await this._countAssociatedFeatures(_,C,p,F,t):C.length;switch(c.type){case"attachment":this._set("attachmentsFeatureCount",A);break;case"structure":this._set("structureFeatureCount",A);break;case"content":this._set("contentFeatureCount",A);break;case"container":this._set("containerFeatureCount",A);break;case"connectivity":this._set("connectivityFeatureCount",A)}});await Promise.allSettled(b)}async _countAssociatedFeatureCount(t,e,o,i,n){const l=this._getFeatureQueryWhereClause(t,e,o,i);return t.queryFeatureCount({where:l,outFields:["*"],returnGeometry:!1},{signal:n?.signal})}async _countAssociatedFeatures(t,e,o,i,n){if(e.length===0)return 0;const l=(await this._findLayersBySourceId(t)).map(async y=>this._countAssociatedFeatureCount(y,e,o,i,n));return(await Promise.all(l)).reduce((y,h)=>y+h,0)}async _queryAssociatedFeatures(t,e){const{layer:o,globalId:i,associationTypes:n,utilityNetwork:l,canQuery:y,associationFeatures:h}=this;if(await Promise.allSettled([o?.load(),l?.load()]),!(y&&o&&n&&l))return;const u=this._getAssociationsByType(t.type),{associatedAssetGroup:w,associatedAssetType:g}=t,d=new Map;u.forEach(c=>{const{fromNetworkElement:_,toNetworkElement:p}=c,{networkSourceId:F,elementGlobalId:C}=_.globalId===i?{networkSourceId:p.networkSourceId,elementGlobalId:p.globalId}:{networkSourceId:_.networkSourceId,elementGlobalId:_.globalId},A=d.get(F)||[];A.push(C),d.set(F,A)});const b=await this._createAssociationFeatureObjects(u,d,i,w,g,e);this._parseFeatureObjects(b,h)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(await this._queryAssociations(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(t){if(!t)return;await this._loadUtiltyNetworks();const{_queryAbortController:e}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.featureCount!==0&&(this.destroyed||await this._queryAssociatedFeatures(t,{signal:e?.signal}))}_shouldDiscardNetworkElement(t,e,o){if(!t)return!1;const{networkSourceIdsInUse:i}=this,{networkSourceId:n}=t,l=o.get(e)?.associatedNetworkSourceId,y=i.has(n);return l!=null&&l!==n||!y}_getFeatureQueryWhereClause(t,e,o,i){const n=t.globalIdField,l=t.fieldsIndex.get(T.assetGroup),y=t.fieldsIndex.get(T.assetType),h=o!=null,u=i!=null;return[n?D(n,e):null,h?`(${l?.name} = ${o})`:null,h&&u?`(${y?.name} = ${i})`:null].filter(Boolean).join(" AND ")}};r([a()],s.prototype,"_loaded",void 0),r([a()],s.prototype,"_queryAbortController",void 0),r([a()],s.prototype,"_queryPageAbortController",void 0),r([a()],s.prototype,"_queryFeatureCountAbortController",void 0),r([a({readOnly:!0})],s.prototype,"supportsCacheHint",null),r([a({readOnly:!0})],s.prototype,"canLoad",null),r([a({readOnly:!0})],s.prototype,"canQuery",null),r([a()],s.prototype,"networkSourceIdsInUse",void 0),r([a({constructOnly:!0})],s.prototype,"source",void 0),r([a()],s.prototype,"description",void 0),r([a({value:3})],s.prototype,"displayCount",null),r([a({type:P})],s.prototype,"graphic",void 0),r([a()],s.prototype,"layer",void 0),r([a()],s.prototype,"map",void 0),r([a({readOnly:!0})],s.prototype,"objectId",null),r([a({readOnly:!0})],s.prototype,"objectIdField",null),r([a({readOnly:!0})],s.prototype,"globalId",null),r([a({readOnly:!0})],s.prototype,"globalIdField",null),r([a()],s.prototype,"featureCount",void 0),r([a()],s.prototype,"associationTypes",void 0),r([a()],s.prototype,"activeAssociationType",null),r([a()],s.prototype,"showAllEnabled",void 0),r([a()],s.prototype,"state",null),r([a()],s.prototype,"title",void 0),r([a({readOnly:!0})],s.prototype,"utilityNetwork",null),r([a({readOnly:!0})],s.prototype,"attachmentsFeatureCount",void 0),r([a({readOnly:!0})],s.prototype,"structureFeatureCount",void 0),r([a({readOnly:!0})],s.prototype,"attachmentsAssociations",null),r([a({readOnly:!0})],s.prototype,"structureAssociations",null),r([a({readOnly:!0})],s.prototype,"contentFeatureCount",void 0),r([a({readOnly:!0})],s.prototype,"containerFeatureCount",void 0),r([a({readOnly:!0})],s.prototype,"contentAssociations",null),r([a({readOnly:!0})],s.prototype,"containerAssociations",null),r([a({readOnly:!0})],s.prototype,"connectivityFeatureCount",void 0),r([a({readOnly:!0})],s.prototype,"connectivityAssociations",null),r([a({readOnly:!0})],s.prototype,"associationFeatures",null),r([a({readOnly:!0})],s.prototype,"associationViewModels",null),s=r([U("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],s);export{s as v};
