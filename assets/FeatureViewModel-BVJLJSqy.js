import{a5 as l,x as p,y as L,a7 as S,j as R,bH as O,ao as X,bT as Fe,Ar as Ce,ei as fe,bI as ee,nM as Ee,pN as $,iR as ke,a9 as Y,cf as Ve,ec as G,lL as Re,As as me,dr as $e,aP as ye,ej as Le,bO as _e,K as ge,aZ as A,kb as H,d1 as U,nW as Ne,nX as be,nY as Pe,At as Oe,ai as ve,c_ as Se,eD as je,ez as te,bG as Ze,Y as Ue,al as qe}from"./index-aRi8Xk-b.js";import{l as D}from"./throttle-84JFhoJl.js";import{y as He}from"./AttachmentsViewModel-Kvln51-6.js";import{graphicCallback as z,getFieldInfoLabel as W,isSupportedContext as De,getFieldFormat as ze,isRelatedField as F,substituteFieldsInLinksAndAttributes as C,fixTokens as ie,substituteAttributes as se,getFixedFieldNames as Be,getFixedFieldName as re,isExpressionField as Ie,getFieldInfo as Je,preLayerQueryCallback as Ge,preRequestCallback as Qe,createFieldInfoMap as Ke,getAllFieldInfos as oe,getSourceLayer as Ye,querySourceLayer as We,queryUpdatedFeature as Xe,isRelatableFeatureSupportedLayer as et,isAssociatedFeatureSupportedLayer as tt,formatEditInfo as it,formatAttributes as Q}from"./featureUtils-BDJwkMic.js";import{s as K}from"./executeQueryJSON-BsEB0j6G.js";import{A as st,L as rt,y as ot}from"./arcadeFeatureUtils-KwUvoN0-.js";import{_ as at}from"./FeatureRelationshipViewModel-rUwGRIWV.js";import{v as nt}from"./FeatureUtilityNetworkAssociationsViewModel-BcJK5cyc.js";let P=class extends He{constructor(a){super(a),this.description=null,this.title=null}};l([p()],P.prototype,"description",void 0),l([p()],P.prototype,"title",void 0),P=l([L("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],P);let x=class extends S{constructor(a){super(a),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(R(()=>this.creator,e=>{this._destroyContent(),this._createContent(e)},O))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:a,graphic:e,destroyer:t}=this;a&&e&&(z({type:"content",value:t,event:{graphic:e}}),this._set("created",null))}async _createContent(a){const e=this.graphic;if(!e||!a)return;const t=z({type:"content",value:a,event:{graphic:e}});this._loadingPromise=t,this.notifyChange("state");const i=await t;t===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",i))}};l([p({readOnly:!0})],x.prototype,"created",void 0),l([p()],x.prototype,"creator",void 0),l([p()],x.prototype,"destroyer",void 0),l([p({type:X})],x.prototype,"graphic",void 0),l([p({readOnly:!0})],x.prototype,"state",null),x=l([L("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],x);let w=class extends S{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.isContentFieldInfos=!1,this.graphic=null,this.layer=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t,layer:i,isContentFieldInfos:s,graphic:r}=this,n=[];return t?.forEach(o=>{if(!(!o.hasOwnProperty("visible")||o.visible))return;const d=o.clone();d.label=W({fieldInfo:d,expressionInfos:e,layer:i,graphic:r,isContentFieldInfos:s}),Fe(i)&&De({fieldInfo:o,graphic:r})&&(d.fieldFormat=ze({fieldInfo:d,isContentFieldInfos:s,layer:i})),n.push(d)}),n}};l([p()],w.prototype,"attributes",void 0),l([p({type:[Ce]})],w.prototype,"expressionInfos",void 0),l([p()],w.prototype,"description",void 0),l([p({type:[fe]})],w.prototype,"fieldInfos",void 0),l([p({readOnly:!0})],w.prototype,"formattedFieldInfos",null),l([p()],w.prototype,"isContentFieldInfos",void 0),l([p()],w.prototype,"graphic",void 0),l([p()],w.prototype,"layer",void 0),l([p()],w.prototype,"title",void 0),w=l([L("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],w);const lt="esri.widgets.Feature.support.relatedFeatureUtils",ae=()=>Y.getLogger(lt),ne=new Map;function q(a){if(!F(a))return null;const[e,t]=a.split("/").slice(1);return{layerId:e,fieldName:t}}function pt(a,e){if(!e.relationships)return null;let t=null;const{relationships:i}=e;return i.some(s=>s.id===parseInt(a,10)&&(t=s,!0)),t}function dt({originRelationship:a,relationships:e,layerId:t}){return e.find(({relatedTableId:i,id:s})=>`${i}`===t&&s===a?.id)??null}function ct(a,e){const t=e.toLowerCase();for(const i in a)if(i.toLowerCase()===t)return a[i];return null}function ut(a,e){const t=pt(a,e);if(t)return{url:`${e.url}/${t.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:t,relatedFields:[],outStatistics:[]}}function ht(a,e){if(!e||!a)return;const{features:t,statsFeatures:i}=a,s=t?.value;e.relatedFeatures=s?s.features:[];const r=i?.value;e.relatedStatsFeatures=r?r.features:[]}function ft(a,e,t,i){const s=new $e;return s.outFields=["*"],s.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),s.objectIds=[a.attributes[t.objectIdField]],s.gdbVersion=t.gdbVersion??null,s.historicMoment=t.historicMoment??null,t.queryRelatedFeatures?.(s,i)??Promise.resolve({})}function mt(a,e,t){let i=0;const s=[];for(;i<e.length;)s.push(`${a} IN (${e.slice(i,t+i)})`),i+=t;return s.join(" OR ")}function yt(a){return a?me(a):void 0}function _t(a){return a?me(a,(e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON())):void 0}async function gt(a,e,t,i){const s=t.layerId.toString(),{layerInfo:r,relation:n,relatedFields:o,outStatistics:d,url:u,sourceSpatialReference:c}=e,h=yt(o),f=_t(d);if(!r||!n)return null;const _=dt({originRelationship:n,relationships:r.relationships,layerId:s});if(_?.relationshipTableId&&_.keyFieldInRelationshipTable){const b=(await ft(a,_,t,i))[a.attributes[t.objectIdField]];if(!b)return null;const T=b.features.map(v=>v.attributes[r.objectIdField]);if(f?.length&&r.supportsStatistics){const v=new G;v.where=mt(r.objectIdField,T,1e3),v.outFields=h,v.outStatistics=f,v.sourceSpatialReference=c;const M={features:Promise.resolve(b),statsFeatures:K(u,v)};return $(M)}}const g=_?.keyField;if(g){const b=Re(xt(r.fields,g)),T=ct(a.attributes,n.keyField),v=b?`${g}=${T}`:`${g}='${T}'`,M=t.historicMoment,k=t.gdbVersion,B=K(u,new G({where:v,outFields:h,sourceSpatialReference:c,historicMoment:M,gdbVersion:k}),i),N=f?.length&&r.supportsStatistics?K(u,new G({where:v,outFields:h,outStatistics:f,sourceSpatialReference:c}),i):null,j={features:B};return N&&(j.statsFeatures=N),$(j)}return null}function bt(a,e){return Ve(a,{query:{f:"json"},signal:e?.signal})}function vt({relatedInfos:a,layer:e},t){const i={};return a.forEach((s,r)=>{const{relation:n}=s;if(!n){const h=new ee("editor:relation-required","A relation is required on a layer to retrieve related records.");throw ae().error(h),h}const{relatedTableId:o}=n;if(typeof o!="number"){const h=new ee("editor:related-table","A related table ID is required on a layer to retrieve related records.");throw ae().error(h),h}const d=`${e.url}/${o}`,u=ne.get(d),c=u??bt(d);u||ne.set(d,c),i[r]=c}),Ee($(i),t)}function It({graphic:a,relatedInfos:e,layer:t},i){const s={};return e.forEach((r,n)=>{r.layerInfo&&(s[n]=gt(a,r,t,i))}),$(s)}function wt({relatedInfo:a,fieldName:e,fieldInfo:t}){if(a.relatedFields?.push(e),t.statisticType){const i=new ke({statisticType:t.statisticType,onStatisticField:e,outStatisticFieldName:e});a.outStatistics?.push(i)}}function xt(a,e){if(a!=null){e=e.toLowerCase();for(const t of a)if(t&&t.name.toLowerCase()===e)return t}return null}const le={chartAnimation:!0};let y=class extends S{constructor(a){super(a),this.abilities={...le},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(a){return{...le,...a}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(a){this._setContentElementMedia(a)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(a){const{formattedMediaInfoCount:e}=this,t=(a+e)%e;this.activeMediaInfoIndex=t}_pageContentElementMedia(a){const{activeMediaInfoIndex:e}=this,t=e+a;this._setContentElementMedia(t)}_formatMediaInfos(){const{mediaInfos:a,layer:e}=this,t=this.attributes??{},i=this.formattedAttributes??{},s=this.expressionAttributes??{},r=this.fieldInfoMap??new Map;return a?.map(n=>{const o=n?.clone();return o?(o.title=C({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:s,layer:e,text:o.title}),o.caption=C({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:s,layer:e,text:o.caption}),o.altText=C({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:s,layer:e,text:o.altText}),o.type==="image"?o.value?(this._setImageValue({value:o.value,formattedAttributes:i,layer:e}),o.value.sourceURL?o:void 0):void 0:o.type==="pie-chart"||o.type==="line-chart"||o.type==="column-chart"||o.type==="bar-chart"?o.value?(this._setChartValue({value:o.value,chartType:o.type,attributes:t,formattedAttributes:i,layer:e,expressionAttributes:s}),o):void 0:null):null}).filter(ye)??[]}_setImageValue(a){const e=this.fieldInfoMap??new Map,{value:t,formattedAttributes:i,layer:s}=a,{linkURL:r,sourceURL:n}=t;if(n){const o=ie(n,s);t.sourceURL=se({formattedAttributes:i,template:o,fieldInfoMap:e})}if(r){const o=ie(r,s);t.linkURL=se({formattedAttributes:i,template:o,fieldInfoMap:e})}}_setChartValue(a){const{value:e,attributes:t,formattedAttributes:i,chartType:s,layer:r,expressionAttributes:n}=a,{popupTemplate:o,relatedInfos:d}=this,{fields:u,normalizeField:c}=e,h=r;if(e.fields=Be(u,h),c&&(e.normalizeField=re(c,h)),!u.some(_=>!!(i[_]!=null||F(_)&&d?.size)))return;const f=o?.fieldInfos??[];u.forEach((_,g)=>{const b=e.colors?.[g];if(F(_))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:f,fieldName:_,formattedAttributes:i,chartType:s,value:e,color:b})]);const T=this._getChartOption({value:e,attributes:t,chartType:s,formattedAttributes:i,expressionAttributes:n,fieldName:_,fieldInfos:f,color:b});e.series.push(T)})}_getRelatedChartInfos(a){const{fieldInfos:e,fieldName:t,formattedAttributes:i,chartType:s,value:r,color:n}=a,o=[],d=q(t),u=d&&this.relatedInfos?.get(d.layerId.toString());if(!u)return o;const{relatedFeatures:c,relation:h}=u;if(!h||!c)return o;const{cardinality:f}=h;return c.forEach(_=>{const{attributes:g}=_;g&&Object.keys(g).forEach(b=>{b===d.fieldName&&o.push(this._getChartOption({value:r,attributes:g,formattedAttributes:i,fieldName:t,chartType:s,relatedFieldName:b,hasMultipleRelatedFeatures:c?.length>1,fieldInfos:e,color:n}))})}),f==="one-to-many"||f==="many-to-many"?o:[o[0]]}_getTooltip({label:a,value:e,chartType:t}){return t==="pie-chart"?`${a}`:`${a}: ${e}`}_getChartOption(a){const{value:e,attributes:t,formattedAttributes:i,expressionAttributes:s,fieldName:r,relatedFieldName:n,fieldInfos:o,chartType:d,hasMultipleRelatedFeatures:u,color:c}=a,{layer:h,graphic:f}=this,_=this.fieldInfoMap??new Map,{normalizeField:g,tooltipField:b}=e,T=g?F(g)?t[q(g).fieldName]:t[g]:null,v=Ie(r)&&s&&s[r]!==void 0?s[r]:n&&t[n]!==void 0?t[n]:t[r]!==void 0?t[r]:i[r],M=v===void 0?null:v&&T?v/T:v,k=new Le({fieldName:r,color:c,value:M!=null?typeof M=="number"?M:Number(M):void 0});if(F(r)){const Z=_.get(r.toLowerCase()),xe=b&&_.get(b.toLowerCase()),Ae=Z?.fieldName??r,J=u&&b?q(b).fieldName:xe?.fieldName??b,Te=u&&J?t[J]:i[J]??(Z&&W({fieldInfo:Z,graphic:f,layer:h}))??Z?.fieldName??n,Me=u&&n?t[n]:i[Ae];return k.tooltip=this._getTooltip({label:Te,value:Me,chartType:d}),k}const B=Je(o,r),N=re(r,h),j=b&&i[b]!==void 0?i[b]:W({fieldInfo:B||new fe({fieldName:N}),expressionInfos:this.popupTemplate?.expressionInfos,graphic:f,layer:h}),we=i[N];return k.tooltip=this._getTooltip({label:j,value:we,chartType:d}),k}};l([p()],y.prototype,"abilities",void 0),l([_e("abilities")],y.prototype,"castAbilities",null),l([p()],y.prototype,"activeMediaInfoIndex",void 0),l([p({readOnly:!0})],y.prototype,"activeMediaInfo",null),l([p()],y.prototype,"attributes",void 0),l([p()],y.prototype,"description",void 0),l([p()],y.prototype,"fieldInfoMap",void 0),l([p()],y.prototype,"formattedAttributes",void 0),l([p()],y.prototype,"expressionAttributes",void 0),l([p({readOnly:!0})],y.prototype,"formattedMediaInfos",null),l([p()],y.prototype,"graphic",void 0),l([p()],y.prototype,"layer",void 0),l([p({readOnly:!0})],y.prototype,"formattedMediaInfoCount",null),l([p()],y.prototype,"mediaInfos",void 0),l([p()],y.prototype,"popupTemplate",void 0),l([p()],y.prototype,"relatedInfos",void 0),l([p()],y.prototype,"title",void 0),y=l([L("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],y);const pe=1;let I=class extends S{constructor(a){super(a),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t=e==="fields"?new w:e==="media"?new y:e==="text"?new x:null;this._set("contentElementViewModel",t)},this._compileThrottled=D(this._startCompile,()=>this.notifyChange("state"),pe,this),this._evaluateThrottled=D(this._startEvaluate,()=>this.notifyChange("state"),pe,this),this.addHandles([R(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),O),R(()=>[this.contentElement],()=>this._createVM(),O),ge(()=>{if(!this._compileTask?.finished)return null;const e=this._compileTask.value,t=e?.dependencies;return[e,this.spatialReference,this.map,this.view,t?.has("view-scale")?this.view?.scale:null,t?.has("view-time-extent")?this.view?.timeExtent?.start:null,t?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([e])=>this._evaluateThrottled(e))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){this._compileTask=A(this._compileTask),this._evaluateTask=A(this._evaluateTask),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null)}get contentElement(){return this._evaluateTask?.value}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(a){this._override("spatialReference",a)}get state(){const{contentElement:a,contentElementViewModel:e}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!this._compileTask?.finished||!this._evaluateTask?.finished?"loading":a||e?"ready":"disabled"}get map(){return this.view?.map??null}set map(a){this._override("map",a)}_startCompile(){this._evaluateTask=A(this._evaluateTask),this._compileTask=A(this._compileTask),this._compileTask=H(async a=>{const{expressionInfo:e,graphic:t}=this,i=e?.expression;if(!i||!t)return null;const s=await st({expression:i,graphic:t});return U(a),s})}_startEvaluate(a){this._evaluateTask=A(this._evaluateTask),this._evaluateTask=H(async e=>{const{graphic:t}=this;if(!a||!t)return null;const{interceptor:i,spatialReference:s,map:r,location:n,view:o}=this,d=await a.evaluate({graphic:t,interceptor:i,location:n,map:r,options:{signal:e},spatialReference:s,view:o});U(e);const u=d;if(!u||u.declaredClass!=="esri.arcade.Dictionary")return null;const c=await u.castAsJsonAsync(e);U(e);const h=c?.type,f=h==="media"?Ne.fromJSON(c):h==="text"?be.fromJSON(c):h==="fields"?Pe.fromJSON(c):null;return f.type==="media"&&!f.mediaInfos||f.type==="fields"&&!f.fieldInfos||f.type==="text"&&!f.text?null:f})}};l([p()],I.prototype,"_compileTask",void 0),l([p()],I.prototype,"_evaluateTask",void 0),l([p({type:Oe})],I.prototype,"expressionInfo",void 0),l([p({type:X})],I.prototype,"graphic",void 0),l([p({readOnly:!0})],I.prototype,"contentElement",null),l([p({readOnly:!0})],I.prototype,"contentElementViewModel",void 0),l([p()],I.prototype,"interceptor",void 0),l([p({type:ve})],I.prototype,"location",void 0),l([p()],I.prototype,"spatialReference",null),l([p({readOnly:!0})],I.prototype,"state",null),l([p()],I.prototype,"map",null),l([p()],I.prototype,"view",void 0),I=l([L("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],I);class At{constructor(e,t){this.preLayerQueryCallback=e,this.preRequestCallback=t,this.preLayerQueryCallback||(this.preLayerQueryCallback=i=>{}),this.preRequestCallback||(this.preLayerQueryCallback=i=>{})}}var V;const de=1,ce="content-view-models",ue="relationship-view-models",Tt="association-view-models",he={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0};var E;let m=(E=class extends Se(S){constructor(e){super(e),this._error=null,this._graphicChangedTask=null,this._evaluateExpressionAttributesTask=null,this._associationVMAbortController=null,this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...he},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.graphic=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._graphicChangedThrottled=D(this._graphicChanged,()=>this.notifyChange("waitingForContent"),de,this),this._isAllowedContentType=t=>{const{abilities:i}=this;return t.type==="attachments"&&!!i.attachmentsContent||t.type==="custom"&&!!i.customContent||t.type==="fields"&&!!i.fieldsContent||t.type==="media"&&!!i.mediaContent||t.type==="text"&&!!i.textContent||t.type==="expression"&&!!i.expressionContent||t.type==="relationship"&&!!i.relationshipContent||t.type==="utility-network-associations"&&!!i.utilityNetworkAssociationsContent},this._evaluateExpressionAttributesThrottled=D(this._evaluateExpressionAttributes,()=>this.notifyChange("waitingForContent"),de,this),this.addHandles([R(()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone],()=>this._graphicChangedThrottled(),O),ge(()=>{if(!this._graphicChangedTask?.finished||this._graphicChangedTask.value==null)return null;const t=this._graphicChangedTask.value,i=t?.expressionInfos?.dependencies;return[t,i?.has("view-scale")?this.view?.scale:null,i?.has("view-time-extent")?this.view?.timeExtent?.start:null,i?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([t])=>this._evaluateExpressionAttributesThrottled(t))])}initialize(){this.addHandles([this._graphicChangedThrottled,this._evaluateExpressionAttributesThrottled])}destroy(){this._clear(),this._graphicChangedTask=A(this._graphicChangedTask),this._evaluateExpressionAttributesTask=A(this._evaluateExpressionAttributesTask),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return this.graphic!=null?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return Ke(oe(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Ye(this.graphic)}castAbilities(e){return{...he,...e}}get isFeatureFromTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get timeZone(){return this.view?.timeZone??je}set timeZone(e){this._overrideIfSome("timeZone",e)}get map(){return this.view?.map||null}set map(e){this._override("map",e)}get waitingForContent(){const{_graphicChangedThrottled:e,_evaluateExpressionAttributesThrottled:t,_graphicChangedTask:i,_evaluateExpressionAttributesTask:s,_associationVMAbortController:r}=this;return e.hasPendingUpdates()||t.hasPendingUpdates()||i!=null&&!i.finished||s!=null&&!s.finished||!!r}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof y&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof y&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof y&&t.previous()}async updateGeometry(){const{graphic:e,spatialReference:t,_sourceLayer:i}=this;await i?.load();const s=i?.objectIdField;if(!s||!e||!i)return;const r=e?.attributes?.[s];if(r==null)return;const n=[r];if(!e.geometry){const o=await We({layer:i,graphic:e,outFields:[],objectIds:n,returnGeometry:!0,spatialReference:t}),d=o?.geometry;d&&(e.geometry=d)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}_graphicChanged(){this._evaluateExpressionAttributesTask=A(this._evaluateExpressionAttributesTask),this._graphicChangedTask=A(this._graphicChangedTask),this._graphicChangedTask=H(async e=>{this._error=null,this._clear();const{graphic:t}=this;try{if(!t)return null;const{_sourceLayer:i,_effectivePopupTemplate:s}=this,r=this.spatialReference;await Xe({graphic:t,popupTemplate:s,layer:i,spatialReference:r},{signal:e});const[{value:n},{value:o}]=await $([this._getContent(),this._getTitle()]),[,{value:d}]=await $([this._checkForRelatedFeatures({signal:e}),rt(s?.expressionInfos,t)]);return{expressionInfos:d,content:n,title:o}}catch(i){throw te(i)||(this._error=i,Y.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:t,popupTemplate:this._effectivePopupTemplate})),i}})}_compileContentElement(e,t){return e.type==="attachments"?this._compileAttachments(e,t):e.type==="custom"?this._compileCustom(e,t):e.type==="fields"?this._compileFields(e,t):e.type==="media"?this._compileMedia(e,t):e.type==="text"?this._compileText(e,t):e.type==="expression"?this._compileExpression(e,t):e.type==="relationship"?this._compileRelationship(e,t):e.type==="utility-network-associations"?this._compileUtilityNetworkAssociation(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((t,i)=>this._compileContentElement(t,i)).filter(ye):typeof e=="string"?this._compileText(new be({text:e}),0).text:e}_destroyContentViewModels(){this.removeHandles(ue),this.removeHandles(ce),this.contentViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("contentViewModels",[])}_matchesFeature(e,t){const i=e?.graphic?.getObjectId(),s=t?.getObjectId();return i!=null&&s!=null&&i===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:e,relatedFeatures:t,map:i}){const{view:s,spatialReference:r,timeZone:n}=this;t?.filter(Boolean).forEach(o=>{e.some(d=>this._matchesFeature(d,o))||e.add(new V({abilities:{relationshipContent:!1},map:i,view:s,spatialReference:r,timeZone:n,graphic:o}))}),e.forEach(o=>{t?.find(u=>this._matchesFeature(o,u))||e.remove(o)})}_setExpressionContentVM(e,t){const i=this.formattedAttributes,{contentElement:s,contentElementViewModel:r}=e,n=s?.type;r&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:i}),r.set(this._createFieldsVMParams(s,t))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:i}),r.set(this._createMediaVMParams(s,t))),n==="text"&&r.set(this._createTextVMParams(s)))}_compileRelationship(e,t){const{displayCount:i,orderByFields:s,relationshipId:r,title:n,description:o}=e,{_sourceLayer:d,graphic:u,map:c}=this;if(!et(d))return;const h=new at({displayCount:i,graphic:u,orderByFields:s,relationshipId:r,layer:d,map:c,...this._compileTitleAndDesc({title:n,description:o})});return this.contentViewModels[t]=h,this.addHandles(Ze(()=>h.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(h)),ue),e}_matchesGlobalFeature(e,t){return e.association.equals(t.association)}_setUpUtilityNetworkAssociationsViewModels(e,t,i){const{view:s,spatialReference:r,timeZone:n}=this;e.forEach((o,d)=>{const u=t.get(d);u?o.forEach(c=>{u.find(h=>this._matchesGlobalFeature(c,h))||(o.remove(c),o.length===0&&e.delete(d))}):(o.removeAll(),e.delete(d))}),t.forEach((o,d)=>{const u=e.get(d)||new Ue;o?.filter(Boolean).forEach((c,h)=>{if(!u.some(f=>this._matchesGlobalFeature(f,c))){const{association:f,feature:_,terminalName:g,title:b}=c;u.add({title:b,association:f,featureViewModel:new V({abilities:{utilityNetworkAssociationsContent:!1},map:i,view:s,spatialReference:r,timeZone:n,graphic:_}),terminalName:g},h)}}),e.set(d,u)})}_compileUtilityNetworkAssociation(e,t){const{displayCount:i,title:s,description:r,associationTypes:n}=e,{_sourceLayer:o,graphic:d,map:u}=this;if(!tt(o))return;const c=new nt({graphic:d,displayCount:i,associationTypes:n,layer:o,map:u,...this._compileTitleAndDesc({title:s,description:r})});return this.contentViewModels[t]=c,this.addHandles([R(()=>c.associationFeatures.values(),()=>this._setUpUtilityNetworkAssociationsViewModels(c.associationViewModels,c.associationFeatures,c.map))],Tt),e}_compileExpression(e,t){const{expressionInfo:i}=e,{graphic:s,map:r,spatialReference:n,view:o,location:d}=this,u=new I({expressionInfo:i,graphic:s,interceptor:V.interceptor,map:r,spatialReference:n,view:o,location:d});return this.contentViewModels[t]=u,this.addHandles(R(()=>u.contentElementViewModel,()=>this._setExpressionContentVM(u,t),O),ce),e}_compileAttachments(e,t){const{graphic:i}=this,{description:s,title:r,orderByFields:n,attachmentKeywords:o,attachmentTypes:d}=e;return this.contentViewModels[t]=new P({attachmentKeywords:o,attachmentTypes:d,graphic:i,orderByFields:n,...this._compileTitleAndDesc({title:r,description:s})}),e}_compileCustom(e,t){const{graphic:i}=this,{creator:s,destroyer:r}=e;return this.contentViewModels[t]=new x({graphic:i,creator:s,destroyer:r}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:i,_sourceLayer:s,graphic:r,formattedAttributes:n}=this,o=r?.attributes,d=this._expressionAttributes,u=n.global;return{title:C({attributes:o,fieldInfoMap:i,globalAttributes:u,expressionAttributes:d,layer:s,text:e}),description:C({attributes:o,fieldInfoMap:i,globalAttributes:u,expressionAttributes:d,layer:s,text:t})}}_createFieldsVMParams(e,t){const i=this._effectivePopupTemplate,s=this.formattedAttributes,r={...s?.global,...s?.content[t]},n=!!e?.fieldInfos,o=e?.fieldInfos||i?.fieldInfos,d=o?.filter(({fieldName:f})=>!!f&&(Ie(f)||F(f)||r.hasOwnProperty(f))),u=i?.expressionInfos,{description:c,title:h}=e;return{attributes:r,expressionInfos:u,fieldInfos:d,isContentFieldInfos:n,graphic:this.graphic,layer:this._sourceLayer,...this._compileTitleAndDesc({title:h,description:c})}}_compileFields(e,t){const i=e.clone(),s=new w(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=s,i.fieldInfos=s.formattedFieldInfos.slice(),i}_createMediaVMParams(e,t){const{abilities:i,graphic:s,_fieldInfoMap:r,_effectivePopupTemplate:n,relatedInfos:o,_sourceLayer:d,_expressionAttributes:u}=this,c=this.formattedAttributes,h=s?.attributes??{},{description:f,mediaInfos:_,title:g}=e;return{abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:h,graphic:s,layer:d,fieldInfoMap:r,formattedAttributes:{...c?.global,...c?.content[t]},expressionAttributes:u,mediaInfos:_,popupTemplate:n,relatedInfos:o,...this._compileTitleAndDesc({title:g,description:f})}}_compileMedia(e,t){const i=e.clone(),s=new y(this._createMediaVMParams(e,t));return i.mediaInfos=s.formattedMediaInfos.slice(),this.contentViewModels[t]=s,i}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:i,_sourceLayer:s,_expressionAttributes:r}=this;if(e&&e.text){const n=t?.attributes??{},o=this.formattedAttributes?.global??{};e.text=C({attributes:n,fieldInfoMap:i,globalAttributes:o,expressionAttributes:r,layer:s,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const i=e.clone();return this.contentViewModels[t]=new x(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i,timeZone:s}=this;if(!e)return;const{lastEditInfoEnabled:r}=e,n=t?.editFieldsInfo;return r&&n?it(n,i?.attributes,s,t):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:s,_expressionAttributes:r}=this,n=s?.attributes??{},o=this.formattedAttributes?.global??{};return C({attributes:n,fieldInfoMap:t,globalAttributes:o,expressionAttributes:r,layer:i,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this;return t?z({type:"title",value:e?.title,event:{graphic:t}}):null}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this;return t?z({type:"content",value:e?.content,event:{graphic:t}}):null}_evaluateExpressionAttributes({title:e,content:t,expressionInfos:i}){this._evaluateExpressionAttributesTask=A(this._evaluateExpressionAttributesTask),this._evaluateExpressionAttributesTask=H(async s=>{const{graphic:r,map:n,view:o,spatialReference:d,location:u}=this;try{if(!r)return;let c;if(i!=null){const h=[];for(const[f,_]of i.expressions.entries())_!=null?h.push(_.evaluate({graphic:r,interceptor:V.interceptor,location:u,map:n,options:{signal:s},spatialReference:d,view:o}).then(g=>[f,typeof g=="string"?ot(g):g]).catch(()=>[f,void 0])):h.push(Promise.resolve([f,void 0]));c=Object.fromEntries(await Promise.all(h)),U(s)}this._expressionAttributes=c,this._graphicExpressionAttributes={...r.attributes,...c},this._set("formattedAttributes",this._createFormattedAttributes(t)),this._set("title",this._compileTitle(e)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(t)||null)}catch(c){te(c)||(this._error=c,Y.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:c,graphic:r,popupTemplate:this._effectivePopupTemplate}))}})}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){const{_effectivePopupTemplate:s,graphic:r,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:d,_graphicExpressionAttributes:u,timeZone:c}=this;i.content[t]=Q({attributes:{...u,...e.attributes},fieldInfoMap:d,fieldInfos:s?.fieldInfos,graphic:r,layer:o,relatedInfos:n,timeZone:c})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){const{graphic:s,relatedInfos:r,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:d,timeZone:u}=this;i.content[t]=Q({attributes:{...d,...e.attributes},fieldInfoMap:o,fieldInfos:e.fieldInfos,graphic:s,isContentFieldInfos:!0,layer:n,relatedInfos:r,timeZone:u})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:i,relatedInfos:s,_sourceLayer:r,_fieldInfoMap:n,_graphicExpressionAttributes:o,timeZone:d}=this,u=t?.fieldInfos,c={global:Q({attributes:o,fieldInfoMap:n,fieldInfos:u,graphic:i,layer:r,relatedInfos:s,timeZone:d}),content:[]};return Array.isArray(e)&&e.forEach((h,f)=>{h.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:h,contentElementIndex:f,formattedAttributes:c}),h.type==="media"&&this._createMediaFormattedAttributes({contentElement:h,contentElementIndex:f,formattedAttributes:c})}),c}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,oe(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:s,_sourceLayer:r}=this;s.clear();const n=r?.associatedLayer!=null?await r?.associatedLayer.load(i):r;if(!n||!e||!t.filter(c=>!!c.fieldName&&F(c.fieldName))?.length)return;t.forEach(c=>this._configureRelatedInfo(c,n));const d=await vt({relatedInfos:s,layer:n},i);Object.keys(d).forEach(c=>{const h=s.get(c.toString()),f=d[c]?.value;h&&f&&(h.layerInfo=f.data)});const u=await It({graphic:e,relatedInfos:s,layer:n},i);Object.keys(u).forEach(c=>{ht(u[c]?.value,s.get(c.toString()))})}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,s=q(e.fieldName||"");if(!s)return;const{layerId:r,fieldName:n}=s;if(!r)return;const o=i.get(r.toString())||ut(r,t);o&&(wt({relatedInfo:o,fieldName:n,fieldInfo:e}),this.relatedInfos.set(r,o))}},V=E,E.interceptor=new At(Ge,Qe),E);l([p()],m.prototype,"_error",void 0),l([p()],m.prototype,"_graphicChangedTask",void 0),l([p()],m.prototype,"_evaluateExpressionAttributesTask",void 0),l([p()],m.prototype,"_associationVMAbortController",void 0),l([p({readOnly:!0})],m.prototype,"_effectivePopupTemplate",null),l([p({readOnly:!0})],m.prototype,"_fieldInfoMap",null),l([p({readOnly:!0})],m.prototype,"_sourceLayer",null),l([p()],m.prototype,"abilities",void 0),l([_e("abilities")],m.prototype,"castAbilities",null),l([p({readOnly:!0})],m.prototype,"content",void 0),l([p({readOnly:!0})],m.prototype,"contentViewModels",void 0),l([p()],m.prototype,"description",void 0),l([p({type:Boolean})],m.prototype,"defaultPopupTemplateEnabled",void 0),l([p({readOnly:!0})],m.prototype,"isFeatureFromTable",null),l([p({readOnly:!0})],m.prototype,"state",null),l([p({readOnly:!0})],m.prototype,"formattedAttributes",void 0),l([p({type:X})],m.prototype,"graphic",void 0),l([p({readOnly:!0})],m.prototype,"lastEditInfo",void 0),l([p({type:ve})],m.prototype,"location",void 0),l([p({readOnly:!0})],m.prototype,"relatedInfos",void 0),l([p({type:qe})],m.prototype,"spatialReference",null),l([p()],m.prototype,"timeZone",null),l([p({readOnly:!0})],m.prototype,"title",void 0),l([p()],m.prototype,"map",null),l([p({readOnly:!0})],m.prototype,"waitingForContent",null),l([p()],m.prototype,"view",void 0),m=V=l([L("esri.widgets.Feature.FeatureViewModel")],m);export{x as c,w as d,I as k,m as n,P as s,y as v};
