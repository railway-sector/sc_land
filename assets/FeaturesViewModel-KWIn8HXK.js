const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/intersectsOperator-CKuf4yKG.js","assets/ProjectionTransformation-BjD312Kq.js","assets/Envelope2D-CUWyosZh.js","assets/Point2D-DNXcsliy.js","assets/Transformation2D-BUBnKQZf.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/index-BrQW8HOS.js","assets/index-lUE0m221.css","assets/OperatorDefinitions-DP7_WWTp.js","assets/jsonConverter-BHYd2kGf.js","assets/OperatorIntersects-DfaHxqTc.js","assets/apiConverter---8F7iZ4.js","assets/proximityOperator-CeAOEVUj.js","assets/OperatorProximity-Bx0bzIXN.js"])))=>i.map(i=>d[i]);
import{fb as R,fc as x,ao as O,fd as T,b2 as $,aV as B,U as E,fe as L,$ as v,f as g,y as b,ff as S,d2 as H,fg as Z,a4 as M,aQ as j,fh as z,fi as G,db as D,_ as a,e as n,al as W,aa as N,g as U}from"./index-BrQW8HOS.js";import{o as V}from"./geometryUtils-DV6xDwql.js";import{F as I}from"./symbolUtils-C3MaPSzp.js";import{n as q}from"./FeatureViewModel-DUcUeCTn.js";import{i as F,l as Q,g as w,d as k,h as J,v as K,p as X,n as A,a as Y,m as ee}from"./actionUtils-8wl7T0BJ.js";import{c as te}from"./AnchorElementViewModel-Djy63Zpd.js";const C="location-scale-handle",ie=()=>[A.clone()],se=()=>[Y.clone(),ee.clone()];let P=null;function re(e,t){return e==="building-scene"||e==="map-image"||e==="tile"||e==="imagery"||t==="2d"&&e==="imagery-tile"}let r=class extends R(te){constructor(e){super(e),this._pendingPromises=new x,this._fetchFeaturesController=null,this._highlightPromises={"highlight-active-feature":null,"highlight-selected-feature":null},this._selectedClusterFeature=null,this.actions=new F,this.activeFeature=null,this.autoCloseEnabled=!1,this.browseClusterEnabled=!1,this.content=null,this.defaultPopupTemplateEnabled=!1,this.featurePage=null,this.featuresPerPage=20,this.featureMenuOpen=!1,this.featureMenuTitle=null,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.initialDisplayMode="feature",this.selectedClusterBoundaryFeature=new O({symbol:new T({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null,this._debouncedLocationUpdate=$(async t=>{const{spatialReference:i}=this,s=this.selectedFeature?.geometry?.type,o=this.location??t;if(s&&s!=="mesh"&&i&&o&&this.selectedFeature)if(s!=="point")try{const l=this.selectedFeature;let u=l.geometry;const h=this._getHighlightLayer(l),c=l.getObjectId();if(!h||!this.view)return;if(c){const d=this.view?.allLayerViews.find(_=>_.layer.uid===h.uid);if(!d||!("queryFeatures"in d))return;const f=d.createQuery();f.outSpatialReference=i,f.objectIds=[c],f.returnGeometry=!0;const{features:m}=await d.queryFeatures(f);u=m[0]?.geometry}if(!u||u.type==="mesh")return;u=B(u,i),P||(P=await Promise.all([E(()=>import("./intersectsOperator-CKuf4yKG.js").then(d=>d.i),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),E(()=>import("./proximityOperator-CeAOEVUj.js").then(d=>d.p),__vite__mapDeps([12,3,2,1,4,5,6,7,8,9,13,11]))]));const[y,p]=P;if(!y.execute(u,o)){const d=p.getNearestCoordinate(u,o).coordinate??o;this.selectedFeature===l&&(this.location=d)}}catch(l){L(l)||v.getLogger(this).error(l)}else this.location=V(this.selectedFeature.geometry)??o})}initialize(){this.addHandles([this.on("view-change",()=>this._autoClose()),g(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),g(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),g(()=>this.view?.animation?.state,e=>this._animationStateChange(e)),g(()=>this.location,e=>this._locationChange(e)),g(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),g(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),g(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),g(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>Q({event:e,viewModel:this,view:this.view})),b(()=>!this.waitingForResult,()=>this._waitingForResultChange(),S),g(()=>[this.features,this.map,this.spatialReference,this.timeZone],()=>this._updateFeatureVMs()),g(()=>this.view?.scale,()=>this._viewScaleChange()),b(()=>!this.visible,()=>this.browseClusterEnabled=!1),g(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null,this.map=null,this.spatialReference=null,this.timeZone=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new F;e.removeAll();const{actions:t,defaultActions:i,defaultPopupTemplateEnabled:s,includeDefaultActions:o,selectedFeature:l}=this,u=o?i.concat(t):t,h=l&&(typeof l.getEffectivePopupTemplate=="function"&&l.getEffectivePopupTemplate(s)||l.popupTemplate),c=h?.actions;return(h?.overwriteActions?c:c?.concat(u)??u)?.filter(Boolean).forEach(p=>e.add(p)),e}get defaultActions(){const e=this._get("defaultActions")||new F;return e.removeAll(),e.addMany(w(this.selectedFeature)?se():ie()),e}get featureCount(){return this.features.length}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:o}=this,l=s&&t.length;this.initialDisplayMode!=="list"?l&&i&&o===-1?this.selectedFeatureIndex=0:l&&o!==-1||(this.selectedFeatureIndex=t.length?0:-1):(!l||l&&i===s)&&(this.selectedFeatureIndex=-1)}set location(e){let t=e;const i=this.spatialReference?.isWebMercator;e?.spatialReference?.isWGS84&&i&&(t=H(e)),this._set("location",t)}get map(){return this.view?.map??null}set map(e){this._override("map",e)}get pendingPromisesCount(){return this._pendingPromises.size}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){this._pendingPromises.clear(),this.features=[],Array.isArray(e)&&e.length?(this._set("promises",e),(e=e.slice()).forEach(t=>this._pendingPromises.add(t)),e.reduce((t,i)=>t.finally(()=>i.then(s=>{this._pendingPromises.has(i)&&this._updateFeatures(s)}).finally(()=>this._pendingPromises.delete(i)).catch(()=>{})),Promise.resolve())):this._set("promises",[])}get screenLocation(){return super.screenLocation}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return t===-1?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;(isNaN(e)||e<0||!t)&&(e=-1),this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{view:e,map:t}=this;return e?e.ready?"ready":"disabled":t?"ready":"disabled"}get timeZone(){return this.view?.timeZone??Z}set timeZone(e){this._overrideIfSome("timeZone",e)}get waitingForContents(){return this.featureViewModels.some(e=>e.waitingForContent)}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}centerAtLocation(){const{view:e}=this,t=k(this);return t&&e?this.callGoTo({target:{target:t,scale:e.scale}}):Promise.reject(new M("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e}))}zoomTo(e){return this.callGoTo(e)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,t){const{view:i}=this;if(!i||!e)throw new M("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return i.fetchPopupFeatures(e,{pointerType:t?.event?.pointerType,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t?.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:i}=t;delete t.fetchFeatures,i&&this._setFetchFeaturesPromises(t.location);const s=["actionsMenuOpen","collapsed"];for(const o of s)delete t[o];this.set(t)}triggerAction(e){const t=this.allActions.at(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex+1,this.featureCount),this}previous(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex-1,this.featureCount),this}disableClusterBrowsing(){J(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:t}=this;e?.type==="2d"?w(t)?(await K(this),await X(this)):v.getLogger(this).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",t):v.getLogger(this).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",t)}async handleViewClick(e){return this._fetchFeaturesAndOpen(e)}_getRoundRobinIndex(e,t){return(e+t)%t}_animationStateChange(e){this.zoomToLocation||(A.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){const e=[this.selectedClusterBoundaryFeature,this._selectedClusterFeature].filter(j);this.view?.graphics?.removeMany(e),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(w(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:i,view:s}=this;s&&i&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>0?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>0?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:i,featuresPerPage:s,featureViewModels:o}=this;if(i==null)return;const l=((i-1)*s+t)%t,u=l+s;o.slice(l,u).forEach((h,c)=>{h&&(h.graphic??=e[l+c])})}async _selectedFeatureChange(e){const{location:t,updateLocationEnabled:i,view:s}=this;if(!e||!s)return;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(s.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),w(e)?void 0:(e.symbol=await I(e),this._selectedClusterFeature=e,void s.graphics.add(this._selectedClusterFeature));const o=e.sourceLayer?.type;if(o!=="map-image"&&o!=="imagery"&&o!=="imagery-tile"||(e.symbol=await I(e)),!i&&t||!e.geometry){if(i&&!e.geometry){await this.centerAtLocation();const l=s.center?.clone();l&&(this.location=l)}}else this.location=V(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}async _setFetchFeaturesPromises(e){const{pendingFeatures:t}=await this._fetchFeaturesWithController({mapPoint:e});this.promises=t}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:i,view:s,spatialReference:o,map:l,timeZone:u,location:h}=this;if(w(t[0])||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t?.length)return;const c=i.slice(),y=[];t.forEach((p,d)=>{if(!p)return;let f=null;if(c.some((m,_)=>(m&&m.graphic===p&&(f=m,c.splice(_,1)),!!f)),f)y[d]=f;else{const m=new q({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:o,graphic:p===e?p:null,location:h,map:l,view:s,timeZone:u});y[d]=m}}),c.forEach(p=>p&&!p.destroyed&&p.destroy()),this._set("featureViewModels",y)}async _getScreenPoint(e,t){const{spatialReference:i,view:s}=this;if(!s)return null;await s?.when();const o=e?.spatialReference;return o&&i?(await z(o,i,null,t),s.toScreen(e)):null}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null}async _projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,event:i,signal:s}){return this.fetchFeatures(t??await this._getScreenPoint(e??this.location,{signal:s}),{signal:s,event:i})}_fetchFeaturesWithController({mapPoint:e,screenPoint:t,event:i}){this._cancelFetchingFeatures();const s=new AbortController,{signal:o}=s;this._fetchFeaturesController=s;const l=this._projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,signal:o,event:i});return l.catch(()=>{}).then(()=>{this._fetchFeaturesController=null}),l}async _fetchFeaturesAndOpen(e){const{mapPoint:t,screenPoint:i}=e;this.removeHandles(C),this.addHandles([g(()=>this.view?.scale,()=>this._debouncedLocationUpdate(t).catch(o=>{L(o)||v.getLogger(this).error(o)})),b(()=>!this.visible,()=>{this.removeHandles(C)},{once:!0})],C);const{pendingFeatures:s}=await this._fetchFeaturesWithController({mapPoint:t,screenPoint:i,event:e});return{location:t??void 0,promises:s}}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}_getHighlightLayer(e){const{layer:t,sourceLayer:i}=e;return i&&"layer"in i&&i.layer?i.layer:i?.type==="map-notes"||i?.type==="subtype-group"?i:t??i}_getHighlightLayerView(e,t){return t.type==="subtype-sublayer"&&t.parent&&this._mapIncludesLayer(t.parent)?this._getLayerView(e,t.parent):t&&this._mapIncludesLayer(t)?this._getLayerView(e,t):null}_getHighlightTarget(e,t,i){if(re(t.type,i))return e;const s=e.getObjectId();if(s!=null)return s;const o=t.type==="imagery"?void 0:"objectIdField"in t?t.objectIdField||G:null,l=e.attributes;return l&&o&&l[o]||e}_mapIncludesLayer(e){return!!this.map?.allLayers?.includes(e)}async _highlightFeature(e,t){this.removeHandles(e);const i=this[t];if(!i)return;const{highlightEnabled:s,view:o,visible:l}=this;if(!o||!s||!l)return;const u=this._getHighlightLayer(i);if(!u)return;const h=this._getHighlightLayerView(o,u);if(!h)return;this._highlightPromises[e]=h;const c=await h;if(!(c&&D(c)&&this._highlightPromises[e]===h&&this[t]&&this.highlightEnabled))return;const y=c.highlight(this._getHighlightTarget(i,u,o.type));this.addHandles(y,e)}async _highlightActiveFeature(){return this._highlightFeature("highlight-active-feature","activeFeature")}async _highlightSelectedFeature(){return this._highlightFeature("highlight-selected-feature","selectedFeature")}_updateFeatures(e){const{features:t}=this,i=e.filter(s=>!t.includes(s));i?.length&&(this.features=t.concat(i))}};a([n()],r.prototype,"_fetchFeaturesController",void 0),a([n({type:F})],r.prototype,"actions",void 0),a([n({readOnly:!0})],r.prototype,"active",null),a([n()],r.prototype,"activeFeature",void 0),a([n({readOnly:!0})],r.prototype,"allActions",null),a([n()],r.prototype,"autoCloseEnabled",void 0),a([n()],r.prototype,"browseClusterEnabled",void 0),a([n()],r.prototype,"content",void 0),a([n({type:F,readOnly:!0})],r.prototype,"defaultActions",null),a([n({type:Boolean})],r.prototype,"defaultPopupTemplateEnabled",void 0),a([n({readOnly:!0})],r.prototype,"featureCount",null),a([n()],r.prototype,"featurePage",void 0),a([n({value:[]})],r.prototype,"features",null),a([n()],r.prototype,"featuresPerPage",void 0),a([n()],r.prototype,"featureMenuOpen",void 0),a([n()],r.prototype,"featureMenuTitle",void 0),a([n()],r.prototype,"featureViewModelAbilities",void 0),a([n({readOnly:!0})],r.prototype,"featureViewModels",void 0),a([n()],r.prototype,"highlightEnabled",void 0),a([n()],r.prototype,"includeDefaultActions",void 0),a([n()],r.prototype,"initialDisplayMode",void 0),a([n({type:W})],r.prototype,"location",null),a([n()],r.prototype,"map",null),a([n({readOnly:!0})],r.prototype,"pendingPromisesCount",null),a([n({readOnly:!0})],r.prototype,"promiseCount",null),a([n()],r.prototype,"promises",null),a([n({readOnly:!0})],r.prototype,"selectedClusterBoundaryFeature",void 0),a([n({value:null,readOnly:!0})],r.prototype,"selectedFeature",null),a([n({value:-1})],r.prototype,"selectedFeatureIndex",null),a([n({readOnly:!0})],r.prototype,"selectedFeatureViewModel",null),a([n({type:N})],r.prototype,"spatialReference",null),a([n({readOnly:!0})],r.prototype,"state",null),a([n()],r.prototype,"timeZone",null),a([n()],r.prototype,"title",void 0),a([n()],r.prototype,"updateLocationEnabled",void 0),a([n()],r.prototype,"view",void 0),a([n()],r.prototype,"visible",void 0),a([n({readOnly:!0})],r.prototype,"waitingForContents",null),a([n({readOnly:!0})],r.prototype,"waitingForResult",null),a([n()],r.prototype,"zoomFactor",void 0),a([n()],r.prototype,"zoomToLocation",void 0),a([n()],r.prototype,"centerAtLocation",null),r=a([U("esri.widgets.Features.FeaturesViewModel")],r);export{r as z};
