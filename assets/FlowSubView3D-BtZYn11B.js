import{k2 as H,zT as N,zU as X,eK as Z,i7 as K,pu as Q,f5 as J,aE as Y,zV as V,qO as g,zW as F,b0 as $,i2 as ee,a_ as x,hQ as te,s4 as se,rX as ie,b2 as re,qx as ae,qv as ne,j as f,eB as le,K as oe,aZ as ue,cS as b,oD as v,f1 as de,sj as he,l3 as ce,f3 as _e,zX as pe,zY as ge,xI as z,ag as me,g0 as fe,hO as ye,ki as Te,zZ as ve,b1 as C,d1 as we,i1 as Se,bD as be,z_ as Re,N as $e,jQ as xe,a5 as o,x as u,y as Le}from"./index-aRi8Xk-b.js";import{p as Me,x as Pe,i as Ae}from"./utils-Cx8QTkBv.js";import{p as ke}from"./SubView3D-C_h5NLFJ.js";import{f as Ee,o as U,m as Ge,s as O,b as qe}from"./loadUtils-DBazF7kv.js";import{n as De,E as Ve,f as ze}from"./line-BL5uCDyo.js";const Ce=.1,I=1,Oe=1,nt=1e3,Ie=!1,Fe=3,Ue=1,We=1.5,w=501,Be=256,je=3,He=2,Ne=2;class Xe extends H{constructor(e){super("FlowWorker","generateStreamlines",{generateStreamlines:s=>[s.flowData.data.buffer,s.flowData.mask.buffer],generateTiledStreamlines:s=>{const i=[];return s.flowDataTiles.forEach(r=>{r.type==="loaded"&&i.push(r.data.data.buffer,r.data.mask.buffer)}),i}},e,{strategy:"dedicated"})}generateStreamlines(e,s){return this.invokeMethod("generateStreamlines",e,s)}generateTiledStreamlines(e,s){return this.invokeMethod("generateTiledStreamlines",e,s)}}function Ze(t,e,{vertices:s,stage:i,hasMagnitude:r},a,n,d){const{spatialReference:c}=e.extent,_=[],m=Ee(r),y=e.flowExtentInfo.modelSize[0];let S=0;for(let h=0;h<s.length;h+=m){if(d&&h>0){const D=s[h]-s[h-m];D>y/2?S-=y:-D>y/2&&(S+=y)}const[p,q]=e.modelToMapSpace(s[h]+S,s[h+1],!1),j=d?[p,q,K]:Qe(p,q,c,t,a);_.push(j)}const T=Math.floor(s.length/m),L=De(T);for(let h=0;h<T;h++)L[h]=s[h*m+2];const{hasVVColor:M,hasVVOpacity:P,hasVVSize:A}=n.parameters;let k,E,G;if(r&&(M||P||A)){const h=Q(T);for(let p=0;p<T;p++)h[p]=s[p*m+3];M&&(k=[h]),P&&(E=[h]),A&&(G=[h])}const B=Ve([_],void 0,[{timeStamps:L,streamlineType:i}],k,E,G);return ze(n,B[0])}function Ke(t,e,s){if(t==null)return{};let i=null;if(t.visualVariables){const a=[],n=t.visualVariables,d=new X({supports:{size:!0,color:!0,rotation:!1,opacity:!0}});i=N(n,d,a)}const r=i?.color?[1,1,1,1]:Z.toUnitRGBA(t.color);return r[3]*=e,{color:r,width:t.trailWidth,cap:0,animationSpeed:t.flowSpeed,trailLength:t.trailLength,animation:3,emissiveStrength:s,vvColor:i?.color,vvOpacity:i?.opacity,vvSize:i?.size}}function Qe(t,e,s,i,r){const{absoluteZ:a}=J(t,e,0,s,i,r),n=Y(t,e,a);return i.renderCoordsHelper.toRenderCoords(n,s,n),n}class W{constructor(e,s,i,r,a){this._query=e,this.streamlines=s,this._material=i,this.geometries=r,this._bytesPerFeature=a,this._startTime=0,this._endTime=1/0,this.usedMemory=null,this.startTime=this._query.time,this.computeMemory()}computeMemory(){const e=V(this.streamlines),s=V(this.geometries.map(r=>r.attributes)),i=this.streamlines.length*this._bytesPerFeature;this.usedMemory=e+s+i}get startTime(){return this._startTime}set startTime(e){this._query.time!==e&&(this._query=new U(this._query.extent,this._query.timeExtent,this._query.size,this._query.pixelRatio,g(e))),this._startTime=e,this.setMaterialParameters({startTime:e})}get endTime(){return this._endTime}set endTime(e){this._endTime=e,this.setMaterialParameters({endTime:e})}get query(){return this._query}hasFadedOut(e){return this.endTime+this._material.parameters.fadeOutTime<e}setMaterialParameters(e){this._material.setParameters(e)}get test(){return null}}class Je extends W{constructor(e,s,i,r,a){super(e,s,i,r,F.LINE_ROUND.draped.bytesPerFeature),this._layerView=a,this._drapeRenderer=null,this.drapeSourceType=2,this.updatePolicy=0,this.renderGroup=0,this._frameTask=null,this._renderGeometries=[]}get _view(){return this._layerView.view}get layer(){return this._layerView.layer}get fullOpacity(){return this._layerView.fullOpacity}get attached(){return this._drapeRenderer!=null}get destroyed(){return this.attached}async attach(){const{geometries:e}=this;e!=null&&(this.detach(),this._frameTask=this._view.resourceController.scheduler.registerTask($.FLOW_GENERATOR),await this._frameTask.scheduleGenerator(s=>this._addGeometryToOverlay(e,s)))}async*_addGeometryToOverlay(e,s){this._drapeRenderer=this._view.overlayManager.registerGeometryDrapeSource(this);for(let i=0;i<e.length;i+=w){const r=e.slice(i,i+w).map(a=>new ee(a));this._drapeRenderer.addGeometries(r,0),this._renderGeometries.push(...r),this._drapeRenderer.commitChanges(),s.madeProgress(),s.done&&(s=yield)}}detach(){this._frameTask=x(this._frameTask),this._drapeRenderer&&(this._drapeRenderer.removeGeometries(this._renderGeometries,2),this._drapeRenderer.commitChanges(),this._renderGeometries.length=0),this.attached&&this._view.overlayManager.unregisterDrapeSource(this),this._drapeRenderer=te(this._drapeRenderer)}}class Ye extends W{constructor(e,s,i,r,a){super(e,s,i,r,F.LINE_ROUND.bytesPerFeature),this._view=a,this._objects3D=[],this._engineLayer=null,this._frameTask=null}get attached(){return this._engineLayer!=null}async attach(){const{geometries:e}=this;e!=null&&(this.detach(),this._frameTask=this._view.resourceController.scheduler.registerTask($.FLOW_GENERATOR),await this._frameTask.scheduleGenerator(s=>this._addGeometryToLayer(e,s)))}detach(){this.attached&&(this._engineLayer?.removeMany(this._objects3D),this._objects3D.forEach(e=>e.dispose()),this._engineLayer?.commit(),this._objects3D=[],this._engineLayer=null,this._frameTask=x(this._frameTask))}async*_addGeometryToLayer(e,s){const{stage:i}=this._view,r=new se(i,{pickable:!1,updatePolicy:1});for(let a=0;a<e.length;a+=w){const n=new ie({geometries:e.slice(a,a+w),castShadow:!1});r.add(n),this._objects3D.push(n),r.commit(),s.madeProgress(),s.done&&(s=yield)}this._engineLayer=r}}let l=class extends ke{constructor(t){super(t),this.type="flow",this.renderedTiles=null,this.requireLoad=!1,this.workerHandle=null,this.frameTask=null,this._averageLoadingTime=g(0),this._abortController=null,this._loadingState="ready-to-load",this._tilesUpdateIsWaiting=!1,this._debugAllowAutoLoading=!0,this.emissiveStrength=0,this._overrideMaterialParameters=null,this._overrideSimulationSettings=null,this._overrideTransitionEnabled=null,this._updateTask=null,this._debouncedTileUpdate=re(async()=>{const{allTiles:e}=this.surface,s=this._getTileFilterFunction(),i=new Set;function*r(a){for(let n=0;n<e.length;++n){const d=e.at(n);s(d)&&i.add(d),a.madeProgress(),a.done&&(a=yield)}}await this.frameTask.scheduleGenerator(r),this.renderedTiles=i})}initialize(){const{surface:t,view:e}=this,{resourceController:s}=e;this.workerHandle=new Xe(ae(s)),this.frameTask=s.scheduler.registerTask($.FLOW_GENERATOR),this._updateTask=ne({update:i=>this._update(i)}),this.addHandles([f(()=>this._simulationSettings,()=>this.triggerLoad(),{sync:!0,equals:(i,r)=>i==null&&r==null||i!=null&&r!=null&&Me(i,r)}),f(()=>{const{elevationInfo:i}=this;return[this._clippingArea,this._visible,this._draped,this.view.state.contentPixelRatio,this.view.viewingMode,i?.mode,i?.offset,i?.unit,this._effectiveDensity]},()=>this.triggerLoad(),le),f(()=>this._materialParameters,i=>{this._resources?.setMaterialParameters(i),this._lastResources?.setMaterialParameters(i)}),t.on("tiles-changed",()=>{this.loadByTileTreesAllowed&&this._triggerTilesUpdate()}),e.enableFeatureTiles(),f(()=>[this._dataBounds,this._featureTilesBounds,this.loadAllTiles],()=>this._triggerTilesUpdate()),f(()=>this._flowRenderer,(i,r)=>{const a=r?.visualVariables??[],n=i?.visualVariables??[];n.length===a.length&&n.every((d,c)=>d.type===a[c].type)||this.clear()}),oe(()=>!e.featureTiles?.updating,()=>{this.loadByTileTreesAllowed&&this._triggerTilesUpdate()})]),this._triggerTilesUpdate()}destroy(){this._updateTask=x(this._updateTask),this.abort(),this.clear()}abort(){this._abortController=ue(this._abortController),this.requireLoad=!1}get _clippingArea(){const t=b(this.view.clippingArea,this.surface.spatialReference).geometry;return t==null?null:v(t)}get _dataBounds(){const t=b(this.layer.fullExtent,this.surface.spatialReference).geometry;return t==null?null:v(t)}get _draped(){return this.elevationInfo.mode==="on-the-ground"}get _ellipsoidRadius(){return de(this.view.spatialReference).radius}get extent(){const{spatialReference:t}=this.surface;let e=this.renderedTiles;if(t==null||e==null)return null;const s=this.view.terrainLevel;if(s!=null){const r=new Set;e.forEach(a=>{Math.abs(s-a.level)<je&&r.add(a)}),e=r}const i=Ge(e,this.spatialReferenceInfo);return i==null?null:(he(i,this._clippingArea,i),ce(i,t))}get loadAllTiles(){const{position:t}=this.view.camera,e=t.z;return e==null?!1:e*_e(t.spatialReference)/this._ellipsoidRadius>=We}get isDataGlobal(){const{extent:t,spatialReferenceInfo:e}=this;return t!=null&&O(t.xmin,t.xmax,e)}get loadByTileTreesAllowed(){return!this.loadAllTiles||!this.loadRequirementsMet}get _featureTilesBounds(){const t=this.view.featureTiles?.filterExtent,e=b(t,this.surface.spatialReference).geometry;return e==null?null:v(e)}get _flowRenderer(){const t=this.layer.renderer;return t?.type!=="flow"?null:t}get _materialParameters(){return{...Ke(this._flowRenderer,this.layerView.fullOpacity,this.emissiveStrength),fadeInTime:Oe,fadeOutTime:I,...this._overrideMaterialParameters,hasSlicePlane:this.layerView.slicePlaneEnabled,screenSizePerspective:!this._draped&&pe(this.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null}}get _opacity(){return this.layerView.fullOpacity}get _seamlessTransitionWaitingTime(){const{_averageLoadingTime:t}=this;return g(t===0?Ue:this._averageLoadingTime*Fe)}get _seamlessTransitionEnabled(){return this._overrideTransitionEnabled!=null?this._overrideTransitionEnabled:Ie}get _tracingResolution(){const{extent:t}=this;if(!t)return[0,0];const e=qe(t.xmin,t.xmax,this.spatialReferenceInfo?.valid)/(t.ymax-t.ymin),[s,i]=this.view.size;let r,a;s<i?(r=s,a=s/e):(r=i*e,a=i);const n=Be,d=this.view.qualitySettings.flow3D.maxTracingResolution,c=Math.max(1,n/Math.min(r,a)),_=c*Math.min(1,d/Math.max(r*c,a*c));return[Math.round(r*_),Math.round(a*_)]}get _visible(){const t=this._flowRenderer?.color;return this.visibleAtCurrentScale&&this.layer.effectiveVisible&&this._opacity>0&&(t==null||t.a>0)}get _estimatedStreamlines(){const{extent:t,_simulationSettings:e,renderedTiles:s}=this;if(e==null||s==null)return 0;const i=this._tracingResolution[0]*this._tracingResolution[1]/e.lineSpacing**2*e.density,r=t==null?null:v(t);if(r==null)return 0;let a=0;for(const c of s)ge(r,c.extent)&&(a+=z(c.extent));const n=z(r),d=n===0?0:a/n;return 2*Math.round(i*d)}get _effectiveDensity(){const{_estimatedStreamlines:t,_simulationSettings:e}=this,{qualitySettings:s,quality:i}=this.view;if(e==null)return 0;const r=s.flow3D.maxTotalNumberOfStreamlines,a=t>=r?r/t:1,n=e.density*a*i;return e.lineSpacing/Math.sqrt(n)<e.lineCollisionWidth?(e.lineSpacing/e.lineCollisionWidth)**2:n}get elevationInfo(){return this.layer.elevationInfo??et}startPositions(t){if(!this._seamlessTransitionEnabled)return[];const{_flowRenderer:e,_resources:s}=this;return e==null||s==null?[]:Pe(s.streamlines,s.query,t,e.flowSpeed)}get needsMagnitude(){return this._flowRenderer?.hasVisualVariables()??!1}get spatialReferenceInfo(){return fe(this.surface.spatialReference)}get layer(){return this.layerView.layer}get loadingState(){return this._loadingState}get loadRequirementsMet(){return this.renderedTiles!=null&&this.renderedTiles.size>0}getUpdating(){return this.updatingHandles.updating||this.requireLoad||this._loadingState==="before-transition"}get updating(){return this.getUpdating()}get visibleAtCurrentScale(){return!ye()||Te(this.layer.effectiveScaleRange,this.view.scale)}get _simulationSettings(){const{_flowRenderer:t,_overrideSimulationSettings:e}=this;if(t==null)return null;let s=Ae(t);return s.segmentLength=s.lineCollisionWidth/2,s.onlyForwardTracing=!1,s.density*=He,this.loadAllTiles&&this.isDataGlobal&&(s.density*=Ne),e!=null&&(s={...s,...e}),s}getSimulationSettings(t){const{_simulationSettings:e,spatialReferenceInfo:s}=this;if(e==null)return null;const i=this.view.viewingMode==="global"&&s!=null&&O(t.extent.xmin,t.extent.xmax,s);return{...e,wrapAround:i,density:this._effectiveDensity}}get surface(){return this.view.basemapTerrain}doRefresh(){this.triggerLoad()}clear(){this._resources?.detach(),this._resources=null,this._lastResources?.detach(),this._lastResources=null,this._loadingState="ready-to-load"}_update(t){const e=ve(t.time);this._lastResources?.hasFadedOut(e)&&this._lastResources.detach();const s=this._nextStateForTransition(e);if(!this.requireLoad||this.updatingHandles.updating||s!=="ready-to-load"||!this.loadRequirementsMet)return void(this._loadingState=s);this._loadingState="loading";const i=async()=>{const r=performance.now(),a=this._seamlessTransitionEnabled&&this._resources!=null?g(e+this._seamlessTransitionWaitingTime):e;await this._load(a);const n=g((performance.now()-r)/1e3);this._updateAverageLoadingTime(n)};this.updatingHandles.addPromise(C(i())),this.requireLoad=!1}_updateAverageLoadingTime(t){const e=Ce;this._averageLoadingTime=g(e*t+(1-e)*this._averageLoadingTime)}triggerLoad(){this._debugAllowAutoLoading&&(this.requireLoad=!0)}async _load(t){const{extent:e,view:s}=this;if(!this._visible)return this.clear(),void(this._loadingState="ready-to-load");if(e==null)return void(this._loadingState="ready-to-load");const i=new U(e,this.layerView.timeExtent,this._tracingResolution,s.state.contentPixelRatio,t);this._abortController==null&&(this._abortController=new AbortController);const r=this._abortController,a=await this._loadStreamlines(i,r.signal);if(we(r.signal),this._visible&&a!=null){this._lastResources?.detach(),this._lastResources=this._resources,this._resources=a;const n=performance.now()/1e3,d=n>t?n:t;this._lastResources!=null&&(this._lastResources.endTime=d),this._resources.startTime=d,await a.attach(),this._loadingState=this._seamlessTransitionEnabled?"before-transition":"transitioning"}else this._loadingState="ready-to-load"}async _loadStreamlines(t,e){const s=await this.fetchDataAndGenerateStreamlines(t,e);if(s==null)return null;const{geometries:i,material:r}=await this._createGeometry(t,s);return this._draped?new Je(t,s,r,i,this.layerView):new Ye(t,s,r,i,this.view)}async fetchDataAndGenerateStreamlines(t,e){return null}async _createGeometry(t,e){const s=new Se(this._materialParameters,this.view.state.isGlobal),i=new Array,{elevationInfo:r,_draped:a,view:n}=this;function*d(c){for(let _=0;_<e.length;++_)i.push(Ze(n,t,e[_],r,s,a)),c.madeProgress(),c.done&&(c=yield)}return await this.frameTask.scheduleGenerator(d),{geometries:i,material:s}}_triggerTilesUpdate(){if(this._tilesUpdateIsWaiting)return;this._tilesUpdateIsWaiting=!0;const t=async()=>{await $e(()=>this.view.stationary),this._tilesUpdateIsWaiting=!1,await this._debouncedTileUpdate()};this.updatingHandles.addPromise(C(t()))}_getTileFilterFunction(){const{_dataBounds:t,view:e,_featureTilesBounds:s}=this;if(this.loadAllTiles)return n=>n.leaf&&R(t,n.extent);const i=n=>n.rendered&&n.visible&&R(t,n.extent),{featureTiles:r}=e;if(!r)return i;const a=r.tiles.filter(n=>n.measures.visible);return n=>i(n)&&R(s,n.extent)&&a.some(({lij:d})=>be(d,n.lij)||Re(d,n.lij))}_nextStateForTransition(t){const{_resources:e}=this;if(this._flowRenderer==null||e==null||this._loadingState==="ready-to-load"||this._loadingState==="loading")return this._loadingState;const s=e.startTime;return t<s?"before-transition":t<s+I?"transitioning":"ready-to-load"}get usedMemory(){return(this._lastResources?.usedMemory??0)+(this._resources?.usedMemory??0)}get test(){}};o([u()],l.prototype,"type",void 0),o([u()],l.prototype,"renderedTiles",void 0),o([u()],l.prototype,"_resources",void 0),o([u()],l.prototype,"_lastResources",void 0),o([u()],l.prototype,"requireLoad",void 0),o([u()],l.prototype,"_averageLoadingTime",void 0),o([u()],l.prototype,"_loadingState",void 0),o([u()],l.prototype,"emissiveStrength",void 0),o([u()],l.prototype,"_clippingArea",null),o([u()],l.prototype,"_dataBounds",null),o([u()],l.prototype,"_draped",null),o([u()],l.prototype,"_ellipsoidRadius",null),o([u()],l.prototype,"extent",null),o([u()],l.prototype,"loadAllTiles",null),o([u()],l.prototype,"isDataGlobal",null),o([u()],l.prototype,"_featureTilesBounds",null),o([u()],l.prototype,"_flowRenderer",null),o([u()],l.prototype,"_materialParameters",null),o([u()],l.prototype,"_opacity",null),o([u()],l.prototype,"_seamlessTransitionWaitingTime",null),o([u()],l.prototype,"_seamlessTransitionEnabled",null),o([u()],l.prototype,"_tracingResolution",null),o([u()],l.prototype,"_visible",null),o([u()],l.prototype,"_estimatedStreamlines",null),o([u()],l.prototype,"_effectiveDensity",null),o([u()],l.prototype,"elevationInfo",null),o([u()],l.prototype,"needsMagnitude",null),o([u()],l.prototype,"spatialReferenceInfo",null),o([u()],l.prototype,"layer",null),o([u()],l.prototype,"loadingState",null),o([u()],l.prototype,"updating",null),o([u()],l.prototype,"visibleAtCurrentScale",null),o([u()],l.prototype,"_overrideMaterialParameters",void 0),o([u()],l.prototype,"_overrideSimulationSettings",void 0),o([u()],l.prototype,"_overrideTransitionEnabled",void 0),o([u()],l.prototype,"_simulationSettings",null),o([u()],l.prototype,"surface",null),l=o([Le("esri.views.3d.layers.FlowSubView3D")],l);const et=new me({mode:"on-the-ground"});function R(t,e){return t==null||e==null||xe(t,e)}export{nt as c,l as r};
