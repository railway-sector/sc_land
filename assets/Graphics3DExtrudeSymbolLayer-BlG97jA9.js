import{jj as B,jn as Lt,jk as zt,jo as jt,jp as V,b3 as Mt,ae as Ot,q1 as $,q0 as Q,p$ as xt,s7 as Rt,s8 as it,dn as ot,s9 as Ut,sa as rt,fE as Vt,aP as K,sb as Ft,jV as Bt,oK as Tt,es as Gt,pw as Ht,sc as kt,sd as Wt,hA as lt,pN as qt,se as Nt,sf as Kt,sg as Zt,sh as Jt,si as Qt,et as J,ar as P,bx as Xt,aC as O,gC as ct,bh as wt,jg as Yt,bg as X,sj as te,sk as ee,sl as se,sm as ne,qv as ae,sn as ie,kg as k,aI as oe,bf as ut}from"./index-BrQW8HOS.js";import{e as St}from"./earcut-D9gy186-.js";import{t as re,e as ht}from"./SnappingCandidate-DGkpYqI6.js";import{a as le}from"./renderingInfoUtils-Ciob3c1F.js";import{h as Pt,i as ce}from"./triangulationUtils-DRNEJzEV.js";function ue(e,t,s,a){const n=Pt(e.rings,!!e.hasZ&&a.mode!=="on-the-ground",1,e.spatialReference),i=B(n.position.length),o=Lt(n.position,e.spatialReference,0,i,0,n.position,0,n.position.length/3,t,s,a),r=o!=null;return new de(n.position,i,Ct(n.polygons,n.position,i),vt(n.outlines,n.position,i),r,o)}function ze(e,t){const s=Pt(e.rings,!1,1),a=zt(s.position,e.spatialReference,0,s.position,t,0);for(let n=2;n<s.position.length;n+=3)s.position[n]=jt;return{position:s.position,polygons:Ct(s.polygons,s.position),outlines:vt(s.outlines,s.position),projectionSuccess:a}}function vt(e,t,s=null){return e.filter(({count:a})=>a>1).map(({index:a,count:n})=>{const i=3*a,o=3*n;return s!=null?new Et(a,n,V(t,i,o),V(s,i,o)):new Y(a,n,V(t,i,o))})}function Ct(e,t,s=null){const a=new Array;for(const{index:n,count:i,holeIndices:o,pathLengths:r}of e){if(i<=1)continue;const l=3*n,_=3*i,x=o.map(m=>m-n),f=s!=null?new he(n,i,V(t,3*n,3*i),V(s,l,_),x,r):new pe(n,i,V(t,3*n,3*i),x,r);a.push(f)}return a}let Y=class{constructor(t,s,a){this.index=t,this.count=s,this.position=a}};class Et extends Y{constructor(t,s,a,n){super(t,s,a),this.mapPositions=n}}class he extends Et{constructor(t,s,a,n,i,o){super(t,s,a,n),this.holeIndices=i,this.pathLengths=o}}class pe extends Y{constructor(t,s,a,n,i){super(t,s,a),this.holeIndices=n,this.pathLengths=i}}class de{constructor(t,s,a,n,i,o){this.position=t,this.mapPositions=s,this.polygons=a,this.outlines=n,this.projectionSuccess=i,this.sampledElevation=o}}function Me(e,t,s){const a=(t.length>0?t[0]:e.length/3)-1,n=ce(e,a,s);if(n!==2){e=e.slice();for(let i=0;i<e.length;i+=3)e[i+n]=e[i+2]}return St(e,t,3)}function Oe(e){const t=[["position",new $(e.attributeData.position,e.indices,3,!0)]],s=xt(e.indices.length);return e.attributeData.colorFeature!=null?t.push(["colorFeatureAttribute",new $([e.attributeData.colorFeature],s,1,!0)]):e.attributeData.color&&t.push(["color",new $(e.attributeData.color,s,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new $(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new $(e.attributeData.boundingRect,e.indices,9,!0)]),new Q(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function Re(e,t=null){const s=[["position",new $(e.attributeData.position,e.indices,3,!0)],["uv0",new $(e.attributeData.uv0,e.indices,2,!0)]];return new Q(e.material,s,e.mapPositions,0,t)}function ge(e){switch(e.type){case"extent":if(e instanceof Mt)return Ot.fromExtent(e);break;case"polygon":return e}return null}class Ue{constructor(t,s,a){this.renderData=t,this.layerViewUid=s,this.graphicUid=a,this.outGeometries=new Array}}const me=["polygon","extent"];class Ve extends Rt{constructor(t,s,a,n){super(t,s,a,n,xe(s)),this.ensureDrapedStatus(!1)}async doLoad(){const t=this.symbolLayer,s=t?.material,a=this.symbolLayer.material?.color?.a,n=this.needsDrivenTransparentPass||a!=null&&a!==1,i=s?.emissive,o=!this._hasDrivenColorOrOpacity&&(a==null||a===0),r={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:ot,diffuse:ot,opacity:o?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:n,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:t.castShadows,emissiveStrength:i?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},l=new it(r,this._context),_=new it({...r,cullFace:2},this._context);this._materials[0]=l,this._materials[1]=_,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(t){const s=t.graphic;if(!this._validateGeometry(s.geometry,me,this.symbolLayer.type))return null;const a=this._getDrivenUInt8ColorWithNaNSupport(t.renderingInfo,this._materialColor,!1);Ut(a,a);const n=this.createElevationContextForGraphic(s);return this._createAs3DShape(s,t.renderingInfo,a,n,s.uid)}layerOpacityChanged(t,s){const a=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:a}),this._materials[1]?.setParameters({layerOpacity:a}),this._updateTransparentDepedentMaterialParameters(),t?.forEach(n=>s(n)?.layerOpacityChanged(a,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,s){return this.updateGraphics3DGraphicElevationInfo(t,s,rt)}slicePlaneEnabledChanged(t,s){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t?.forEach(a=>{const n=s(a);n?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(t),this._materials[1]?.setParameters(t),!0}_getExtrusionSize(t){let s;return s=t.size&&this._drivenProperties.size?le(t.size,2)??0:this._getSymbolSize(),s/=this._context.renderCoordsHelper.unitInMeters,s}applyRendererDiff(t,s){return this._drivenPropertiesChanged(s)?0:1}async queryForSnapping(t,s,a,n){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Vt(s),{objectId:o,target:r}=t,l=K(r);switch(l.z=(l.z??0)+i,t.type){case"edge":{const{start:_,end:x}=t,f=K(_),m=K(x);return f.z=(f.z??0)+i,m.z=(m.z??0)+i,[ht(o,l,1/0,f,m)]}case"vertex":return[re(o,l,1/0),ht(o,r,1/0,r,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,s,a,n,i){const o=ge(t.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(C=>C.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const r=ue(o,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(r,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Ft(o);if(l==null)return null;const _=new Array,x=new Array,f=Bt(),m=J(),w=P(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,w),Tt(o.spatialReference,[l.x,l.y,0],m,this._context.renderCoordsHelper.spatialReference);const b=J();Gt(b,m);const g=Xt();Ht(g,b);const{polygons:y,mapPositions:c,position:d}=r,h=new Map,v=this._materials[0];for(const C of y){const z=C.count;if(this._context.clippingExtent&&(kt(C.mapPositions,f),!Wt(f,this._context.clippingExtent)))continue;const j=St(C.mapPositions,C.holeIndices,3);if(j.length===0)continue;const M=j.length,D=6*z,R=lt(D+M),W=lt(M),T=B(3*D),tt=B(3*D),et=B(3*D),st=B(D);ye(d,c,j,C,T,et,tt,st,R,W,this._getExtrusionSize(s),w,p),qt(T,T,b);const nt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),q=new Ce(T,et,Nt(tt),st),N=pt(v,R,R.length-W.length,q,a,nt),$t=z,At=z,It=2*C.count,at=new Ee($t,At,It,M/3);Dt(N,at,m),h.set(N,at),_.push(N,pt(this._materials[1],W,0,q,a,nt)),x.push(q.heights)}if(_.length===0)return null;const u=new Kt({geometries:_,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});u.transformation=m;const A=Zt(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=A?new Jt(this._materials[0],A,this._context.slicePlaneEnabled):null,L=new Qt(this,u,null,(C,z,j,M,D)=>_e(C,z,j,M,D,x,h),n,I);return L.alignedSampledElevation=r.sampledElevation,L.needsElevationUpdates=rt(n.mode),L}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){const t=this._materials[0];t&&t.setParameters({cullFace:t.transparent?0:2})}}function pt(e,t,s,a,n,i){const o=xt(t.length),r=[["position",new $(a.positions,t,3,!0)],["normalCompressed",new $(a.normals,t,2,!0)],["symbolColor",new $(n,o,4,!0)]];return new Q(e,r,a.elevation,0,i,s)}function ye(e,t,s,a,n,i,o,r,l,_,x,f,m){const w=s.length/3;let p=2*a.count;fe(e,t,a.index,a.count,s,0,w,n,i,o,r,l,_,p,x,f,m);let b=0,g=2*a.count;p=0;const y=a.pathLengths[0];dt(n,i,r,o,b,y,a.count,g,l,p,x),g+=4*y,p+=2*y,b+=y;for(let c=1;c<a.pathLengths.length;++c){const d=a.pathLengths[c];dt(n,i,r,o,b,d,a.count,g,l,p,x),g+=4*d,p+=2*d,b+=d}}function fe(e,t,s,a,n,i,o,r,l,_,x,f,m,w,p,b,g){oe(E,b),l??=[],_??=[],x??=[];const y=p>0?1:-1;let c=3*s,d=0,h=3*d,v=a,u=3*v;for(let L=0;L<a;++L){const C=e[c],z=e[c+1],j=e[c+2];g&&(E[0]=C,E[1]=z,E[2]=j,X(E,E)),r[h+0]=C,r[h+1]=z,r[h+2]=j;const M=t[c+0],D=t[c+1],R=t[c+2];l[h+0]=M,l[h+1]=D,l[h+2]=R,_[h+0]=-y*E[0],_[h+1]=-y*E[1],_[h+2]=-y*E[2],x[d]=0,r[u+0]=C+p*E[0],r[u+1]=z+p*E[1],r[u+2]=j+p*E[2],l[u+0]=M,l[u+1]=D,l[u+2]=R,x[v]=p,h+=3,u+=3,c+=3,d+=1,v+=1}c=3*i,h=0,u=3*w;const A=p<0?_t:bt,I=p<0?bt:_t;for(let L=0;L<o;++L)m[h]=n[c+A[0]],m[h+1]=n[c+A[1]],m[h+2]=n[c+A[2]],f[u]=n[c+I[0]]+a,f[u+1]=n[c+I[1]]+a,f[u+2]=n[c+I[2]]+a,h+=3,u+=3,c+=3}function G(e,t,s,a,n,i,o){a[i]=a[o],o*=3,e[i*=3]=e[o],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],s[i]=n[0],s[i+1]=n[1],s[i+2]=n[2]}const F=P();function dt(e,t,s,a,n,i,o,r,l,_,x){t??=[],s??=[],a??=[];let f=n,m=n+1,w=n+o,p=n+o+1,b=r,g=r+1,y=r+2*i,c=r+2*i+1;x<0&&(f=n+o+1,p=n);let d=3*_;for(let h=0;h<i;++h)h===i-1&&(m=n,x>0?p=n+o:f=n+o),be(e,f,m,w,F),G(e,t,a,s,F,b,f),G(e,t,a,s,F,g,m),G(e,t,a,s,F,y,w),G(e,t,a,s,F,c,p),l[d]=b,l[d+1]=y,l[d+2]=c,l[d+3]=b,l[d+4]=c,l[d+5]=g,d+=6,f++,m++,w++,p++,b+=2,g+=2,y+=2,c+=2}const Z=P(),gt=P(),mt=P(),yt=P(),ft=P();function be(e,t,s,a,n){t*=3,s*=3,a*=3,O(Z,e[t++],e[t++],e[t++]),O(gt,e[s++],e[s++],e[s++]),O(mt,e[a++],e[a++],e[a++]),ut(yt,gt,Z),ut(ft,mt,Z),wt(n,ft,yt),X(n,n)}const U=P();function _e(e,t,s,a,n,i,o){const r=e.stageObject,l=r.geometries,_=l.length,x=t.mode!=="absolute-height";let f=0;const m=r.transformation,w=ee(J(),m);for(let p=0;p<_;p+=2){const b=l[p];if(!se(b))continue;const g=b.getMutableAttribute("position").data,y=i[p/2],c=new ne(b.mapPositions),d=g.length/3;let h=!1,v=0;{let u=0;for(let A=0;A<d;A++){U[0]=g[u],U[1]=g[u+1],U[2]=g[u+2],a(c,H),x&&(v+=H.sampledElevation),ie.TESTS_DISABLE_OPTIMIZATIONS?(O(S,c.array[c.offset],c.array[c.offset+1],H.z+y[u/3]),s!=null&&n.toRenderCoords(S,s,S),k(S,S,w)):(O(S,g[u],g[u+1],g[u+2]),k(S,S,m),n.setAltitude(S,H.z+y[u/3]),k(S,S,w)),g[u]=S[0],g[u+1]=S[1],g[u+2]=S[2];const I=we/n.unitInMeters;(Math.abs(U[0]-g[u])>=I||Math.abs(U[1]-g[u+1])>=I||Math.abs(U[2]-g[u+2])>=I)&&(h=!0),c.offset+=3,u+=3}}if(h){const u=o.get(b);u&&Dt(b,u,m),r.geometryVertexAttributeUpdated(l[p],"normalCompressed"),b.invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(l[p],"position"),l[p+1].invalidateBoundingInfo(),r.geometryVertexAttributeUpdated(l[p+1],"position")}f+=v/d}return f/_}function Dt(e,t,s){const a=e.getMutableAttribute("position"),n=e.getMutableAttribute("normalCompressed").data,i=a.data,o=e.attributes.get("position").indices,{topVertexStart:r,topVertexCount:l,topFaceStart:_,topFaceCount:x}=t,f=_+x,m=r+l,w=Se,p=Pe,b=ve,g=E,y=S;O(y,0,0,0);const c=(d,h)=>{const v=3*d;O(h,i[v+0],i[v+1],i[v+2]),k(h,h,s)};for(let d=_;d<f;++d){const h=3*d;c(o[h+0],w[0]),c(o[h+1],w[1]),c(o[h+2],w[2]),ct(p,w[1],w[0]),ct(b,w[2],w[0]),wt(g,p,b),Yt(y,y,g)}X(y,y);for(let d=r;d<m;++d){const h=y[0],v=y[1],u=y[2];te(n,d,h,v,u)}}function xe(e){return(e.material?.color?.a??0)===1}const S=P(),E=P(),H=new ae,bt=[0,2,1],_t=[0,1,2],we=.01,Se=[P(),P(),P()],Pe=P(),ve=P();class Ce{constructor(t,s,a,n){this.positions=t,this.elevation=s,this.normals=a,this.heights=n}}class Ee{constructor(t,s,a,n){this.topVertexStart=t,this.topVertexCount=s,this.topFaceStart=a,this.topFaceCount=n}}export{Ve as K,ye as X,Ue as a,Re as c,ge as l,ze as p,ue as r,Oe as s,Me as u};
