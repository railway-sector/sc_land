import{a2 as U,eB as u,Y as f,Z as r,$ as s,a0 as M,fW as I,cI as W,q as j,k as w,hL as S,mf as N,aP as q,eP as P,mh as H,ad as C,a4 as z,aq as L,ap as B,rh as Y,ri as $,nt as Z,hT as G,eN as F}from"./index-CVzGOCNQ.js";import{a as J}from"./MeasuredGrid-DI-PDY_x.js";import{e as K}from"./defaultUnit-CXgP0zyu.js";import{t as Q,l as X,f as tt,u as et}from"./gridUtils-Cxf4yL-E.js";import{DrawGraphicTool2D as it}from"./editingTools-DouNzilx.js";import{f as T,u as rt}from"./euclideanLengthMeasurementUtils-DBiCfquW.js";import{n as st}from"./TextOverlayItem-Ct7LPxL5.js";import{u as at}from"./automaticAreaMeasurementUtils-DmTPCnFV.js";import{c as nt}from"./automaticLengthMeasurementUtils-Blbew1js.js";import{o as ot}from"./formatUtils-BuH0ssKK.js";let h=class extends U{constructor(t){super(t),this.color=new u([255,127,0,1]),this.isDecoration=!0,this.length=34,this.rotation=0,this.thickness=2,this.visible=!0}get _strokeStyle(){return this.color.toCss(!0)}render(){const{x:t,y:e,length:i,thickness:a,rotation:o}=this,l=i/2,c=`0 0 ${i} ${i}`,d=`M${l} 0 V${i} M0 ${l} H${i}`;return f("div",{classes:{"esri-box-overlay-item":!0},dir:"ltr",styles:{left:`${(t??0)-l}px`,top:`${(e??0)-l}px`,width:`${i}px`,height:`${i}px`,transform:`rotate(${o}deg)`,visibility:this.visible?"visible":"hidden"}},f("svg",{styles:{overflow:"visible"},viewbox:c},f("path",{d,stroke:this._strokeStyle,"stroke-width":a})))}renderCanvas(){}};r([s()],h.prototype,"color",void 0),r([s()],h.prototype,"isDecoration",void 0),r([s()],h.prototype,"length",void 0),r([s()],h.prototype,"rotation",void 0),r([s()],h.prototype,"thickness",void 0),r([s()],h.prototype,"visible",void 0),r([s()],h.prototype,"x",void 0),r([s()],h.prototype,"y",void 0),r([s({readOnly:!0})],h.prototype,"_strokeStyle",null),h=r([M("esri.views.overlay.CrosshairOverlayItem")],h);const lt=t=>{if(t==null||isNaN(t))return 0;const e=t+180;return Math.trunc(I(e,360))},wt=t=>{let e=t;return e==null?0:(typeof e=="string"&&(e=parseInt(e,10)),isNaN(e)?0:I(Math.trunc(e),360)-180)},k=(t,e)=>{if(!t||e.length<3)return;const[i,a,o,l]=e,[c,d]=l===void 0?[1,.25]:[l,.25*l];t.majorLineColor=u.fromArray([i,a,o,c]),t.minorLineColor=u.fromArray([i,a,o,d])},O=Symbol("grid-interactivity");let n=class extends W{constructor(t){super(t),this._drawGraphicTool=null,this._keybindings=null,this._crosshairLabel=null,this._crosshairItem=null,this.snappingManager=null,this.snappingOptions=null,this.view=null,this.placementDisabled=!1,this._mostRecentlyShownGrid=null,this._sketchedVertexCount=0}initialize(){this.addHandles([j(()=>!this.displayEnabled,()=>{this.interactivePlacementState=null}),w(()=>this.view?.viewpoint,()=>{this._renderOverlays()}),w(()=>this.snappingOptions?.gridEnabled,t=>{t!=null&&this.trySetDisplayEnabled(t)}),w(()=>this.view?.grid,(t,e)=>{this._mostRecentlyShownGrid=!t&&e?e:null})])}destroy(){this._resetGridPlacementState(),this._crosshairItem&&(this.view?.overlay?.removeItem(this._crosshairItem),this._crosshairItem=S(this._crosshairItem)),this._crosshairLabel&&(this.view?.overlay?.removeItem(this._crosshairLabel),this._crosshairLabel=S(this._crosshairLabel))}get displayEnabled(){return!!this.view?.grid}get dynamicScaling(){return this.grid?.dynamicScaling??!1}set dynamicScaling(t){this.grid&&(this.grid.dynamicScaling=t)}get grid(){return this.view?.grid??this._mostRecentlyShownGrid}set gridColor(t){if(t?.equals(this.grid?.majorLineColor)||!t)return;const[e,i,a,o]=t.toArray();k(this.grid,[e,i,a,o/255])}get gridColor(){return this.grid?.majorLineColor}get gridControlsEnabled(){return this.displayEnabled&&!this.interactivePlacementState}set interactivePlacementState(t){this._set("interactivePlacementState",t),this._resetGridPlacementState(),t&&this._startGridManipulation(t)}get majorLineInterval(){return this.grid?.majorLineInterval??10}set majorLineInterval(t){this.grid&&(this.grid.majorLineInterval=t<1?1:t>15?15:t)}get rotateWithMap(){return this.grid?.rotateWithMap??!1}set rotateWithMap(t){this.grid&&(this.grid.rotateWithMap=t)}get rotation(){return this.grid?.rotation??-180}set rotation(t){this.grid&&(this.grid.rotation=t)}get snappingEnabled(){return(this.grid&&this.snappingOptions?.gridEnabled)??!1}set snappingEnabled(t){const{snappingOptions:e}=this;e&&(e.gridEnabled=t)}get spacing(){return this.grid?.spacing??1}set spacing(t){this.grid&&t>0&&(this.grid.spacing=t)}get unit(){return this.grid?.units}set unit(t){this.grid&&(this.grid.units=t)}get gridOutOfScale(){return!this.dynamicScaling&&this._pixelsPerStride!=null&&this._pixelsPerStride<Q}get effectiveSpacingAfterDynamicScaling(){return this.majorLineInterval<1||!this.dynamicScaling||!this.view||this._pixelsPerStride==null||!this.grid?.spacing?null:this.grid.spacing*X(this.majorLineInterval,this._pixelsPerStride,this.dynamicScaling)}get numericSpacingInputShouldBeVisible(){return!!this.view?.spatialReference&&tt(this.view.spatialReference)}get _metersPerSRUnit(){if(!(this.view&&this.displayEnabled&&this.grid&&N(this.grid.center.spatialReference,this.view.spatialReference)))return null;const t=q(this.grid.center,this.view.spatialReference);return et(t)}get _pixelsPerStride(){if(!this.view?.scale||!this.displayEnabled||!this.grid||this._metersPerSRUnit==null)return null;const t=this.grid,{scale:e,spatialReference:i}=this.view;return P(t.spacing,t.units,"meters")/(this._metersPerSRUnit*H(e,i))}get _isPlacing(){if(!this._drawGraphicTool)return!1;const t=this.interactivePlacementState;return t==="place"||t==="interactive"&&this._sketchedVertexCount===0}get _isRotating(){if(!this._drawGraphicTool)return!1;const t=this.interactivePlacementState;return t==="rotate"||t==="interactive"&&this._sketchedVertexCount===1}get _isScaling(){return this._drawGraphicTool?this.interactivePlacementState==="interactive"&&this._sketchedVertexCount===1:!1}togglePlacementState(t){this.interactivePlacementState=this.interactivePlacementState===t?null:t}trySetDisplayEnabled(t){const{view:e}=this;if(e?.ready)if(!e.grid&&t)if(this._mostRecentlyShownGrid)e.grid=this._mostRecentlyShownGrid;else{const i=this.defaultUnit==="imperial"?"feet":"meters";e.grid=new J({units:i,center:e.center??new C,rotateWithMap:!0}),k(this.grid,[115,115,115])}else t||(e.grid=null);else z.getLogger(this).warn("Attempting to enable grid display while view is not ready")}async startPlacement(t){const{view:e,snappingManager:i}=this;if(!e)return;this._set("interactivePlacementState",t),this._sketchedVertexCount=0;const a=new it({view:e,graphicProperties:{attributes:{[T]:T}},sketchOptions:{tooltips:{enabled:!0,visibleElements:{direction:!1,rotation:!1,totalLength:!1,elevation:!1,distance:!1,area:!1}}},geometryType:"polyline",mode:"click",snapToScene:!1,snappingManager:i,forceUniformSize:!0,centered:!1,cursor:this.interactivePlacementState==="interactive"||this.interactivePlacementState==="place"?"none":null,regularVerticesSymbol:void 0,activeVertexSymbol:ht,activeLineSymbol:R,graphicSymbol:R,automaticAreaMeasurementUtils:await at(),automaticLengthMeasurementUtils:await nt()});if(this._drawGraphicTool=a,e.addAndActivateTool(a),this._renderOverlays(),!this._keybindings){const o=new Y;o.add($.complete,()=>this._onDrawComplete()),o.add($.vertexAdd,()=>this._drawGraphicTool?.drawOperation.commitStagedVertex()),this._keybindings=o}this.addHandles([a.on("cursor-update",o=>this._onCursorUpdate(o)),a.on("complete",()=>this._onDrawComplete()),a.on("vertex-add",o=>this._onVertexAdd(o,t)),this._keybindings.register(e,Z.WIDGET)],O)}async _startGridManipulation(t){const{view:e}=this;if(!e)return void(this.interactivePlacementState=null);const i=new CustomEvent("before-placement",{cancelable:!0});this.emit("before-placement",i),i.defaultPrevented||await this.startPlacement(t)}_onCursorUpdate(t){try{if(this._isPlacing){const e=t.vertices[0].coordinates;return void this._handlePlace(e)}if(this._drawGraphicTool.cursor=null,this._isRotating&&this._handleRotate(t.vertices[0].coordinates),this._isScaling){const e=this._drawGraphicTool?.drawOperation.cursorVertex;this._handleScale(e)}}finally{this._renderOverlays()}}_onDrawComplete(){this._drawGraphicTool.cursor=null,this.interactivePlacementState=null}_onVertexAdd(t,e){const i=t.vertices[0].coordinates;this._isPlacing&&this._handlePlace(i),this._isRotating&&this._sketchedVertexCount>0&&this._handleRotate(i),this._isScaling&&this._sketchedVertexCount>0&&this._handleScale(G(i[0],i[1],void 0,this.view.spatialReference)),this._sketchedVertexCount++,this._drawGraphicTool.cursor=null,this._sketchedVertexCount!==2&&e==="interactive"||(this.interactivePlacementState=null),this._renderOverlays()}_handlePlace(t){const{grid:e,view:i}=this;e&&i&&(e.center=new C({x:t[0],y:t[1],spatialReference:i.spatialReference}))}_handleRotate(t){const{grid:e,view:i}=this;if(!e||!i)return;this._drawGraphicTool?.sketchOptions.tooltips.set("enabled",!1);const{x:a,y:o}=e.center,[l,c]=t,d=i.toScreen(e.center,{pickClosestTarget:!0}),g=d&&i.toMap(d),v=i.toScreen(G(l,c,void 0,i.spatialReference),{pickClosestTarget:!0}),p=v&&i.toMap(v),m=g?g.x:a,_=g?g.y:o,y=m-(p?p.x:l),b=_-(p?p.y:c);if(y===0&&b===0)return;const V=Math.atan2(b,y),x=F(V),E=e.rotateWithMap,A=i.viewpoint.rotation??0,D=E?x:x-A;e.rotation=Math.fround(D)%360}_handleScale(t){const{view:e,grid:i,_drawGraphicTool:a,interactivePlacementState:o,_metersPerSRUnit:l}=this;if(!(t&&e&&i&&a&&l))return;a.sketchOptions.tooltips.enabled=!1;const c=o==="interactive"?i.center:a.drawOperation.firstVertex;if(!c||!t)return;const d=e?.toScreen(c),g=d&&e.toMap(d),v=e?.toScreen(t),p=g??c,m=(v&&e.toMap(v))??t,_=Math.sqrt((p.x-m.x)**2+(p.y-m.y)**2),y=P(_*l,"meters",i.units);this.spacing=y}_renderOverlays(){this._renderCrosshairOverlay(),this._renderTextOverlay()}_renderTextOverlay(){const{grid:t,view:e,_drawGraphicTool:i}=this,a=this._getCrosshairLabel();if(!(t&&e?.overlay&&i&&a))return;const o=e.toScreen(t.center,{pickClosestTarget:!0});o&&(a.position=[o.x+12,o.y+12]),this._isRotating?(a.text=`${lt(t.rotation)}${ot}`,a.visible=!0):a.visible=!1}_renderCrosshairOverlay(){const{grid:t,view:e,_drawGraphicTool:i}=this;if(!t||!e?.overlay||!i)return;const a=this._getCrosshair();if(!a)return;const o=e.toScreen(t.center);o&&(a.x=o.x,a.y=o.y,a.rotation=t.rotateWithMap?e.viewpoint.rotation-t.rotation:-t.rotation,a.visible=!!i)}_getCrosshairLabel(){if(this._crosshairLabel)return this._crosshairLabel;const{grid:t,view:e,_drawGraphicTool:i}=this;if(!t||!e?.overlay||!i)return null;const a=new st({anchor:"top-left",fontSize:10,textColor:new u([21,21,21]),backgroundColor:new u([248,248,248]),padding:8,borderRadius:20});return e.overlay.addItem(a),this._crosshairLabel=a,a}_getCrosshair(){const{_crosshairItem:t,view:e}=this;return e?.overlay?t&&e.overlay.items.includes(t)?t:(this._crosshairItem=new h({color:e.effectiveTheme.accentColor,thickness:4,length:36,visible:!0}),e.overlay?.addItem(this._crosshairItem),this._crosshairItem):null}_resetGridPlacementState(){this.removeHandles(O),this._crosshairItem&&(this._crosshairItem.visible=!1),this._crosshairLabel&&(this._crosshairLabel.visible=!1),this._drawGraphicTool&&(this.view?.activeTool===this._drawGraphicTool&&(this.view.activeTool=null),this.view?.tools.remove(this._drawGraphicTool)),this._drawGraphicTool=S(this._drawGraphicTool)}};r([s(K)],n.prototype,"defaultUnit",void 0),r([s({readOnly:!0})],n.prototype,"displayEnabled",null),r([s()],n.prototype,"dynamicScaling",null),r([s()],n.prototype,"grid",null),r([s()],n.prototype,"gridColor",null),r([s({readOnly:!0})],n.prototype,"gridControlsEnabled",null),r([s()],n.prototype,"interactivePlacementState",null),r([s()],n.prototype,"majorLineInterval",null),r([s()],n.prototype,"rotateWithMap",null),r([s()],n.prototype,"rotation",null),r([s()],n.prototype,"snappingEnabled",null),r([s()],n.prototype,"snappingManager",void 0),r([s({type:rt})],n.prototype,"snappingOptions",void 0),r([s()],n.prototype,"spacing",null),r([s()],n.prototype,"unit",null),r([s()],n.prototype,"view",void 0),r([s({readOnly:!0})],n.prototype,"gridOutOfScale",null),r([s({readOnly:!0})],n.prototype,"effectiveSpacingAfterDynamicScaling",null),r([s({readOnly:!0})],n.prototype,"numericSpacingInputShouldBeVisible",null),r([s()],n.prototype,"placementDisabled",void 0),r([s()],n.prototype,"_metersPerSRUnit",null),r([s()],n.prototype,"_pixelsPerStride",null),r([s()],n.prototype,"_isPlacing",null),r([s()],n.prototype,"_isRotating",null),r([s()],n.prototype,"_isScaling",null),r([s()],n.prototype,"_mostRecentlyShownGrid",void 0),r([s()],n.prototype,"_sketchedVertexCount",void 0),n=r([M("esri.widgets.support.GridControls.GridControlsViewModel")],n);const R=new L({width:0}),ht=new B({color:u.fromArray([0,0,0,0]),outline:new L({color:u.fromArray([0,0,0,0])})});export{n as A,wt as n,lt as t};
