import{b2 as x,K as D,a5 as n,y as u,ap as H,jA as _,j as g,a8 as S,bH as v,x as w}from"./index-aRi8Xk-b.js";import{A as b,m as E}from"./DynamicLayerView3D-Ce1GCzcl.js";import{w as I}from"./ImageHighlightHelper3D-Blj10jmR.js";import{x as V}from"./dataUtils-BlaM2BDe.js";import{r as $}from"./FlowSubView3D-BtZYn11B.js";import{y as P}from"./ImageryLayerView-CM-viYrx.js";import"./SubView3D-C_h5NLFJ.js";import"./ImageMaterial.glsl-WcrjHHp7.js";import"./TriangleMaterial-DkjAC4as.js";import"./DefaultLayouts-D_0RpMaS.js";import"./LayerView3D-Ci5QWCAL.js";import"./LayerView-luaHV6B0.js";import"./RefreshableLayerView-Cn5M_zja.js";import"./highlightUtils-BGTt03LV.js";import"./utils-Cx8QTkBv.js";import"./loadUtils-DBazF7kv.js";import"./FeatureTileDescriptor-Dh4sU6wT.js";import"./line-BL5uCDyo.js";import"./rasterFieldUtils-ewF5JZJG.js";import"./timeSupport-DVHtDRpz.js";import"./rasterProjectionHelper-B5cSg6T6.js";import"./popupUtils-lp22Q4NK.js";let h=class extends b{constructor(e){super(e),this.redrawDebounced=x(async t=>{this.redraw((i,a)=>this._redrawImage(i,a),t)},2e3)}initialize(){this.addHandles([D(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const i=e.image,a=i.getContext("2d"),l=await this.layer.applyRenderer(e.pixelData,{signal:t}),r=this.layer.applyFilter(l).pixelBlock;if(r==null)throw new Error;i.width=r.width,i.height=r.height;const o=a.createImageData(r.width,r.height);o.data.set(r.getAsRGBA()),a.putImageData(o,0,0)}};h=n([u("esri.views.3d.layers.ImagerySubView3D")],h);let p=class extends ${constructor(e){super(e)}initialize(){this.updatingHandles.add(()=>this.renderedTiles,()=>this.triggerLoad()),this.updatingHandles.add(()=>this.elevationInfo.mode,e=>this._updatePopupDrapeSource(e),{initial:!0})}_updatePopupDrapeSource(e){if(e==="on-the-ground")return void this.removeHandles(d);if(this.hasHandles(d))return;const t={destroyed:!1,drapeSourceType:2,updatePolicy:0,layer:this.layer},i=this.layerView.view.overlayManager;i.registerGeometryDrapeSource(t),this.addHandles(H(()=>i.unregisterDrapeSource(t)),d)}async fetchDataAndGenerateStreamlines(e,t){const{needsMagnitude:i,workerHandle:a}=this,l=this.getSimulationSettings(e),{size:r,extent:o,timeExtent:c}=e;if(l==null||a==null)return;const m=await V(this.layer,o,r[0],r[1],c,t);if(m==null)return null;const y={simulationSettings:l,flowExtentInfo:e.flowExtentInfo,flowData:m,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:f}=await a.generateStreamlines(y,t);return f}};p=n([u("esri.views.3d.support.flow.FlowSubViewExtent3D")],p);const d=Symbol("popupDrapeSource");let s=class extends P(E){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add(()=>this.layer?.exportImageServiceParameters?.version,e),this._updatingHandles.add(()=>this.layer?.renderer,e),this._updatingHandles.add(()=>this.timeExtent,e),this._highlightHelper=new I({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([_(this._highlightHelper),g(()=>this.suspended,t=>this._highlightHelper.suspended=t,S)])}_initSubView(){this.addHandles([g(()=>this.layer.renderer,e=>this._recreateSubView(e),v)])}_recreateSubView(e){const t=e?.type==="flow",i=this.subView?.type==="flow",a=this.subView;a&&t===i||(this.subView=t?new p({layerView:this}):new h({layerView:this}),a?.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};n([w()],s.prototype,"highlightOptions",null),n([w()],s.prototype,"pixelData",null),s=n([u("esri.views.3d.layers.ImageryLayerView3D")],s);const Z=s;export{Z as default};
