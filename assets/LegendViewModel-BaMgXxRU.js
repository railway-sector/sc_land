const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CgzAF5Ey.js","assets/index-ni9qn0ie.css"])))=>i.map(i=>d[i]);
import{aQ as Ke,zB as Xe,df as O,au as Ye,av as X,aw as Ct,nK as Vt,rv as et,V as Ce,dh as tt,Z as it,O as Ve,bI as Ft,f as R,bJ as ne,rl as Rt,kq as Dt,d4 as zt,a0 as T,b3 as xt,fd as st,aR as te,kk as Mt,cv as Ae,oj as $t,qp as kt,qA as Tt,zC as At,qr as Ht,B as Pt,zD as Ot,aX as He,c4 as Bt,bU as Nt,_ as b,e as _,g as rt,z as Wt,o2 as qt,y as Ut}from"./index-CgzAF5Ey.js";import{e as Pe}from"./featureReductionUtils-Caulfaw_.js";import{a as Gt}from"./EffectView-B3K5O1-N.js";import{y as jt}from"./ExportImageParameters-CHuh_iLO.js";import{u as Oe}from"./pixelRangeUtils-BvOub3JO.js";import{t as Jt}from"./rendererConversion-CDc69Ii2.js";import{k as lt}from"./cimSymbolUtils-D8zbHeXT.js";import{V as j,w as Zt,l as Qt,S as Kt,L as Xt}from"./symbolUtils-0l5vVMbV.js";import{h as Fe,m as Yt,q as ei}from"./utils-BxeCvIiv.js";import{u as ae,C as A,w as nt,m as ti,i as Be,l as pe,a as ii,f as si,s as ri,b as li,r as ni,d as me,j as ge,c as ai,e as oi,g as Ne,h as ci,V as ui,t as We}from"./utils-6ht-EJRw.js";import{y as qe,u as yi}from"./gfxUtils-B1R76T6S.js";import{getSymbolLayerFill as di}from"./previewSymbol3D-xRDRpg6O.js";import{getCIMSymbolPreviewSize as hi}from"./previewCIMSymbol-Ct8s9f2u.js";import{s as fi}from"./utils-B0DWbpnl.js";const Ue={HH:315,HL:45,LL:135,LH:225},pi={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function mi(e){if(!e)return;const{type:t}=e;if(t.includes("3d"))return di(e.symbolLayers.at(0));if(t==="simple-line"){const i=qe(e);return i&&i.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const i=qe(e);return i&&i.color}return yi(e)}function gi(e,t){const i=t.HH.label,r=t.LL.label,s=t.HL.label,l=t.LH.label;switch(e){case"HH":default:return{top:i,bottom:r,left:s,right:l};case"HL":return{top:s,bottom:l,left:r,right:i};case"LL":return{top:r,bottom:i,left:l,right:s};case"LH":return{top:l,bottom:s,left:i,right:r}}}function bi(e){const{focus:t,infos:i,numClasses:r}=e,s=pi[r],l={};i.forEach(a=>{l[a.value]={label:a.label,fill:mi(a.symbol)}});const n=[];for(let a=0;a<r;a++){const o=[];for(let u=0;u<r;u++){const c=l[s[a][u]];o.push(c.fill)}n.push(o)}return{type:"relationship-ramp",numClasses:r,focus:t,colors:n,labels:gi(t,l),rotation:at(t)}}function at(e){let t=Ue[e];return e&&t==null&&(t=Ue.HH),t||0}function Li(e){switch(e){case"circle":return{rings:[[[8.5,.2],[7.06,.33],[5.66,.7],[4.35,1.31],[3.16,2.14],[2.14,3.16],[1.31,4.35],[.7,5.66],[.33,7.06],[.2,8.5],[.33,9.94],[.7,11.34],[1.31,12.65],[2.14,13.84],[3.16,14.86],[4.35,15.69],[5.66,16.3],[7.06,16.67],[8.5,16.8],[9.94,16.67],[11.34,16.3],[12.65,15.69],[13.84,14.86],[14.86,13.84],[15.69,12.65],[16.3,11.34],[16.67,9.94],[16.8,8.5],[16.67,7.06],[16.3,5.66],[15.69,4.35],[14.86,3.16],[13.84,2.14],[12.65,1.31],[11.34,.7],[9.94,.33],[8.5,.2]]]};case"square":return{rings:[[[.5,.5],[.5,16.5],[16.5,16.5],[16.5,.5],[.5,.5]]]};case"diamond":return{rings:[[[8.5,.5],[.2,8.5],[8.5,16.5],[16.5,8.5],[8.5,.5]]]};case"hexagon-pointy":return{rings:[[[15.86,12.75],[15.86,4.25],[8.5,0],[1.14,4.25],[1.14,12.75],[8.5,17],[15.86,12.75]]]};case"hexagon-flat":return{rings:[[[12.75,15.86],[17,8.5],[12.75,1.14],[4.25,1.14],[0,8.5],[4.25,15.86],[12.75,15.86]]]}}}function Re(e){return e?.type==="CIMVectorMarker"?e.markerGraphics?.[0]:void 0}function ot(e){return e?.symbol?.type==="CIMPolygonSymbol"?e.symbol.symbolLayers?.[0]:void 0}function _i(e,t){e?.type==="CIMVectorMarker"&&t!=null&&(e.size=t)}function wi(e,t){const i=Re(e);i&&t!=null&&(i.geometry=Li(t))}function vi(e,t){const i=ot(Re(e));i&&t!=null&&(i.color=t.toArray())}function Si(e,t,i){const r=ot(Re(e));r&&t!=null&&i&&(r.colorLocked=t)}function De(e,t){const{outerRingSize:i,innerDotSize:r,type:s,color:l,colorLocked:n,primitiveOverrides:a}=t,o=e.data.symbol?.type==="CIMPolygonSymbol"?e.data.symbol.symbolLayers:null;if(o?.length===2)for(const u of o){const c=u.primitiveName==="reference-size-outer-ring";_i(u,c?i:r),wi(u,s),vi(u,l),Si(u,n,c)}return i!=null&&r!=null&&(e.data.primitiveOverrides=null),a!==void 0&&(e.data.primitiveOverrides=Ke(a)),e}function Ii(e,t,i){const r=e.effectiveClusterRenderer;if(!r||!("visualVariables"in r)||!r.visualVariables)return null;const s=r.visualVariables.find(c=>c.type==="size");if(!("stops"in s)||!s.stops)return null;const l=s.stops.find(c=>c.useMinValue),n=s.stops.find(c=>c.useMaxValue);if(l==null||n==null)return null;const a=i.featuresTilingScheme.getClosestInfoForScale(i.scale).level,o=s.field,u=t.getDisplayStatistics(a,o);return u?new Xe({field:s.field,minSize:e.clusterMinSize,minDataValue:u.minValue,maxSize:e.clusterMaxSize,maxDataValue:u.maxValue}):null}const Ei="spike-height-override";function Ci(e){const{strokeColor:t,strokeWidth:i,symbolStyle:r}=e,s=r?.includes("solid-fill")||r?.includes("gradient-fill");let l=t?.toArray(),n=!1;return r?.includes("outline")&&s?n=!0:l=e.color?.toArray(),{type:"CIMSolidStroke",effects:Vi(r),enable:!0,colorLocked:n,capStyle:"Round",joinStyle:"Round",lineStyle3D:"Strip",miterLimit:4,width:i??Ye(1),color:l}}function Vi(e){if(!e?.includes("closed"))return[{type:"CIMGeometricEffectAddControlPoints",angleTolerance:90,primitiveName:"spike-control-points"},{type:"CIMGeometricEffectSuppress",suppress:!0,invert:!0,primitiveName:"spike-stroke-suppress"}]}function Ge(e){const{color:t,symbolStyle:i}=e,r=i?.includes("solid-fill"),s=i?.includes("gradient-fill");if(!r&&!s||!t)return;if(r)return{type:"CIMSolidFill",enable:!0,colorLocked:!1,color:t?.toArray()};const l=t.clone();return l.a=0,{type:"CIMGradientFill",enable:!0,angle:90,colorRamp:{type:"CIMMultipartColorRamp",colorRamps:[{type:"CIMLinearContinuousColorRamp",fromColor:t.toArray(),toColor:l.toArray()}],weights:[1]},gradientMethod:"Linear",gradientSize:70,gradientSizeUnits:"Relative",gradientType:"Continuous"}}function ct(e,t){const{defaultHeight:i,baseWidth:r,color:s,strokeColor:l,primitiveOverrides:n,symbolStyle:a,strokeWidth:o}=t,u=e.data.symbol?.type==="CIMPointSymbol"?e.data.symbol:null,c=u?.symbolLayers;if(!c)return e;const y=u.effects,C=y?.find(f=>f.type==="CIMGeometricEffectTaperedPolygon"),h=y?.find(f=>f.type==="CIMGeometricEffectRadial"&&f.primitiveName===Ei);r!=null&&C&&(C.fromWidth=r),i!=null&&h&&(h.length=i);const L=c?.find(f=>f.type==="CIMSolidStroke"),v=c?.find(f=>f.type==="CIMSolidFill"),V=c?.find(f=>f.type==="CIMGradientFill"),S=V?.colorRamp?.type==="CIMMultipartColorRamp"&&V.colorRamp.colorRamps[0]?.type==="CIMLinearContinuousColorRamp"?V.colorRamp.colorRamps[0]:null;if(a){const f=v?.color??S?.fromColor??L?.color,d=s??(f?new O(f):void 0),p=L?.color??f,m=l??(p?new O(p):void 0),w=a.includes("solid-fill"),g=a.includes("gradient-fill");if(w||g||be(c,v??V),d){if(w)be(c,V),v?v.color=d?.toArray():c.push(Ge({...t,color:d}));else if(g)if(be(c,v),V){if(S&&s){const I=d.clone();I.a=0,S.fromColor=d.toArray(),S.toColor=I.toArray()}}else c.push(Ge({...t,color:d}))}if(L){const I=Ci({...t,strokeColor:m,color:d});L.effects=I.effects,L.color=I.color,L.width=I.width,L.colorLocked=I.colorLocked}}else if(L&&(l&&(L.color=l.toArray()),o!=null&&(L.width=o)),v&&s&&(v.color=s.toArray()),S&&s){const f=s.clone();f.a=0,S.fromColor=s.toArray(),S.toColor=f.toArray()}return n!==void 0&&(e.data.primitiveOverrides=Ke(n)),e}function be(e,t){if(!t)return;const i=e.indexOf(t);i!==-1&&e.splice(i,1)}const ve=30,Se=12,Ie=24,ut=[255,255,255],oe=[200,200,200],q=[128,128,128],Fi=20,Ri=5;function Di(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function zi(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function xi(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function Mi(e){return e.declaredClass==="esri.symbols.TextSymbol"}function $i(e,t){const i=e.length-1;return e.map((r,s)=>ti(r,s,i,t))}async function ki(e,t,i,r,s,l,n){const a=t.legendOptions,o=a?.customValues,u=n||await Hi(e,i),c=t.stops,y=!!u,C=!!o,h=t.minSize!=null&&t.maxSize!=null,L=c&&c.length>1,v=!!t.target;if(!y||!C&&!(h||L&&!v))return;const V=Fe(u);let S=!1,f=null,d=null;f=V&&!L?ae([t.minDataValue,t.maxDataValue]):o??await Oi(t,u,r,s?.type);const p=e?.authoringInfo,m=p?.type==="univariate-color-size",w=m&&p?.univariateTheme==="above-and-below",g=!!A(e,"reference-size"),I=!!A(e,"spike");if(!f&&L&&(f=c.map(z=>z.value),S=c.some(z=>!!z.label),e.type==="flow"&&(f=ae(f)),S&&(d=c.map(z=>z.label))),V&&f!=null&&f?.length>2&&!w&&(f=[f[0],f[f.length-1]]),!f)return null;m&&f?.length!==5&&(f=ht({minSize:f[0],maxSize:f[f.length-1]}));const E=V?Ti(e,f):null,D=Yt(u),H=S?null:$i(f,l);return(await Promise.all(f.map(async(z,x)=>{let $=V?E[x]:await Q(t,u,z,r,s?.type),k=$;g&&($*=Ie/t.maxSize||1,k=Ie);const U=Wi(u,$,e,x);return I&&U.type==="cim"&&(k=await hi(U)),{value:z,symbol:U,label:S?d[x]:H[x],size:k,outlineSize:D}}))).reverse()}function Ti(e,t){const i=e?.authoringInfo,r=i?.type==="univariate-color-size";let s=[Se,ve];if(r){const l=t[0],n=t[t.length-1],a=Se,o=ve;s=t.map(u=>a+(u-l)/(n-l)*(o-a))}return r&&i?.univariateTheme==="below"&&s.reverse(),s}function Ai(e,t){const i=e.classBreakInfos,r=i.length,s=r<2||!(t>=2)?i[0].symbol.clone():i[r-1].symbol.clone();return e.visualVariables?.some(n=>n.type==="color")&&(s.type.includes("3d")?yt(s):dt(s)),s}async function Hi(e,t){if(e.type==="flow")return nt(e,t);if(e.type==="pie-chart")return new X({color:null,outline:e.outline?.width?e.outline:new Ct});let i=null,r=null;if(e.type==="simple")i=e.symbol;else if(e.type==="class-breaks"){const s=e.classBreakInfos;i=s&&s[0]&&s[0].symbol,r=s.length>1}else if(e.type==="unique-value"){const s=e.uniqueValueInfos;i=s?.[0]?.symbol,r=s!=null&&s.length>1}if(!i||Pi(i))return null;if(i=i.clone(),t||r)if(i.type.includes("3d"))yt(i);else if(A(e,"reference-size")&&i.type==="cim")De(i,{color:t??(e.type!=="class-breaks"?new O(oe):null)});else if(A(e,"spike")&&i.type==="cim"){const s=new O(oe),l=new O(q),n=i.data.symbol?.type==="CIMPointSymbol"?i.data.symbol:null,a=!!n?.symbolLayers?.find(({type:c})=>c==="CIMSolidStroke")?.colorLocked;let o,u=t??void 0;if(u){const c=Vt(u),y=et();(!y&&c>225||y&&c<25)&&(u=s,o=a?l:s)}else u=s,o=a?l:s;ct(i,{color:u,strokeColor:o})}else dt(i);return i}function Pi(e){return tt(e)?e.symbolLayers?.some(t=>t?.type==="fill")??!1:e?.type.includes("fill")??!1}function yt(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:q}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource?.href?t.material={color:oe}:(t.material={color:ut},t.outline={color:q,size:1.5})})}function dt(e){const t=et();e.type==="cim"?lt(e,new O(oe)):e.type.includes("line")?e.color=q:(e.color=t?q:ut,e.type==="simple-marker"&&(e.outline?e.outline?.color?.toHex()==="#ffffff"&&(e.outline.color=q):e.outline={color:q,width:1.5}))}async function Oi(e,t,i,r){const s=(await Ce(async()=>{const{getSizeRangeAtScale:a}=await import("./index-CgzAF5Ey.js").then(o=>o.ML);return{getSizeRangeAtScale:a}},__vite__mapDeps([0,1]))).getSizeRangeAtScale(e,i,r),l=s&&ht(s);if(!s||!l)return;let n=l.map(a=>Bi(a,e,s));n=ae(n);for(let a=1;a<n.length-1;a++){const o=await Ni(e,t,n[a],n[a-1],i,r);o&&(n[a]=o[0],l[a]=o[1])}return n}function ht(e){const t=e.minSize,i=e.maxSize,r=Ri,s=(i-t)/(r-1),l=[];for(let n=0;n<r;n++)l.push(t+s*n);return l}function Bi(e,t,i){const r=i.minSize,s=i.maxSize,l=t.minDataValue,n=t.maxDataValue;let a;return e<=r?a=l:e>=s?a=n:a=(e-r)/(s-r)*(n-l)+l,a}async function Ni(e,t,i,r,s,l){const n=await Q(e,t,i,s,l),a=await Q(e,t,r,s,l),o=Be(i),u=o.fractional,c=Fi;let y=o.integer,C=null,h=null;i>0&&i<1&&(C=10**u,y=Be(i*=C).integer);for(let L=y-1;L>=0;L--){const v=10**L;let V=Math.floor(i/v)*v,S=Math.ceil(i/v)*v;C!=null&&(V/=C,S/=C);let f=(V+S)/2;[,f]=ae([V,f,S],{indexes:[1]});const d=await Q(e,t,V,s,l),p=await Q(e,t,S,s,l),m=await Q(e,t,f,s,l),w=pe(n,d,a,null),g=pe(n,p,a,null),I=pe(n,m,a,null);let E=w.previous<=c,D=g.previous<=c;if(E&&D&&(w.previous<=g.previous?(E=!0,D=!1):(D=!0,E=!1)),E?h=[V,d]:D?h=[S,p]:I.previous<=c&&(h=[f,m]),h)break}return h}async function Q(e,t,i,r,s){const{getSize:l}=await Ce(()=>import("./index-CgzAF5Ey.js").then(n=>n.ML),__vite__mapDeps([0,1]));return l(e,i,{scale:r,view:s,shape:t.type==="simple-marker"?t.style:null})}function Wi(e,t,i,r){i?.authoringInfo?.type==="univariate-color-size"&&i?.authoringInfo?.univariateTheme==="above-and-below"&&i.type==="class-breaks"&&(e=Ai(i,r));const s=e.clone();if(tt(s))Fe(s)||s.symbolLayers.forEach(l=>{l.type!=="fill"&&(l.size=t)});else if(Di(s))s.size=t;else if(zi(s)){const l=s.width,n=s.height;s.height=t,s.width=t*(l/n)}else xi(s)?s.width=t:Mi(s)?s.font&&(s.font.size=t):s.type==="cim"&&A(i,"reference-size")?De(s,{innerDotSize:t,outerRingSize:Ie}):s.type==="cim"&&A(i,"spike")&&ct(s,{defaultHeight:t,primitiveOverrides:null});return s}const je=16,qi="https://utility.arcgis.com/sharing/tools/legend",Ui="esri.layers.ImageryLayer",Gi="esri.layers.ImageryTileLayer",ji="esri.layers.WCSLayer",se=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Ji=new zt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),re=new X({size:6,outline:{color:[128,128,128,.5],width:.5}}),Zi=new st({style:"solid"});function Ee(e){return e.type==="flow"}function ft(e){return e.type==="vector-field"}function pt(e){return e.type==="raster-colormap"}function mt(e){return e.type==="raster-stretch"}function gt(e){return e.type==="raster-shaded-relief"}function K(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function N(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function W(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function bt(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function Qi(e){return ze(e)||xe(e)||Me(e)||Ki(e)}function Ki(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function ze(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function xe(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function Me(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Lt(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function _t(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function Xi(e,t){return K(e)||N(e)||W(e)||bt(e)||Lt(e)||_t(e)?t.type==="2d"||Jt(e):mt(e)||pt(e)||gt(e)||ze(e)||xe(e)||Me(e)||ft(e)||Ee(e)}function Yi(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function Le(e){return e.declaredClass==="esri.layers.SubtypeGroupLayer"}function es(e){return e.declaredClass==="esri.layers.VoxelLayer"}function ts(e){return e.declaredClass==="esri.layers.WMSLayer"}function is(e){return e.declaredClass==="esri.layers.WMTSLayer"}function _e(e){return e.declaredClass==="esri.layers.MapImageLayer"}function Je(e){return e.declaredClass==="esri.layers.TileLayer"}function J(e){return e.declaredClass===Ui}function le(e){return e.declaredClass===Gi}function ss(e){return e.declaredClass===ji}function rs(e){return e.type==="stretch-ramp"}function ls(e){return("authoringInfo"in e?e?.authoringInfo:null)?.type==="univariate-color-size"}function ns(e){const t="authoringInfo"in e?e?.authoringInfo:null;return t?.type==="univariate-color-size"&&t?.univariateTheme==="above-and-below"}function Ze(e){return"sublayers"in e}function Qe(e){return e&&"symbol"in e}function as(e,t){const{field:i,field2:r,field3:s,fieldDelimiter:l,valueExpression:n}=e;if(!i)return null;const a=!i&&!n||!r&&!s?[t]:t?.toString().split(l||""),o=i?{[i]:a?.[0]}:null;return o&&(r&&(o[r]=a?.[1]),s&&(o[s]=a?.[2])),o}const os=new X({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Z={};const we=new WeakMap;let F=class extends it{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._loading=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._clusterSizeVariable=null,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilter=null,this._layerDisplayFilterClause=null,this.children=new Ve,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this.addHandles([Ft(()=>this.children,"change",t=>{const{added:i,removed:r}=t;i.forEach(s=>{const l=`activeLayerInfo-ready-watcher-${s.layer.uid}`;this.addHandles(R(()=>s.ready,e,ne),l)}),r.forEach(s=>this.removeHandles(s.layer.uid)),e()})]),this.keepCacheOnDestroy||(Z={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Z=null),this._layerDefinitionExpressionClause=null}get cssEffectFilter(){const{layer:e,scale:t}=this,i="effect"in e?e.effect:null;if(!i)return null;const r=new Gt({effect:i});return r.endTransition(),r.scale=t,ei(r)}get loading(){return this.children.length>0?this.children.some(e=>e.loading):this._loading}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,i=this.layer.parent,r=i&&"uid"in i?this._getParentLayerOpacity(i):null;return t!=null?t*e:r!=null?r*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?!!("displayFilterInfo"in e&&e.displayFilterInfo&&W(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(this._loading=!0,!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],this._loading=!1,void this.notifyChange("ready");const t=Array.from(e,i=>{if(Rt(i))return this._getRendererLegendElements(i.renderer,{title:i.title});if(i.featureSet?.features.length){const r=i.layerDefinition,s=r?.drawingInfo,l=s&&Dt(s.renderer),n=Ji.read(r.geometryType);return l?this._getRendererLegendElements(l,{title:i.name,geometryType:n}):(T.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const i=[],r=await Promise.allSettled(t);for(const s of r)if(s.status==="fulfilled")for(const l of s.value??[])i.push(l);this.legendElements=i}catch(i){T.getLogger(this).warn("error while building legend for layer!",i)}finally{this._loading=!1,this.notifyChange("ready")}}async buildLegendElementsForRenderer(e){try{this._loading=!0;const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[]}catch(t){T.getLogger(this).warn("error while building legend for layer!",t)}finally{this._loading=!1,this.notifyChange("ready")}}async buildLegendElementsForFeatureReduction(e){try{this._loading=!0,await this._waitForLayerViewUpdate(this.layerView);const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[]}catch(t){T.getLogger(this).warn("error while building legend for layer!",t)}finally{this._loading=!1,this.notifyChange("ready")}}async buildLegendElementsForTools(){this._loading=!0;const e=this.layer;if(es(e))await this._constructLegendElementsForVoxelLayer();else if(is(e))this._constructLegendElementsForWMTSlayer();else if(ts(e))await this._constructLegendElementsForWMSSublayers();else if(Yi(e))await this._constructLegendElementsForBuildingSceneLayer();else if(_e(e)||Je(e)||Le(e))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";if(J(e)&&(t=(e?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")),le(e)||e.type==="link-chart")return;await this._getLegendLayers(`${e.uid}-${t}`).then(async i=>{this.legendElements=[];const r=i.map(async s=>{if(J(e)){const n=R(()=>[e.rasterFunction,e.bandIds],()=>xt(async()=>{Z.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this.addHandles(n,"imageryLayers-watcher")}const l=this._generateSymbolTableElementForLegendLayer(s);l?.infos.length&&(J(e)&&(l.title=e.title),this.legendElements.push(l))});await Promise.allSettled(r)}).catch(i=>{T.getLogger(this).warn("Request to server for legend has failed!",i)})}this._loading=!1,this.notifyChange("ready")}async _isLayerInCurrentView(e){return this._checkFeatureCountForExpression(e,this.view.extent)}_getParentLayerOpacity(e){let t=1;const i=e.parent;return i&&"uid"in i&&(t=this._getParentLayerOpacity(i)),e.opacity*t}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;const t="valueExpression"in e?e.valueExpression:null;return se.test(t)?!0:!!("visualVariables"in e?e.visualVariables:null)?.some(r=>this._isScaleDrivenSizeVariable(r))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case"simple":return this._isScaleDrivenSymbol(e.symbol);case"class-breaks":return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(t=>this._isScaleDrivenSymbol(t.symbol));case"unique-value":return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(t=>this._isScaleDrivenSymbol(t.symbol))}return!1}_isScaleDrivenSymbol(e){if(e?.type==="cim"){const{primitiveOverrides:t,minScale:i,maxScale:r}=e.data,s=t?.some(l=>(l.valueExpressionInfo?.expression||"").includes("$view.scale"))??!1;return i!=null||r!=null||s}return!1}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,i=t.minSize,r=t.maxSize;return!(typeof i!="object"||!i||!this._isScaleDrivenSizeVariable(i))||!(typeof r!="object"||!r||!this._isScaleDrivenSizeVariable(r))||se.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(i=>this._isLayerScaleDriven(i));const t=e.parent;if(e.loaded===!1&&t&&_e(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const i of t.sourceJSON.layers??[])if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxelLayer(){this._loading=!0,this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");const e=this.layer;this.addHandles(R(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),"voxel-current-variable"),this.addHandles(R(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),"voxel-style-watcher");const t=e.getVariableStyle(null),i=[];if(t){if(t.uniqueValues?.length){const r=[];t.uniqueValues.forEach(s=>{s.enabled&&r.push({label:s.label||`${s.value}`,value:s.value,symbol:new st({color:s.color,outline:null})})}),r.length&&i.push({type:"symbol-table",title:t.label,infos:r})}else if(t.transferFunction){const{colorStops:r,stretchRange:s}=t.transferFunction,l=r.toArray().reverse(),n=s.map((o,u)=>`${u===0?ii:si} ${fi(o)}`).reverse(),a=l.map(o=>({color:o.color,value:null,label:null}));a[0].label=n[0],a[a.length-1].label=n[1],i.push({type:"color-ramp",title:t.label,infos:a,preview:j(l.map(o=>o.color))})}}await this._generatePreviewsForLegendElements(i,{opacity:e.opacity}),this.legendElements=i,this._loading=!1,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this._loading=!0,this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const e=this.layer.activeLayer;this.addHandles(R(()=>{const{layer:i}=this;return i&&"activeLayer"in i&&i.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");const t=e.styleId?e.styles?.find(({id:i})=>i===e.styleId)?.legendUrl:void 0;t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}]),this._loading=!1,this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this._loading=!0,this.legendElements=[],this.removeHandles("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(R(()=>{const{layer:i}=this;return i&&"sublayers"in i&&i.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this._loading=!1,this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const i=this.layer,r=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const s=this.sublayerIds?.map(n=>i.findSublayerById(n))?.filter(te)??[],l=s.length?s:e.toArray();for(const n of l){const a=R(()=>[n.title,n.visible,n.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(a,"wms-sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled){const o=await this._generateSymbolTableElementForWMSSublayer(n,t);o?.infos.length&&r.unshift(o)}}return r}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const i=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(r=>r);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let i=e.legendUrl;if(!i)return;const r={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(i=Mt(i,t));let s=null;const l=e.layer?.opacity;try{s=(await Ae(i,{responseType:"image"})).data,s&&(s.style.opacity=l)}catch{}return r.infos.push({src:i,preview:s,opacity:l}),r}_getLegendLayers(e,t){const i=Z&&Z[e];return i?Promise.resolve(i):this._legendRequest(t).then(r=>{const s=r.layers;return Z[e]=s,s})}_legendRequest(e){const t=this.layer;let i={f:"json",dynamicLayers:e};if(J(t)){const s=t.exportImageServiceParameters.rasterFunction;if(s&&(i.renderingRule=JSON.stringify(s.functionDefinition?.toJSON()||s.toJSON())),t.bandIds&&(i.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:l,viewId:n,customParameters:a}=t;i={raster:l,viewId:n,...i,...a}}}let r=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){const s=r.indexOf("?");s>-1?r=r.slice(0,s)+"/legend"+r.slice(s):r+="/legend"}else{const s=r.toLowerCase().indexOf("/rest/"),l=s===-1?r:r.slice(0,s)+r.slice(s+5);r=qi+"?soapUrl="+encodeURI(l)+"&returnbytes=true"}return Ae(r,{query:i}).then(s=>s.data)}async _constructLegendElementsForBuildingSceneLayer(){this._loading=!0,this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;this.addHandles(R(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity)}catch(t){T.getLogger(this).warn("Request to server for legend has failed!",t)}finally{this._loading=!1,this.notifyChange("ready")}}async _generateLegendElementsForBuildingSublayers(e,t){let i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const r=e.toArray();for(const s of r){const l=R(()=>["renderer"in s&&s.renderer,s.opacity,s.title,s.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(l,"sublayers-watcher"),!this.respectLayerVisibility||s.visible){const n=s?.opacity!=null?s.opacity:null,a=n!=null?n*t:t;if(s.type==="building-group"){const o={type:"symbol-table",title:s.title,infos:[]},u=await this._generateLegendElementsForBuildingSublayers(s.sublayers,a);o.infos.push(...u),i=[o,...i]}else s.renderer&&(i=[...await this._getRendererLegendElements(s.renderer,{title:s.title,opacity:a,sublayer:s}),...i])}}return i.filter(s=>!!s&&(!("infos"in s)||!s.infos||s.infos.length>0))}async _constructLegendElementsForSublayers(){this._loading=!0,this.removeHandles("sublayers-watcher");const e=this.layer;if(!(_e(e)||Je(e)||Le(e))||this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())return this.legendElements=[],this._loading=!1,void this.notifyChange("ready");this.addHandles(R(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity)}catch(t){T.getLogger(this).warn("Request to server for legend has failed!",t)}finally{this._loading=!1,this.notifyChange("ready")}}async _generateLegendElementsForSublayers(e,t,i){const r=this.layer;let s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let l=e.toArray();!i&&this.sublayerIds&&this.sublayerIds.length&&(l=Le(r)?this.sublayerIds.map(n=>r.findSublayerForSubtypeCode(n)).filter(te):this.sublayerIds.map(n=>r.findSublayerById(n)).filter(te));for(const n of l){const a=R(()=>[n.renderer,n.opacity,n.title,n.visible,n.legendEnabled],()=>this._constructLegendElementsForSublayers());this.addHandles(a,"sublayers-watcher");const o=n.createQuery().where,u=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView(o),c=!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n);if(u&&c){const y=n?.opacity!=null?n.opacity:null,C=y!=null?y*t:t,h=!Ze(n)||n.originIdOf("renderer")>2&&!n.sublayers;if(n.renderer&&h)await n.load(),s=[...await this._getRendererLegendElements(n.renderer,{title:n.title,opacity:C,sublayer:n}),...s];else if(Ze(n)){const L=await this._generateSymbolTableElementForSublayer(n,C,i);L&&s.unshift(L)}}}return s.filter(n=>!!n&&(!("infos"in n)||!n.infos||n.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,i){if(!i){i=new Map;const s=this.layer,l=e.source;let n=null;if(!(!l||l.type==="map-layer"&&l.mapLayerId===e.id&&(!l.gdbVersion||l.gdbVersion===("gdbVersion"in s&&s.gdbVersion)))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("labelsVisible")>2){const o=new jt({layer:this.layer});n=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const a=n||`${s.uid}-default`;(await this._getLegendLayers(a,n)).forEach(o=>i.set(o.layerId,o))}const r=i.get(e.id);if((!r||r?.subLayerIds&&r.defaultVisibility)&&e.sublayers){const s=await this._generateLegendElementsForSublayers(e.sublayers,t,i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}_generateSymbolTableElementForLegendLayer(e,t,i){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=t?.renderer;let s=t?.title||e.layerName;if(r&&(!t||t?.originIdOf("renderer")>2)){const a=t?.title||this._getRendererTitle(r,t);a&&(s&&typeof a!="string"&&"title"in a&&(a.title=s),s=a)}const l={type:"symbol-table",title:s,legendType:e.legendType||null,infos:[]},n=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(a=>{const o={type:"symbol-table",title:a.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(n.filter(u=>u.groupId===a.id),e.layerId,a.heading||l.title||t?.title,i)};o.infos?.length>0&&l.infos.push(o)}):l.infos=this._generateSymbolTableElementInfosForLegendLayer(n,e.layerId,l.title||t?.title,i),l.infos.length>0?l:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i,r){return e.map(s=>{let l=s.url;if(s.imageData&&s.imageData.length>0)l=`data:image/png;base64,${s.imageData}`;else{if(l.startsWith("http"))return null;l=$t(`${this.layer.url}/${t}/images/${l}`)}let n=s.label;return n==="<all other values>"&&(n="others"),{previewAriaLabel:n||i,label:n,src:l,opacity:r??this.opacity,width:s.width,height:s.height}}).filter(te)}_isSublayerInScale(e){const t=e.minScale||0,i=e.maxScale||0;return!(t>0&&t<this.scale||i>this.scale)}_isLegendLayerInScale(e,t){const i=t||this.layer;let r=null,s=null,l=!0;return!i.minScale&&i.minScale!==0||!i.maxScale&&i.maxScale!==0?(e.minScale===0&&i.tileInfo&&(r=i.tileInfo.lods[0].scale),e.maxScale===0&&i.tileInfo&&(s=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(r=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,s=Math.max(i.maxScale,e.maxScale)),(r>0&&r<this.scale||s>this.scale)&&(l=!1),l}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||e.length===0)return e;const i=t.renderer,r=e.some(n=>n.values);let s=0,l=null;return r&&e.some((n,a)=>(n.values||(s=a,l=n,l.label||(l.label="others")),l!=null)),i?i.type==="unique-value"?l&&(e.splice(s,1),e.push(l)):i.type==="class-breaks"&&(l&&e.splice(s,1),i.legendOptions?.order||e.reverse(),l&&e.push(l)):l&&(e.splice(s,1),e.push(l)),e}async _getRendererLegendElements(e,t={}){if(!Xi(e,this.view))return T.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(Qi(e))return this._constructPointCloudRendererLegendElements(e,t);if(Lt(e))return this._constructDotDensityRendererLegendElements(e);const i=await this._loadRenderer(e);return _t(i)?this._constructPieChartRendererLegendElements(i):this._constructRendererLegendElements(i,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return e.type==="binning"?t=e.renderer:e.type==="cluster"&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t,{isFeatureReductionRenderer:!0}):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}async _constructPointCloudRendererLegendElements(e,t={}){const i=t.title,r=[];let s=null,l=null;if(ze(e))s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(n=>{s.infos.unshift({label:n.label||n.minValue+" - "+n.maxValue,value:[n.minValue,n.maxValue],symbol:this._getAppliedCloneSymbol(re,n.color)})});else if(xe(e)){const n=e.stops;let a=null;if(n?.length&&(n.length===1&&(a=n[0].color),!a)){const u=n[0].value,c=n[n.length-1].value;u!=null&&c!=null&&(a=ri(u+(c-u)/2,n))}s={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(re,a||re.color)}]};const o=li(e.stops??[])??[];l={type:"color-ramp",title:i||this._getPointCloudRendererTitle(e),infos:o,preview:j(o.map(u=>u.color))}}else Me(e)&&(s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(n=>{s.infos.push({label:n.label||n.values.join(", "),value:n.values.join(", "),symbol:this._getAppliedCloneSymbol(re,n.color)})}));return s?.infos.length&&r.push(s),l?.infos.length&&r.push(l),await this._generatePreviewsForLegendElements(r,{opacity:this.opacity,symbolConfig:{applyColorModulation:!!e.colorModulation}}),r}async _getElementInfoForDotDensity(e,t){const{color:i,label:r,valueExpressionTitle:s}=t,{backgroundColor:l,outline:n,dotSize:a}=e,o=this.cssEffectFilter,u=a+"-"+i+"-"+l+"-"+(n&&JSON.stringify(n.toJSON()))+"-"+o,c=this._dotDensityUrlCache,y=c.has(u)?c.get(u):Zt(e,i);c.set(u,y);const C={shape:{type:"image",x:0,y:0,width:y.width,height:y.height,src:y.src},fill:null,stroke:null,offset:[0,0]},h=Qt([[C]],[y.width,y.height],{cssEffectFilter:this.cssEffectFilter});return{opacity:1,src:y.src,preview:h,width:y.width,height:y.height,previewAriaLabel:r||s}}async _constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),i=e.legendOptions?.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:i||""},infos:[]};for(const s of e.attributes){const l=await this._getElementInfoForDotDensity(e,s);l.label=s.label||s.valueExpressionTitle||s.field,r.infos.push(l)}return[r]}async _constructPieChartRendererLegendElements(e){const t=[];let i=null;const r=e.outline;e.attributes.forEach(n=>{const a=new X({color:n.color,outline:r}),o=n.label||n.valueExpressionTitle||n.field;t.push({label:o,symbol:a})});const s=t.length?[...t]:[];if(e.othersCategory?.color&&e.othersCategory?.threshold!==0){const n=new X({color:e.othersCategory.color,outline:r});i=e.othersCategory.label||"Other",t.push({label:i,symbol:n})}if(e.defaultColor?.a){const n=new X({color:e.defaultColor,outline:r});t.push({label:e.defaultLabel,symbol:n})}const l=await this._getVisualVariableLegendElements(e,this.layer)||[];if(t.length){l.unshift({type:"symbol-table",title:null,infos:t});const n=s.filter(o=>o.label!==i).map(o=>o.symbol.color).filter(Boolean),a=Kt(n,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,cssEffectFilter:this.cssEffectFilter,outline:r});l.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:t,preview:a})}return await this._generatePreviewsForLegendElements(l,{opacity:this.layer.opacity,cssEffectFilter:this.cssEffectFilter}),l}async _getWhereClause(e,t,i){const r=await kt(e,i),s=new Set,{field:l,field2:n,field3:a}=t;Tt(s,i,[l,n,a]),await At(s,i,null,t.valueExpression);const o=new Set(Array.from(s,c=>c.toLowerCase()));return r?.fieldNames.map(c=>c.toLowerCase())?.some(c=>!o.has(c))?null:r}async _processDefinitionExpression(e,t){if(!("definitionExpression"in e))return;const i=e.definitionExpression;i&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==i&&(this._layerDefinitionExpressionClause=await this._getWhereClause(i,t,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=i}async _processDisplayFilter(e,t){if(!("displayFilterInfo"in e))return;const i=e.displayFilterInfo?Ht(e.displayFilterInfo,this.view):null;return i?.where?this._layerDisplayFilter?.id!==i?.id&&(this._layerDisplayFilterClause=await this._getWhereClause(i.where,t,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilter=i,i}async _constructRendererLegendElements(e,t={}){const{title:i,sublayer:r,isFeatureReductionRenderer:s}=t,l=r||this.layer,n=A(e,"reference-size"),a=A(e,"spike"),o=s&&"renderer"in l&&l.renderer?l.renderer:e;let u=null;W(o)&&(await this._processDefinitionExpression(l,o),u=await this._processDisplayFilter(l,o)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const c=await this._getVisualVariableLegendElements(e,l)||[],y={type:"symbol-table",title:i||this._getRendererTitle(e,l),infos:[]};let C=null,h=!1;const L=new Set;if(Ee(e)&&!this._hasSizeRamp){const d=await nt(e);y.infos.push({label:null,symbol:d})}else if(ls(e)){let d=i;const p=ns(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",m=c.findIndex(D=>D.type==="color-ramp"),w=m!==-1?c.splice(m,1)[0]:null,g=c.findIndex(D=>D.type==="size-ramp"),I=g!==-1?c.splice(g,1)[0]:null,E=[];w&&(d=w.title,E.push(w)),I&&(d=I.title,E.push(I)),E.length>0&&c.push({type:p,title:d,infos:E})}else if(bt(e)){const d=ni(e);c.push({type:"heatmap-ramp",title:i||this._getRendererTitle(e,l),infos:d,preview:j(d.map(p=>p.color),{cssEffectFilter:this.cssEffectFilter})})}else if(W(e)){const d=e.authoringInfo;if(d&&d.type==="relationship"){const{numClasses:p,field1:m,field2:w}=d,g=d.focus;if(p&&m&&w){const I=[m,w];let E=at(g)||0;for(const H of I){const{field:P,normalizationField:z,label:x}=H,$=x||{field:this._getFieldAlias(P,l),normField:z&&this._getFieldAlias(z,l)},k=os.clone();k.angle=E,y.infos.push({label:$,symbol:k}),L.add(k),E+=90}const D=bi({focus:g,numClasses:p,infos:e.uniqueValueInfos??[]});c.unshift(D)}}else if(J(this.layer)||le(this.layer)){const{uniqueValueInfos:p}=e;if(p)for(const m of p)m.symbol&&await this._checkClausesForUVR(o,m.value)&&y.infos.push({label:m.label||m.value,value:m.value,symbol:m.symbol})}else{const{field:p,field2:m,field3:w,fieldDelimiter:g,valueExpression:I,defaultSymbol:E}=e,D=!(!p&&!I||!m&&!w),H=u?u.title:null,P=[],{uniqueValueGroups:z}=e;if(z)for(const x of z){const $={type:"symbol-table",title:H||x.heading,infos:[]},{classes:k}=x;if(k)for(const U of k){const{symbol:$e,values:Et}=U;if($e){const ce=[],ke=[];for(const G of Et??[]){const{value:de,value2:he,value3:fe}=G,ee=[],ie=[];(p||I)&&(ee.push(de),ie.push(this._getDomainName(p,de,l)??me(de,ge(l,p,this.view.timeZone)))),m&&(ee.push(he),ie.push(this._getDomainName(m,he,l)??me(he,ge(l,m,this.view.timeZone)))),w&&(ee.push(fe),ie.push(this._getDomainName(w,fe,l)??me(fe,ge(l,w,this.view.timeZone)))),ce.push(D?ee.join(g||""):ee[0]),ke.push(ie.join(" - "))}const Te=ce.join(", ");let ue=U.label;if(!ue){const G=ke.filter(Boolean);ue=G.length?G.join(", "):Te}let Y=$e;Y.type==="cim"&&n&&(Y=Y.clone(),De(Y,{innerDotSize:.5*je,outerRingSize:je}));let ye=!1;for(const G of ce)if(ye=await this._checkClausesForUVR(o,G),ye)break;ye&&$.infos.push({label:ue,value:Te,symbol:Y})}}$.infos.length&&P.push($)}if(P.length){const x=P[0];if(P.length===1&&"title"in x&&!x.title){const $=x.infos?.filter(Qe)??[];y.infos.push(...$)}else E&&(P.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:E}]}),h=!0),y.infos.push(...P);i||e.legendOptions?.title||e.valueExpressionTitle||(y.title=null)}}e.defaultSymbol&&!h&&(y.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),h=!0)}else if(N(e)){if(!n&&!a){if(C=this._isUnclassedRenderer(e),!C||!this._hasSizeRamp){const d=e.classBreakInfos.filter(({symbol:m})=>m),p=e.legendOptions?.order==="ascending-values";for(const{label:m,minValue:w,maxValue:g,symbol:I}of d){const E=m||(C?null:`${w} - ${g}`),D={previewAriaLabel:E||y.title||l.title,label:E,value:[w,g],symbol:I};p?y.infos.push(D):y.infos.unshift(D)}C&&(y.title=null),this._updateInfosForClassedSizeRenderer(e,y.infos)}e.defaultSymbol&&!C&&(y.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),h=!0)}}else if(mt(e))if(le(this.layer)||ss(this.layer)){const d=await this._constructTileImageryStretchRendererElements(e);rs(d)?c.push(d):y.infos=d}else{const d=this.layer;let p,m;e.customStatistics?.length&&({min:p,max:m}=e.customStatistics[0]);let w=[],g=d.serviceRasterInfo;if(d.rasterFunction)try{g=await d.generateRasterInfo(d.rasterFunction)}catch{}const I=Oe(g.pixelType);if(g.bandCount===1){const E=d.bandIds?.[0]||0;p=p??(g.statistics?g.statistics[E].min:I[0]),m=m??(g.statistics?g.statistics[E].max:I[1]),p||m?c.push(await this._getStretchLegendElements(e,{min:p,max:m})):this._getServerSideLegend()}else if(d.bandIds&&d.bandIds.length===1)p=p??(g.statistics?g.statistics[d.bandIds[0]].min:I[0]),m=m??(g.statistics?g.statistics[d.bandIds[0]].max:I[1]),p||m?c.push(await this._getStretchLegendElements(e,{min:p,max:m})):this._getServerSideLegend();else if(g.bandCount>=3){const{bandInfos:E}=g,{bandIds:D}=d;E.length>=g.bandCount?D?.length===3?(w=D.map(H=>E[H].name),y.infos=this._createSymbolTableElementMultiBand(w)):d.format==="lerc"?(w=[0,1,2].map(H=>E[H].name),y.infos=this._createSymbolTableElementMultiBand(w)):this._getServerSideLegend():d.format==="lerc"?(w=["band1","band2","band3"],y.infos=this._createSymbolTableElementMultiBand(w)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(pt(e))e.colormapInfos.forEach(d=>{y.infos.push({label:d.label,value:d.value,symbol:this._getAppliedCloneSymbol(Zi,d.color)})});else if(K(e)){let d=e.symbol;switch(t.geometryType){case"point":d="pointSymbol"in l?l.pointSymbol:null;break;case"polyline":d="lineSymbol"in l?l.lineSymbol:null;break;case"polygon":d="polygonSymbol"in l?l.polygonSymbol:null}const p=this._clusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&p&&y.infos.push({previewAriaLabel:e.label||y.title||l.title,label:e.label,symbol:d})}else if(ft(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),y.title=e.attributeField;const d=e.getClassBreakInfos();d?.length?d.forEach(p=>{y.infos.push({label:p.minValue+" - "+p.maxValue,symbol:p.symbol})}):y.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else gt(e)&&c.push(await this._getStretchLegendElements(e,{min:0,max:255}));const v=e.defaultSymbol;!v||h||K(e)||C&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||c.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:v}]}),y.infos.length&&c.unshift(y);const V=t.opacity==null?this.opacity:t.opacity,S=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),f=J(this.layer)||le(this.layer);return await this._generatePreviewsForLegendElements(c,{opacity:V,symbolConfig:{isTall:S,isSquareFill:f},cssEffectFilter:this.cssEffectFilter},{arrowMarkerSymbols:L}),e=null,c}async _waitForLayerViewUpdate(e){await Pt(()=>!e.updating)}async _checkFeatureCountForExpression(e,t){const i=this.layerView;if(!(i&&"createQuery"in i&&"queryFeatureCount"in i))return!0;try{await this._waitForLayerViewUpdate(i);const r=i.createQuery();return e&&(r.where=ai(r.where,e)),t&&(r.geometry=t),await i.queryFeatureCount(r)>0}catch{return!0}}async _checkClausesForUVR(e,t){const i=as(e,t);return i?(!(!this._layerDefinitionExpressionClause&&this._layerDefinitionExpression&&this.respectLayerDefinitionExpression||!this._layerDisplayFilterClause&&this._layerDisplayFilter?.where)||await this._checkFeatureCountForExpression(`${e.field} = ${t}`))&&(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(i))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(i)):!0}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce((i,r)=>i.concat(this._getAllInfos(r)),[]):[e]}async _constructTileImageryStretchRendererElements(e){const t=this.layer,i=t.symbolizer.rasterInfo??t.raster.rasterInfo;let r,s;const l=e?.customStatistics?.length?e.customStatistics:i?.statistics;if(l)({min:r,max:s}=l[0]);else{const a=Oe(i.pixelType);r=a[0],s=a[1]}if(t.hasStandardTime()&&(r=t.getStandardTimeValue(r),s=t.getStandardTimeValue(s)),i.bandCount===1||t.bandIds?.length===1)return this._getStretchLegendElements(e,{min:r,max:s});const n=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(i.bandCount,3)).keys())).map(a=>i.bandInfos[a].name);return n.length<3?n.push(n[1]):n.length>3&&n.splice(3),this._createSymbolTableElementMultiBand(n)}async _getStretchLegendElements(e,t){const i=e.colorRamp?.toJSON(),r=oi(i,t);return{type:"stretch-ramp",title:"",infos:r,preview:j(r.map(s=>s.color))}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,i=t&&"symbol"in t&&t.renderer;return i&&i?.authoringInfo?.isAutoGenerated!==!0?null:t&&"symbol"in t?t.symbol:null}async _getSizeLegendElement(e,t,i,r){return{type:"size-ramp",title:this._clusterSizeVariable?this._getClusterTitle(t):e,infos:await ki(i,t,await Ne(i),this.scale,this.view,r,this._clusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],i=["red","green","blue"];return e.forEach((r,s)=>{t.push({label:{colorName:i[s],bandName:r},src:ci[s],opacity:this.opacity??1})}),t}_updateInfosForClassedSizeRenderer(e,t){const i=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",r=e.classBreakInfos.some(s=>Fe(s.symbol));if(i&&r){const s=ve,l=Se,n=e.classBreakInfos.length,a=(s-l)/(n>1?n-1:n);t.forEach((o,u)=>{o.size=s-a*u})}}_isTallSymbol(e){let t=!1,i=!1;if(e)for(let r=0;r<e.length&&(!t||!i);r++){const s=e[r];s.type==="size"&&(s.axis==="height"&&(t=!0),s.axis==="width-and-depth"&&(i=!0))}return t&&i}async _generatePreviewsForLegendElements(e,t,i){const r=[];for(const s of e)for(const l of s.infos??[])if("infos"in l&&l.infos&&r.push(this._generatePreviewsForLegendElements([l],t,i)),Qe(l)&&l.symbol&&!l.preview){let n=!0;if(l.symbol.type==="cim"){const{minScale:a,maxScale:o}=l.symbol.data;(a&&a<this.scale||o&&o>this.scale)&&(n=!1)}n&&r.push(this._generateSymbolPreviewForInfo(l,{...t,clipBloomEffect:"theme"in s&&s.theme==="spike",cssEffectFilter:i?.arrowMarkerSymbols?.has(l.symbol)?null:t.cssEffectFilter},i?{applyScaleDrivenSize:!i.arrowMarkerSymbols?.has(l.symbol)}:void 0))}await Promise.all(r)}async _getSize(e,t){let i=e.size==null&&this._hasSizeRamp?Ye(22):e.size;if(this._scaleDrivenSizeVariable&&t?.applyScaleDrivenSize){const{getSize:r}=await Ce(()=>import("./index-CgzAF5Ey.js").then(s=>s.ML),__vite__mapDeps([0,1]));i=r(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return i}_getPreviewCIMOptions(e){return{style:"legend",cimOptions:{allowScalingUp:this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!e?.applyScaleDrivenSize),viewParams:this.isScaleDriven?{viewingMode:this.view?.type==="2d"?"map":this.view?.viewingMode,scale:this.view?.scale}:null}}}async _generateSymbolPreviewForInfo(e,t={},i){const{symbol:r}=e;try{if(t.size=await this._getSize(e,i),t.scale=!1,r.type==="cim"){const s=this._getPreviewCIMOptions(i);t={...t,...s}}e.preview=await Xt(r,t)}catch{e.preview=null,T.getLogger(this).warn(`Generating symbol preview failed for symbol type: ${r?.type}`)}}_getClusterRenderer(e){this._clusterSizeVariable=null;const t="renderer"in this.layer?this.layer.renderer:null,i=e.renderer?.clone()||t?.clone(),r=Ii(e,this.layerView,this.view);if(r&&i!=null&&"visualVariables"in i&&!i.visualVariables?.some(l=>l.type==="size"&&l.target!=="outline"&&!se.test(l.valueExpression))){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:n,clusterMaxSize:a}=e;r.legendOptions=new Ot({showLegend:n!==a})}const l=i.visualVariables||[];i.visualVariables=l.concat([r]),this._clusterSizeVariable=r}return i}async _loadRenderer(e){if(we.has(e))return we.get(e);const t=[],i=e.clone(),r=await Ne(i);if(N(i)||W(i)){const s=(i.classBreakInfos||i.uniqueValueInfos).map(l=>this._fetchSymbol(l.symbol,r).then(n=>{l.symbol=n}).catch(()=>{l.symbol=null}));Array.prototype.push.apply(t,s)}return t.push(this._fetchSymbol(i.symbol||i.defaultSymbol,i.defaultSymbol?null:r).then(s=>{this._applySymbolToRenderer(i,s,K(i))}).catch(()=>{this._applySymbolToRenderer(i,null,K(i))})),await Promise.allSettled(t),we.set(e,i),i}_applySymbolToRenderer(e,t,i){i?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if(e.type==="web-style"){const i=this._webStyleSymbolCache;try{const r=await e.fetchSymbol({cache:i});return this._getAppliedCloneSymbol(r,t)}catch{throw T.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const i=e.clone(),r=t&&t.toRgba();return i.type.includes("3d")?this._applyColorTo3dSymbol(i,r):i.type==="cim"?lt(i,t):i.color&&(i.color=new O(r||i.color)),i}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(i=>{i&&(i.material||(i.material={}),i.material.color=new O(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||e.type==="vector-field")return null;const i=e.visualVariables??[],r=[],s=[],l=[],n=A(e,"reference-size")??A(e,"spike");let a;const o=this._clusterSizeVariable;if(n?.sizeStops?.length===2&&(N(e)||W(e))){const[h,L]=n.sizeStops,v=o?o.minDataValue:h.value,V=o?o.maxDataValue:L.value;a=new Xe({field:n.field??void 0,normalizationField:n.normalizationField,minSize:He(h.size,10,100),maxSize:He(L.size,50,150),minDataValue:v,maxDataValue:V}),s.push(a)}for(const h of i)if(h.type==="color")r.push(h);else if(h.type==="size"){if(h.field==="cluster_count"&&a)continue;s.push(h)}else h.type==="opacity"&&l.push(h);const u=[...r,...s,...l];let c,y;if(r.length===0&&N(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const h=e.classBreakInfos[0];c=h&&h.symbol}if(r.length===0&&K(e)&&(c=e.symbol),c)if(c.type.includes("3d")){const h=c.symbolLayers.at(0);h.type==="water"?h.color!=null&&(y=h.color):h.material?.color!=null&&(y=h.material.color)}else c.url||(y=c.color);const C=this.cssEffectFilter;return(await Promise.all(u.map(async h=>{if(!h.legendOptions||h.legendOptions.showLegend!==!1){const L=Ee(e)?h.field:this._getRampTitle(h,t);let v=null;const V=ui(t,h,this.view.timeZone);if(h.type==="color"){const S=await We(h,null,V)??[];v={type:"color-ramp",title:L,infos:S,preview:j(S.map(f=>f.color),{cssEffectFilter:C})},this._hasColorRamp||(this._hasColorRamp=S.length>0)}else if(h.type==="size"&&h.target!=="outline")se.test(h.valueExpression)?this._clusterSizeVariable||(this._scaleDrivenSizeVariable=h):(v=await this._getSizeLegendElement(L,h,e,V),a===h&&n?.theme==="spike"&&(v.theme=n.theme),this._hasSizeRamp||(this._hasSizeRamp=!(v.infos==null||!v.infos.length)));else if(h.type==="opacity"){const S=await We(h,y,V)??[];v={type:"opacity-ramp",title:L,infos:S,preview:j(S.map(f=>f.color),{cssEffectFilter:C})},this._hasOpacityRamp||(this._hasOpacityRamp=S.length>0)}return v?.infos?v:null}}))).filter(te)}_getDomainName(e,t,i){if(e&&typeof e!="function"){const r="getField"in i&&i.getField?.(e),s=r&&"getFieldDomain"in i&&i.getFieldDomain?i.getFieldDomain(r.name,{excludeImpliedDomains:Bt("esri-widget-legacy-field-domain-calculation")}):null;return s?.type==="coded-value"?s.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,i=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const r=t.featureReduction,s="popupTemplate"in r&&r.popupTemplate,l=s&&s.fieldInfos;if(l){for(const n of l)if(n.fieldName===i)return i==="cluster_count"?n.label||{showCount:!0}:n.label}}return{showCount:!0}}_getRampTitle(e,t){let i=e.field,r=e.normalizationField,s=!1,l=!1,n=!1,a=null;i=typeof i=="function"?null:i,r=typeof r=="function"?null:r;const o=e.legendOptions?.title;if(o!=null)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo?.visualVariables){const u=t.renderer.authoringInfo.visualVariables;for(let c=0;c<u.length;c++){const y=u[c];if(y.type==="color"){if(y.style==="ratio"){s=!0;break}if(y.style==="percent"){l=!0;break}if(y.style==="percent-of-total"){n=!0;break}}}}a={field:i&&this._getFieldAlias(i,t),normField:r&&this._getFieldAlias(r,t),ratio:s,ratioPercent:l,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const i=e;if(i.legendOptions?.title)return i.legendOptions.title;if(i.valueExpressionTitle)return i.valueExpressionTitle;let r=i.field,s=null,l=null;if(N(i)&&(s=i.normalizationField,l=i.normalizationType==="percent-of-total"),r=typeof r=="function"?null:r,s=typeof s=="function"?null:s,W(i)){const{field2:a,field3:o,fieldDelimiter:u}=i;let c=r&&this._getFieldAlias(r,t);return a&&(c=`<${c}>${u}<${this._getFieldAlias(a,t)}>`,o&&(c=`${c}${u}<${this._getFieldAlias(o,t)}>`)),c}let n=null;return(r||s)&&(n={field:r&&this._getFieldAlias(r,t),normField:s&&this._getFieldAlias(s,t),normByPct:l}),n}_getFieldAlias(e,t){const i="featureReduction"in t&&t.featureReduction;if(Nt(t)&&!i)return t.getFieldAlias(e)||e;let l=("popupTemplate"in t?t.popupTemplate:null)?.fieldInfos?.find(c=>e===c.fieldName),n=null;"getField"in t&&t.getField?n=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(n=t.fieldsIndex.get(e));let a=null;i&&(l??="popupTemplate"in i?i.popupTemplate?.fieldInfos?.find(c=>e?.toLowerCase()===c.fieldName?.toLowerCase()):void 0,"fields"in i&&i.fields&&(a=i.fields.find(c=>c.name?.toLowerCase()===e?.toLowerCase())));const o=l||n||a;let u=null;return o&&(u=l?.label||n?.alias||a?.alias||"name"in o&&o.name||"fieldName"in o&&o.fieldName||null),u}_isUnclassedRenderer(e){const t=e.visualVariables;let i=!1;return N(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(i=e.field?t.some(r=>!(!r||e.field!==r.field||(e.normalizationField||r.normalizationField)&&e.normalizationField!==r.normalizationField)):!!t.length),i}};b([_()],F.prototype,"_loading",void 0),b([_()],F.prototype,"children",void 0),b([_({readOnly:!0})],F.prototype,"cssEffectFilter",null),b([_()],F.prototype,"layerView",void 0),b([_()],F.prototype,"layer",void 0),b([_()],F.prototype,"legendElements",void 0),b([_({readOnly:!0})],F.prototype,"loading",null),b([_({readOnly:!0})],F.prototype,"opacity",null),b([_()],F.prototype,"parent",void 0),b([_({readOnly:!0,dependsOn:[]})],F.prototype,"ready",null),b([_()],F.prototype,"hideLayersNotInCurrentView",void 0),b([_()],F.prototype,"keepCacheOnDestroy",void 0),b([_()],F.prototype,"respectLayerDefinitionExpression",void 0),b([_()],F.prototype,"respectLayerVisibility",void 0),b([_({readOnly:!0})],F.prototype,"scale",null),b([_()],F.prototype,"sublayerIds",void 0),b([_({readOnly:!0})],F.prototype,"isScaleDriven",null),b([_()],F.prototype,"title",void 0),b([_({readOnly:!0,dependsOn:["ready"],value:0})],F.prototype,"version",null),b([_()],F.prototype,"view",void 0),F=b([rt("esri.widgets.Legend.support.ActiveLayerInfo")],F);const B={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},wt=Ve.ofType(F),cs=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CatalogLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.ParquetLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.catalog.CatalogFootprintLayer","esri.layers.catalog.CatalogDynamicGroupLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer","esri.layers.KnowledgeGraphLayer"]),vt="view.basemapView.baseLayerViews",St="view.groundView.layerViews",It="view.basemapView.referenceLayerViews",us=[vt,St,"view.layerViews",It];let M=class extends it{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Ve,this._activeLayerInfosPromises=new WeakMap,this.activeLayerInfos=new wt,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(R(()=>this.view,()=>this._viewHandles(),ne),B.view),this.addHandles(Wt(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get loading(){return this.activeLayerInfos.some(e=>e.loading)}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(B.state),this.view&&this.addHandles(R(()=>this.state,()=>this._stateHandles(),ne),B.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([B.allLayerViews,B.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);const t=this._activeLayerInfosByLayerViewId[e];t&&this._activeLayerInfosPromises.delete(t),delete this._activeLayerInfosByLayerViewId[e],t?.parent?.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{view:e}=this;if(!e)return;const{allLayerViews:t}=e;t.length&&this._refresh(),this.addHandles(t.on("change",i=>this._allLayerViewsChangeHandle(i)),B.allLayerViews),this.addHandles(R(()=>[this.basemapLegendVisible,this.groundLegendVisible,this.hideLayersNotInCurrentView,this.keepCacheOnDestroy,this.layerInfos,this.respectLayerDefinitionExpression,this.respectLayerVisibility],()=>this._refresh()),B.legendProperties)}_allLayerViewsChangeHandle(e){if(e.added.length&&this._generateActiveLayerInfosForLayerViews(e.added),e.moved.length)return this._destroyViewActiveLayerInfos(),void this._refresh();if(e.removed.length){for(const{uid:t}of e.removed)this._destroyViewActiveLayerInfo(t);this._refresh()}}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.drain(e=>this._activeLayerInfosPromises.delete(e)),this._generateActiveLayerInfosForLayerViews(this._generateLayerViews())}_generateActiveLayerInfosForLayerViews(e){e.filter(this._filterBasemapLayerViews,this).filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this)}_filterBasemapLayerViews(e){if(!this.view?.basemapView)return!0;const{baseLayerViews:t,groundLayerViews:i,referenceLayerViews:r}=this.view.basemapView,s=!this.basemapLegendVisible&&(t?.includes(e)||r?.includes(e)),l=!this.groundLegendVisible&&i?.includes(e);return!s&&!l}_sortActiveLayerInfos(e){const t=this.view;if(e.length<2||!t)return;const i=[];e.forEach(s=>{if(!s.parent){const l=s.layer.parent,n=l&&"uid"in l&&this._layerViewByLayerId[l.uid],a=n&&this._activeLayerInfosByLayerViewId[n.uid];a&&e.includes(a)&&(i.push(s),s.parent=a,a.children.add(s),this._sortActiveLayerInfos(a.children))}}),e.removeMany(i);const r={};t.allLayerViews.forEach((s,l)=>r[s.layer.uid]=l),e.sort((s,l)=>{const n=r[s.layer.uid]||0;return(r[l.layer.uid]||0)-n})}_generateLayerViews(){const e=[];return us.filter(this._filterLayerViews,this).map(t=>qt(this,t)).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===vt||e===It),i=!this.groundLegendVisible&&e===St;return!t&&!i}_collectLayerViews(e,t){const i=r=>(r&&r.forEach(s=>{t.push(s),i(s[e])}),t);return i}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(i=>this._hasLayerInfo(i,e))}_hasLayerInfo(e,t){const i=this._isLayerUIDMatching(e.layer,t.layer.uid);return i&&(this._layerInfosByLayerViewId[t.uid]=e),i}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(i=>this._isLayerUIDMatching(i,t))}_isLayerViewSupported(e){return!!cs.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(R(()=>[e.legendEnabled,e.layer?.legendEnabled],()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}async _buildActiveLayerInfo(e){const t=e.layer,i=e.uid,r=this._layerInfosByLayerViewId[i];let s=this._activeLayerInfosByLayerViewId[i];s||(s=new F({layer:t,layerView:e,view:this.view??void 0}),this._activeLayerInfosByLayerViewId[i]=s);const l=r?.title!==void 0&&r.layer.uid===t.uid;s.title=l?r.title:t.title,s.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,s.respectLayerVisibility=this.respectLayerVisibility,s.hideLayersNotInCurrentView=this.hideLayersNotInCurrentView,s.keepCacheOnDestroy=this.keepCacheOnDestroy,s.sublayerIds=r?.sublayerIds||[];const n=t.parent&&"uid"in t.parent?this._layerViewByLayerId[t.parent?.uid]:null;s.parent=this._activeLayerInfosByLayerViewId[n?.uid],this._addActiveLayerInfo(s),this._constructLegendElements(s),this._attachHandlesToActiveLayerInfo(s)}_attachHandlesToActiveLayerInfo(e){const{layer:t,layerView:i}=e,r=i.uid;this.removeHandles(r),this.addHandles([R(()=>t.title,s=>this._titleHandle(s,e)),R(()=>[t.opacity,"renderer"in t&&t.renderer,"pointSymbol"in t&&t.pointSymbol,"lineSymbol"in t&&t.lineSymbol,"polygonSymbol"in t&&t.polygonSymbol,"effect"in t&&t.effect,"featureReduction"in t&&Pe(t,i.view),this.view?.timeZone],()=>this._constructLegendElements(e)),R(()=>"filter"in i&&i.filter,()=>{Pe(i.layer,i.view)!=null&&this._constructLegendElements(e)}),Ut(()=>!!this.view?.stationary,()=>this._scaleHandle(e)),R(()=>e.loading,()=>this.notifyChange("loading"),ne)],r),this.respectLayerVisibility&&this.addHandles([R(()=>t.legendEnabled,s=>this._legendEnabledHandle(s,e)),R(()=>i.legendEnabled,s=>{this.view?.suspended||this._legendEnabledHandle(s,e)})],r),this.respectLayerDefinitionExpression&&"definitionExpression"in t&&this.addHandles(R(()=>t.definitionExpression,()=>this._constructLegendElements(e)),r)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:t,layer:i}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){const r=e.parent;if(r)r.children.includes(e)||r.children.push(e),this._sortActiveLayerInfos(r.children);else{const s=this.layerInfos?.some(n=>n.layer.uid===i.uid),l=i.parent;l&&"uid"in l&&this._layerViewByLayerId[l.uid]&&!s?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const s=[];this._activeLayerInfosWithNoParent.forEach(l=>{const n=l.layer.parent,a=n&&"uid"in n?this._layerViewByLayerId[n?.uid]:null,o=this._activeLayerInfosByLayerViewId[a?.uid];o&&(s.push(l),l.parent=o)}),s.length&&(this._activeLayerInfosWithNoParent.removeMany(s),s.forEach(l=>this._addActiveLayerInfo(l)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}async _getBuildLegendPromise(e){const{layer:t}=e;if("featureCollections"in t&&t.featureCollections)return e.buildLegendElementsForFeatureCollections(t.featureCollections);if("featureReduction"in t&&t.featureReduction&&"renderer"in t.featureReduction&&(t.featureReduction.type==="binning"||t.featureReduction.type==="cluster")&&(!this.view||t.featureReduction.maxScale<=this.view.scale))return e.buildLegendElementsForFeatureReduction(t.featureReduction);if("renderer"in t&&t.renderer&&!("sublayers"in t))return e.buildLegendElementsForRenderer(t.renderer);if("url"in t&&t.url&&t.type!=="catalog"&&t.type!=="knowledge-graph")return e.buildLegendElementsForTools();const i=e.children.map(r=>this._constructLegendElements(r));return Promise.all(i).then(()=>{})}async _constructLegendElements(e){const t=this._activeLayerInfosPromises.get(e);t&&await t.catch(()=>{});const i=this._getBuildLegendPromise(e);this._activeLayerInfosPromises.set(e,i),i.finally(()=>{this._activeLayerInfosPromises.delete(e)})}};b([_({type:wt})],M.prototype,"activeLayerInfos",void 0),b([_()],M.prototype,"basemapLegendVisible",void 0),b([_()],M.prototype,"groundLegendVisible",void 0),b([_()],M.prototype,"hideLayersNotInCurrentView",void 0),b([_()],M.prototype,"keepCacheOnDestroy",void 0),b([_({readOnly:!0})],M.prototype,"loading",null),b([_()],M.prototype,"respectLayerDefinitionExpression",void 0),b([_()],M.prototype,"respectLayerVisibility",void 0),b([_()],M.prototype,"layerInfos",void 0),b([_({readOnly:!0})],M.prototype,"state",null),b([_()],M.prototype,"view",void 0),M=b([rt("esri.widgets.Legend.LegendViewModel")],M);export{M as _};
