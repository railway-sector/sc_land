import{qH as Z,x4 as J,x5 as X,et as N,x6 as ee,x7 as te,x8 as ne,aw as k,x9 as se,rk as ae,lf as W,xa as ie,aQ as j,jK as Y,ds as K,kt as re,gy as A,xb as oe,xc as le,ar as R,xd as ce,u5 as he,xe as de,b0 as ue,xf as _e,da as E,xg as ge,sD as me,sn as O,ua as fe,bf as w,j4 as pe,xh as L,be as B,a4 as P,f8 as ye,xi as be,xj as ve,xk as Ie,xl as D,kg as V,xm as xe,xn as S,xo as Ce,_ as p,e as y,g as De}from"./index-BrQW8HOS.js";class Se extends Z{constructor(e,n){super(s=>J(this._instanceData.view.boundingSphere.getVec(s,Re)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=n,this._tmpSphere=X(),this._tmpMat4=N()}addInstance(e){const n=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);ee(this._tmpSphere,this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*te(s),n.setVec(e,ne(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const Re=k();class Ee{constructor(e,n){this._worldSpaceRadius=e,this._minScreenSpaceRadii=n}selectLevel(e,n,s){const a=s.computeScreenPixelSizeAt(e),o=this._worldSpaceRadius*n/a;let i=0;for(let l=1;l<this._minScreenSpaceRadii.length;++l)o>=this._minScreenSpaceRadii[l]&&(i=l);return i}}class we{constructor(e,n){this.geometry=n;const s=e.renderContext.rctx,a=n.renderGeometry,{material:o,layout:i,buffer:l}=a;this._materials=e.materials,o.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new se(o,this._materials),this.vbo=new ae(s,W(i),l),this.vao=new ie(s,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,n,s,a,o,i,l,r){return this.geometry.intersect(e,n,s,a,o,i,l,r)}}class M{static async create(e,n,s){const a=await Promise.allSettled(n.components.map(i=>e.controller.schedule(()=>new we(e,i.geometry),s))),o=a.map(i=>i.status==="fulfilled"?i.value:null).filter(j);if(Y(s)||o.length!==a.length){o.forEach(i=>i.destroy()),K(s);for(const i of a)if(i.status==="rejected")throw i.reason}return new M(n.minScreenSpaceRadius,o)}constructor(e,n){this.minScreenSpaceRadius=e,this.components=n}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,n,s,a,o,i,l){this.components.forEach(r=>r.intersect(e,n,s,a,o,i,this.boundingSphere,l))}get boundingBox(){if(this._boundingBox==null){const e=re();this.components.forEach(n=>{n.boundingInfo!=null&&(A(e,n.boundingInfo.bbMin),A(e,n.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,n=R();oe(e,n),this._boundingSphere={center:n,radius:.5*le(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,n)=>e+n.numTriangles,0)}}const Le=t=>{const e=t.baseBoundingSphere.radius,n=t.levels.map(s=>s.minScreenSpaceRadius);return new Ee(e,n)};let m=class extends ce{constructor(t,e){super(t),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new he,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,n=>this._produces(n)],[4,n=>!!this._hasTransparentLevels()&&this._produces(n)]]),this._instanceData=new de({shaderTransformation:t.shaderTransformation},t.symbol.materialParameters),this.addHandles(e.registerTask(ue.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=_e(this.symbol.materialParameters),this._glInstanceBufferLayout=W(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDatas)e[0]!==E&&t.push(e[1]);return t}hasHighlight(t){return this._highlightRenderInstanceDatas.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((n,s)=>n+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((n,s)=>n+s.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((n,s)=>{const a=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,o=n.triangleCount;e.push({renderedInstances:a,renderedTriangles:a*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:e.reduce((n,s)=>n+s.renderedInstances,0),renderedTriangles:e.reduce((n,s)=>n+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(e=>new ge(t,this._instanceBufferLayout))}async initializeRenderContext(t,e){this._context=t,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const n=await Promise.allSettled(this.symbol.levels.map(a=>M.create(t,a,e))),s=n.map(a=>a.status==="fulfilled"?a.value:null).filter(j);if(Y(e)||s.length!==n.length){s.forEach(a=>a.destroy()),K(e);for(const a of n)if(a.status==="rejected")throw a.reason}this._levels=s,this._levelSelector=Le(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDatas.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return me(this._highlightRenderInstanceDatas,t=>t.some(e=>e.size>0))}_produces(t){return(t!==9||this.hasHighlights())&&(t!==5||this.hasHighlight(E))}prepareRender(t){if(!O.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(fe),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const n=new Array,s=this.levels;return e.forEach(a=>s.forEach(({components:o},i)=>o.forEach(l=>n.push(this._beginComponent(t,a[i],l))))),n}render(t,e){const n=this._getInstanceDatas(t);if(!n||e==null)return;let s=0;const a=this.levels;n.forEach(o=>a.forEach(({components:i},l)=>i.forEach(r=>this._renderComponent(t,e[s++],o[l],r,l)))),t.rctx.unbindBuffer(34962),t.rctx.bindVAO(null)}_getInstanceDatas(t){const{output:e,bind:n}=t,s=e===9,a=e===5,o=e!==6;if(!s&&!a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:i}=this;if(o){if(s){const r=n.highlight?.name;if(!r)return null;const _=i.get(r);return _?[_]:null}const l=i.get(E);return a?l?[l]:null:Array.from(i.values())}return null}intersect(t,e,n,s){if(!this.baseMaterial.visible||this._octree==null)return;const a=R();w(a,s,n);const o=i=>{this._instanceData.getCombinedModelTransform(i,q),t.transform.set(q),V(H,n,t.transform.inverse),V(z,s,t.transform.inverse);const l=this._instanceData.getState(i),r=this._instanceData.getLodLevel(i),_=this._levels.length;4&l&&(D(!!(18&l),"invalid instance state"),D(r>=0&&r<_,"invaid lod level"),this._levels[r].intersect(t,e,H,z,i,this.metadata,_))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(n,a,o)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new Se(t,this.baseBoundingSphere);for(let n=0;n<t.capacity;++n)18&e.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=pe(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new L;const e=t.viewForward,n=this._octree.findClosest(e,1,t.frustum),s=this._octree.findClosest(e,-1,t.frustum);if(n==null||s==null)return new L;const a=t.eye,o=this._instanceData.view;o.boundingSphere.getVec(n,f),w(f,f,a);const i=B(f,e)-f[3];o.boundingSphere.getVec(s,f),w(f,f,a);const l=B(f,e)+f[3];return new L(i,l)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:n,_levelSelector:s}=this;this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.beginUpdate()));const a=this._instanceData,o=a.view;let i=a.size;const l=a.capacity;let r=this._instanceIndex;const _=Math.ceil(l/500),{_highlightRenderInstanceDatas:u}=this;for(let d=0;d<i&&!t.done;++d){r===this._cycleStartIndex&&this._startUpdateCycle();const c=o.state.get(r);let h=0;if(!(1&c)){r=r+1===l?0:r+1,i++;continue}const I=o.lodLevel.get(r);if(2&c&&this._defaultRenderInstanceData[I].freeTail(),16&c){const g=a.geHighlightOptionsPrev(r);if(g){const b=u.get(g);if(!b)throw new P("internal:lod-renderer","Internal error in lodRenderer");b[I].freeTail(),b.every(C=>C.isEmpty)&&(b.forEach(C=>C.destroy()),u.delete(g))}}if(32&c)a.freeInstance(r);else if(4&c){let g=0;if(e&&(o.modelOrigin.getVec(r,F),g=s.selectLevel(F,a.getCombinedMedianScaleFactor(r),n)),h=-83&c,g>=0)if(8&c){const b=a.getHighlightName(r);if(b){const C=()=>{const $=this._createRenderInstanceDataArray();return $.forEach(Q=>Q.beginUpdate()),$},T=ye(u,b,C);if(g>=T.length)throw new P("internal:lod-renderer",`LodRenderer internal error - missing lodLevel ${g}`);U(T[g],o,r)}h|=16}else U(this._defaultRenderInstanceData[g],o,r),h|=2;o.state.set(r,h),o.lodLevel.set(r,g)}else h=-83&c,o.state.set(r,h);const v=!!(18&c),x=!!(18&h);this._octreeCached!=null&&(!v&&x?this._octreeCached.addInstance(r):v&&!x?this._octreeCached.removeInstance(r):v&&x&&64&c&&(this._octreeCached.removeInstance(r),this._octreeCached.addInstance(r))),r=r+1===l?0:r+1,r%_===0&&t.madeProgress(),v!==x&&this.metadata.notifyGraphicVisibilityChanged(r),x&&64&c&&this.metadata.notifyGraphicGeometryChanged(r)}this._instanceIndex=r,this._allRenderInstanceData.forEach(d=>d.forEach(c=>c.endUpdate())),this._context.requestRender()}_beginComponent(t,e,n){return e.size===0?null:n.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,n,s,a){if(!e)return;const{bind:o,rctx:i}=t;i.runAppleAmdDriverHelper();const l=i.bindTechnique(e,o,s.material.parameters,Te),r=this._glInstanceBufferLayout;l.assertCompatibleVertexAttributeLocations(s.vao,ve(r)),i.bindVAO(s.vao),O.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===0&&(l.setUniform4fv("externalColor",G[Math.min(a,G.length-1)]),l.setUniform1i("symbolColorMixMode",Ie.replace));const _=n.capacity,u=n.headIndex,d=n.tailIndex,c=n.firstIndex,h=(I,v)=>{xe(i,l.locations,n.buffer,I),i.drawArraysInstanced(e.primitiveType,0,s.numVertices,v-I)};s.material.transparent&&c!=null?u>d?(D(c>=d&&c<=u,"invalid firstIndex"),h(c,u),h(d,c)):u<d&&(c<=u?(D(c>=0&&c<=u,"invalid firstIndex"),h(c,u),h(d,_),h(0,c)):(D(c>=d&&c<=_,"invalid firstIndex"),h(c,_),h(0,u),h(d,c))):u>d?h(d,u):u<d&&(h(0,u),h(d,_))}};function U(t,e,n){const s=t.allocateHead();Me(e,n,t.view,s)}function Me(t,e,n,s){Ce(t.modelOrigin,e,n.modelOriginHi,n.modelOriginLo,s),n.model.copyFrom(s,t.model,e),n.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&n.color&&n.color.copyFrom(s,t.color,e),t.olidColor&&n.olidColor&&n.olidColor.copyFrom(s,t.olidColor,e),t.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(s,t.featureAttribute,e)}p([y({constructOnly:!0})],m.prototype,"symbol",void 0),p([y({constructOnly:!0})],m.prototype,"metadata",void 0),p([y({constructOnly:!0})],m.prototype,"shaderTransformation",void 0),p([y()],m.prototype,"_instanceData",void 0),p([y()],m.prototype,"_cycleStartIndex",void 0),p([y({readOnly:!0})],m.prototype,"_enableLevelSelection",null),p([y()],m.prototype,"_updateCyclesWithStaticCamera",void 0),p([y({readOnly:!0})],m.prototype,"readyToRun",null),m=p([De("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],m);const F=R(),f=k(),q=N(),H=R(),z=R(),G=[S(1,0,1,1),S(0,0,1,1),S(0,1,0,1),S(1,1,0,1),S(1,0,0,1)],Te=new be;export{m as F};
