import{gS as b,ad as D,aa as k,ao as F,ae as I,ex as g,ds as v,m_ as R,_ as w,e as y,g as B}from"./index-BrQW8HOS.js";import{W as V,L as S,R as z,a as G,Z as H}from"./customElement-C8MorqK0.js";import{a as O}from"./SketchHandlerMixin-CHotD10T.js";import"./OrientedImageryLayer-T2nz_Xpq.js";import"./a11yUtils-BrnjXW_g.js";import"./projectOperator-p23D9sjF.js";import"./operatorProject-DxiD_TZp.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ElevationLayer-mcjhsuEV.js";import"./ArcGISCachedService-CjQQR1Jv.js";import"./TileInfoTilemapCache-DZPzARxb.js";import"./LercDecoder-CQqToE6M.js";import"./ImageryLayer-BC1GWxe2.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./multidimensionalUtils-C73Q5ZGV.js";import"./RasterJobHandlerMixin-MT2g2T_q.js";import"./RasterSymbolizer-B2A1UV2B.js";import"./PixelBlock-BLuOu6Ty.js";import"./pixelRangeUtils-BvOub3JO.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./vectorFieldUtils-BtFp6QX2.js";import"./datasetUtils-DdDUWBI2.js";import"./utils-6_NAbAK3.js";import"./cimSymbolUtils-CmFYUdpV.js";import"./gfxUtils-DDSu4Luj.js";import"./ClassBreaksDefinition-Bdvs4GrJ.js";import"./dataUtils-GsysffW0.js";import"./imageBitmapUtils-CV2jqiy6.js";import"./rasterFieldUtils-Ch69mkjb.js";import"./RasterPresetRendererMixin-B-VKGZPd.js";import"./executeForIds-Cnn1OWXP.js";import"./query-D5mFMRFz.js";import"./pbfQueryUtils-PegbNvJC.js";import"./pbf-bO1aG1II.js";import"./executeQueryJSON-CQzDonsh.js";import"./requestPresets-CKwN6OUr.js";import"./ExpandViewModel-CFigZjjU.js";import"./widget-lSGAz9tN.js";import"./GraphicsLayer-CtVknZ1a.js";import"./Mesh-fhI0Tv0o.js";import"./MeshComponent-BJOK3WKo.js";import"./meshProperties-DWLWd_LJ.js";import"./MeshTransform-wQhxY5y6.js";import"./MeshVertexAttributes-D5nCmuxt.js";import"./triangulationUtils-DRNEJzEV.js";import"./earcut-D9gy186-.js";import"./deduplicate-BmrPw5DR.js";import"./vertexSpaceConversion-DeCTRUfs.js";import"./vec4-CDOmPIEg.js";import"./External-B7cfwcdG.js";import"./vmEvent-CsrnYMSK.js";import"./MediaLayer-CCxfRpfr.js";import"./VideoElement-H0PUUZ6l.js";import"./MediaElementView-B-fdwXAA.js";import"./normalizeUtilsSync-DbZEvtY3.js";import"./ControlPoint-BjgmUvqO.js";import"./mediaLayerUtils-BJ-DU5EY.js";import"./ImageElement-CQTHnHSe.js";import"./BoundsStore-DpCEPPZ3.js";import"./Circle-CDzQBXRC.js";import"./geodesicUtils-BJZXB7Hp.js";import"./deepClone-CS2OSa44.js";import"./languageUtils-DuyO7Ix1.js";import"./ImmutableArray-BPVd6ESQ.js";import"./shared-DBXlHENV.js";import"./number-CjVmF4xk.js";import"./floorFilterUtils-DKzVzLpH.js";import"./MapView-YOBSX6K6.js";import"./View2D-CXXq0vs5.js";import"./clippingUtils-BM7WDzJt.js";import"./viewpointUtils-CqwA4uEG.js";import"./mat2d-BbBq4Byx.js";import"./mat2df64-DJ_RMjZ3.js";import"./mat2df32-Dpt2CT5P.js";import"./hitTestUtils-DuJ-LfGM.js";import"./rbush-DRx18tQf.js";import"./Tile-BIybhnuW.js";import"./arcadeUtils-MYBE13Eg.js";import"./Timeline-Cz5T4vl1.js";import"./utils-D_VO_1nP.js";import"./Draw-C_AMmCSB.js";import"./SnappingVisualizer2D-D8AbMCG0.js";import"./euclideanLengthMeasurementUtils-B8AL_WaV.js";import"./geometry2dUtils-kADrF-iP.js";import"./geodeticLengthOperator-DifrZujk.js";import"./geodeticCurveType-CirnHLSB.js";import"./geodesicMeasurementUtils-CQw8IWGR.js";import"./SnappingVisualizer-C6MiCxsp.js";import"./PointSnappingHint-Bb4Sdzt2.js";import"./coordinateHelper-DrvFu3jL.js";import"./EditGeometryOperations-vGO-F4bG.js";import"./rotate-BhR0-nSl.js";import"./curveOperationUtils-DH-ids6k.js";import"./SnappingContext-lR2hMWGP.js";import"./SnappingOperation-C2jjQrkg.js";import"./automaticLengthMeasurementUtils-Cr-y0OEN.js";import"./DrawingMode-Cvvf0VVz.js";import"./surfaceCoordinateSystems-BrNYf00T.js";import"./drawUtils-SR7_OwBd.js";import"./quantityFormatUtils-DM7lTTMC.js";import"./areaOperator-D3kAgWzZ.js";import"./Point2D-DNXcsliy.js";import"./Envelope2D-CUWyosZh.js";import"./ProjectionTransformation-BjD312Kq.js";import"./Transformation2D-BUBnKQZf.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-BHYd2kGf.js";import"./apiConverter---8F7iZ4.js";import"./geodeticAreaOperator-ByYk3Bkb.js";import"./geodeticDensifyOperator-BOpsJkz4.js";import"./operatorGeodeticDensify-nwbiaD87.js";import"./lengthOperator-Br-Q2qCg.js";import"./simplifyOperator-BQVvn5Fy.js";import"./operatorSimplify-C16tE3lk.js";import"./operators-CXiTjj3T.js";import"./affineTransformOperator-BKNCSN4p.js";import"./operatorGeodesicBuffer-D8PQ9jFi.js";import"./simplifyOGCOperator-DDBsrw9u.js";import"./OperatorSimplifyOGC-DcNrF_Mf.js";import"./Transformation-CXt5h21i.js";import"./bufferOperator-BiJUv4mF.js";import"./operatorBuffer-CaIv_CSz.js";import"./Bufferer-Dw9Qi4T1-CvYDX-1r.js";import"./OperatorGeneralize-DppLq4y-.js";import"./centroidOperator-Cjo9P-qe.js";import"./Centroid-DZi-eb9F-ClGofmgB.js";import"./clipOperator-CZe8yiJF.js";import"./containsOperator-DNx102s3.js";import"./operatorConvexHull-CLXAmAdc.js";import"./OperatorCrosses-DB7FRg7V.js";import"./cutOperator-C_GdDi0E.js";import"./densifyOperator-vKowcNxj.js";import"./operatorDensify-BYGdpA54.js";import"./differenceOperator-CyhDoPG_.js";import"./distanceOperator-BeiDdpLt.js";import"./Distance2DCalculator-CXhBP-8I-Dkb8-KBJ.js";import"./equalsOperator-DvQtL8Uf.js";import"./generalizeOperator-COoaBFuG.js";import"./operatorGeneralize-Cl8mifHq.js";import"./intersectionOperator-BerN0YBP.js";import"./operatorIntersection-Dk662p0x.js";import"./intersectsOperator-CKuf4yKG.js";import"./OperatorIntersects-DfaHxqTc.js";import"./labelPointOperator-Cx7qMfIy.js";import"./OperatorProximity-Bx0bzIXN.js";import"./OperatorOverlaps-n6lZ5y_F.js";import"./proximityOperator-CeAOEVUj.js";import"./relateOperator-BbKNGnbr.js";import"./symmetricDifferenceOperator-BDttf2Xk.js";import"./OperatorTouches-DGMDJcwi.js";import"./unionOperator-CEwj5emJ.js";import"./operatorUnion-B1Eso4ej.js";import"./OperatorWithin-D4IqirkT.js";import"./offset-5dJF8WuL.js";import"./unitConversion-xbmYuQOc.js";import"./operatorOffset-Dh_0wl36.js";import"./ImageryTileLayer-Bw8EVTFT.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./xmlUtilities-0Gc5qIUC.js";import"./QueueProcessor-CL6qRd0z.js";import"./RawBlockCache-Dkglau7b.js";import"./rasterProjectionHelper-daQRJxKm.js";import"./clipUtils-C90NVAfo.js";import"./rasterFunctionHelper-CVPDO2RW.js";import"./PolynomialTransform-B3lvtn1Q.js";import"./SketchViewModel-NRhuw9HA.js";import"./isSupportedObject-DknMXN_6.js";import"./layerUtils-CdCZXuDJ.js";import"./SketchLabelOptions-BPF5xZLI.js";import"./SketchOptions-CHLlByzL.js";import"./SnappingManager-BWOfKl0d.js";import"./automaticAreaMeasurementUtils-dI3X5owW.js";import"./geodesicAreaMeasurementUtils-CPlOyDe5.js";import"./substitute-D-eLZ17Q.js";import"./useWidget-CYtf2hFT.js";import"./useView-Cya0Zpns.js";let l=[],A=[],_=0,u=class extends O(R){constructor(e){super(e),this.type="measurement",this.measurementArray=[],this.pixelMeasurement=0,this.pixelAreaMeasurement=0,this.polygonVertices=[],this._calculationTask=null,this._distanceCalculation=0,this._areaCalculation=null}initialize(){this.addResolvingPromise(b())}async handleCreate(e){const t=e.toolEventInfo;switch(e.tool){case"polyline":await this.handlePolylineEvents(e,t);break;case"polygon":await this.handlePolygonEvents(e,t)}}handleDelete(e){this.resetDistanceMeasurements(),this.resetAreaMeasurements()}handleDestroy(){this.resetDistanceMeasurements(),this.resetAreaMeasurements()}cursorUpdatePolylineHandler(e){const{mode:t,activeViewer:i}=this.viewModel;if(t==="none"||!i?.imageSize)return;if(t==="default")this.measurementArray.push(e.coordinates);else{const s={x:e.coordinates[0],y:e.coordinates[1],z:e.coordinates[2]},o=V(s,i.imageSize[0],i.imageSize[1]);this.measurementArray.push([o.x,o.y])}const r=A.reduce((s,o)=>s+o,0)+this.pixelMeasurement;this.viewModel.distanceMeasurementResult=r}async cursorUpdatePolygonHandler(e){const{mode:t,activeViewer:i}=this.viewModel;if(t==="none"||!i?.imageSize)return;const r=e.coordinates;if(l=[...this.polygonVertices],t==="default")l.push(r);else{const m={x:r[0],y:r[1],z:r[2]},a=V(m,i?.imageSize[0],i?.imageSize[1]);l.push([a.x,a.y])}if(l.length<3||!this.viewModel.currentBestFeature||!this.viewModel.activeViewer?.imageSize)return;const s=l[0];l=l.filter((m,a)=>a===0||a===l.length-1||JSON.stringify(m)!==JSON.stringify(s));const o=await this._getAreaFromTask(l);o?.area&&o?.perimeter&&(_=o.area)}async handlePolylineEvents(e,t){const i=!this.viewModel.accuracyParametersMissing;if(e.state==="cancel")return this.resetDistanceMeasurements(),this.viewModel.distanceMeasurementResult=0,this.viewModel.distanceAccuracyArray=[],void(this.viewModel.displayNewMeasurementButton=!0);if(e.state==="complete"&&e.graphic){if(this.viewModel.activeViewer?.addGraphic(e.graphic),this.viewModel.triangularMeasurementActive){const s=e.graphic.geometry;await this.viewModel.processMeasurementVectors(s.paths[0]),await this._overlayFirstMeasurement(e.graphic,e.tool)}return this.viewModel.measurementGraphic=e.graphic,void this.resetDistanceMeasurements()}switch(t?.type){case"cursor-update":this.cursorUpdatePolylineHandler(t);break;case"vertex-add":if(this.measurementArray.length&&i){const s=await this._getAccuracyFromTask();s&&this.viewModel.distanceAccuracyArray.push(s)}this.vertexUpdatePolylineHandler()}const r=await this._getDistanceFromTask();this.pixelMeasurement=r??this.pixelMeasurement}async handlePolygonEvents(e,t){const i=!this.viewModel.accuracyParametersMissing;if(e.state==="cancel")return this.resetAreaMeasurements(),this.viewModel.areaMeasurementResult=0,this.viewModel.areaMeasurementAccuracy=0,void(this.viewModel.displayNewMeasurementButton=!0);if(e.state==="complete"&&e.graphic){if(this.viewModel.activeViewer?.addGraphic(e.graphic),i){const r=await this._getAreaAccuracyFromTask(this.polygonVertices);this.viewModel.areaMeasurementAccuracy=r&&r>this.viewModel.areaMeasurementAccuracy?r:this.viewModel.areaMeasurementAccuracy}if(this.viewModel.triangularMeasurementActive){const r=e.graphic.geometry;await this.viewModel.processMeasurementVectors(r.rings[0]),await this._overlayFirstMeasurement(e.graphic,e.tool)}return this.viewModel.measurementGraphic=e.graphic,void this.resetAreaMeasurements()}switch(t?.type){case"vertex-add":await this.vertexAddPolygonHandler(t);break;case"cursor-update":await this.cursorUpdatePolygonHandler(t)}this.viewModel.areaMeasurementResult=_>0?_:this.pixelAreaMeasurement}async vertexAddPolygonHandler(e){const{mode:t,activeViewer:i}=this.viewModel,r=e.added,s=r[r.length-1];if(!Array.isArray(s)||t==="none"||!i?.imageSize)return;if(t==="default")this.polygonVertices.push(s);else{const c={x:s[0],y:s[1],z:s[2]},n=V(c,i?.imageSize[0],i?.imageSize[1]);this.polygonVertices.push([n.x,n.y])}if(this.polygonVertices.length<3||!this.viewModel.currentBestFeature||!this.viewModel.activeViewer?.imageSize)return;const o=this.polygonVertices[0];this.polygonVertices=this.polygonVertices.filter((c,n)=>n===0||n===this.polygonVertices.length-1||JSON.stringify(c)!==JSON.stringify(o));const m=await this._getAreaFromTask(this.polygonVertices);if(!m?.area||!m?.perimeter)return;const{area:a}=m;this.pixelAreaMeasurement=a}vertexUpdatePolylineHandler(){this.measurementArray=this.measurementArray.slice(-1);const e=A.reduce((t,i)=>t+i,0)+this.pixelMeasurement;this.viewModel.distanceMeasurementResult=e,this.pixelMeasurement>0&&A.push(this.pixelMeasurement)}resetDistanceMeasurements(){this.measurementArray=[],this.pixelMeasurement=0,A=[]}resetAreaMeasurements(){this.polygonVertices=[],this.pixelAreaMeasurement=0,_=0}async _overlayFirstMeasurement(e,t){switch(t){case"polyline":await this._overlayFirstDistanceMeasurement(e);break;case"polygon":await this._overlayFirstAreaGeometry(e)}}async _overlayFirstDistanceMeasurement(e){const{mode:t,activeTriangulatedViewer:i}=this.viewModel,r=e.geometry?.clone(),s=e.symbol?.clone(),o=i?.imageSize,m=[...r.paths[0]],a=t==="default";if(t==="none"||t==="video"||!o)return;const c=a?m:S(m,o),n=a?z(c,!0):c,h=a?await this.viewModel.getMeasurementProperties():await this.viewModel.getMeasurementPropertiesPanoramic(),d=a?await this.viewModel.getMeasurementProperties(this.viewModel.currentBestFeatureMeasurementImage,this.viewModel.imageMeasurementViewer):await this.viewModel.getMeasurementPropertiesPanoramic(this.viewModel.currentBestFeatureMeasurementImage,this.viewModel.activeTriangulatedViewer);if(n?.length&&h&&d){const M=a?await this.viewModel.imageToImageTransform(n,h,d):await this.viewModel.imageToImageTransformPanoramic(n,h,d),f=M.map(p=>[p.x-.5,-.5-p.y]),T=M.slice(0,2).map(p=>C(p,o)),P=new D({paths:a?[f]:[T],spatialReference:k.WebMercator}),x=new F({geometry:P,symbol:s});await this.viewModel.editOverlayedGraphics(x)}}async _overlayFirstAreaGeometry(e){const{mode:t,activeTriangulatedViewer:i}=this.viewModel,r=e.geometry?.clone(),s=e.symbol?.clone(),o=i?.imageSize,m=[...r.rings[0]],a=t==="default";if(t==="none"||t==="video"||!o)return;const c=a?m:S(m,o),n=a?z(c,!0):c,h=a?await this.viewModel.getMeasurementProperties():await this.viewModel.getMeasurementPropertiesPanoramic(),d=a?await this.viewModel.getMeasurementProperties(this.viewModel.currentBestFeatureMeasurementImage,this.viewModel.imageMeasurementViewer):await this.viewModel.getMeasurementPropertiesPanoramic(this.viewModel.currentBestFeatureMeasurementImage,this.viewModel.activeTriangulatedViewer);if(n?.length&&h&&d){const M=a?await this.viewModel.imageToImageTransform(n,h,d):await this.viewModel.imageToImageTransformPanoramic(n,h,d),f=M.map(p=>[p.x-.5,-.5-p.y]),T=M.slice(0,a?2:M.length).map(p=>C(p,o)),P=new I({rings:a?[f]:[T],spatialReference:k.WebMercator}),x=new F({geometry:P,symbol:s});await this.viewModel.editOverlayedGraphics(x)}}async _getAreaFromTask(e){const{mode:t}=this.viewModel;return this._calculationTask?.abort(),this._calculationTask=g(async i=>{this._areaCalculation=null;const r=await this.viewModel.calculateAreaMeasurement(e,t,i);v(i),this._areaCalculation=r}),await this._calculationTask.promise,this._areaCalculation}async _getDistanceFromTask(){const{mode:e}=this.viewModel;return this._calculationTask?.abort(),this._calculationTask=g(async t=>{this._distanceCalculation=0;const i=await this.viewModel.calculateDistanceMeasurement(this.measurementArray,e,t);v(t),this._distanceCalculation=i}),await this._calculationTask.promise,this._distanceCalculation}async _getAccuracyFromTask(){const{mode:e}=this.viewModel;return e==="none"?null:(this._calculationTask?.abort(),this._calculationTask=g(async t=>{this._distanceCalculation=0;const i=e==="default"?await this.viewModel.calculateAccuracy(this.measurementArray,"distance",t):await this.viewModel.calculateAccuracyPanoramic(this.measurementArray,"distance",void 0,t);v(t),this._distanceCalculation=i}),await this._calculationTask.promise,this._distanceCalculation)}async _getAreaAccuracyFromTask(e){const{mode:t}=this.viewModel;return t==="none"?null:(this._calculationTask?.abort(),this._calculationTask=g(async i=>{this._distanceCalculation=0;const r=t==="default"?await this.viewModel.calculateAccuracy(e,"area",i):await this.viewModel.calculateAccuracyPanoramic(e,"area",void 0,i);v(i),this._distanceCalculation=r}),await this._calculationTask.promise,this._distanceCalculation)}};w([y()],u.prototype,"type",void 0),w([y()],u.prototype,"measurementArray",void 0),w([y()],u.prototype,"pixelMeasurement",void 0),w([y()],u.prototype,"pixelAreaMeasurement",void 0),w([y()],u.prototype,"polygonVertices",void 0),u=w([B("esri.widgets.OrientedImageryViewer.adapters.sketch.MeasurementAdapter")],u);const er=u,C=(e,t)=>{const{heading:i,pitch:r}=G(e,t[0],t[1]);return H(i,r)};export{er as default};
