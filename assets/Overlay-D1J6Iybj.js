import{i0 as b,ar as E,i4 as F,f as w,bJ as y,i5 as A,y as L,i6 as f,a0 as S,a5 as C,i7 as $,A as V,gM as k,by as W}from"./index-CgzAF5Ey.js";import{p as D}from"./MediaElementView-D6UZnd3c.js";import{o as H}from"./mediaLayerUtils-BJ-DU5EY.js";import{h as O,m as P}from"./utils-DQIbIkse.js";const g=[1,1],l=W(),I={none:"None",loop:"Loop",oscillate:"Oscillate"};function z(n){return n?{type:"CIMAnimatedSymbolProperties",...n,playAnimation:n.playing,repeatType:n.repeatType?I[n.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"}}class j extends b{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=E(),this._handles=new F,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([w(()=>this.elementView.element.opacity,s=>this.opacity=s,y),w(()=>[this.elementView.coords],()=>{this.requestRender()},y),w(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this.texture=A(this.texture),this.requestRender()},y),L(()=>this.elementView.element.loaded,()=>{const s=this.elementView.element;this.ready(),H(s)&&s.content!=null&&(this._handles.add([f(s.content,"play",()=>this.requestRender()),f(s.content,"loadeddata",()=>this.requestRender()),f(s.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in s.content?s.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([f(s.content,"seeked",()=>this.requestRender())]),this.requestRender())},y)]),t.element.load().catch(s=>{S.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new C("element-load-error","Element cannot be displayed",{element:t,error:s}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){super.destroy(),this._handles.destroy(),this.texture=A(this.texture)}get textureSize(){return g}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,e=this.elementView.element.content;if(e!=null){const a=e instanceof HTMLImageElement,r=e instanceof HTMLVideoElement,o=a?e.naturalWidth:r?e.videoWidth:e.width,d=a?e.naturalHeight:r?e.videoHeight:e.height;if(this._updatePerspectiveTransform(o,d),this.texture)if(r)if(e.readyState>=e.HAVE_CURRENT_DATA)t.animationsEnabled&&this._updateTextureAndRequestRender(e);else{const i=()=>{this._updateTextureAndRequestRender(e),e.removeEventListener("canplay",i),e.removeEventListener("seeked",i)};e.addEventListener("canplay",i),e.addEventListener("seeked",i)}else"getFrame"in e&&t.animationsEnabled&&this.requestRender();else{const i=new $(o,d);if(i.wrapMode=33071,i.preMultiplyAlpha=!0,"getFrame"in e){const u=h=>{this.texture?this.texture.setData(h):this.texture=new V(s,i,h)};"animationOptions"in this.elementView.element&&(this._player=O(e,z(this.elementView.element.animationOptions),null,u))}else this.texture=new V(s,i,e);this.texture.generateMipmap(),r&&this._requestVideoFrame(e)}}super.beforeRender(t)}_updateTextureAndRequestRender(t){this.texture.setData(t),this.texture.generateMipmap(),this._requestVideoFrame(t)}_requestVideoFrame(t){"requestVideoFrameCallback"in t?t.requestVideoFrameCallback(()=>this.requestRender()):t.paused||this.requestRender()}_createTransforms(){return null}draw(t,s){this.isReady&&this.texture!=null?(P(t,this._player),s.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:g,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices})):this.requestRender()}updateDrawCoords(t,s,e,a){const{coords:r,bounds:o}=this.elementView;if(r==null||o==null)return;const[d,i,u,h]=r.rings[0],T=this._vertices,{x:p,y:m}=t;T.set([i[0]-p,i[1]-m,d[0]-p,d[1]-m,u[0]-p,u[1]-m,h[0]-p,h[1]-m]);let c=s;if(a){const[x,,v]=o,{worldWidth:_,xBounds:M}=a,[R,q]=M;x<R&&v>R?c=_:v>q&&x<q&&(c=-_)}this.wrapAroundShift=c,this.isWrapAround=c!==0}_updatePerspectiveTransform(t,s){const e=this._vertices;D(l,[0,0,t,0,0,s,t,s],[e[0],e[1],e[4],e[5],e[2],e[3],e[6],e[7]]),k(this.perspectiveTransform,l[6]/l[8]*t,l[7]/l[8]*s)}}export{j as R};
