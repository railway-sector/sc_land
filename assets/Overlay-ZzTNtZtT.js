import{gy as M,al as E,gD as F,k as f,by as y,gE as q,q as L,gF as w,a4 as S,bz as k,gG as C,A,gH as $,bw as W}from"./index-Bp3GeDhQ.js";import{p as D}from"./perspectiveUtils-D9PRqmF2.js";import{o as H}from"./mediaLayerUtils-BJ-DU5EY.js";import{h as O,m as P}from"./utils-VA0D0gEu.js";const V=[1,1],l=W(),z={none:"None",loop:"Loop",oscillate:"Oscillate"};function I(n){return n?{type:"CIMAnimatedSymbolProperties",...n,playAnimation:n.playing,repeatType:n.repeatType?z[n.repeatType]:void 0}:{type:"CIMAnimatedSymbolProperties"}}class j extends M{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=E(),this._handles=new F,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([f(()=>this.elementView.element.opacity,s=>this.opacity=s,y),f(()=>[this.elementView.coords],()=>{this.requestRender()},y),f(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this.texture=q(this.texture),this.requestRender()},y),L(()=>this.elementView.element.loaded,()=>{const s=this.elementView.element;this.ready(),H(s)&&s.content!=null&&(this._handles.add([w(s.content,"play",()=>this.requestRender()),w(s.content,"loadeddata",()=>this.requestRender()),w(s.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in s.content?s.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([w(s.content,"seeked",()=>this.requestRender())]),this.requestRender())},y)]),t.element.load().catch(s=>{S.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new k("element-load-error","Element cannot be displayed",{element:t,error:s}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){super.destroy(),this._handles.destroy(),this.texture=q(this.texture)}get textureSize(){return V}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,e=this.elementView.element.content;if(e!=null){const a=e instanceof HTMLImageElement,i=e instanceof HTMLVideoElement,o=a?e.naturalWidth:i?e.videoWidth:e.width,d=a?e.naturalHeight:i?e.videoHeight:e.height;if(this._updatePerspectiveTransform(o,d),this.texture)if(i)if(e.readyState>=e.HAVE_CURRENT_DATA)t.animationsEnabled&&this._updateTextureAndRequestRender(e);else{const r=()=>{this._updateTextureAndRequestRender(e),e.removeEventListener("canplay",r),e.removeEventListener("seeked",r)};e.addEventListener("canplay",r),e.addEventListener("seeked",r)}else"getFrame"in e&&t.animationsEnabled&&this.requestRender();else{const r=new C(o,d);if(r.wrapMode=33071,r.preMultiplyAlpha=!0,"getFrame"in e){const u=h=>{this.texture?this.texture.setData(h):this.texture=new A(s,r,h)};"animationOptions"in this.elementView.element&&(this._player=O(e,I(this.elementView.element.animationOptions),null,u))}else this.texture=new A(s,r,e);this.texture.generateMipmap(),i&&this._requestVideoFrame(e)}}super.beforeRender(t)}_updateTextureAndRequestRender(t){this.texture.setData(t),this.texture.generateMipmap(),this._requestVideoFrame(t)}_requestVideoFrame(t){"requestVideoFrameCallback"in t?t.requestVideoFrameCallback(()=>this.requestRender()):t.paused||this.requestRender()}_createTransforms(){return null}draw(t,s){this.isReady&&this.texture!=null?(P(t,this._player),s.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:V,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices})):this.requestRender()}updateDrawCoords(t,s,e,a){const{coords:i,bounds:o}=this.elementView;if(i==null||o==null)return;const[d,r,u,h]=i.rings[0],T=this._vertices,{x:p,y:m}=t;T.set([r[0]-p,r[1]-m,d[0]-p,d[1]-m,u[0]-p,u[1]-m,h[0]-p,h[1]-m]);let c=s;if(a){const[x,,v]=o,{worldWidth:_,xBounds:b}=a,[g,R]=b;x<g&&v>g?c=_:v>R&&x<R&&(c=-_)}this.wrapAroundShift=c,this.isWrapAround=c!==0}_updatePerspectiveTransform(t,s){const e=this._vertices;D(l,[0,0,t,0,0,s,t,s],[e[0],e[1],e[4],e[5],e[2],e[3],e[6],e[7]]),$(this.perspectiveTransform,l[6]/l[8]*t,l[7]/l[8]*s)}}export{j as R};
