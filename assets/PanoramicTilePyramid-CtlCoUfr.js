import{d1 as L,bI as A,al as S,a7 as C,b3 as H,a5 as P,x as J,y as O}from"./index-aRi8Xk-b.js";import{i as W}from"./RasterJobHandlerMixin-ZMXsKT3M.js";import{l as N,n as D,t as Y}from"./customElement-Duf7jtxI.js";import{Y as j}from"./Mesh-Dxc9QN5X.js";import{n as q,g as E}from"./MeshComponent-DO-Vuh-B.js";import"./multidimensionalUtils-DPCJo6rl.js";import"./RasterSymbolizer-B_xou3r7.js";import"./PixelBlock-D6s_WAG4.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./vectorFieldUtils-nfa_tg3e.js";import"./datasetUtils-DdDUWBI2.js";import"./ClassBreaksDefinition-DT1Dgqyb.js";import"./dataUtils-BlaM2BDe.js";import"./OrientedImageryLayer-DNUkew_7.js";import"./projectOperator-pbpmSpqo.js";import"./operatorProject-Bp6D6u9T.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ElevationLayer-BtAhVoF1.js";import"./ArcGISCachedService-D8WBQN18.js";import"./TileInfoTilemapCache-DpPwfrSR.js";import"./LercDecoder-Ba_HK_eF.js";import"./ImageryLayer-C1WpU_1u.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./imageBitmapUtils-DWFhzbXj.js";import"./rasterFieldUtils-ewF5JZJG.js";import"./RasterPresetRendererMixin-BCm-HQgI.js";import"./executeForIds-BOIvqEB-.js";import"./query-zZV_LNG5.js";import"./pbfQueryUtils-Cjywei14.js";import"./pbf-D2pQhulj.js";import"./executeQueryJSON-BsEB0j6G.js";import"./GraphicsLayer-aZe0Dbdm.js";import"./MediaLayer-BSg-18GK.js";import"./VideoElement-B-R-4fHC.js";import"./perspectiveUtils-DkWurYV9.js";import"./normalizeUtilsSync-DladfY4H.js";import"./ControlPoint-roJedap0.js";import"./mediaLayerUtils-BJ-DU5EY.js";import"./ImageElement-oWmrClPK.js";import"./BoundsStore-DeNuAjVw.js";import"./Circle-VvoTd42k.js";import"./MeshVertexAttributes-myWlh2p7.js";import"./meshProperties-DWLWd_LJ.js";import"./deepClone-C3prMmcx.js";import"./languageUtils-BFDfiQjg.js";import"./ImmutableArray-BPVd6ESQ.js";import"./shared-DNQAIdLr.js";import"./number-CRnfhq1R.js";import"./Draw-B5Y6tvI-.js";import"./SnappingVisualizer2D-CuIzKepu.js";import"./euclideanLengthMeasurementUtils-4a6kHLjp.js";import"./geometry2dUtils-CgYtdIFN.js";import"./geodeticLengthOperator-BPMj1oiZ.js";import"./geodeticCurveType-CirnHLSB.js";import"./SnappingVisualizer-DcEQkqUs.js";import"./PointSnappingHint-B1wS2G__.js";import"./coordinateHelper-DuZS2XLt.js";import"./EditGeometryOperations-BtS6ng1n.js";import"./rotate-BMbD9698.js";import"./curveOperationUtils-DNLI8alC.js";import"./SnappingContext-lR2hMWGP.js";import"./SnappingOperation-STPFAn9b.js";import"./automaticLengthMeasurementUtils-CCfVEmrk.js";import"./DrawingMode-Cvvf0VVz.js";import"./surfaceCoordinateSystems-H1MVPt50.js";import"./drawUtils-Br2aF8oP.js";import"./areaOperator-JiNZPKm3.js";import"./Point2D-8Py_srEd.js";import"./Envelope2D-DQ3Tn1o-.js";import"./ProjectionTransformation-CepNZ9PX.js";import"./Transformation2D-Ckyhe4wc.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-BSFqafDe.js";import"./apiConverter-FnkTMlaa.js";import"./geodeticAreaOperator-DYnNn27m.js";import"./geodeticDensifyOperator-BbdO1oBy.js";import"./operatorGeodeticDensify-CqM-82EQ.js";import"./lengthOperator-B93QPg-F.js";import"./simplifyOperator-BRnc_X18.js";import"./operatorSimplify-BOKlU8rf.js";import"./operators-Ca4ZfP-e.js";import"./affineTransformOperator-CYcPpYBN.js";import"./operatorGeodesicBuffer-9fSni0Zj.js";import"./simplifyOGCOperator-BrAX_zNk.js";import"./OperatorSimplifyOGC-C4cFJI6O.js";import"./Transformation-B5QFC7mB.js";import"./bufferOperator-CSTG6DI2.js";import"./operatorBuffer-CIZ3g07A.js";import"./Bufferer-Dw9Qi4T1-D8yKlGHi.js";import"./OperatorGeneralize-DoFoqaxi.js";import"./centroidOperator-__ITf3sI.js";import"./Centroid-DZi-eb9F-bsuFT5fW.js";import"./clipOperator-B-c7w6tM.js";import"./containsOperator-ClgHXVAE.js";import"./operatorConvexHull-D2b8GS3k.js";import"./OperatorCrosses-h4jZOYNE.js";import"./cutOperator-D3MceKr1.js";import"./densifyOperator-DHWBdh-U.js";import"./operatorDensify-Cd1Qu20O.js";import"./differenceOperator-By7S1Y_y.js";import"./distanceOperator-DXoZ1ofm.js";import"./Distance2DCalculator-CXhBP-8I-Ci-vwecj.js";import"./equalsOperator-VICYJXZz.js";import"./generalizeOperator-DeqIVVGV.js";import"./operatorGeneralize-DgWCTRem.js";import"./intersectionOperator-ClmheFJp.js";import"./operatorIntersection-D5fgKHb0.js";import"./intersectsOperator-C2mY84EI.js";import"./OperatorIntersects-BedDA8cr.js";import"./labelPointOperator-R7L8jZGU.js";import"./OperatorProximity-gMgF6_DS.js";import"./OperatorOverlaps-BeZHQzly.js";import"./proximityOperator-P1L3GlzQ.js";import"./relateOperator-BP9UkBE5.js";import"./symmetricDifferenceOperator-Y7nMmrf_.js";import"./OperatorTouches-8n8ac3eQ.js";import"./unionOperator-DbwqLb2E.js";import"./operatorUnion-D0Yl3krj.js";import"./OperatorWithin-OGsjnXMO.js";import"./offset-C4oRIUmr.js";import"./unitConversion-CuhlvP-p.js";import"./operatorOffset-BnhEHmGh.js";import"./ImageryTileLayer-ahBg2tJx.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./xmlUtilities-BrCIVSt6.js";import"./QueueProcessor-BBZoq4x6.js";import"./RawBlockCache-DcA_xtd5.js";import"./rasterProjectionHelper-B5cSg6T6.js";import"./clipUtils-CIPL8g4V.js";import"./rasterFunctionHelper-Dc05Qk8O.js";import"./PolynomialTransform-D9daHnVQ.js";import"./SketchViewModel-CgPwD4NK.js";import"./isSupportedObject-BODRvkc7.js";import"./layerUtils-kYGDyovj.js";import"./SketchLabelOptions-CdsKprwo.js";import"./SketchOptions-CwjAcyI0.js";import"./SnappingManager-DCRQCwjI.js";import"./automaticAreaMeasurementUtils-BDF5aXgy.js";import"./geodesicAreaMeasurementUtils-thvXrmuo.js";import"./earcut-D9gy186-.js";import"./MeshTransform-DL7voDcB.js";import"./triangulationUtils-Bx6S2VF2.js";import"./deduplicate-DCdpRX6I.js";import"./vertexSpaceConversion--9VICkO9.js";import"./vec4-CJuiouB0.js";import"./External-CRHviFCd.js";class T{constructor(t,r,i,s,n,a,e,o,p){this.level=t,this.row=r,this.column=i,this.horizontalFieldOfView=s,this.verticalFieldOfView=n,this.yaw=a,this.pitch=e,this.distance=o,this.getPixelBlock=p,this._cache=null,this.loadMesh=async l=>{const{level:h,row:c,column:u,horizontalFieldOfView:f,verticalFieldOfView:d,yaw:w,pitch:M,distance:g}=this,{Mesh:_,MeshComponent:v,MeshVertexAttributes:x,panoramicMeshManager:b}=await N(),{faces:R,...I}=await b.getFacesWithVertexAttributes({distance:g,yaw:w,horizontalFieldOfView:f,pitch:M,verticalFieldOfView:d});L(l);const y=await this.getPixelBlock(h,c,u,l);if(L(l),!y)throw new A("panoramic-viewer:missing-tile-data",`Tile data for level ${h}, row ${c}, column ${u} is missing`,{level:h,row:c,column:u});const B=await b.convertPixelBlockToImageData(y);L(l);const z=new _({vertexAttributes:new x(I),components:[new v({faces:R,trustSourceNormals:!0,material:new q({colorTexture:new E({data:B})})})],spatialReference:S.WebMercator});return await z.load(l),this._cache=z,this._cache},this.loadMeshAtDistance=async(l,h)=>{const c=this.distance;return this.distance=l,Math.abs(c-l)>1e-6&&this._cache?this._cache:await this.loadMesh(h)}}get loaded(){return this._cache!==null}get key(){return`${this.level}/${this.row}/${this.column}`}clone(){const{level:t,row:r,column:i,horizontalFieldOfView:s,verticalFieldOfView:n,yaw:a,pitch:e,distance:o,getPixelBlock:p}=this,l=new T(t,r,i,s,n,a,e,o,p);if(this._cache){const{vertexAttributes:h,components:c,spatialReference:u}=this._cache,f=c?.map(({material:d,faces:w,trustSourceNormals:M})=>({material:d,faces:w?.slice(),trustSourceNormals:M}));l._cache=new j({components:f,vertexAttributes:h.clone(),spatialReference:u})}return l}}class G{constructor(){this._keys=[],this._map=new Map}set(t,r){let i=0;for(;i<this._keys.length&&this._keys[i]<t;)i++;return this._keys.splice(i,0,t),this._map.set(t,r),this}get(t){let r=this._keys[0];for(const i of this._keys)t>=i&&(r=i);return this._map.get(r)}clear(){this._keys=[],this._map.clear()}}function $(m){return((m+180)%360+360)%360-180}function F(m){return Math.max(-90,Math.min(90,m))}function K(m,t,r,i){const s=Math.min(Math.max(r,0),360),n=Math.min(Math.max(i,0),180),a=s/2,e=n/2,o=t-90,p=F(o-e),l=F(o+e),h=l>=90||p<=-90||s>=360,c=$(m);return{latMin:p,latMax:l,lonMin:$(c-a),lonMax:$(c+a),fullLongitude:h,hfov:s,vfov:n}}function Q(m,t,r,i){if(Math.abs(t-m)>=360||Math.abs(i-r)>=360)return!0;function s(e,o){return e<=o?[[e,o]]:[[e,180],[-180,o]]}const n=s(m,t),a=s(r,i);for(const e of n)for(const o of a)if(!(e[1]<=o[0]||e[0]>=o[1]))return!0;return!1}function U(m,t,r,i){return!(t<=r||m>=i)}function V(m,t,r,i){const s=360/r,n=180/i,a=m*s-180,e=a+s,o=90-t*n,p=o-n;return{lonMinRaw:a,lonMaxRaw:e,lonMin:$(a),lonMax:$(e),latMin:p,latMax:o}}function X(m,[t,r],[i,s],n,a,e,o,p){const{latMin:l,latMax:h,lonMin:c,lonMax:u,fullLongitude:f}=K(a,e,o,p),d=i-t+1,w=s-r+1,M=[];for(let g=t;g<=i;g++){const{lonMin:_,lonMax:v}=V(g,r,d,w);if(f||Q(c,u,_,v))for(let x=r;x<=s;x++){const{latMin:b,latMax:R}=V(g,x,d,w);if(!U(l,h,b,R))continue;const I=`${m}/${x}/${g}`,y=n.get(I);y&&M.push(y)}}return M}let k=class extends W(C){constructor(m){super(m),this._maximumPyramidLevel=-1,this._pixelAngleToLevelMap=new G,this._tileMap=new Map,this.raster=null,this._fetchRawTile=async(t,r,i,s)=>{await this._initJobHandler();const{pyramidBlockWidth:n,pyramidBlockHeight:a}=this.storageInfo,{minCol:e,maxCol:o,minRow:p,maxRow:l}=this.storageInfo.blockBoundary[t],h=o-e+1,c=l-p+1,u=i*this.imageSize[0]/h,f=r*this.imageSize[1]/c,d=Math.min((i+1)*this.imageSize[0]/h,this.imageSize[0]),w=Math.min((r+1)*this.imageSize[1]/c,this.imageSize[1]),M=d-u,g=w-f,_=new H({xmin:u-.5,ymin:.5-w,xmax:d-.5,ymax:.5-f,spatialReference:this.raster.rasterInfo.spatialReference}),{pixelBlock:v}=await this.raster.fetchPixels(_,n??M,a??g,s);return v},this.getLevelTiles=t=>{const r=[],{minCol:i,maxCol:s,minRow:n,maxRow:a}=this.storageInfo.blockBoundary[t];for(let e=n;e<=a;e++)for(let o=i;o<=s;o++){const p=this._tileMap.get(`${t}/${e}/${o}`);p&&r.push(p)}return r.length?r:null},this.getLevelWithPixelAngle=t=>this._pixelAngleToLevelMap.get(t)??0,this.getLowResolutionTiles=()=>{const t=this.maximumPyramidLevel;return t<0?null:this.getLevelTiles(t)},this.getTiles=(t,r,i,s,n)=>{const{minCol:a,minRow:e,maxCol:o,maxRow:p}=this.storageInfo.blockBoundary[t];return X(t,[a,e],[o,p],this._tileMap,r,i,s,n)}}initialize(){this._processLevels()}destroy(){this.raster.rasterJobHandler=null,this.raster=null,this._shutdownJobHandler(),this._tileMap.clear(),this._pixelAngleToLevelMap.clear()}async _initJobHandler(){this._rasterJobHandler||(await super._initJobHandler(),this.raster.rasterJobHandler=this._rasterJobHandler)}_processLevels(){const{blockBoundary:m,tileInfo:t}=this.storageInfo,r=m?.length;if(!r)throw new A("panoramic-viewer:missing-pyramid-resolutions","TIFF/MRF must have pyramid resolutions defined",{rasterId:this.raster.rasterId});this._tileMap.clear();for(let i=0;i<r;i++){const{maxCol:s,maxRow:n,minCol:a,minRow:e}=m[i],o=180/(n-e+1),p=360/(s-a+1),l=p/t.size[0];if(l>D)break;this._pixelAngleToLevelMap.set(l,i);for(let h=e;h<=n;h++){const c=180-(h+.5)*o;for(let u=a;u<=s;u++){const f=(u+.5)*p-180;this._tileMap.set(`${i}/${h}/${u}`,new T(i,h,u,p,o,f,c,Y/2,this._fetchRawTile))}}this._maximumPyramidLevel=i}}get rasterInfo(){return this.raster.rasterInfo}get storageInfo(){return this.rasterInfo.storageInfo}get imageSize(){const{width:m,height:t}=this.rasterInfo;return[m,t]}get maximumPyramidLevel(){return this._maximumPyramidLevel}};P([J()],k.prototype,"raster",void 0),k=P([O("esri.widgets.PanoramicViewer.support.PanoramicTilePyramid")],k);const Cr=k;export{Cr as default};
