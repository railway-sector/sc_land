import{ds as L,a4 as A,aa as S,Y as C,b3 as H,_ as P,e as J,g as O}from"./index-BrQW8HOS.js";import{i as W}from"./RasterJobHandlerMixin-MT2g2T_q.js";import{l as N,n as D,t as Y}from"./customElement-C8MorqK0.js";import{Y as j}from"./Mesh-fhI0Tv0o.js";import{n as q,g as E}from"./MeshComponent-BJOK3WKo.js";import"./multidimensionalUtils-C73Q5ZGV.js";import"./RasterSymbolizer-B2A1UV2B.js";import"./PixelBlock-BLuOu6Ty.js";import"./pixelRangeUtils-BvOub3JO.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./vectorFieldUtils-BtFp6QX2.js";import"./datasetUtils-DdDUWBI2.js";import"./utils-6_NAbAK3.js";import"./cimSymbolUtils-CmFYUdpV.js";import"./gfxUtils-DDSu4Luj.js";import"./ClassBreaksDefinition-Bdvs4GrJ.js";import"./dataUtils-GsysffW0.js";import"./OrientedImageryLayer-T2nz_Xpq.js";import"./a11yUtils-BrnjXW_g.js";import"./projectOperator-p23D9sjF.js";import"./operatorProject-DxiD_TZp.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ElevationLayer-mcjhsuEV.js";import"./ArcGISCachedService-CjQQR1Jv.js";import"./TileInfoTilemapCache-DZPzARxb.js";import"./LercDecoder-CQqToE6M.js";import"./ImageryLayer-BC1GWxe2.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./imageBitmapUtils-CV2jqiy6.js";import"./rasterFieldUtils-Ch69mkjb.js";import"./RasterPresetRendererMixin-B-VKGZPd.js";import"./executeForIds-Cnn1OWXP.js";import"./query-D5mFMRFz.js";import"./pbfQueryUtils-PegbNvJC.js";import"./pbf-bO1aG1II.js";import"./executeQueryJSON-CQzDonsh.js";import"./requestPresets-CKwN6OUr.js";import"./ExpandViewModel-CFigZjjU.js";import"./widget-lSGAz9tN.js";import"./GraphicsLayer-CtVknZ1a.js";import"./vmEvent-CsrnYMSK.js";import"./MediaLayer-CCxfRpfr.js";import"./VideoElement-H0PUUZ6l.js";import"./MediaElementView-B-fdwXAA.js";import"./normalizeUtilsSync-DbZEvtY3.js";import"./ControlPoint-BjgmUvqO.js";import"./mediaLayerUtils-BJ-DU5EY.js";import"./ImageElement-CQTHnHSe.js";import"./BoundsStore-DpCEPPZ3.js";import"./Circle-CDzQBXRC.js";import"./geodesicUtils-BJZXB7Hp.js";import"./MeshVertexAttributes-D5nCmuxt.js";import"./meshProperties-DWLWd_LJ.js";import"./deepClone-CS2OSa44.js";import"./languageUtils-DuyO7Ix1.js";import"./ImmutableArray-BPVd6ESQ.js";import"./shared-DBXlHENV.js";import"./number-CjVmF4xk.js";import"./floorFilterUtils-DKzVzLpH.js";import"./MapView-YOBSX6K6.js";import"./View2D-CXXq0vs5.js";import"./clippingUtils-BM7WDzJt.js";import"./viewpointUtils-CqwA4uEG.js";import"./mat2d-BbBq4Byx.js";import"./mat2df64-DJ_RMjZ3.js";import"./mat2df32-Dpt2CT5P.js";import"./hitTestUtils-DuJ-LfGM.js";import"./rbush-DRx18tQf.js";import"./Tile-BIybhnuW.js";import"./arcadeUtils-MYBE13Eg.js";import"./Timeline-Cz5T4vl1.js";import"./utils-D_VO_1nP.js";import"./Draw-C_AMmCSB.js";import"./SnappingVisualizer2D-D8AbMCG0.js";import"./euclideanLengthMeasurementUtils-B8AL_WaV.js";import"./geometry2dUtils-kADrF-iP.js";import"./geodeticLengthOperator-DifrZujk.js";import"./geodeticCurveType-CirnHLSB.js";import"./geodesicMeasurementUtils-CQw8IWGR.js";import"./SnappingVisualizer-C6MiCxsp.js";import"./PointSnappingHint-Bb4Sdzt2.js";import"./coordinateHelper-DrvFu3jL.js";import"./EditGeometryOperations-vGO-F4bG.js";import"./rotate-BhR0-nSl.js";import"./curveOperationUtils-DH-ids6k.js";import"./SnappingContext-lR2hMWGP.js";import"./SnappingOperation-C2jjQrkg.js";import"./automaticLengthMeasurementUtils-Cr-y0OEN.js";import"./DrawingMode-Cvvf0VVz.js";import"./surfaceCoordinateSystems-BrNYf00T.js";import"./drawUtils-SR7_OwBd.js";import"./quantityFormatUtils-DM7lTTMC.js";import"./areaOperator-D3kAgWzZ.js";import"./Point2D-DNXcsliy.js";import"./Envelope2D-CUWyosZh.js";import"./ProjectionTransformation-BjD312Kq.js";import"./Transformation2D-BUBnKQZf.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-BHYd2kGf.js";import"./apiConverter---8F7iZ4.js";import"./geodeticAreaOperator-ByYk3Bkb.js";import"./geodeticDensifyOperator-BOpsJkz4.js";import"./operatorGeodeticDensify-nwbiaD87.js";import"./lengthOperator-Br-Q2qCg.js";import"./simplifyOperator-BQVvn5Fy.js";import"./operatorSimplify-C16tE3lk.js";import"./operators-CXiTjj3T.js";import"./affineTransformOperator-BKNCSN4p.js";import"./operatorGeodesicBuffer-D8PQ9jFi.js";import"./simplifyOGCOperator-DDBsrw9u.js";import"./OperatorSimplifyOGC-DcNrF_Mf.js";import"./Transformation-CXt5h21i.js";import"./bufferOperator-BiJUv4mF.js";import"./operatorBuffer-CaIv_CSz.js";import"./Bufferer-Dw9Qi4T1-CvYDX-1r.js";import"./OperatorGeneralize-DppLq4y-.js";import"./centroidOperator-Cjo9P-qe.js";import"./Centroid-DZi-eb9F-ClGofmgB.js";import"./clipOperator-CZe8yiJF.js";import"./containsOperator-DNx102s3.js";import"./operatorConvexHull-CLXAmAdc.js";import"./OperatorCrosses-DB7FRg7V.js";import"./cutOperator-C_GdDi0E.js";import"./densifyOperator-vKowcNxj.js";import"./operatorDensify-BYGdpA54.js";import"./differenceOperator-CyhDoPG_.js";import"./distanceOperator-BeiDdpLt.js";import"./Distance2DCalculator-CXhBP-8I-Dkb8-KBJ.js";import"./equalsOperator-DvQtL8Uf.js";import"./generalizeOperator-COoaBFuG.js";import"./operatorGeneralize-Cl8mifHq.js";import"./intersectionOperator-BerN0YBP.js";import"./operatorIntersection-Dk662p0x.js";import"./intersectsOperator-CKuf4yKG.js";import"./OperatorIntersects-DfaHxqTc.js";import"./labelPointOperator-Cx7qMfIy.js";import"./OperatorProximity-Bx0bzIXN.js";import"./OperatorOverlaps-n6lZ5y_F.js";import"./proximityOperator-CeAOEVUj.js";import"./relateOperator-BbKNGnbr.js";import"./symmetricDifferenceOperator-BDttf2Xk.js";import"./OperatorTouches-DGMDJcwi.js";import"./unionOperator-CEwj5emJ.js";import"./operatorUnion-B1Eso4ej.js";import"./OperatorWithin-D4IqirkT.js";import"./offset-5dJF8WuL.js";import"./unitConversion-xbmYuQOc.js";import"./operatorOffset-Dh_0wl36.js";import"./ImageryTileLayer-Bw8EVTFT.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./xmlUtilities-0Gc5qIUC.js";import"./QueueProcessor-CL6qRd0z.js";import"./RawBlockCache-Dkglau7b.js";import"./rasterProjectionHelper-daQRJxKm.js";import"./clipUtils-C90NVAfo.js";import"./rasterFunctionHelper-CVPDO2RW.js";import"./PolynomialTransform-B3lvtn1Q.js";import"./SketchViewModel-NRhuw9HA.js";import"./isSupportedObject-DknMXN_6.js";import"./layerUtils-CdCZXuDJ.js";import"./SketchLabelOptions-BPF5xZLI.js";import"./SketchOptions-CHLlByzL.js";import"./SnappingManager-BWOfKl0d.js";import"./automaticAreaMeasurementUtils-dI3X5owW.js";import"./geodesicAreaMeasurementUtils-CPlOyDe5.js";import"./earcut-D9gy186-.js";import"./substitute-D-eLZ17Q.js";import"./useWidget-CYtf2hFT.js";import"./useView-Cya0Zpns.js";import"./MeshTransform-wQhxY5y6.js";import"./triangulationUtils-DRNEJzEV.js";import"./deduplicate-BmrPw5DR.js";import"./vertexSpaceConversion-DeCTRUfs.js";import"./vec4-CDOmPIEg.js";import"./External-B7cfwcdG.js";class T{constructor(t,r,i,m,p,s,o,e,n){this.level=t,this.row=r,this.column=i,this.horizontalFieldOfView=m,this.verticalFieldOfView=p,this.yaw=s,this.pitch=o,this.distance=e,this.getPixelBlock=n,this._cache=null,this.loadMesh=async l=>{const{level:h,row:c,column:u,horizontalFieldOfView:f,verticalFieldOfView:d,yaw:w,pitch:M,distance:g}=this,{Mesh:_,MeshComponent:v,MeshVertexAttributes:x,panoramicMeshManager:b}=await N(),{faces:R,...I}=await b.getFacesWithVertexAttributes({distance:g,yaw:w,horizontalFieldOfView:f,pitch:M,verticalFieldOfView:d});L(l);const y=await this.getPixelBlock(h,c,u,l);if(L(l),!y)throw new A("panoramic-viewer:missing-tile-data",`Tile data for level ${h}, row ${c}, column ${u} is missing`,{level:h,row:c,column:u});const B=await b.convertPixelBlockToImageData(y);L(l);const z=new _({vertexAttributes:new x(I),components:[new v({faces:R,trustSourceNormals:!0,material:new q({colorTexture:new E({data:B})})})],spatialReference:S.WebMercator});return await z.load(l),this._cache=z,this._cache},this.loadMeshAtDistance=async(l,h)=>{const c=this.distance;return this.distance=l,Math.abs(c-l)>1e-6&&this._cache?this._cache:await this.loadMesh(h)}}get loaded(){return this._cache!==null}get key(){return`${this.level}/${this.row}/${this.column}`}clone(){const{level:t,row:r,column:i,horizontalFieldOfView:m,verticalFieldOfView:p,yaw:s,pitch:o,distance:e,getPixelBlock:n}=this,l=new T(t,r,i,m,p,s,o,e,n);if(this._cache){const{vertexAttributes:h,components:c,spatialReference:u}=this._cache,f=c?.map(({material:d,faces:w,trustSourceNormals:M})=>({material:d,faces:w?.slice(),trustSourceNormals:M}));l._cache=new j({components:f,vertexAttributes:h.clone(),spatialReference:u})}return l}}class G{constructor(){this._keys=[],this._map=new Map}set(t,r){let i=0;for(;i<this._keys.length&&this._keys[i]<t;)i++;return this._keys.splice(i,0,t),this._map.set(t,r),this}get(t){let r=this._keys[0];for(const i of this._keys)t>=i&&(r=i);return this._map.get(r)}clear(){this._keys=[],this._map.clear()}}function $(a){return((a+180)%360+360)%360-180}function F(a){return Math.max(-90,Math.min(90,a))}function K(a,t,r,i){const m=Math.min(Math.max(r,0),360),p=Math.min(Math.max(i,0),180),s=m/2,o=p/2,e=t-90,n=F(e-o),l=F(e+o),h=l>=90||n<=-90||m>=360,c=$(a);return{latMin:n,latMax:l,lonMin:$(c-s),lonMax:$(c+s),fullLongitude:h,hfov:m,vfov:p}}function Q(a,t,r,i){if(Math.abs(t-a)>=360||Math.abs(i-r)>=360)return!0;function m(o,e){return o<=e?[[o,e]]:[[o,180],[-180,e]]}const p=m(a,t),s=m(r,i);for(const o of p)for(const e of s)if(!(o[1]<=e[0]||o[0]>=e[1]))return!0;return!1}function U(a,t,r,i){return!(t<=r||a>=i)}function V(a,t,r,i){const m=360/r,p=180/i,s=a*m-180,o=s+m,e=90-t*p,n=e-p;return{lonMinRaw:s,lonMaxRaw:o,lonMin:$(s),lonMax:$(o),latMin:n,latMax:e}}function X(a,[t,r],[i,m],p,s,o,e,n){const{latMin:l,latMax:h,lonMin:c,lonMax:u,fullLongitude:f}=K(s,o,e,n),d=i-t+1,w=m-r+1,M=[];for(let g=t;g<=i;g++){const{lonMin:_,lonMax:v}=V(g,r,d,w);if(f||Q(c,u,_,v))for(let x=r;x<=m;x++){const{latMin:b,latMax:R}=V(g,x,d,w);if(!U(l,h,b,R))continue;const I=`${a}/${x}/${g}`,y=p.get(I);y&&M.push(y)}}return M}let k=class extends W(C){constructor(a){super(a),this._maximumPyramidLevel=-1,this._pixelAngleToLevelMap=new G,this._tileMap=new Map,this.raster=null,this._fetchRawTile=async(t,r,i,m)=>{await this._initJobHandler();const{pyramidBlockWidth:p,pyramidBlockHeight:s}=this.storageInfo,{minCol:o,maxCol:e,minRow:n,maxRow:l}=this.storageInfo.blockBoundary[t],h=e-o+1,c=l-n+1,u=i*this.imageSize[0]/h,f=r*this.imageSize[1]/c,d=Math.min((i+1)*this.imageSize[0]/h,this.imageSize[0]),w=Math.min((r+1)*this.imageSize[1]/c,this.imageSize[1]),M=d-u,g=w-f,_=new H({xmin:u-.5,ymin:.5-w,xmax:d-.5,ymax:.5-f,spatialReference:this.raster.rasterInfo.spatialReference}),{pixelBlock:v}=await this.raster.fetchPixels(_,p??M,s??g,m);return v},this.getLevelTiles=t=>{const r=[],{minCol:i,maxCol:m,minRow:p,maxRow:s}=this.storageInfo.blockBoundary[t];for(let o=p;o<=s;o++)for(let e=i;e<=m;e++){const n=this._tileMap.get(`${t}/${o}/${e}`);n&&r.push(n)}return r.length?r:null},this.getLevelWithPixelAngle=t=>this._pixelAngleToLevelMap.get(t)??0,this.getLowResolutionTiles=()=>{const t=this.maximumPyramidLevel;return t<0?null:this.getLevelTiles(t)},this.getTiles=(t,r,i,m,p)=>{const{minCol:s,minRow:o,maxCol:e,maxRow:n}=this.storageInfo.blockBoundary[t];return X(t,[s,o],[e,n],this._tileMap,r,i,m,p)}}initialize(){this._processLevels()}destroy(){this.raster.rasterJobHandler=null,this.raster=null,this._shutdownJobHandler(),this._tileMap.clear(),this._pixelAngleToLevelMap.clear()}async _initJobHandler(){this._rasterJobHandler||(await super._initJobHandler(),this.raster.rasterJobHandler=this._rasterJobHandler)}_processLevels(){const{blockBoundary:a,tileInfo:t}=this.storageInfo,r=a?.length;if(!r)throw new A("panoramic-viewer:missing-pyramid-resolutions","TIFF/MRF must have pyramid resolutions defined",{rasterId:this.raster.rasterId});this._tileMap.clear();for(let i=0;i<r;i++){const{maxCol:m,maxRow:p,minCol:s,minRow:o}=a[i],e=180/(p-o+1),n=360/(m-s+1),l=n/t.size[0];if(l>D)break;this._pixelAngleToLevelMap.set(l,i);for(let h=o;h<=p;h++){const c=180-(h+.5)*e;for(let u=s;u<=m;u++){const f=(u+.5)*n-180;this._tileMap.set(`${i}/${h}/${u}`,new T(i,h,u,n,e,f,c,Y/2,this._fetchRawTile))}}this._maximumPyramidLevel=i}}get rasterInfo(){return this.raster.rasterInfo}get storageInfo(){return this.rasterInfo.storageInfo}get imageSize(){const{width:a,height:t}=this.rasterInfo;return[a,t]}get maximumPyramidLevel(){return this._maximumPyramidLevel}};P([J()],k.prototype,"raster",void 0),k=P([O("esri.widgets.PanoramicViewer.support.PanoramicTilePyramid")],k);const co=k;export{co as default};
