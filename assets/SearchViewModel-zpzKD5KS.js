import{bF as rt,ch as H,_ as i,e as l,nm as Y,g as D,a4 as R,fn as ot,$ as A,DI as it,c3 as Te,DJ as oe,aP as U,ae as Le,H as nt,bT as lt,b3 as ce,al as Z,aa as te,cj as Re,dA as pe,dC as Ie,dB as Ee,cv as de,cR as je,cn as me,cE as at,ac as ut,ao as ie,O as ct,fb as pt,d8 as dt,fd as ht,av as gt,o3 as yt,bR as ft,a2 as Ce,f as Se,bI as ve,rm as W,j0 as mt,BB as we,db as St,B as vt,DK as wt,aQ as re,DL as xt,iJ as bt}from"./index-BrQW8HOS.js";import{c as he,i as ne,o as xe,a as _t}from"./geometryUtils-DV6xDwql.js";import{s as $t}from"./substitute-D-eLZ17Q.js";import{t as ge}from"./commonProperties-DHiB1uzW.js";import{g as be,p as Ft,f as Tt}from"./geolocationUtils-D_cZV359.js";let v=class extends rt(H){constructor(s){super(s),this.autoNavigate=null,this.filter=null,this.getResults=null,this.getSuggestions=null,this.maxResults=null,this.maxSuggestions=null,this.minSuggestCharacters=null,this.outFields=null,this.placeholder="",this.popupEnabled=null,this.popupTemplate=null,this.prefix="",this.resultGraphicEnabled=null,this.resultSymbol=null,this.suffix="",this.suggestionsEnabled=null,this.withinViewEnabled=!1,this.zoomScale=null}};i([l()],v.prototype,"autoNavigate",void 0),i([l()],v.prototype,"filter",void 0),i([l()],v.prototype,"getResults",void 0),i([l()],v.prototype,"getSuggestions",void 0),i([l()],v.prototype,"maxResults",void 0),i([l()],v.prototype,"maxSuggestions",void 0),i([l()],v.prototype,"minSuggestCharacters",void 0),i([l()],v.prototype,"outFields",void 0),i([l()],v.prototype,"placeholder",void 0),i([l()],v.prototype,"popupEnabled",void 0),i([l({type:Y})],v.prototype,"popupTemplate",void 0),i([l()],v.prototype,"prefix",void 0),i([l()],v.prototype,"resultGraphicEnabled",void 0),i([l()],v.prototype,"resultSymbol",void 0),i([l()],v.prototype,"suffix",void 0),i([l()],v.prototype,"suggestionsEnabled",void 0),i([l()],v.prototype,"withinViewEnabled",void 0),i([l()],v.prototype,"zoomScale",void 0),v=i([D("esri.widgets.Search.SearchSource")],v);const ye=v,Lt=/https?:\/\/services.*\.arcgis\.com/i,Rt=/(?:\{([^}]+)\})/g,q=()=>A.getLogger("esri.widgets.Search.support.layerSearchUtils");function It(s,e){const{exactMatch:t=!1,location:o,maxResults:r,spatialReference:n,source:a,sourceIndex:u,suggestResult:c,view:p}=s,{layer:d,filter:y,zoomScale:S}=a,f=p?.scale,g=Ne(a,p),w=e?.signal;return Pe(d).then(()=>{const x=d.popupTemplate;return x?x.getRequiredFields(d.fieldsIndex):null}).then(x=>{const{objectIdField:C,returnZ:N}=d,I=Ke(a);if(!fe(d,I))throw q().error("invalid-field: displayField is invalid."),new R("getResults():invalid-field","displayField is invalid.");const b=x?.length?x:[I],F=a.outFields||b,G=Oe(F);if(F.includes(C)||G||F.push(C),d.floorInfo?.floorField&&F.push(d.floorInfo.floorField),!(G||ee(d,F)))throw q().error("invalid-field: outField is invalid."),new R("getResults():invalid-field","outField is invalid.");const m=d.createQuery(),{orderByFields:k}=a;if(k&&(m.orderByFields=k),n){m.outSpatialReference=n;const O=1/ot(n);O&&(m.maxAllowableOffset=O)}const K=d.geometryType==="mesh"||d.geometryType==="multipatch",E=d.capabilities?.data?.supportsZ&&!K;if(m.returnZ=E&&N!==!1,m.returnGeometry=!0,m.multipatchOption=K?"xyFootprint":null,F&&(m.outFields=F),o)m.geometry=o;else if(c.key)m.objectIds=[c.key];else{const O=a.searchFields||[I];if(!ee(d,O))throw q().error("invalid-field: search field is invalid."),new R("getResults():invalid-field","search field is invalid.");if(ke(d)&&(m.num=r),g&&(m.geometry=g),!c.text?.trim())return[];const se=c.text,{prefix:Ye="",suffix:et=""}=a,tt=Ve(`${Ye}${se}${et}`);Me(d)&&De(d,O)&&!t&&se&&(m.fullText=Ge({text:se,searchFields:O}));const st=ze({searchTerm:tt,layer:d,searchFields:O,filter:y,exactMatch:t,query:m,type:"search"});if(m.where=st,!Ae(m))return[]}return d.queryFeatures(m,{signal:w}).then(O=>Vt(O,p,a,u,I,f,S))})}function Et(s,e){const{source:t,spatialReference:o,view:r,suggestTerm:n,maxSuggestions:a,sourceIndex:u,exactMatch:c}=s,{layer:p,filter:d}=t,y=e?.signal,S=Ne(t,r);return Pe(p).then(()=>{if(!ke(p))return[];const f=Ke(t),g=t.searchFields||[f],w=[];t.suggestionTemplate?t.suggestionTemplate.replaceAll(Rt,(E,O)=>(w.push(O),E)):w.push(f);const x=Oe(w);w.includes(p.objectIdField)||x||w.push(p.objectIdField);const C=fe(p,f),N=x||ee(p,w),I=ee(p,g);if(!C)throw q().error("invalid-field: displayField is invalid."),new R("getSuggestions():invalid-field","displayField is invalid.");if(!N)throw q().error("invalid-field: outField is invalid."),new R("getSuggestions():invalid-field","outField is invalid.");if(!I)throw q().error("invalid-field: search field is invalid."),new R("getSuggestions():invalid-field","search field is invalid.");const b=p.createQuery(),{orderByFields:F}=t;if(F&&(b.orderByFields=F),b.outSpatialReference=o,b.returnGeometry=!1,b.num=a,b.outFields=w,S&&(b.geometry=S),!n.trim())return[];const{prefix:G="",suffix:m=""}=t,k=Ve(`${G}${n}${m}`);Me(p)&&De(p,g)&&!c&&n&&(b.fullText=Ge({text:n,searchFields:g}));const K=ze({searchTerm:k,layer:p,searchFields:g,filter:d,exactMatch:c,query:b,type:"suggest"});return b.where=K,Ae(b)?p.queryFeatures(b,{signal:y}).then(E=>Mt(E,t,u,f)):[]})}function Ne(s,e){const{filter:t,withinViewEnabled:o}=s,r=e?.extent;return t?.geometry??(o&&r?r:void 0)}function Oe(s){return s&&s.includes("*")}async function Pe(s){s&&await s.load()}function Ae(s){return!(!s.fullText&&!s.where)}function De(s,e){const t=s?.indexes;return!t||!e?.length?!1:t.filter(o=>o.indexType==="FullText").some(o=>{const r=o.fields?.split(",").map(n=>n.trim().toLowerCase())||[];return e.every(n=>r.includes(n.toLowerCase()))})}function Ge({text:s,searchFields:e}){return s.trim().split(" ").filter(t=>!!t.trim()).map(t=>new it({onFields:e,searchTerm:t,searchType:"prefix"}))}function Me(s){return s?.capabilities?.query?.supportsFullTextSearch??!1}function ke(s){return s?.capabilities?.query?.supportsPagination??!1}function jt(s){return s?.fieldsIndex?.fields?.find(e=>e.type==="string")?.name??""}function Ke(s){return s.displayField||s.layer.displayField||jt(s.layer)}function ee(s,e){return!(!s||!e?.length)&&e.every(t=>fe(s,t))}function fe(s,e){return!!s.getField(e)}function Ct(s){for(let e=0;e<s.length;e++)if(s.charCodeAt(e)>255)return!0;return!1}function Nt({codedValues:s},e,t){return oe(s??[],o=>{const r=o.name,n=t?r:r.toLowerCase();return(t?e:e.toLowerCase())===n?o.code.toString():null})??null}function Ve(s){return s.replaceAll("'","''")}function Q(s,e){const t=e?.where;return t?`(${s}) AND (${t})`:s}function Ot({currentTerm:s,field:e,filter:t,exactMatch:o,url:r,type:n}){const a=e?.type,u=e?.name;if(a==="string"||a==="date"||a==="global-id"){const c=Lt.test(r??""),p=c&&Ct(s)?"N":"";return Q(o&&n==="search"?`${u} = ${p}'${s}'`:c?`${u} LIKE ${p}${`'${s}%'`}`:`${`LOWER(${u})`} LIKE ${p}${`'${s.toLowerCase()}%'`}`,t)}if(a==="oid"||a==="small-integer"||a==="integer"||a==="single"||a==="double"){const c=Number(s);return isNaN(c)?null:Q(`${u} = ${c}`,t)}return Q(`${u} = ${s}`,t)}function Pt(s,e){return s?` OR (${e})`:`(${e})`}function ze({searchTerm:s,layer:e,searchFields:t,filter:o,exactMatch:r,query:n,type:a}){const{definitionExpression:u,url:c}=e;let p="";return!n.fullText&&s&&t&&t.forEach(d=>{const y=e.getField(d),S=e.getFieldDomain?.(d,{excludeImpliedDomains:Te("esri-widget-legacy-field-domain-calculation")}),f=(S&&S.type==="coded-value"?Nt(S,s,r):null)||s||null;if(f!==null){const g=Ot({currentTerm:f,field:y,filter:o,exactMatch:r,url:c,type:a});g&&(p+=Pt(p,g))}}),u&&p?`(${u}) AND (${p})`:u||p}function At(s,e){let t=null;const{codedValues:o}=s;return o&&o.length&&o.some(r=>r.code===e&&(t=r.name,!0)),t}function Dt(s,e){return s[e]??s[Object.keys(s).find(t=>t.toLowerCase()===e.toLowerCase())]}function Be(s,e,t){const o=s.sourceLayer,{attributes:r}=s,n=o.getFieldDomain?.(t,{feature:s,excludeImpliedDomains:Te("esri-widget-legacy-field-domain-calculation")});if(e)return $t(e,r);if(t&&r){const a=o.getField(t),u=Dt(r,t);return u==null?"":n&&n.type==="coded-value"?At(n,u)??"":a?.type==="date"?nt(new Date(u)):typeof u=="number"?u.toString():typeof u!="string"?"":u.trim()}return""}function Gt(s,e,t,o){const r=s.sourceLayer,{attributes:n}=s,{objectIdField:a}=r,u=a?n[a]:null;return{text:Be(s,e.suggestionTemplate,o),key:u,sourceIndex:t}}function Mt(s,e,t,o){return s.features.map(r=>Gt(r,e,t,o))}function kt(s){return s!=null&&s.minScale!=null&&s.maxScale!=null}function Kt(s,e,t,o,r,n,a){const u=s.clone();u.layer=s.layer;const c=s.sourceLayer,p=c?.objectIdField,d=p?s.attributes[p]:null,y=Be(s,t.searchTemplate,r);n!=null&&kt(c)&&(c.minScale&&c.minScale<n?n=c.minScale:c.maxScale&&c.maxScale>n&&(n=c.maxScale));const S=u.geometry?he(u.geometry,e??void 0,n??void 0):void 0,f=typeof a=="number"&&S?ne(U(S),e??void 0,a):S,g=s.clone();return g.layer=s.layer,f!=null&&(g.geometry=Le.fromExtent(f)),{extent:f,target:g,feature:u,key:d,name:y,sourceIndex:o}}function Vt(s,e,t,o,r,n,a){return s.features.map(u=>Kt(u,e,t,o,r,n,a))}var le;let P=le=class extends ye{constructor(s){super(s),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,t)=>It({source:this,...e},t),this.getSuggestions=(e,t)=>Et({source:this,...e},t)}set layer(s){this._set("layer",s),s&&s.load().catch(()=>{})}get name(){return this._getLayerTitle()??""}set name(s){this._overrideIfSome("name",s)}clone(){return new le({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?U(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?U(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find(s=>s.type==="string")?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:s,searchFields:e}=this;if(!s.loaded)return"";const t=e||[this._getDisplayField()],o=lt(s);return`: ${t.map(r=>{const n=s.getField(r);return(o?s.getFieldAlias(r):n?.alias)||r}).join(", ")}`}_getLayerTitle(){const{layer:s}=this;if(!s)return;const{title:e}=s;return e?`${e}${this._getSearchFieldsString()}`:void 0}};i([l({json:{read:{source:"field.name"},write:{target:"field.name"}}})],P.prototype,"displayField",void 0),i([l({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],P.prototype,"exactMatch",void 0),i([l({value:null})],P.prototype,"layer",null),i([l()],P.prototype,"name",null),i([l({type:[String],json:{write:!0}})],P.prototype,"orderByFields",void 0),i([l()],P.prototype,"searchFields",void 0),i([l()],P.prototype,"searchTemplate",void 0),i([l()],P.prototype,"suggestionTemplate",void 0),P=le=i([D("esri.widgets.Search.LayerSearchSource")],P);const z=P;function zt(s){return!!s&&typeof s.x=="number"&&typeof s.y=="number"}function Bt(s){return s&&typeof s.xmin=="number"&&typeof s.ymin=="number"&&typeof s.xmax=="number"&&typeof s.ymax=="number"}let M=class extends H{constructor(e){super(e),this.address=null,this.attributes=null,this.extent=null,this.location=null,this.score=null}};i([l({type:String,json:{write:!0}})],M.prototype,"address",void 0),i([l({type:Object,json:{write:!0}})],M.prototype,"attributes",void 0),i([l({type:ce,json:{write:!0}})],M.prototype,"extent",void 0),i([l({type:Z,json:{write:!0}})],M.prototype,"location",void 0),i([l({type:Number,json:{write:!0}})],M.prototype,"score",void 0),M=i([D("esri.rest.support.AddressCandidate")],M);const qe=M;let _=class extends H{constructor(e){super(e),this.address=null,this.apiKey=null,this.categories=null,this.countryCode=null,this.forStorage=null,this.location=null,this.locationType=null,this.magicKey=null,this.maxLocations=null,this.outFields=null,this.outSpatialReference=null,this.searchExtent=null}};i([l({type:Object,json:{write:!0}})],_.prototype,"address",void 0),i([l(ge)],_.prototype,"apiKey",void 0),i([l({type:[String],json:{read:{source:"category",reader:s=>s?s.split(","):null},write:{target:"category",writer:(s,e)=>{e.category=s?s.join(","):null}}}})],_.prototype,"categories",void 0),i([l({type:String,json:{write:!0}})],_.prototype,"countryCode",void 0),i([l({type:Boolean,json:{write:!0}})],_.prototype,"forStorage",void 0),i([l({type:Z,json:{write:{writer:(s,e)=>{e.location=s?s.clone().normalize():null}}}})],_.prototype,"location",void 0),i([l({type:["rooftop","street"],json:{write:!0}})],_.prototype,"locationType",void 0),i([l({type:String,json:{write:!0}})],_.prototype,"magicKey",void 0),i([l({type:Number,json:{write:!0}})],_.prototype,"maxLocations",void 0),i([l({type:[String],json:{write:{writer:(s,e)=>{e.outFields=s?s.join(","):null}}}})],_.prototype,"outFields",void 0),i([l({type:te,json:{read:{source:"outSR"},write:{target:"outSR"}}})],_.prototype,"outSpatialReference",void 0),i([l({type:ce,json:{write:{writer:(s,e)=>{const t=s?s.shiftCentralMeridian():null;e.searchExtent=t}}}})],_.prototype,"searchExtent",void 0),_=i([D("esri.rest.support.AddressToLocationsParameters")],_),_.from=Re(_);const Je=_;async function qt(s,e,t){e=Je.from(e);const o=pe(s),{address:r,...n}=e.toJSON(),a={...r,...n,f:"json"},u=Ie({...o.query,...a}),c=Ee(u,t),p=`${o.path}/findAddressCandidates`;return de(p,c).then(Jt)}function Jt({data:s}){if(!s)return[];const{candidates:e,spatialReference:t}=s;return e?e.map(o=>{if(!o)return;const{extent:r,location:n}=o,a=!r||Bt(r);return zt(n)&&a?(r&&(r.spatialReference=t),n&&(n.spatialReference=t),qe.fromJSON(o)):void 0}):[]}const Zt=je()({DistanceMarker:"distance-marker",Locality:"locality",POI:"poi",PointAddress:"point-address",Postal:"postal",StreetAddress:"street-address",StreetInt:"street-intersection",StreetName:"street-name",Subaddress:"sub-address"}),Ht=je()({localCity:"local-city",postalCity:"postal-city"});var ae;let L=ae=class extends H{constructor(s){super(s),this.apiKey=null,this.featureTypes=null,this.forStorage=null,this.language=null,this.location=null,this.locationType=null,this.outFields=null,this.outSpatialReference=null,this.preferredLabelValues=null,this.returnInputLocation=null}writeFeatureTypes(s,e){s?.length&&(e.featureTypes=s.map(t=>Zt.toJSON(t)))}writeLocation(s,e){e.location=s?.clone().normalize().toJSON()}static from(s){return ut(ae,s)}};i([l(ge)],L.prototype,"apiKey",void 0),i([l({type:[["distance-marker","locality","poi","point-address","postal","street-address","street-intersection","street-name","sub-address"]],json:{write:!0}})],L.prototype,"featureTypes",void 0),i([me("featureTypes")],L.prototype,"writeFeatureTypes",null),i([l({type:Boolean,json:{write:!0}})],L.prototype,"forStorage",void 0),i([l({type:String,json:{name:"langCode",write:!0}})],L.prototype,"language",void 0),i([l({type:Z,json:{write:!0}})],L.prototype,"location",void 0),i([me("location")],L.prototype,"writeLocation",null),i([l({type:["street","rooftop"],json:{write:!0}})],L.prototype,"locationType",void 0),i([l({type:[String],json:{write:!0}})],L.prototype,"outFields",void 0),i([l({type:te,json:{name:"outSR",write:!0}})],L.prototype,"outSpatialReference",void 0),i([at(Ht)],L.prototype,"preferredLabelValues",void 0),i([l({type:Boolean,json:{write:!0}})],L.prototype,"returnInputLocation",void 0),L=ae=i([D("esri.rest.support.LocationToAddressParameters")],L);const Ze=L;async function Qt(s,e,t){const o=pe(s),{path:r,query:n}=o,a=Ze.from(e);if(!a.location)throw new R("location-to-address:location-required","The location parameter is required");const u={...t,query:{...n,...Ut(a),f:"json"}},c=`${r}/reverseGeocode`,{data:p}=await de(c,u),{address:d,location:y}=p;return qe.fromJSON({address:d?.Match_addr??"",attributes:d,location:y,score:100})}function Ut(s){const e=s.toJSON(),{featureTypes:t,forStorage:o,langCode:r,location:n,locationType:a,outFields:u,outSR:c,preferredLabelValues:p,returnInputLocation:d,token:y}=e;return{featureTypes:t?.join(","),forStorage:o,langCode:r,location:JSON.stringify(n),locationType:a,outFields:u?.join(","),outSR:c?.wkid??void 0,preferredLabelValues:p,returnInputLocation:d,token:y}}let B=class extends H{constructor(s){super(s),this.isCollection=null,this.magicKey=null,this.text=null}};i([l({type:Boolean,json:{write:!0}})],B.prototype,"isCollection",void 0),i([l({type:String,json:{write:!0}})],B.prototype,"magicKey",void 0),i([l({type:String,json:{write:!0}})],B.prototype,"text",void 0),B=i([D("esri.rest.support.SuggestionCandidate")],B);const Wt=B;let j=class extends H{constructor(s){super(s),this.apiKey=null,this.categories=null,this.countryCode=null,this.location=null,this.maxSuggestions=null,this.outSpatialReference=null,this.searchExtent=null,this.text=null}};i([l(ge)],j.prototype,"apiKey",void 0),i([l({type:[String],json:{read:{source:"category",reader:s=>s?s.split(","):null},write:{target:"category",writer:(s,e)=>{e.category=s?s.join(","):null}}}})],j.prototype,"categories",void 0),i([l({type:String,json:{write:!0}})],j.prototype,"countryCode",void 0),i([l({type:Z,json:{write:{writer:(s,e)=>{e.location=s?s.clone().normalize():null}}}})],j.prototype,"location",void 0),i([l({type:Number,json:{write:!0}})],j.prototype,"maxSuggestions",void 0),i([l({type:te,json:{read:{source:"outSR"},write:{target:"outSR"}}})],j.prototype,"outSpatialReference",void 0),i([l({type:ce,json:{write:{writer:(s,e)=>{const t=s?s.shiftCentralMeridian():null;e.searchExtent=JSON.stringify(t)}}}})],j.prototype,"searchExtent",void 0),i([l({type:String,json:{write:!0}})],j.prototype,"text",void 0),j=i([D("esri.rest.support.SuggestLocationsParameters")],j),j.from=Re(j);const He=j;async function Xt(s,e,t){const o=pe(s),r={...(e=He.from(e)).toJSON(),f:"json"},n=Ie({...o.query,...r}),a=Ee(n,t),u=`${o.path}/suggest`;return de(u,a).then(Yt)}function Yt(s){const{data:e}=s;if(!e)return[];const{suggestions:t}=e;return t?t.map(o=>new Wt(o)):[]}const es="Single Line Input",ts=3e5;function ss(s,e){return s.location?ls(s,e):as(s,e)}function Qe(s,e){if(e.localSearchDisabled)return null;const t=s?.scale;return typeof t=="number"&&t<=ts?s?.extent?.center:null}async function rs(s,e){const{source:t,spatialReference:o,view:r,suggestTerm:n,maxSuggestions:a,sourceIndex:u}=s,c=new He,{apiKey:p,url:d}=t,y=Ue(t,r),S=e?.signal;if(!d)return null;p&&(c.apiKey=p),t.categories&&(c.categories=t.categories),o&&(c.outSpatialReference=o);const f=Qe(r,t);if(f&&(c.location=f),!n.trim())return null;const{prefix:g="",suffix:w=""}=t,x=`${g}${n}${w}`;return c.text=x,y&&(c.searchExtent=y),c.maxSuggestions=a,t.countryCode&&(c.countryCode=t.countryCode),Xt(d,c,{signal:S}).then(C=>cs(C,u))}function os(s){return!!s&&/(?:geocode-api\.arcgis\.com\/arcgis\/rest\/services\/world\/geocodeserver).*/i.test(s)}function is(s){return!!s&&/(?:\/servers\/[\da-z.-]+\/rest\/services\/world\/geocodeserver).*/i.test(s)}function _e(s){return!!s&&/(?:arcgis\.com\/arcgis\/rest\/services\/world\/geocodeserver).*/i.test(s)}const ns="https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer";async function ls(s,e){const{location:t,source:o,sourceIndex:r,spatialReference:n,view:a}=s,{apiKey:u,defaultZoomScale:c,language:p,url:d,zoomScale:y}=o;if(d==null)return[];const S=a?.scale,f=e?.signal,g=new Ze({language:p,location:t,apiKey:u,outSpatialReference:n});try{return We([await Qt(d,g,{signal:f})],{defaultZoomScale:c,scale:S,sourceIndex:r,view:a,zoomScale:y})}catch{return[]}}function Ue(s,e){const{filter:t,withinViewEnabled:o}=s,r=e?.scale,n=e?.extent,a=t?.geometry;return(a?he(a,e??void 0,r):void 0)||(o&&n?n:void 0)}async function as(s,e){const{source:t,suggestResult:o,spatialReference:r,view:n,maxResults:a,sourceIndex:u}=s,c=t?.zoomScale,p=t?.defaultZoomScale;if(!o.text?.trim())return null;const y=!o.key&&t.prefix?t.prefix:"",S=!o.key&&t.suffix?t.suffix:"",f=`${y}${o.text}${S}`,g=new Je,{apiKey:w,url:x}=t,C=n?.scale,N=Ue(t,n),I=e?.signal;if(w&&(g.apiKey=w),!x)return null;t.categories&&(g.categories=t.categories),t.locationType&&(g.locationType=t.locationType),r&&(g.outSpatialReference=r);const b=Qe(n,t);b&&(g.location=b),g.maxLocations=a,N&&(g.searchExtent=N),t.countryCode&&(g.countryCode=t.countryCode);const{key:F}=o,G=`${F}`;return F&&(g.magicKey=G),g.address={},g.address[t.singleLineFieldName||es]=f,t.outFields&&(g.outFields=t.outFields),qt(x,g,{signal:I}).then(m=>We(m,{key:G,scale:C,sourceIndex:u,view:n,zoomScale:c,defaultZoomScale:p}))}function us(s,e){return{text:s.text,key:s.magicKey,sourceIndex:e}}function cs(s,e){return s.map(t=>us(t,e))}function ps(s,e){const{key:t,scale:o,sourceIndex:r,view:n,zoomScale:a,defaultZoomScale:u}=e,{attributes:c,extent:p,location:d,address:y}=s,S=new ie({geometry:d,attributes:c}),f=p||d,g=f?he(f,n??void 0,o??void 0):void 0,w=g?typeof a=="number"?ne(g,n??void 0,a):typeof u=="number"&&f?.type==="point"?ne(g,n??void 0,u):g:null,x=d?`${d.x},${d.y}`:"",C=y||x,N=S.clone();return w!=null&&(N.geometry=Le.fromExtent(w)),{extent:w,feature:S,target:N,key:t,name:C,sourceIndex:r}}function We(s,e){return s.filter(Boolean).map(t=>ps(t,e))}var ue;let $=ue=class extends ye{constructor(s){super(s),this.apiKey=null,this.categories=null,this.countryCode=null,this.defaultZoomScale=null,this.localSearchDisabled=!1,this.language=null,this.locationType=null,this.name="",this.placeholder="",this.searchTemplate="",this.singleLineFieldName=null,this.suggestionsEnabled=null,this.url=null,this.zoomScale=null,this.getResults=(e,t)=>ss({source:this,...e},t),this.getSuggestions=(e,t)=>rs({source:this,...e},t)}clone(){return new ue({apiKey:this.apiKey,autoNavigate:this.autoNavigate,categories:this.categories?U(this.categories):null,countryCode:this.countryCode,filter:this.filter,language:this.language,locationType:this.locationType,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?U(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?.clone()??null,searchTemplate:this.searchTemplate,singleLineFieldName:this.singleLineFieldName,suffix:this.suffix,suggestionsEnabled:this.suggestionsEnabled,url:this.url,withinViewEnabled:this.withinViewEnabled,zoomScale:this.zoomScale})}};i([l()],$.prototype,"apiKey",void 0),i([l()],$.prototype,"categories",void 0),i([l()],$.prototype,"countryCode",void 0),i([l({json:{write:!0}})],$.prototype,"defaultZoomScale",void 0),i([l()],$.prototype,"localSearchDisabled",void 0),i([l()],$.prototype,"language",void 0),i([l()],$.prototype,"locationType",void 0),i([l({json:{write:!0}})],$.prototype,"name",void 0),i([l({json:{write:!0}})],$.prototype,"placeholder",void 0),i([l()],$.prototype,"searchTemplate",void 0),i([l({json:{write:!0}})],$.prototype,"singleLineFieldName",void 0),i([l({json:{read:{source:"suggest"},write:{target:"suggest"}}})],$.prototype,"suggestionsEnabled",void 0),i([l({json:{write:!0}})],$.prototype,"url",void 0),i([l({json:{write:!0}})],$.prototype,"zoomScale",void 0),$=ue=i([D("esri.widgets.Search.LocatorSearchSource")],$);const Xe=$;function T(s,e){return s.hasOwnProperty(e)&&s[e]!=null&&s[e]!==""}const $e="highlight",X=ct.ofType({key:s=>s.layer?"layer":"locator",base:ye,typeMap:{layer:z,locator:Xe}}),Fe=te.WGS84,ds="esri/images/search/search-symbol-32.png",hs=/<[\s\S]*?>/g,V=-1;var J;let h=(J=class extends pt(dt){constructor(e){super(e),this._defaultPopupTemplate=new Y({content:"{Match_addr}"}),this._gotoController=null,this._searching=null,this._updatingPromise=null,this._createdFeatureLayers=[],this.autoNavigate=!0,this.autoSelect=!0,this.defaultSources=new X,this.defaultSymbols={point:new yt({url:ft(ds),size:24,width:24,height:24}),polyline:new gt({color:[130,130,130,1],width:2}),polygon:new ht({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})},this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=3,this.popupEnabled=!0,this.popupTemplate=null,this.portal=Ce.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new X,this.suggestionDelay=350,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){this.addHandles([Se(()=>[this.includeDefaultSources,this.view,this.portal],()=>this._update(),ve),Se(()=>this.messages,()=>{this._defaultPopupTemplate.title=this.messages?.searchResult??"",this._update()},ve)])}destroy(){this._destroyFeatureLayers(),this._abortGoTo(),this.clearGraphics()}get activeSource(){return this.allSources.at(this.activeSourceIndex)??null}get activeSourceIndex(){return this.allSources.length===1||!this.searchAllEnabled?0:V}set activeSourceIndex(e){this._overrideIfSome("activeSourceIndex",e)}get allPlaceholder(){return this.messages?.allPlaceholder}set allPlaceholder(e){this._overrideIfSome("allPlaceholder",e)}get allSources(){const{sources:e,defaultSources:t,includeDefaultSources:o}=this,r=typeof o=="function"?o.call(null,{sources:e,defaultSources:t}):o?t.concat(e):e,n=this._get("allSources")||new X;return n.removeAll(),n.addMany(r.filter(Boolean)),n}get defaultPopupTemplate(){return this._defaultPopupTemplate}set defaultPopupTemplate(e){this._overrideIfSome("defaultPopupTemplate",e)}get locationEnabled(){return this._get("locationEnabled")||be()}set locationEnabled(e){if(e===void 0)return void this._clearOverride("locationEnabled");const t=be();if(e&&!t){const o=new R("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});A.getLogger(this).error(o)}this._override("locationEnabled",!!e&&t)}get placeholder(){const{allSources:e,activeSourceIndex:t,allPlaceholder:o}=this;return t===V?o??"":e.at(t)?.placeholder??""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),e===""&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":this.allSources.length===0?"disabled":"ready"}get updating(){return this._updatingPromise!=null}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup();const{view:e,resultGraphic:t}=this;e&&t&&e.graphics.remove(t),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();const o=this._createSuggestionForSearch(e),r=(async()=>{try{await this.when();const n=await this._getResultsFromSources(o,t);if(t?.signal?.aborted)return null;const a={activeSourceIndex:this.activeSourceIndex,searchTerm:o.text??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(a,n,o);const u=this._getFirstResult(a.results),c=o.location&&u?u.name:o.text,p=c?.replaceAll(hs,"");return this._set("searchTerm",p),(o.key&&typeof o.sourceIndex=="number"||o.location)&&this._set("selectedSuggestion",o),this._set("results",a.results),this._set("resultCount",a.results.reduce((d,y)=>d+(y.results?.length??0),0)),this.emit("search-complete",a),await this._selectFirstResult(u),a}finally{this._clearSearching()}})();return this._searching=r,r}async searchNearby(e){if(!this.locationEnabled){const o=new R("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});throw A.getLogger(this).error(o),o}const t=(async()=>{try{const o=await Ft(),r=await Tt({position:o,view:this.view},e);return await this.search(r,e)}finally{this._clearSearching()}})();return this._searching=t,t}async select(e){if(this.clearGraphics(),!e){const E=new R("select:missing-parameter","Cannot select without a searchResult.",{value:e});throw A.getLogger(this).error(E),E}const{view:t}=this,o=T(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),r=o!=null?this.allSources.at(o):null;if(!r){const E=new R("select:missing-source","Cannot select without a source.",{source:r});throw A.getLogger(this).error(E),E}const n=r instanceof z?this._getLayerSourcePopupTemplate(r):r.popupTemplate,a=r.resultSymbol||this._getDefaultSymbol(e),u=T(r,"resultGraphicEnabled")?r.resultGraphicEnabled:this.resultGraphicEnabled,c=T(r,"autoNavigate")?r.autoNavigate:this.autoNavigate,p=T(r,"popupEnabled")?r.popupEnabled:this.popupEnabled,d=p?n||this.popupTemplate||this.defaultPopupTemplate:null,{feature:y}=e;if(!y){const E=new R("select:missing-feature","Cannot select without a feature.",{feature:y});throw A.getLogger(this).error(E),E}const{attributes:S,geometry:f,layer:g,sourceLayer:w}=y,x=f?xe(f):null,C={layerViewQuery:this._getLayerView(y),elevationQuery:t&&x!=null?_t(x,t):Promise.resolve(x)},N=await W(C),I=N.layerViewQuery.value,b=N.elevationQuery.value;a instanceof mt&&(a.text=e.name);const F=t&&c?e.target||e.extent:null;await(F!=null?this._goToSearchResult(F):Promise.resolve());const m=I?y:new ie({geometry:f,symbol:a,attributes:S,layer:g,sourceLayer:w,popupTemplate:d}),k=we(t),K=k&&p&&m.getEffectivePopupTemplate(k.defaultPopupTemplateEnabled);return K&&await t?.openPopup({features:[m],location:b}),I&&St(I)&&!K&&this._highlightFeature({graphic:m,layerView:I}),!I&&u&&t&&t.graphics.push(m),this._setResultFloor(e),this._set("selectedResult",e),this._set("resultGraphic",m),this.emit("select-result",{result:e,source:r,sourceIndex:o}),e}async suggest(e,t,o){const r=e||this.searchTerm;this.emit("suggest-start",{searchTerm:r}),await this._suggestTimer(t,o);const n=await this._suggestImmediate(r,o);return this._set("suggestions",n?.results),this._set("suggestionCount",n?.results.reduce((a,u)=>a+(u.results?.length??0),0)??null),this.emit("suggest-complete",n),n}async when(e,t){await vt(()=>!this.updating)}async _update(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const o=this._updatingPromise=W([e?.load(),t?.when()]);if(this.destroyed||(await o,o!==this._updatingPromise))return}this.destroyed||this._updateDefaultSources(),this._updatingPromise=null}_clearSearching(){this._searching=null}_convertHelperServices(){const e=this.portal?.helperServices?.geocode;return e?e.map(t=>{if(t.placefinding===!1)return;const o=_e(t.url)&&wt(t.url)?{url:ns}:null,r=Xe.fromJSON({...t,...o}),n=r.url;if(_e(n)||is(n)||os(n)){const a=r.outFields??["Addr_type","Match_addr","StAddr","City"],u=(r.placeholder||this.messages?.placeholder)??"",c=typeof r.defaultZoomScale=="number"?r.defaultZoomScale:2500;r.singleLineFieldName="SingleLine",r.outFields=a,r.placeholder=u,r.defaultZoomScale=c}return r.singleLineFieldName?r:void 0}).filter(re):[]}_destroyFeatureLayers(){this._createdFeatureLayers.forEach(e=>e?.destroy()),this._createdFeatureLayers=[]}_getLayerSources(e,t){const o=this.view?.map;return e.map(r=>{const n=o.findLayerById(r.id);if(!n)return;const a=this._getLayerJSON(r),u=z.fromJSON(a);return u.placeholder=t,this._getLayer(n,a).then(c=>{u.layer=c}),u}).filter(re).toArray()}_getTableSources(e,t){const o=this.view?.map;return e.map(r=>{if(!r.id)return;const n=o.findTableById(r.id);if(!n)return;const a=this._getLayerJSON(r),u=z.fromJSON(a);return u.placeholder=t,this._getLayer(n,a).then(c=>{u.layer=c}),u}).filter(re).toArray()}_convertApplicationProperties(){const e=this.view?.map,t=e?.applicationProperties?.viewing?.search;if(!t)return[];const{enabled:o,hintText:r,layers:n,tables:a}=t;return o?[...this._getLayerSources(n,r),...this._getTableSources(a,r)]:[]}async _getSubLayer(e,t){if(await e.load(),!e.allSublayers)throw new Error;const o=e.allSublayers.find(n=>n.id===t.subLayer);if(!o)throw new Error;const r=await o.createFeatureLayer?.();if(!r)throw new Error;return this._createdFeatureLayers.push(r),r}async _getBuildingSubLayer(e,t){await e.load();const o=e.allSublayers.find(r=>r.id===t.subLayer);if(o?.type!=="building-component")throw new Error;if(await o.load(),o.associatedLayer==null)throw new Error;return await o.associatedLayer.load(),o}async _getLayer(e,t){if(e.type==="feature"||e.type==="scene"||e.type==="csv"||e.type==="geojson"||e.type==="ogc-feature")return e;if(e.type==="map-image")try{return await this._getSubLayer(e,t)}catch{const r=new R("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return A.getLogger(this).error(r),null}return e.type==="building-scene"?this._getBuildingSubLayer(e,t):null}_getLayerJSON(e){return typeof e.toJSON=="function"?e.toJSON():e}_updateDefaultSources(){const{defaultSources:e,includeDefaultSources:t}=this;this._destroyFeatureLayers(),e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()])}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){const e=we(this.view),{resultGraphic:t}=this;if(!e||!t)return;const o="selectedFeature"in e,r=o?e.selectedFeature:null;o&&r&&r===t&&xt(this.view?.popup,this.view?.popupElement)}_suggestTimer(e,t){const o=e??this.suggestionDelay;return bt(o,null,t?.signal)}_createLocationForSearch(e){return e instanceof ie&&e.geometry?xe(e.geometry):e instanceof Z?e:Array.isArray(e)&&e.length===2?new Z({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&T(e,"key")&&T(e,"text")&&T(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),o=typeof e=="string"?e:this.searchTerm,{selectedSuggestion:r,selectedResult:n}=this,a=!e&&r&&n,u=a&&r.key===n.key&&r.sourceIndex===n.sourceIndex,c=a&&r.location;return u||c?r:{location:t,text:t?"":o,sourceIndex:null,key:null}}_getFirstResult(e){return oe(e,({results:t})=>t?.[0])??null}async _selectFirstResult(e){return this.autoSelect&&e?this.select(e):null}async _suggestImmediate(e,t){await this.when();const o=await this._getSuggestionsFromSources(e,t);if(t?.signal?.aborted)return null;const r={activeSourceIndex:this.activeSourceIndex,searchTerm:e??"",numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(r,o),r}_formatSourceResponse(e,t,o){const r=t?.value||[],n=t?.error,a=this.allSources.at(o);if(n){const u={sourceIndex:o,source:a,error:n};e.errors.push(u),A.getLogger(this).error(n),e.numErrors++}else{const u={sourceIndex:o,source:a,results:r};e.results.push(u),e.numResults+=r.length}}_formatResponse(e,t,o){if(t)if(e.activeSourceIndex===V){const r=o&&T(o,"sourceIndex")&&o.sourceIndex!==-1?o.sourceIndex:void 0;t.forEach((n,a)=>{const u=r!==void 0?r:a;this._formatSourceResponse(e,n,u)})}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}async _getResultsFromSources(e,t){const{allSources:o}=this,r=!e.location&&T(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,n=[];if(!o.length){const a=new R("search:no-sources-defined","At least one source is required.",{allSources:o});throw A.getLogger(this).error(a),a}return r===V?o.forEach((a,u)=>{n.push(this._getResultsFromSource(e,u,t))}):n.push(this._getResultsFromSource(e,r,t)),W(n)}async _getSuggestionsFromSources(e,t){const{allSources:o,activeSourceIndex:r}=this,n=[];if(!o.length){const a=new R("suggest:no-sources-defined","At least one source is required.",{allSources:o});throw A.getLogger(this).error(a),a}return r===V?o.forEach((a,u)=>{n.push(this._getSuggestionsFromSource(e,u,t))}):n.push(this._getSuggestionsFromSource(e,r,t)),W(n)}async _getResultsFromSource(e,t,o){const r=t!=null?this.allSources.at(t):null;if(!r)return null;const{location:n=null}=e,a=this.view?.spatialReference??Fe,u=T(r,"maxResults")?r.maxResults:this.maxResults,c=!!(r instanceof z&&T(r,"exactMatch"))&&r.exactMatch,{view:p}=this;return r.getResults?.({exactMatch:c,location:n,maxResults:u,sourceIndex:t,spatialReference:a,suggestResult:e,view:p},o)}async _getSuggestionsFromSource(e,t,o){const r=this.allSources.at(t);if(!r)return null;e??="";const n=T(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,a=e?.length,u=T(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(n&&e.trim()&&a>=u){const c=this.view?.spatialReference||Fe,p=T(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,{view:d}=this,y=!!(r instanceof z&&T(r,"exactMatch"))&&r.exactMatch;return r.getSuggestions?.({view:d,sourceIndex:t,suggestTerm:e,spatialReference:c,maxSuggestions:p,exactMatch:y},o)}return null}_getLayerSourcePopupTemplate(e){const{layer:t}=e;if(t)return T(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){return oe(this.results??[],({results:t,sourceIndex:o})=>t?.includes(e)?o:null)??null}async _goToSearchResult(e){this._abortGoTo();const t=new AbortController;this._gotoController=t;const o={target:{target:e},options:{signal:t.signal}};e||(o.options.animate=!1),await this.callGoTo(o),this._gotoController=null}_getDefaultSymbol(e){const{defaultSymbols:t}=this,o=e.feature?.geometry;if(o==null)return null;switch(o.type){case"point":case"multipoint":return t.point;case"polyline":return t.polyline;case"extent":case"polygon":return t.polygon;default:return null}}_removeHighlight(){this.removeHandles($e)}async _getLayerView(e){const{view:t}=this;if(!e||!t)return null;const{layer:o,sourceLayer:r}=e,n=o??r;return n&&n.type!=="building-component"&&n.type!=="subtype-sublayer"?(await t.when(),t.whenLayerView(n)):null}_highlightFeature(e){const{graphic:t,layerView:o}=e,{attributes:r,layer:n,sourceLayer:a}=t,u=n??a,{objectIdField:c}=u,p=(c&&r?.[c])??null,d=o.highlight(p??t);this.addHandles(d,$e)}_setResultFloor(e){const{view:t}=this,o=e.feature?.attributes,r=e.feature?.sourceLayer;if(r&&"floorInfo"in r&&r?.floorInfo?.floorField&&o){const n=o[r.floorInfo.floorField];t?.emit("select-result-floor",n)}}},J.ALL_INDEX=V,J);i([l()],h.prototype,"_searching",void 0),i([l()],h.prototype,"_updatingPromise",void 0),i([l({readOnly:!0,value:null})],h.prototype,"activeSource",null),i([l()],h.prototype,"activeSourceIndex",null),i([l()],h.prototype,"allPlaceholder",null),i([l({readOnly:!0})],h.prototype,"allSources",null),i([l()],h.prototype,"autoNavigate",void 0),i([l()],h.prototype,"autoSelect",void 0),i([l({type:Y})],h.prototype,"defaultPopupTemplate",null),i([l({readOnly:!0})],h.prototype,"defaultSources",void 0),i([l()],h.prototype,"defaultSymbols",void 0),i([l()],h.prototype,"includeDefaultSources",void 0),i([l()],h.prototype,"locationEnabled",null),i([l()],h.prototype,"maxInputLength",void 0),i([l()],h.prototype,"maxResults",void 0),i([l()],h.prototype,"maxSuggestions",void 0),i([l()],h.prototype,"messages",void 0),i([l()],h.prototype,"minSuggestCharacters",void 0),i([l({readOnly:!0})],h.prototype,"placeholder",null),i([l()],h.prototype,"popupEnabled",void 0),i([l({type:Y})],h.prototype,"popupTemplate",void 0),i([l({type:Ce})],h.prototype,"portal",void 0),i([l()],h.prototype,"resultCount",void 0),i([l()],h.prototype,"resultGraphicEnabled",void 0),i([l({readOnly:!0})],h.prototype,"resultGraphic",void 0),i([l({readOnly:!0})],h.prototype,"results",void 0),i([l({readOnly:!0})],h.prototype,"selectedSuggestion",void 0),i([l()],h.prototype,"searchAllEnabled",void 0),i([l({readOnly:!0})],h.prototype,"selectedResult",void 0),i([l()],h.prototype,"searchTerm",null),i([l({type:X})],h.prototype,"sources",void 0),i([l({readOnly:!0})],h.prototype,"state",null),i([l()],h.prototype,"suggestionDelay",void 0),i([l()],h.prototype,"suggestionCount",void 0),i([l({readOnly:!0})],h.prototype,"suggestions",void 0),i([l()],h.prototype,"suggestionsEnabled",void 0),i([l({readOnly:!0})],h.prototype,"updating",null),i([l()],h.prototype,"view",void 0),i([l()],h.prototype,"clear",null),h=i([D("esri.widgets.Search.SearchViewModel")],h);const bs=h;export{bs as K,ns as v,_e as x};
