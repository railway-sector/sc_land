import{a7 as y,kb as g,d1 as u,bI as m,c5 as v,mX as _,dz as w,mY as T,gK as k,ai as x,mZ as b,a5 as l,x as n,y as F}from"./index-Brd6-W-v.js";import{i as R,e as S,h as z}from"./progressUtils-DozaJHv-.js";let i=class extends y{constructor(){super(...arguments),this.files=[],this.progress=0,this._uploadTask=null,this._layer=null}destroy(){this.cancel(),this.files=[],this._layer=null,this._uploadTask=null}get state(){const e=this._uploadTask;return e&&this.files.length!==0?e.finished?e.error?"error":"success":"pending":"default"}get result(){return this._uploadTask?.value??null}get error(){return this._uploadTask?.error??null}uploadTo(e){this.cancel(),this.files=[],this._layer=e,this._uploadTask=g(async r=>{const o=await E(e);u(r),this.progress=0,this.files=o;const t=R(S.upload,d=>{this.progress=d},"Upload.uploadTo");if(o.length===0)return null;u(r);const a=await e.extractAndFilterFiles(o);u(r),a.length>0&&(this.files=a);const s=await e.convertMesh(a,{signal:r,onProgress:t.makeOnProgress("createFromFiles")});if(u(r),!s)throw new m("editor:upload","could not upload or convert model");const p=a.reduce((d,h)=>d+h.size,0),f=t.simulate("loadMesh",z(p));try{await s.load()}finally{f.remove()}if(!v("disable-feature:georeferenced-uploads")&&s.metadata.georeferenced){if(await _(e.spatialReference,s.origin?.spatialReference))return{type:"georeferenced",mesh:s};if(await P(s,e.spatialReference))return{type:"georeferenced-reprojected",mesh:s}}return s.spatialReference=e.spatialReference,s.vertexSpace.origin=[0,0,0],{type:"non-georeferenced",mesh:s}})}retry(){this._layer&&this.uploadTo(this._layer)}cancel(){this._uploadTask?.abort()}};l([n()],i.prototype,"files",void 0),l([n()],i.prototype,"progress",void 0),l([n()],i.prototype,"state",null),l([n()],i.prototype,"result",null),l([n()],i.prototype,"error",null),l([n()],i.prototype,"_uploadTask",void 0),l([n()],i.prototype,"_layer",void 0),i=l([F("esri.widgets.Editor.Upload")],i);let c=null;async function E(e){const{resolve:r,promise:o}=w(),t=document.createElement("input");t.type="file",t.multiple=!1,t.accept=[...T(e.infoFor3D),".zip"].join(","),t.style.display="none",document.body.appendChild(t);const a=k(t,"change",()=>r(t.files?Array.from(t.files):[]));return c?c(t):t.click(),o.finally(()=>{a.remove(),t.remove()})}function $(e,r){c=o=>{r?.(),Promise.resolve().then(()=>e).then(t=>{if(!c)return;const a=new DataTransfer;t.forEach(s=>a.items.add(s)),o.files=a.files,o.dispatchEvent(new Event("change"))})}}function A(){c=null}async function P(e,r){if(!e.vertexSpace.origin)return!1;const[o,t,a]=e.vertexSpace.origin,s=new x({x:o,y:t,z:a,spatialReference:e.spatialReference}),p=await b(s,r);return!!p&&(e.vertexSpace.origin=[p.x,p.y,p.z??0],e.spatialReference=r,!0)}export{i as Upload,A as clearPromptForFilesStub,$ as stubFilePickerToSelect};
