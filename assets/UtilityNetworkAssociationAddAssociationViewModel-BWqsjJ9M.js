import{e1 as H,dd as T,Y as U,O as g,iW as b,b1 as C,b2 as F,f as m,bI as q,aZ as _,cI as A,p7 as v,fN as $,r9 as j,ra as E,ex as I,_ as o,e as i,ao as W,g as O}from"./index-BrQW8HOS.js";import{isAssociatedFeatureSupportedLayer as D}from"./featureUtils-D2UmGJHI.js";import{a as M}from"./Association-BGd3HRsE.js";import{s as V}from"./NetworkElement-te1zus-P.js";import{t as L}from"./getFeatureTitle-Mrr3SXNI.js";function P(e){return new M({fromNetworkElement:k(e.fromFeature,e.utilityNetwork),toNetworkElement:k(e.toFeature,e.utilityNetwork),associationType:e.associationType,globalId:H()})}function k(e,t){const r=T(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer;if(r&&"globalIdField"in r&&"layerId"in r&&r.globalIdField){const a=t.getSourceIdByLayerId(r.layerId),n=t.getSourceTypeById(a)==="junction"?t.getTerminalConfiguration(e):void 0,l=n?.terminals.at(0)?.id,u=r.fieldsIndex.get("assetGroup").name,y=r.fieldsIndex.get("assetType").name,c=e.attributes[u],h=e.attributes[y],p=e.attributes[r.globalIdField];if(p&&a!=null)return new V({globalId:p,networkSourceId:a,assetGroupCode:c,assetTypeCode:h,terminalId:l})}}const w=100,N="association-key";let s=class extends U{constructor(e){super(e),this.graphic=null,this.layer=null,this.map=null,this.utilityNetwork=null,this.associationType=null,this.featureCount=0,this.featureSpatialItems=new g,this.highlightHelper=null,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=30,this.selectedFeature=null,this.association=null,this.filterOptionsVisible=!1,this.filterWhereClause=null,this._rulesTable=null,this._canAssociate=!1,this._whereClause=null,this._setUpItemsTask=null,this._updatingHandlesSetUp=new b,this._queryFeaturesTask=null,this._updatingHandlesQueryFeatures=new b,this._validateAssociationTask=null,this._updatingHandlesAssociation=new b,this._featureIsNotSelected=t=>(this.globalIdField?t.attributes?.[this.globalIdField]??null:null)!==this.globalId,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await C(this._query()).catch(()=>this._cancelQuery()),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async t=>{this._cancelQueryFeatureCount();const r=new AbortController;this._queryFeatureCountAbortController=r,await C(this._queryFeatureCount(t)).catch(()=>this._cancelQueryFeatureCount()),this._queryFeatureCountAbortController===r&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const t=new AbortController;this._queryPageAbortController=t,await C(this._queryPage()).catch(()=>this._cancelQueryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)},this._queryDebounced=F(this._queryController,w),this._queryFeatureCountDebounced=F(this._queryFeatureCountController,w),this._queryPageDebounced=F(this._queryPageController,w)}initialize(){this.addHandles([m(()=>[this.graphic,this.layer,this.map,this.utilityNetwork,this.globalId,this.associationType],()=>this._syncLayerItems(),q),m(()=>[this.selectedLayer,this.filterWhereClause,this.featuresPerPage],()=>{this.selectedLayer&&this._setUpFeatures()}),m(()=>this.selectedFeature,()=>{this._setUpAssociation()}),m(()=>this.featurePage,()=>this._queryPageDebounced())])}destroy(){this._setUpItemsTask=_(this._setUpItemsTask),this._updatingHandlesSetUp.destroy(),this._queryFeaturesTask=_(this._queryFeaturesTask),this._updatingHandlesQueryFeatures.destroy(),this._validateAssociationTask=_(this._validateAssociationTask),this._updatingHandlesAssociation.destroy(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}get mapTables(){const{map:e}=this;if(!e)return null;const t=new Set;return e.allTables.forEach(r=>this._collectIfValidParent(r,t)),new g([...t])}get mapLayers(){const{map:e}=this;if(!e)return null;const t=new Set;return e.allLayers.forEach(r=>this._collectIfValidParent(r,t)),new g([...t])}get state(){const{canLoadLayers:e,_queryAbortController:t,_queryPageAbortController:r}=this;return e?t||r||this._updatingHandlesQueryFeatures.updating?"querying":this._updatingHandlesSetUp.updating?"loading":"ready":"disabled"}get canAddAssociation(){return!(this.updating||!this.association)&&this._canAssociate}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:e}=this;return e?.globalIdField??null}get layerItems(){return this._get("layerItems")||new g}get tableItems(){return this._get("tableItems")||new g}get featureItems(){return this._get("featureItems")||new g}set featurePage(e){const{featuresPerPage:t,featureCount:r,featureSpatialItems:a}=this,n=a.length||r,l=1,u=Math.ceil(n/t)||1;this._set("featurePage",Math.min(Math.max(e,l),u))}get featurePage(){return this._get("featurePage")}get canLoadLayers(){const{map:e,utilityNetwork:t,graphic:r,associationType:a}=this;return!!(e&&t&&r&&a)}get canQuery(){const{utilityNetwork:e,graphic:t,associationType:r,selectedLayer:a}=this;return!!(e&&t&&r&&a)}get updating(){return this._updatingHandlesSetUp.updating||this._updatingHandlesAssociation.updating}get selectedLayer(){return this._get("selectedLayer")}set selectedLayer(e){e!==this.selectedLayer&&(this.filterWhereClause=null),this._set("selectedLayer",e)}get queryWhereClause(){const{_whereClause:e,filterWhereClause:t}=this;return A(e,t)}async onSelectionComplete(e){const{associationType:t,featureSpatialItems:r,graphic:a,_rulesTable:n}=this,{selection:l}=e;if(r.removeAll(),!(t&&a&&n&&l?.length))return;const u=this._convertTypeToDirection(t.type),y=l.filter(this._featureIsNotSelected),c=n.getFeaturesCanAssociateWith(a,y,u),h=await this._processFeatures(c);r.addMany(h)}reset(){this.highlightHelper?.removeAll(),this.featureSpatialItems.removeAll(),this.featurePage=1}_collectIfValidLayer(e,t){D(e)&&!v(e)&&t.add(e)}_collectIfValidParent(e,t){const r=a=>this._collectIfValidLayer(a,t);$(e)||e.type==="catalog-footprint"||(j(e)?(e.layers?.forEach(r),e.tables?.forEach(r)):E(e)?(e.sublayers?.forEach(r),e.subtables?.forEach(r)):v(e)?e.sublayers?.forEach(r):this._collectIfValidLayer(e,t))}async _queryFeatureCount(e){const{selectedLayer:t,_queryFeatureCountAbortController:r}=this;if(this._set("featureCount",0),!t)return;await t.load();const a=t.createQuery();a.returnGeometry=!1,a.where=A(a.where,e);const n=await t.queryFeatureCount(a,{signal:r?.signal});n>0&&this._set("featureCount",n)}async _query(){const{canQuery:e,queryWhereClause:t,_queryAbortController:r,featureItems:a}=this;e&&(this.featurePage=1,a.destroyAll(),this.featureCount&&!this.destroyed&&a.addMany(await this._queryAssociatedFeatures(t,{signal:r?.signal})))}async _queryPage(){const{canQuery:e,queryWhereClause:t,featurePage:r,_queryPageAbortController:a,featureCount:n,featureItems:l}=this;e&&(r<2||!n||l.addMany(await this._queryAssociatedFeatures(t,{signal:a?.signal})))}_convertTypeToDirection(e){switch(e){case"attachment":return[{type:"attachment",direction:"from"}];case"connectivity":return[{type:"junction-junction-connectivity"},{type:"junction-edge-from-connectivity"},{type:"junction-edge-midspan-connectivity"},{type:"junction-edge-to-connectivity"}];case"container":return[{type:"containment",direction:"to"}];case"content":return[{type:"containment",direction:"from"}];case"structure":return[{type:"attachment",direction:"to"}]}}async getRulesTable(){const{utilityNetwork:e}=this;if(!e)return null;if(this._rulesTable)return this._rulesTable;const t=await e.getRulesTable();return await t?.load(),this._rulesTable=t,t}async _syncLayerItems(){_(this._setUpItemsTask);const{graphic:e,associationType:t,layerItems:r,tableItems:a,canLoadLayers:n}=this,l=I(async u=>{if(this.selectedLayer=null,r.removeAll(),a.removeAll(),!n)return;const y=this.mapLayers?.toArray(),c=this.mapTables?.toArray();if(!y&&!c||u.aborted)return;const h=await this.getRulesTable(),p=this._convertTypeToDirection(t.type);if(y?.length){const f=h?.getLayersCanAssociateWith(e,y,p);if(u.aborted)return;r.addMany(f||[])}if(c?.length){const f=h?.getLayersCanAssociateWith(e,c,p);if(u.aborted)return;a.addMany(f||[])}});this._updatingHandlesSetUp.addPromise(l.promise),this._setUpItemsTask=l}async _setUpFeatures(){_(this._queryFeaturesTask);const{graphic:e,associationType:t,selectedLayer:r,canQuery:a}=this;if(!a)return;const n=I(async l=>{const u=await this.getRulesTable(),y=this._convertTypeToDirection(t.type),c=u?.getFeaturesCanAssociateWithClause(e,r,y);this._whereClause=c,l.aborted||(await this._queryFeatureCountDebounced(this.queryWhereClause),await this._queryDebounced())});this._updatingHandlesQueryFeatures.addPromise(n.promise),this._queryFeaturesTask=n}_determineFromAndTo(e,t,r){return r==="from"?{fromFeature:e,toFeature:t}:{fromFeature:t,toFeature:e}}_determineJunctionEdgeConnectivity(e,t){const{utilityNetwork:r}=this,a=T(e.sourceLayer)?e.sourceLayer.parent:e.sourceLayer,n=T(t.sourceLayer)?t.sourceLayer.parent:t.sourceLayer;if(!(r&&a&&"layerId"in a&&n&&"layerId"in n))return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const l=r.getSourceIdByLayerId(a.layerId),u=r.getSourceIdByLayerId(n.layerId);if(!l||!u)return{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"};const y=r.getSourceTypeById(l)==="junction",c=r.getSourceTypeById(u)==="junction";return y&&c?{fromFeature:e,toFeature:t,type:"junction-junction-connectivity"}:c?{fromFeature:t,toFeature:e,type:"junction-edge-midspan-connectivity"}:{fromFeature:e,toFeature:t,type:"junction-edge-midspan-connectivity"}}_setUpAssociationHandles(){this.removeHandles(N),this.association&&this.addHandles(m(()=>[this.association?.associationType,this.association?.fromNetworkElement,this.association?.fromNetworkElement?.terminalId,this.association?.toNetworkElement,this.association?.toNetworkElement?.terminalId],()=>this.validateAssociation(),q),N)}_setUpAssociation(){const{utilityNetwork:e,graphic:t,selectedFeature:r,associationType:a}=this;if(!(e&&t&&r&&a))return void(this.association=null);const n=this._convertTypeToDirection(a.type);if(n.length>1){const{fromFeature:y,toFeature:c,type:h}=this._determineJunctionEdgeConnectivity(t,r.feature);return this.association=P({fromFeature:y,toFeature:c,utilityNetwork:e,associationType:h}),void this._setUpAssociationHandles()}const{fromFeature:l,toFeature:u}=this._determineFromAndTo(t,r.feature,n[0].direction);this.association=P({fromFeature:l,toFeature:u,utilityNetwork:e,associationType:n[0].type}),this._setUpAssociationHandles()}async _processFeatures(e){return Promise.all(e.map(async t=>{const{sourceLayer:r}=t;return r&&"getFeatureTitle"in r?{label:await r.getFeatureTitle(t)||L(t),feature:t}:{label:L(t),feature:t}}))}async _queryAssociatedFeatures(e,t){const{featuresPerPage:r,layer:a,featurePage:n,featureCount:l,selectedLayer:u}=this,{canQuery:y,globalId:c}=this;if(!y||!a||!u||c==null)return[];const h=((n-1)*r+l)%l,p=r,{historicMoment:f,gdbVersion:Q}=u,d=u.createQuery();d.where=A(d.where,e),d.start=h,d.num=p,d.returnGeometry=!1,d.historicMoment=f,d.gdbVersion=Q,d.outFields=["*"];const S=await u.queryFeatures(d,{signal:t?.signal});return await this._processFeatures(S.features)}validateAssociation(){_(this._validateAssociationTask);const{utilityNetwork:e,association:t}=this,r=I(async()=>{e&&t&&(this._canAssociate=await e.canAddAssociation(t))});this._updatingHandlesAssociation.addPromise(r.promise),this._validateAssociationTask=r}};o([i({type:W})],s.prototype,"graphic",void 0),o([i()],s.prototype,"layer",void 0),o([i()],s.prototype,"map",void 0),o([i({readOnly:!0})],s.prototype,"mapTables",null),o([i({readOnly:!0})],s.prototype,"mapLayers",null),o([i()],s.prototype,"utilityNetwork",void 0),o([i()],s.prototype,"associationType",void 0),o([i()],s.prototype,"state",null),o([i({readOnly:!0})],s.prototype,"canAddAssociation",null),o([i({readOnly:!0})],s.prototype,"globalId",null),o([i({readOnly:!0})],s.prototype,"globalIdField",null),o([i()],s.prototype,"featureCount",void 0),o([i({readOnly:!0})],s.prototype,"layerItems",null),o([i({readOnly:!0})],s.prototype,"tableItems",null),o([i({readOnly:!0})],s.prototype,"featureItems",null),o([i()],s.prototype,"featureSpatialItems",void 0),o([i()],s.prototype,"highlightHelper",void 0),o([i()],s.prototype,"_queryAbortController",void 0),o([i()],s.prototype,"_queryPageAbortController",void 0),o([i()],s.prototype,"_queryFeatureCountAbortController",void 0),o([i({value:1})],s.prototype,"featurePage",null),o([i()],s.prototype,"featuresPerPage",void 0),o([i({readOnly:!0})],s.prototype,"canLoadLayers",null),o([i({readOnly:!0})],s.prototype,"canQuery",null),o([i({readOnly:!0})],s.prototype,"updating",null),o([i()],s.prototype,"selectedLayer",null),o([i()],s.prototype,"selectedFeature",void 0),o([i()],s.prototype,"association",void 0),o([i()],s.prototype,"filterOptionsVisible",void 0),o([i()],s.prototype,"filterWhereClause",void 0),o([i()],s.prototype,"queryWhereClause",null),o([i()],s.prototype,"_rulesTable",void 0),o([i()],s.prototype,"_canAssociate",void 0),o([i()],s.prototype,"_whereClause",void 0),s=o([O("esri.widgets.FeatureForm.UtilityNetworkAssociationAddAssociationViewModel")],s);export{s as w};
