import{mV as G,mW as g,eg as p,cN as w,bz as k,cU as I,ei as c,Z as d,$ as y,a0 as m}from"./index-Bp3GeDhQ.js";let i=class extends G(g){constructor(e){super(e),this.layerIdToSourceIdLookup=new p,this.sourceIdToLayerIdLookup=new p,this.sourceIdToNetworkInfo=new p,this._rulesBySourceId=new Map,this._terminalConfigurationsBySourceId=new Map}async load(e){return this.addResolvingPromise(this._load(e)),this}agatFromRule(e,t){let o;switch(t){case"to":o={networkSource:e.toNetworkSource??null,assetGroup:e.toAssetGroup??null,assetType:e.toAssetType??null};break;case"from":o={networkSource:e.fromNetworkSource??null,assetGroup:e.fromAssetGroup??null,assetType:e.fromAssetType??null};break;case"via":o={networkSource:e.viaNetworkSource??null,assetGroup:e.viaAssetGroup??null,assetType:e.viaAssetType??null}}return o.networkSource===null?null:o}agatToFullDefinition({assetGroup:e,assetType:t,networkSourceId:o}){if(o===null||e===null||t===null)return null;const s={networkSource:null,assetGroup:null,assetType:null},r=this.sourceIdToNetworkInfo.get(o);if(!r)return null;s.networkSource=r;const u=r.assetGroupLookup.get(e);return u?(s.assetGroup=u,s.assetType=u.assetTypeLookup.get(t)??null,s.assetType===null?null:s):null}findAgat(e,t){const o=w(t)?t.parent:t;if(!o)throw new k("utility-network:missing-layer","Unable to find asset group/asset type for layer. The given layer is a `SubtypeSublayer` with no parent.");if(this.utilityNetwork.featureServiceUrl!==o.url)return null;const s=this.getNetworkSourceIdForLayer(o);if(s===null)return null;const r=o.fieldsIndex.get("assettype")?.name??"";if(r==="")return null;const u=o.fieldsIndex.get("assetgroup")?.name??"";if(u==="")return null;const a=e.attributes[r],n=e.attributes[u];return a==null||n==null?null:{assetGroup:n,assetType:a,networkSourceId:s}}findAgatFullDefinition(e,t){const o=this.findAgat(e,t);return o?this.agatToFullDefinition(o):null}findRules({networkSourceId:e,assetGroup:t,assetType:o}){const s=[];if(e===null||t===null)return s;const r=this._rulesBySourceId.get(e)?.get(t);if(!r)return s;for(const u of r.generalRules)s.push(u);if(o!=null){const u=r.typeSpecificRules.get(o);if(u)for(const a of u)s.push(a)}return s}getNetworkSourceIdForLayer(e){const t=w(e)?e.parent:e;return t&&this.utilityNetwork.featureServiceUrl===t.url?this.layerIdToSourceIdLookup.get(t.layerId)??null:null}ruleMatchesAgat(e,t,o){switch(o){case"to":return!(e.toNetworkSource?.sourceId!==t.networkSourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==t.assetGroup||e.toAssetType&&e.toAssetType.assetTypeCode!==t.assetType);case"from":return!(e.fromNetworkSource?.sourceId!==t.networkSourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==t.assetGroup||e.fromAssetType&&e.fromAssetType.assetTypeCode!==t.assetType);case"via":return!(e.viaNetworkSource?.sourceId!==t.networkSourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==t.assetGroup||e.viaAssetType&&e.viaAssetType.assetTypeCode!==t.assetType)}}ruleMatchesFullDefinitionAgat(e,t,o){switch(o){case"to":return!(e.toNetworkSource?.sourceId!==t.networkSource?.sourceId||e.toAssetGroup&&e.toAssetGroup.assetGroupCode!==t.assetGroup?.assetGroupCode||e.toAssetType&&e.toAssetType.assetTypeCode!==t.assetType?.assetTypeCode);case"from":return!(e.fromNetworkSource?.sourceId!==t.networkSource?.sourceId||e.fromAssetGroup&&e.fromAssetGroup.assetGroupCode!==t.assetGroup?.assetGroupCode||e.fromAssetType&&e.fromAssetType.assetTypeCode!==t.assetType?.assetTypeCode);case"via":return!(e.viaNetworkSource?.sourceId!==t.networkSource?.sourceId||e.viaAssetGroup&&e.viaAssetGroup.assetGroupCode!==t.assetGroup?.assetGroupCode||e.viaAssetType&&e.viaAssetType.assetTypeCode!==t.assetType?.assetTypeCode)}}terminalConfiguration(e,t,o){const s=this._terminalConfigurationsBySourceId.get(e);if(!s)return null;const r=s.get(t);return r&&r.get(o)||null}async _load(e){await this.utilityNetwork.load(),I(e);const{dataElement:t}=this.utilityNetwork;if(!t)throw new k("utility-network:no-data-element","No data element found on utility network");for(const s of t.domainNetworks)for(const r of[...s.edgeSources??[],...s.junctionSources??[]]){this.layerIdToSourceIdLookup.set(r.layerId,r.sourceId),this.sourceIdToLayerIdLookup.set(r.sourceId,r.layerId);const u=(r.assetGroups??[]).map(l=>{const f=new p;for(const T of l.assetTypes??[])f.set(T.assetTypeCode,T);return{...l,assetTypeLookup:f}}),a=new p;for(const l of u)a.set(l.assetGroupCode,l);const n={...r,assetGroupLookup:a,assetGroups:u};this.sourceIdToNetworkInfo.set(n.sourceId,n)}const o=await this.utilityNetwork.getRulesTable();I(e);for(const s of o?.rules??[])switch(s.ruleType){case 3:case 2:case 4:case 1:this._registerRule(s.fromNetworkSource.sourceId,s.fromAssetGroup.assetGroupCode,s.fromAssetType.assetTypeCode,s),this._registerRule(s.toNetworkSource.sourceId,s.toAssetGroup.assetGroupCode,s.toAssetType.assetTypeCode,s);break;case 5:this._registerRule(s.fromNetworkSource.sourceId,s.fromAssetGroup.assetGroupCode,s.fromAssetType.assetTypeCode,s),this._registerRule(s.toNetworkSource.sourceId,s.toAssetGroup.assetGroupCode,s.toAssetType.assetTypeCode,s),this._registerRule(s.viaNetworkSource.sourceId,s.viaAssetGroup.assetGroupCode,s.viaAssetType.assetTypeCode,s)}this._makeTerminalConfigurationLookups(t)}_makeTerminalConfigurationLookups(e){const t={};for(const o of e.terminalConfigurations??[])t[o.terminalConfigurationId]=o;for(const o of e.domainNetworks??[])for(const s of o.junctionSources)if(s.utilityNetworkFeatureClassUsageType==="esriUNFCUTJunctionObject"||s.utilityNetworkFeatureClassUsageType==="esriUNFCUTDevice"){for(const r of s.assetGroups??[])for(const u of r.assetTypes??[])if(u.terminalConfigurationId!=null&&u.terminalConfigurationId>=0){const a=t[u.terminalConfigurationId];if(a){const n=c(this._terminalConfigurationsBySourceId,s.sourceId,()=>new Map);c(n,r.assetGroupCode,()=>new Map).set(u.assetTypeCode,a)}}}}_registerRule(e,t,o,s){const r=c(this._rulesBySourceId,e,()=>new Map),u=c(r,t,()=>({generalRules:[],typeSpecificRules:new Map}));if(o!==-1)return void c(u.typeSpecificRules,o,()=>[]).push(s);u.generalRules.push(s)}};d([y()],i.prototype,"layerIdToSourceIdLookup",void 0),d([y()],i.prototype,"sourceIdToLayerIdLookup",void 0),d([y()],i.prototype,"sourceIdToNetworkInfo",void 0),d([y()],i.prototype,"utilityNetwork",void 0),i=d([m("esri.networks.support.UtilityNetworkLookupHelper")],i);export{i as UtilityNetworkLookupHelper};
