const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/createVersion-RtUkTfZj.js","assets/index-CVzGOCNQ.js","assets/index-ni9qn0ie.css","assets/CreateVersionParameters-CkLSZii2.js","assets/deleteVersion-BwTCZz-J.js","assets/serverVersionUtils-6R-EZ8Rb.js","assets/DeleteVersionParameters-DBZExzBK.js","assets/getVersion-BUwd45-t.js","assets/getVersionInfos-DkOzI8XC.js","assets/GetVersionInfosParameters-BVZcLNQm.js","assets/reconcile-CQj68uHg.js","assets/ReconcileParameters-CDjNPx0e.js","assets/post-Kh1lUI9a.js","assets/PostParameters-ux9Kz6tE.js","assets/alterVersion-B58TLfm3.js","assets/AlterVersionParameters-kmJM-Dsi.js","assets/startReading-D8xWE6co.js","assets/stopReading-YPKODX47.js","assets/startEditing-Bx9Dsh3K.js","assets/deleteForwardEdits-BZONBDKT.js","assets/DeleteForwardEditsParameters-4QtNlRFY.js","assets/stopEditing-NZG5onnQ.js"])))=>i.map(i=>d[i]);
import{Z as u,$ as d,f9 as V,cQ as b,cS as M,u1 as R,yq as l,yr as y,ys as T,yt as I,_ as a,d6 as m,yu as f,bz as w,d3 as D,q4 as U,c6 as O,b$ as L,fL as k,a0 as P}from"./index-CVzGOCNQ.js";let $=class{constructor(t){this.moments=[],this.forwardMoments=[],this.moments.push(t)}push(t){return this.forwardMoments.length,this.moments.push(t)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const t=this.moments.pop();return this.forwardMoments.push(t),t}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const t=this.forwardMoments.pop();return this.moments.push(t),t}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}},p=class{constructor(t){this.versionableItem=t,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){const t=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(t,"$1")}};u([d({readOnly:!0})],p.prototype,"type",void 0),u([d()],p.prototype,"gdbVersion",null),u([d({type:Date})],p.prototype,"historicMoment",null),u([d({readOnly:!0})],p.prototype,"featureServiceUrl",null);let g=class{constructor(t){this.versionableItem=t,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}};u([d({readOnly:!0})],g.prototype,"type",void 0),u([d()],g.prototype,"gdbVersion",null),u([d({type:Date})],g.prototype,"historicMoment",null),u([d({readOnly:!0})],g.prototype,"featureServiceUrl",null);class _{constructor(t){this.versionableItem=t,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(t){this.versionableItem.gdbVersion=t}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(t){this.versionableItem.historicMoment=t}get featureServiceUrl(){const t=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(t,"$1")}}u([d({readOnly:!0})],_.prototype,"type",void 0),u([d()],_.prototype,"gdbVersion",null),u([d({type:Date})],_.prototype,"historicMoment",null),u([d({readOnly:!0})],_.prototype,"featureServiceUrl",null);function E(e){return"networkServiceUrl"in e?new g(e):e.type!=="feature"||V(e)?e.type!=="subtype-group"||V(e)?null:new _(e):new p(e)}function S(e){const t=[];for(const r of e)if(r.type==="group"){const s=r,i=s.allTables.concat(s.allLayers);for(const n of i)if(n.type==="feature"||n.type==="subtype-group"){const o=E(n);o&&t.push(o)}}else{const s=E(r);s&&t.push(s)}return t}let c=class extends b(M){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=t=>!t||t===this.defaultVersionIdentifier.name,this._dateEquals=(t,r)=>!t&&!r||!(!t||!r)&&t.toISOString()===r.toISOString(),this._applyEditsHandler=t=>{const{serviceUrl:r,gdbVersion:s,result:i}=t;r===this._featureServiceUrl&&i.then(n=>{const o=n.historicMoment;o&&this._addMomentToVersionItem(s,o)})}}initialize(){this.url=R(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),l.has(this.url)||l.set(this.url,new Map);const e=(y.get(this.url)??0)+1;y.set(this.url,e),this.when().then(()=>this.addHandles(T(this._applyEditsHandler)),()=>{})}destroy(){const e=(y.get(this.url)??1)-1;y.set(this.url,e),e===0&&l.delete(this.url),I.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}get loaded(){return super.loaded}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:r}]=await Promise.all([a(()=>import("./createVersion-RtUkTfZj.js"),__vite__mapDeps([0,1,2])),a(()=>import("./CreateVersionParameters-CkLSZii2.js"),__vite__mapDeps([3,1,2]))]),s=r.from(e);return t(this.url,s)}async deleteVersion(e){const[{deleteVersion:t},{default:r}]=await Promise.all([a(()=>import("./deleteVersion-BwTCZz-J.js"),__vite__mapDeps([4,1,2,5])),a(()=>import("./DeleteVersionParameters-DBZExzBK.js"),__vite__mapDeps([6,1,2]))]);let s;e.guid&&l.get(this.url)?.has(e.guid)&&(s=m??void 0);const i=new r({versionName:e.name,sessionId:s});return t(this.url,i)}async getVersionInfoExtended(e){const{getVersion:t}=await a(()=>import("./getVersion-BUwd45-t.js"),__vite__mapDeps([7,1,2]));return t(this.url,e.guid)}async getVersionInfos(e={}){const[{getVersionInfos:t},{default:r}]=await Promise.all([a(()=>import("./getVersionInfos-DkOzI8XC.js"),__vite__mapDeps([8,1,2])),a(()=>import("./GetVersionInfosParameters-BVZcLNQm.js"),__vite__mapDeps([9,1,2]))]),s=r.from(e);return t(this.url,s)}async reconcile(e,t={}){const[{reconcile:r},{default:s}]=await Promise.all([a(()=>import("./reconcile-CQj68uHg.js"),__vite__mapDeps([10,1,2,5])),a(()=>import("./ReconcileParameters-CDjNPx0e.js"),__vite__mapDeps([11,1,2]))]),i=s.from(t);return i.sessionId=m,r(this.url,e.guid,i)}async post(e){const[{post:t},{default:r}]=await Promise.all([a(()=>import("./post-Kh1lUI9a.js"),__vite__mapDeps([12,1,2,5])),a(()=>import("./PostParameters-ux9Kz6tE.js"),__vite__mapDeps([13,1,2]))]),s=r.from({sessionId:m});return t(this.url,e.guid,s)}async alterVersion(e,t){const[{alterVersion:r},{default:s}]=await Promise.all([a(()=>import("./alterVersion-B58TLfm3.js"),__vite__mapDeps([14,1,2,5])),a(()=>import("./AlterVersionParameters-kmJM-Dsi.js"),__vite__mapDeps([15,1,2]))]),i=s.from(t);return r(this.url,e.guid,i)}async startReading(e){return(await this.startReadingWithResult(e)).success}async startReadingWithResult(e){const{startReading:t}=await a(()=>import("./startReading-D8xWE6co.js"),__vite__mapDeps([16,1,2])),r=await t(this.url,e.guid,m);if(r.success){const s=await this.getVersionInfoExtended(e),i=new Date(s.modifiedDate),n={name:s.versionIdentifier.name,moment:i,lockType:"read"};this._addOrUpdateItem(e.guid,n),f(this._featureServiceUrl,null,e.name,i)}return r}async stopReading(e){return(await this.stopReadingWithResult(e)).success}async stopReadingWithResult(e){const{stopReading:t}=await a(()=>import("./stopReading-YPKODX47.js"),__vite__mapDeps([17,1,2])),r=await t(this.url,e.guid,m);return r.success&&(l.get(this.url)?.delete(e.guid),f(this._featureServiceUrl,null,e.name,null)),r}async startEditing(e){return(await this.startEditingWithResult(e)).success}async startEditingWithResult(e){const{startEditing:t}=await a(()=>import("./startEditing-Bx9Dsh3K.js"),__vite__mapDeps([18,1,2])),r=await t(this.url,e.guid,m);if(r.success){const s=await this.getVersionInfoExtended(e),i=new Date(s.modifiedDate),n=new $(i),o={name:e.name,moment:i,lockType:"edit",stack:n};this._addOrUpdateItem(e.guid,o),f(this._featureServiceUrl,null,e.name,i)}return r}async stopEditing(e,t){return(await this.stopEditingWithResult(e,t)).success}async stopEditingWithResult(e,t){if(t){const i=l.get(this.url)?.get(e.guid);if(i?.stack?.canRedo()){const[{deleteForwardEdits:n},{default:o}]=await Promise.all([a(()=>import("./deleteForwardEdits-BZONBDKT.js"),__vite__mapDeps([19,1,2])),a(()=>import("./DeleteForwardEditsParameters-4QtNlRFY.js"),__vite__mapDeps([20,1,2]))]),h=await n(this.url,e.guid,new o({sessionId:m,moment:i.moment}));if(!h.success)return h}}const{stopEditing:r}=await a(()=>import("./stopEditing-NZG5onnQ.js"),__vite__mapDeps([21,1,2])),s=await r(this.url,e.guid,m,t);if(s.success){const i=await this.getVersionInfoExtended(e),n=new Date(i.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:n,lockType:"read",editMomentStack:void 0}),f(this._featureServiceUrl,null,e.name,n)}return s}getLockType(e){return l.get(this.url)?.get(e.guid)?.lockType??"none"}async changeVersion(e,t,r){if(r&&"name"in r&&!await this.getVersionInfoExtended(r))throw new w("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,r)}else{let s;"layers"in e?(s=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach(i=>{this._featureServiceUrl.toLowerCase()===i.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(i,t,r)})):s=e;for(const i of s)if(i.type==="feature"||i.type==="subtype-group"){const n=/^(.*\/FeatureServer)\/\d+$/,o=i.url.replace(n,"$1");if(this._featureServiceUrl.toLowerCase()===o.toLowerCase()&&!this._changeVersionInternal(i,t,r))return!1}else if(i.type==="group"){const n=i.allTables.concat(i.allLayers);for(const o of n)if(o.type==="feature"||o.type==="subtype-group"){const h=/^(.*\/FeatureServer)\/\d+$/,v=o.url.replace(h,"$1");if(this._featureServiceUrl.toLowerCase()===v.toLowerCase()&&!this._changeVersionInternal(o,t,r))return!1}}}return!0}async changeVersionWithResult(e,t,r){let s;if("layers"in e){const n=S(e.allTables.concat(e.allLayers).filter(o=>o.type!=="group").toArray());e.utilityNetworks&&e.utilityNetworks.forEach(o=>{const h=S([o]);n.push(...h)}),s=n}else s=e;if(r&&"name"in r&&!await this.getVersionInfoExtended(r)){const n=new Map;for(const o of s)n.set(o,{success:!1});return n}if(t&&"name"in t&&this.getLockType(t)!=="none"){const n=new Map;for(const o of s)n.set(o,{success:!1});return n}const i=new Map;for(const n of s)if(n)if(n.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const o=this._changeVersionInternalWithResult(n,t,r);i.set(n,o)}else i.set(n,{success:!1});return i}async getVersionIdentifierFromName(e){try{return(await this.getVersionInfos({includeHidden:!0})).find(r=>r.versionIdentifier.name.toUpperCase()===e.toUpperCase())?.versionIdentifier||null}catch{return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await a(()=>import("./getVersion-BUwd45-t.js"),__vite__mapDeps([7,1,2]));try{return(await t(this.url,e)).versionIdentifier}catch{return null}}canUndo(e){return!!l.get(this.url)?.get(e.guid)?.stack?.canUndo()}canRedo(e){return!!l.get(this.url)?.get(e.guid)?.stack?.canRedo()}undo(e){const t=l.get(this.url)?.get(e.guid),r=t?.stack?.undo()||void 0;if(t&&r){const s=t.stack.peek();f(this._featureServiceUrl,null,e.name,s),l.get(this.url)?.set(e.guid,{...t,moment:s})}}redo(e){const t=l.get(this.url)?.get(e.guid),r=t?.stack?.redo()||void 0;t&&r&&(f(this._featureServiceUrl,null,e.name,r),l.get(this.url)?.set(e.guid,{...t,moment:r}))}_setUpData(e,t){let r=null,s=null,i=null,n=null;const o=h=>{const v=l?.get(this.url)?.get(h.guid);i=h.name,n=v?.moment??null};if(e&&"name"in e){if(this.getLockType(e)!=="none")throw new w("version-management-service:version-locked","version is locked");r=e.name,s=null,t&&"name"in t?o(t):(i=this.defaultVersionIdentifier.name,n=t)}else r=this.defaultVersionIdentifier.name,s=e,t&&"name"in t?o(t):(i=this.defaultVersionIdentifier.name,n=t);return{fromVersionName:r,fromMoment:s,toVersionName:i,toMoment:n}}_changeVersionInternal(e,t,r){try{const{fromVersionName:s,fromMoment:i,toVersionName:n,toMoment:o}=this._setUpData(t,r);(this._isDefault(s)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,i)||s===e.gdbVersion&&this._dateEquals(e.historicMoment,i))&&(e.gdbVersion=n,e.historicMoment=o)}catch{return!1}return!0}_changeVersionInternalWithResult(e,t,r){try{const{fromVersionName:s,fromMoment:i,toVersionName:n,toMoment:o}=this._setUpData(t,r);return this._isDefault(s)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,i)||s===e.gdbVersion&&this._dateEquals(e.historicMoment,i)?(e.gdbVersion=n,e.historicMoment=o,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(e,t){const r=l.get(this.url);if(r)for(const[s,i]of r)i.name===e&&this._addToStack(s,t)}_addToStack(e,t){const r=l.get(this.url),s=r?.get(e);return!!s?.stack&&(N(s.stack.peek(),t)&&s.stack.push(t),r.set(e,{...s,moment:t}),!0)}_addOrUpdateItem(e,t){const r=l.get(this.url),s=r?.get(e);return s?(r.set(e,{...s,...t}),!0):!(!t.name||!t.lockType)&&(r?.set(e,{...t,lockType:t.lockType}),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:D(e)});const s=new U(this.url).host;return void I.set(s,this.defaultVersionIdentifier.name)}const r=await O(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};function N(e,t){return e?e.getTime()<t.getTime():!0}u([d()],c.prototype,"url",void 0),u([d()],c.prototype,"sourceJSON",void 0),u([d({type:String,json:{write:!0}})],c.prototype,"name",void 0),u([d({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],c.prototype,"defaultVersionIdentifier",void 0),u([L("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],c.prototype,"readDefaultVersionIdentifier",null),u([k("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],c.prototype,"writeDefaultVersionIdentifier",null),u([d({json:{write:!0}})],c.prototype,"capabilities",void 0),c=u([P("esri.versionManagement.VersionManagementService")],c);const A=c,j=Object.freeze(Object.defineProperty({__proto__:null,default:A},Symbol.toStringTag,{value:"Module"}));export{A as S,j as V,S as p};
