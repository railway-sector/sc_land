import{eK as b,a7 as Z,eR as mt,oD as gt,pO as ye,pP as fe,ar as y,aC as me,MQ as zt,sl as _t,a5 as n,x as u,y as M,bI as Ut,MR as ae,yl as Ht,MS as yt,Mq as qt,Ke as It,JP as Y,Au as ee,LT as Pe,LU as Bt,J_ as B,JX as A,J$ as te,K0 as ie,a3 as se,L_ as $e,K1 as re,K5 as oe,sy as ft,aq as Nt,e4 as z,JR as Wt,MT as Kt,LS as De,Ay as vt,Kw as Xt,MU as Jt,Kz as Qt,L$ as wt,Ml as bt,M0 as ge,c5 as Zt,gJ as I,pk as q,ph as Yt,zL as Se,ui as ei,MV as ti,pi as Ct,m2 as Vt,xP as xt,jO as Pt,hG as $t,bH as S,j as w,a8 as N,eB as Ft,K as ii,cS as si,a9 as ri,aE as Tt,i6 as ve,ag as we,i3 as be,o4 as Rt,p5 as Gt,fV as Fe,hQ as $,z7 as oi,jQ as ni,KO as ai,kv as li,CV as je,aw as ui,JZ as ci,KR as hi,Ku as pi,Kt as di,xY as mi,Mk as gi,MW as Ee,xX as _i,MX as ke,MY as le,LN as _e,Mm as yi,aI as fi,M as vi,bD as wi,W as Ae,gc as ze,ra as Ue,bk as W,bj as J,bl as He,zu as bi,LG as Ci,bi as qe,C$ as Vi,tU as Ce,tT as xi,aH as Ie,kZ as ue,aF as Pi,wY as $i,H4 as Fi,fX as Ti,dZ as Be,eX as Ve,b1 as Ne,ey as Ri,ap as We,jJ as Gi,ao as Mi,a6 as Li,ai as Ke}from"./index-aRi8Xk-b.js";import{e as Oi}from"./AnalysisView3D-fbICHXki.js";import{e as Mt}from"./earcut-D9gy186-.js";import{a as Di,p as ce,w as Si}from"./ShadedColorMaterial.glsl-BPcU5rai.js";import{r as xe,X as ji}from"./Graphics3DExtrudeSymbolLayer-CQIUQ2HG.js";import{W as Xe,T as Je}from"./euclideanLengthMeasurementUtils-4a6kHLjp.js";import{f as Qe,m as Ei}from"./Segment-BzGddsU2.js";import{R as Ze}from"./OutlineVisualElement-CAfudKGN.js";import{h as ki}from"./lineStippleUtils-CCavR4OV.js";import{n as Ai}from"./GraphicsLayer-aZe0Dbdm.js";import{_ as zi,S as Ui}from"./SlicePlaneMaterial.glsl-C2tX4Qjp.js";import{T as Hi}from"./dragEventPipeline3D-DOWpHM6f.js";import{p as qi,j as Ii}from"./dragEventPipeline-1tFNiFrG.js";import{r as Bi}from"./InteractiveToolBase-mwhNHuv2.js";import{l as Lt,c as Ye}from"./SketchOptions-CwjAcyI0.js";import{r as Ni,R as Wi,H as Ki}from"./SketchTooltipInfo-DZI9sYiU.js";import{h as Xi}from"./TooltipInfoWithCoordinates-BXGJlYMf.js";import{s as Ji}from"./ExclusiveOperationManager-ltabdP4A.js";import{a as Qi}from"./allLayerSnapping-C0OMGdb6.js";import{d as Zi}from"./SketchViewModel-CgPwD4NK.js";import"./AnalysisView-KrhGgree.js";import"./VisualElement-CFrfzfzY.js";import"./line-BL5uCDyo.js";import"./ColorMaterial.glsl-0ERmcTqX.js";import"./TriangleMaterial-DkjAC4as.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-BOXYhl1n.js";import"./triangulationUtils-Bx6S2VF2.js";import"./deduplicate-DCdpRX6I.js";import"./geometry2dUtils-CgYtdIFN.js";import"./geodeticLengthOperator-BPMj1oiZ.js";import"./geodeticCurveType-CirnHLSB.js";import"./SnappingManager-DCRQCwjI.js";import"./TextOverlayItem-BAHHjjLE.js";import"./EngineVisualElement-BEU-Bx0-.js";import"./LaserlinePath.glsl-CmjBGYIH.js";import"./line-DJrtAPPO.js";import"./sliceToolConfig-BWp2E4Iq.js";import"./SlicePlane-30lGclDy.js";import"./DefaultLayouts-D_0RpMaS.js";import"./EditGeometryOperations-BtS6ng1n.js";import"./coordinateHelper-DuZS2XLt.js";import"./rotate-BMbD9698.js";import"./curveOperationUtils-DNLI8alC.js";import"./SketchLabelOptions-CdsKprwo.js";import"./coordinateFormatter-CGfDtUZx.js";import"./MeshTransform-DL7voDcB.js";import"./angularMeasurementUtils-aJNkDwXZ.js";import"./directionModeIcons-Br5woIHu.js";import"./isSupportedObject-BODRvkc7.js";import"./layerUtils-kYGDyovj.js";import"./automaticAreaMeasurementUtils-BDF5aXgy.js";import"./geodesicAreaMeasurementUtils-thvXrmuo.js";import"./automaticLengthMeasurementUtils-CCfVEmrk.js";const et=new b("black");let Yi=class{constructor(){this.geometryOutlineWidth=1.5,this.geometryOutlineColor=new b("rgb(128,128,128)"),this.cutColor=new b("rgba(153, 198, 111, 0.75)"),this.fillColor=new b("rgba(200, 200, 230, 0.75)"),this.cutColorMuted=new b("rgba(176, 176, 176, 0.75)"),this.fillColorMuted=new b("rgba(194, 194, 194, 0.75)"),this.cutProjectionLineColor=b.blendColors(this.cutColor,et,.4),this.fillProjectionLineColor=b.blendColors(this.fillColor,et,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4,this.labelDistance=40,this.labelPrecisions={"cubic-millimeters":0,"cubic-centimeters":0,"cubic-decimeters":1,"cubic-meters":2,"cubic-kilometers":6,"cubic-inches":0,"cubic-feet":2,"cubic-yards":2,"cubic-miles":6,liters:2},this.maxVolumeExtentSizeVw=.7,this.minVolumeExtentSizePixels=250,this.minTargetElevation=-11e3,this.maxTargetElevation=9e3,this.targetElevationRange=this.maxTargetElevation-this.minTargetElevation,this.maxPerimeterLocalWebMercator=1e4,this.maxPerimeterGlobal=5e4}};const G=new Yi;let V=class extends Z{constructor(e){super(e),this.rawResult=null}get localOriginRenderSpace(){const{extent:e,localOrigin:i,renderCoordsHelper:s}=this,r=y();return s.toRenderCoords(i,e.spatialReference,r),r}get cameraPositionRenderSpace(){const{localOriginRenderSpace:e,renderCoordsHelper:i}=this,s=y(),r=1/i.unitInMeters;return i.setAltitude(s,ts*r,e),s}get boundingRect(){const{extent:e,renderCoordsHelper:i}=this,s=mt();return i.viewingMode===2?gt(e,s):(this._expandBoundingRect(e.xmin,e.ymin,s),this._expandBoundingRect(e.xmax,e.ymin,s),this._expandBoundingRect(e.xmin,e.ymax,s),this._expandBoundingRect(e.xmax,e.ymax,s)),s}get cameraDimensions(){const{boundingRect:e}=this;return{width:fe(e),height:ye(e)}}get cameraNearFar(){const{renderCoordsHelper:{unitInMeters:e}}=this,i=1/e;return{near:is*i,far:ss*i}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,y())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,y())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,y())}_expandBoundingRect(e,i,s){const{extent:r,eastVector:l,northVector:a,upVector:c,renderCoordsHelper:h}=this,p=r.center.z??0;me(he,e,i,p),h.toRenderCoords(he,r.spatialReference,he),zt(he,l,a,c,tt),_t(s,tt,s)}};n([u()],V.prototype,"renderCoordsHelper",void 0),n([u()],V.prototype,"extent",void 0),n([u()],V.prototype,"localOrigin",void 0),n([u()],V.prototype,"localOriginRenderSpace",null),n([u()],V.prototype,"cameraPositionRenderSpace",null),n([u()],V.prototype,"boundingRect",null),n([u()],V.prototype,"cameraDimensions",null),n([u()],V.prototype,"upVector",null),n([u()],V.prototype,"northVector",null),n([u()],V.prototype,"eastVector",null),n([u()],V.prototype,"rawResult",void 0),V=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillComputation")],V);const he=y(),tt=y(),es=100,ts=G.maxTargetElevation,is=0,ss=G.targetElevationRange+es;let ne=class extends Ut{constructor(e,i,s){super(e,i,s),this.name="unknown",this.name=e}};class it extends ne{constructor(){super("perimeter-too-large","The input geometry's perimeter is too large for the current viewing mode and spatial reference.")}}let rs=class extends ne{constructor(){super("distance-too-far","The measurement geometry is too far from the camera.")}},os=class extends ne{constructor(){super("distance-too-close","The measurement geometry is too close to the camera.")}};class ns extends ne{constructor(){super("unsupported-coordinate-system","The coordinate system of the view (viewing mode and spatial reference) is not supported.")}}let as=class extends ne{constructor(){super("unsupported-layer-transparency","The volume measurement analysis does not support transparent layers.")}};function ls(t,e,i="cubic-meters"){const s=t-e,r=t+e;return{cutVolume:ae(t,i),fillVolume:ae(e,i),netVolume:ae(s,i),totalVolume:ae(r,i)}}function pe(t,e){return t?Ht(t,yt(t.value,t.unit,e)):null}let T=class extends Z{constructor(e){super(e)}get cutVolume(){return pe(this.rawResult.cutVolume,this.unit)}get fillVolume(){return pe(this.rawResult.fillVolume,this.unit)}get netVolume(){return pe(this.rawResult.netVolume,this.unit)}get totalVolume(){return pe(this.rawResult.totalVolume,this.unit)}};n([u({constructOnly:!0})],T.prototype,"measureType",void 0),n([u()],T.prototype,"cutVolume",null),n([u()],T.prototype,"fillVolume",null),n([u()],T.prototype,"netVolume",null),n([u()],T.prototype,"totalVolume",null),n([u({constructOnly:!0})],T.prototype,"rawResult",void 0),n([u({constructOnly:!0})],T.prototype,"unit",void 0),T=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementResult")],T);class Ot extends qt{constructor(){super(...arguments),this.output=0}}n([It({count:11})],Ot.prototype,"output",void 0);let Te=class extends Y{};function Dt(){const t=new ee;return t.include(Pe),t.fragment.include(Bt),t.fragment.uniforms.add(new B("cutFillReferenceDepthTexture",e=>e.referenceDepthTexture),new B("cutFillTargetDepthTexture",e=>e.targetDepthTexture)),t.fragment.code.add(A`bool outsideFar(float depth) {
return depth >= 1.0;
}`),t.fragment.main.add(A`float referenceDepth = depthFromTexture(cutFillReferenceDepthTexture, uv);
float targetDepth = depthFromTexture(cutFillTargetDepthTexture, uv);
if (outsideFar(targetDepth)) {
discard;
}
float depth = referenceDepth - targetDepth;
float cut = min(0.0, depth);
float fill = max(0.0, depth);
fragColor = vec4(cut, fill, 0.0, 0.0);`),t}const us=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"}));let st=class extends te{constructor(e,i){super(e,i,new ie(us,()=>se(()=>Promise.resolve().then(()=>Fs),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}},Re=class extends Y{};function St(){const t=new ee;return t.include(Pe),t.fragment.uniforms.add(new B("cutFillDepthTexture",e=>e.depthTexture)),t.fragment.main.add(A`ivec2 iuv = ivec2(gl_FragCoord.xy) * 2;
vec2 sum = vec2(0.0);
for (int dx = 0; dx < 2; dx++) {
for (int dy = 0; dy < 2; dy++) {
sum += texelFetch(cutFillDepthTexture, iuv + ivec2(dx, dy), 0).rg;
}
}
fragColor = vec4(sum.r, sum.g, 0.0, 0.0);`),t}const cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"}));class rt extends te{constructor(e,i){super(e,i,new ie(cs,()=>se(()=>Promise.resolve().then(()=>Ts),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}}let Ge=class extends Y{constructor(){super(...arguments),this.origin=ft,this.cutFillCamera={projectionMatrix:z(),viewMatrix:z(),nearFar:Nt()}}};function jt(t){const e=new ee,{vertex:i,fragment:s,varyings:r,attributes:l}=e;return e.include(Wt),e.include(Kt,t),l.add("position","vec3"),r.add("depth","float",{invariant:!0}),i.uniforms.add(new De("proj",a=>a.cutFillCamera.projectionMatrix),new De("view",a=>vt(hs,a.cutFillCamera.viewMatrix,a.origin)),new Xt("nearFar",a=>a.cutFillCamera.nearFar)),i.main.add(A`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, depth);`),s.main.add(A`fragColor = vec4(1.0);
outputDepth(depth);`),e}const hs=z(),ps=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"}));let ot=class extends te{constructor(e,i){super(e,i,new ie(ps,()=>se(()=>Promise.resolve().then(()=>Rs),void 0)),Jt)}initializePipeline(){return re({colorWrite:oe,depthWrite:Qt,depthTest:{func:519}})}},j=class extends wt{constructor(e){super(e),this.consumes={required:[bt.TRANSPARENT]},this.produces=ge.CUTFILL_DEPTH,this._cutFillTargetDepthConfiguration=new Ot,this._cutFillTargetDepthParameters=new Ge,this._cutFillDepthParameters=new Te,this._cutFillReductionParameters=new Re,this.needsRender=!1,this.done=!0,this._localOrigin=y(),this._maxTextureSize=4096,this._width=0,this._height=0,this._reducedWidth=0,this._reducedHeight=0,this._depthFormat=13,this._colorFormat=10,this._targetVao=null}initialize(){this._maxTextureSize=Math.min(Zt("esri-mobile")?1024:this._maxTextureSize,this.fboCache.rctx.parameters.maxTextureSize),this._cutFillTargetDepthConfiguration.output=8}destroy(){this._targetVao=I(this._targetVao)}precompile(){this.techniques.precompile(ot,this._cutFillTargetDepthConfiguration),this.techniques.precompile(st),this.techniques.precompile(rt),this.view.stage.renderer.precompileCutFill()}render(e){const i=e.find(({name:C})=>C===ge.CUTFILL_DEPTH);if(!this._orthographicCamera||!this._targetVao||!this.needsRender)return i;const s=this.techniques.get(ot,this._cutFillTargetDepthConfiguration),r=this.techniques.get(st),l=this.techniques.get(rt);if(!s.compiled||!r.compiled||!l.compiled)return this.requestRender(1),i;this.needsRender=!1;const a=this.renderingContext,c=this.fboCache,h=a.getViewport(),p=c.acquire(this._width,this._height,"cutfill reference depth",this._depthFormat);a.bindFramebuffer(p.fbo),a.setViewport(0,0,this._width,this._height),a.clear(1280),this.view.stage.renderer.renderCutFillReferenceDepth(this._orthographicCamera);const o=c.acquire(this._width,this._height,"cutfill target depth",this._depthFormat);a.bindFramebuffer(o.fbo),a.setViewport(0,0,this._width,this._height),a.setClearDepth(1),a.clear(256),this._cutFillTargetDepthParameters.origin=this._localOrigin,this._cutFillTargetDepthParameters.cutFillCamera=this._orthographicCamera,a.bindTechnique(s,this.bindParameters,this._cutFillTargetDepthParameters),a.bindVAO(this._targetVao),a.drawArrays(q.TRIANGLES,0,this._targetVao.vertexCount("geometry"));let d=c.acquire(this._width,this._height,"cutfill reduction even",this._colorFormat),m=c.acquire(this._width,this._height,"cutfill reduction odd",this._colorFormat);this._cutFillDepthParameters.referenceDepthTexture=p.depthTexture,this._cutFillDepthParameters.targetDepthTexture=o.depthTexture,a.bindFramebuffer(d.fbo),a.bindTechnique(r,this.bindParameters,this._cutFillDepthParameters),a.setClearColor(0,0,0,0),a.clear(16384),a.screen.draw(),p.release(),o.release();let f=this._width,v=this._height;const _=Math.ceil(Math.log2(Math.min(f,v)));for(let C=0;C<_;C++)f=Math.ceil(f/2),v=Math.ceil(v/2),this._cutFillReductionParameters.depthTexture=d.getTexture(),this._prepareFBO(m,f,v),a.bindTechnique(l,this.bindParameters,this._cutFillReductionParameters),a.screen.draw(),[d,m]=[m,d];return this._buffer=new Float32Array(f*v*2),d.fbo?.readPixels(0,0,f,v,33319,Yt.FLOAT,this._buffer),this._reducedWidth=f,this._reducedHeight=v,d.release(),m.release(),a.setViewport(h.x,h.y,h.width,h.height),this.done=!0,i}setup(e,i){const s=this.renderingContext,{cameraDimensions:{width:r,height:l},localOriginRenderSpace:a}=e,c=this._maxTextureSize,h=l/r,p=r>l?c:c/h,o=r>l?c*h:c;this._width=Se(p),this._height=Se(o);const d=[this._width,this._height];this._orthographicCamera=this._createCamera(e,d),this._targetVao=I(this._targetVao),this._targetVao=ds(s,i),this._localOrigin=a,this.done=!1}start(){this._width!==0&&this._height!==0&&(this.needsRender=!0)}getDepth(){let e=0,i=0;for(let s=0;s<this._reducedWidth;s++)for(let r=0;r<this._reducedHeight;r++){const l=s+r*this._reducedHeight;e+=this._buffer?.[2*l]??0,i+=this._buffer?.[2*l+1]??0}return{cut:e,fill:i}}get width(){return this._width}get height(){return this._height}get updating(){return this.needsRender||!this.done}_prepareFBO(e,i,s){const r=this.renderingContext;r.bindFramebuffer(e.fbo),r.setViewport(0,0,i,s),r.setClearColor(0,0,0,0),r.clear(16384)}_createCamera(e,i){const{cameraPositionRenderSpace:s,localOriginRenderSpace:r,northVector:l,cameraDimensions:{width:a,height:c},cameraNearFar:{near:h,far:p}}=e,o=new ei({eye:s,center:r,up:l,near:h,far:p});return o.viewport=[0,0,i[0],i[1]],ti(o.projectionMatrix,-a/2,a/2,-c/2,c/2,h,p),o}};n([u()],j.prototype,"consumes",void 0),n([u()],j.prototype,"produces",void 0),n([u()],j.prototype,"needsRender",void 0),n([u()],j.prototype,"done",void 0),n([u()],j.prototype,"updating",null),j=n([M("esri.views.3d.webgl-engine.lib.CutFillDepth")],j);const nt=Pt().vec3f("position").freeze();function ds(t,e){const{positions:i,indices:s}=e,r=nt.createBuffer(s.length),l=r.position;for(let c=0;c<s.length;++c){const h=3*s[c];l.set(c,0,i[h]),l.set(c,1,i[h+1]),l.set(c,2,i[h+2])}const a=new Ct(t,Vt(nt),r.buffer);return new xt(t,a)}let ms=class{constructor(e,i){this.positions=e,this.indices=i}},g=class extends Z{constructor(t){super(t),this._getElevationProvider=()=>this.view.elevationProvider,this._updatingHandles=new $t,this._computationValue=null}initialize(){const t=this.view;this._renderer=new j({view:t}),this._updatingHandles.add(()=>({computation:this._computation,renderGeometry:this._targetGeometryRenderInfo}),({computation:e,renderGeometry:i})=>{e&&i&&(this._renderer.setup(e,i),this._renderer.start())},S),this.addHandles([this._createElevationUpdateHandle(),w(()=>this._targetGeometry,e=>this.analysisViewData.targetGeometry=e,N),w(()=>this._elevationAlignedGeometry,e=>this.analysisViewData.elevationAlignedGeometry=e,N),w(()=>({computation:this._computation,extent:this._projectedGeometry?.extent,localOrigin:this._localOrigin}),({computation:e,extent:i,localOrigin:s})=>{e&&i&&s&&(e.extent=i,e.localOrigin=s)},Ft),ii(()=>this._renderer.done,()=>this._updateResult())])}destroy(){this._updatingHandles.destroy(),this._renderer.destroy()}get _projectedGeometry(){if(!this.analysis.valid)return null;const t=this.analysis.geometry,e=si(t,this.view.spatialReference);return e.pending?(this._updatingHandles.addPromise(e.pending),null):(t&&!e.geometry&&Di(this.analysis,t.spatialReference,ri.getLogger(this)),e.geometry)}get _localOrigin(){const t=this._projectedGeometry?.extent;return t?Tt(t.center.x,t.center.y,0):null}get _elevationAlignedGeometry(){const t=this._projectedGeometry;if(!t)return null;const e=t.clone();return gs(this._getElevationProvider(),e),e}get _targetGeometry(){const t=this._elevationAlignedGeometry;if(!t)return null;const e=this.analysis.measureType,{effectiveTargetElevation:i}=this.analysisViewData;if(e==="stockpile"||i==null)return t;const s=t.clone();return s.rings[0].forEach(r=>r[2]=i),s}get _targetGeometryRenderInfo(){const t=this._targetGeometry,e=this._projectedGeometry?.extent,i=this._localOrigin;if(!t||!e||!i)return null;const{elevationProvider:s,renderCoordsHelper:r}=this.view,l=xe(t,s,r,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:a}=l,c=a[0],h=Mt(c.position,c.holeIndices,3),p=be(3*c.count),o=z(),d=z();return Rt(e.spatialReference,i,o,r.spatialReference),d[12]=-o[12],d[13]=-o[13],d[14]=-o[14],Gt(p,c.position,d),new ms(p,h)}get updating(){return this._renderer.updating||this._updatingHandles.updating}get result(){const t=this._computation?.rawResult;return t?new T({measureType:this.analysis.measureType,rawResult:t,unit:this.analysisViewData.effectiveDisplayUnits.volume}):null}get error(){return this._unsupportedCoordinateSystemError??this._unsupportedLayerTransparencyError??this._perimeterTooLargeError??this._tooNearFarError}get _tooNearFarError(){const t=this._elevationAlignedGeometry;if(!t)return null;const{view:e}=this,{elevationProvider:i,renderCoordsHelper:s}=e,{camera:r}=e.state,l=xe(t,i,s,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:a}=l,c=a[0].position;Fe(K);for(let m=0;m<c.length;m+=3)r.projectToScreen(me(vs,c[m],c[m+1],c[m+2]),ut),_t(K,ut,K);const h=fe(K),p=ye(K),{maxVolumeExtentSizeVw:o,minVolumeExtentSizePixels:d}=G;return h>r.width/r.pixelRatio*o||p>r.height/r.pixelRatio*o?new os:Math.max(h,p)<d?new rs:null}get _perimeterTooLargeError(){return this._perimeterTooLargeLocalError??this._perimeterTooLargeGlobalError}get _perimeterTooLargeLocalError(){const{spatialReference:t,state:{isLocal:e}}=this.view;if(!e||!t.isWebMercator)return null;const i=this._perimeter,{maxPerimeterLocalWebMercator:s}=G;return i!=null&&i>s?new it:null}get _perimeterTooLargeGlobalError(){if(!this.view.state.isGlobal)return null;const t=this._perimeter,{maxPerimeterGlobal:e}=G;return t!=null&&t>e?new it:null}get _unsupportedCoordinateSystemError(){return this.view.state.isLocal&&this.view.spatialReference.isGeographic?new ns:null}get _unsupportedLayerTransparencyError(){return(this.view.map?.ground.opacity??1)<1?new as:null}get _perimeter(){const t=this._targetGeometryRenderInfo?.positions,e=t?ys(fs(t)):null;return e!=null?e/this.view.renderCoordsHelper.unitInMeters:null}get _enabled(){return!this.error}get _computation(){const t=this._projectedGeometry?.extent;if(!t||!this._enabled)return this._computationValue=$(this._computationValue),null;if(this._computationValue)return this._computationValue;const e=this._localOrigin;if(!e)return null;const{renderCoordsHelper:i}=this.view;return this._computationValue=new V({extent:t,localOrigin:e,renderCoordsHelper:i}),this._computationValue}_createElevationUpdateHandle(){const t=e=>{const i=this._projectedGeometry?.extent;e.context==="ground"&&i&&(oi(e.extent,e.spatialReference,at,this.view.spatialReference),gt(i,lt),ni(at,lt)&&(this._getElevationProvider=()=>this.view.elevationProvider))};return this.view.elevationProvider.on("elevation-change",e=>t(e))}_updateResult(){if(!this._computation)return;const{spatialReference:t,viewingMode:e}=this.view,{extent:i,boundingRect:s,cameraNearFar:{near:r,far:l}}=this._computation,{width:a,height:c}=this._renderer;let h,p;e==="local"&&t.isWebMercator?{width:h,height:p}=_s(i):(h=fe(s),p=ye(s));const o=h/a*(p/c),d=this._renderer.getDepth(),m=_=>_*(l-r)+r,f=m(d.cut)*o,v=m(d.fill)*o;this._computation.rawResult=ls(Math.abs(f),v)}};function gs(t,e){e.rings[0].forEach(i=>{i[2]=ai(t,i,"ground")??0})}function _s(t){const e=Xe([t.xmin,t.ymin,0],[t.xmax,t.ymin,0],t.spatialReference),i=Xe([t.xmin,t.ymin,0],[t.xmin,t.ymax,0],t.spatialReference);return{width:e?.value??0,height:i?.value??0}}function ys(t){if(!t)return null;let e=null,i=null,s=0;for(const r of t)e||(e=[r[0],r[1],r[2]??0]),i?s+=je(i,r):i=[0,0,0],i[0]=r[0],i[1]=r[1],i[2]=r[2];return e&&i&&(s+=je(i,e)),Math.sqrt(s)}function*fs(t){const e=y();for(let i=0;i<t.length;i+=3)e[0]=t[i],e[1]=t[i+1],e[2]=t[i+2],yield e}n([u()],g.prototype,"_projectedGeometry",null),n([u()],g.prototype,"_localOrigin",null),n([u()],g.prototype,"_getElevationProvider",void 0),n([u()],g.prototype,"_elevationAlignedGeometry",null),n([u()],g.prototype,"_targetGeometry",null),n([u()],g.prototype,"_targetGeometryRenderInfo",null),n([u({constructOnly:!0})],g.prototype,"analysis",void 0),n([u({constructOnly:!0})],g.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],g.prototype,"view",void 0),n([u()],g.prototype,"updating",null),n([u()],g.prototype,"result",null),n([u()],g.prototype,"error",null),n([u()],g.prototype,"_tooNearFarError",null),n([u()],g.prototype,"_perimeterTooLargeError",null),n([u()],g.prototype,"_perimeterTooLargeLocalError",null),n([u()],g.prototype,"_perimeterTooLargeGlobalError",null),n([u()],g.prototype,"_unsupportedCoordinateSystemError",null),n([u()],g.prototype,"_unsupportedLayerTransparencyError",null),n([u()],g.prototype,"_perimeter",null),n([u()],g.prototype,"_enabled",null),n([u()],g.prototype,"_renderer",void 0),n([u({readOnly:!0})],g.prototype,"_updatingHandles",void 0),n([u()],g.prototype,"_computation",null),g=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillController")],g);const at=Fe(),lt=Fe(),vs=y(),K=mt(),ut=li();let Me=class extends Y{constructor(){super(...arguments),this.borderColor=ui()}};function Et(){const t=new ee;return t.include(Pe),t.outputs.add("fragColor","vec4",0),t.fragment.uniforms.add(new B("colorTexture",e=>e.color),new B("cutFillVolumes",e=>e.cutFillVolumes),new B("cutFillMask",e=>e.cutFillMask),new ci("pixelRatio",(e,i)=>i.camera.pixelRatio),new hi("borderColor",e=>e.borderColor)).main.add(A`vec4 color = texture(colorTexture, uv, 0.0);
vec4 volumesColor = texture(cutFillVolumes, uv, 0.0);
ivec2 iuv = ivec2(uv * vec2(textureSize(cutFillMask, 0)));
vec2 m0 = texelFetch(cutFillMask, iuv, 0).rg;
vec2 m1 = texelFetch(cutFillMask, iuv + ivec2(-1, 0), 0).rg;
vec2 m2 = texelFetch(cutFillMask, iuv + ivec2(1, 0), 0).rg;
vec2 m3 = texelFetch(cutFillMask, iuv + ivec2(0, -1), 0).rg;
vec2 m4 = texelFetch(cutFillMask, iuv + ivec2(0, 1), 0).rg;
float d = (
step(1.5, abs(m0.r - m1.r) + abs(m0.g - m1.g))
+ step(1.5, abs(m0.r - m2.r) + abs(m0.g - m2.g))
+ step(1.5, abs(m0.r - m3.r) + abs(m0.g - m3.g))
+ step(1.5, abs(m0.r - m4.r) + abs(m0.g - m4.g))
) * 0.25 * pixelRatio;
vec4 base = mix(color, volumesColor, max(m0.r, m0.g) * volumesColor.a);
fragColor = mix(base, borderColor, d);`),t}const ws=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"}));let ct=class extends te{constructor(e,i){super(e,i,new ie(ws,()=>se(()=>Promise.resolve().then(()=>Gs),void 0)),$e)}initializePipeline(){return re({colorWrite:oe})}};class Le extends Y{constructor(){super(...arguments),this.origin=ft}}function kt(){const t=new ee;return t.attributes.add("position","vec3"),t.outputs.add("fragColor","vec4",0),t.vertex.uniforms.add(new pi("proj",e=>e.camera.projectionMatrix),new di("view",(e,i)=>vt(bs,i.camera.viewMatrix,e.origin))).main.add(A`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),t.fragment.main.add(A`fragColor = vec4(1, 1, 0, 0);`),t}const bs=z(),Cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Le,build:kt},Symbol.toStringTag,{value:"Module"}));class ht extends te{constructor(e,i){super(e,i,new ie(Cs,()=>se(()=>Promise.resolve().then(()=>Ms),void 0)),mi(gi))}initializePipeline(){return re({colorWrite:oe,depthTest:{func:515}})}}let E=class extends wt{constructor(t){super(t),this.consumes={required:[bt.OPAQUE]},this.produces=ge.CUTFILL_COLOR,this._vaoCut=null,this._vaoFill=null,this._countCut=0,this._countFill=0,this._maskParameters=new Le,this._cutVolumeParameters=new Ee,this._fillVolumeParameters=new Ee,this._compositeParameters=new Me,this._drawParameters=new _i;const e=t.view.state.viewingMode===1;this._cutVolumeTechniqueConfiguration=new ke(e),this._cutVolumeTechniqueConfiguration.customDepthTest=2,this._cutVolumeTechniqueConfiguration.writeDepth=!1,this._cutVolumeTechniqueConfiguration.cullFace=1,this._cutVolumeTechniqueConfiguration.doubleSidedMode=1,this._fillVolumeTechniqueConfiguration=new ke(e),this._fillVolumeTechniqueConfiguration.cullFace=2}initialize(){this.addHandles([w(()=>[this.cutColor,this.fillColor],()=>this._updateColors(),N)])}destroy(){this._vaoCut=I(this._vaoCut),this._vaoFill=I(this._vaoFill)}precompile(){this.techniques.precompile(le,this._cutVolumeTechniqueConfiguration),this.techniques.precompile(le,this._fillVolumeTechniqueConfiguration),this.techniques.precompile(ht),this.techniques.precompile(ct)}render(t){const e=this.techniques.get(le,this._cutVolumeTechniqueConfiguration),i=this.techniques.get(le,this._fillVolumeTechniqueConfiguration),s=this.techniques.get(ht),r=this.techniques.get(ct),l=t.find(({name:_})=>_===this.produces);if(!this._vaoCut||!this._vaoFill)return l;if(!(e&&i&&s.compiled&&r.compiled))return this.requestRender(1),l;const a=this.bindParameters,c=a.camera,h=c.fullViewport[2],p=c.fullViewport[3],o=this.renderingContext,d=this.fboCache,m=d.acquire(h,p,"cutfill color mask",2);m.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(m.fbo),o.setClearColor(0,0,0,1),o.clear(17408),o.setViewport(0,0,h,p),o.bindTechnique(s,a,yi,this._maskParameters),o.setFaceCullingEnabled(!1),o.setStencilTestEnabled(!0),o.setStencilOpSeparate(1028,7680,34055,7680),o.setStencilOpSeparate(1029,7680,34056,7680),o.setDepthWriteEnabled(!1),o.bindVAO(this._vaoCut),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.setDepthTestEnabled(!1),o.setStencilWriteMask(0),o.setStencilFunction(517,0,255),o.setColorMask(!0,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindVAO(this._vaoFill),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!0,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countFill);const f=d.acquire(h,p,"cutfill color volumes",5);f.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(f.fbo),o.setClearColor(0,0,0,0),o.clear(16384),o.setColorMask(!0,!0,!0,!0),o.bindTechnique(e,this.bindParameters,this._cutVolumeParameters,this._drawParameters),o.setPolygonOffset(1,1),o.setPolygonOffsetFillEnabled(!0),o.bindVAO(this._vaoCut),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindTechnique(i,this.bindParameters,this._fillVolumeParameters,this._drawParameters),o.setPolygonOffset(0,0),o.setPolygonOffsetFillEnabled(!1),o.bindVAO(this._vaoFill),o.drawArrays(q.TRIANGLES,0,this._countFill);const v=this.fboCache.acquire(h,p,this.produces);return o.bindFramebuffer(v.fbo),this._compositeParameters.color=l.getTexture(),this._compositeParameters.cutFillVolumes=f.getTexture(),this._compositeParameters.cutFillMask=m.getTexture(),b.toUnitRGBA(this.borderColor,this._compositeParameters.borderColor),o.bindTechnique(r,a,this._compositeParameters),o.screen.draw(),m.release(),f.release(),v.attachDepth(l.getAttachment(_e)),v}enable(){this.produces=ge.CUTFILL_COLOR,this.requestRender(1)}disable(){this.produces="disabled",this.requestRender(1)}updateGeometries(t,e,i){this._vaoCut=I(this._vaoCut),this._vaoCut=this._createVao(t),this._countCut=t.indicesBottom.length+t.indicesExtruded.length,this._vaoFill=I(this._vaoFill),this._vaoFill=this._createVao(e),this._countFill=e.indicesBottom.length+e.indicesExtruded.length,this._maskParameters.origin=i,fi(this._drawParameters.origin,i),this.requestRender(1)}_updateColors(){this._cutVolumeParameters.diffuse=b.toUnitRGB(this.cutColor),this._cutVolumeParameters.opacity=this.cutColor.a,this._fillVolumeParameters.diffuse=b.toUnitRGB(this.fillColor),this._fillVolumeParameters.opacity=this.fillColor.a,this.requestRender(1)}_createVao(t){const e=this.renderingContext,{vertices:i,normals:s,indicesBottom:r,indicesExtruded:l}=t,a=pt.createBuffer(r.length+l.length),{position:c,normal:h}=a;for(let o=0;o<r.length;o++){const d=3*r[o];c.set(o,0,i[d]),c.set(o,1,i[d+1]),c.set(o,2,i[d+2]),h.set(o,0,s[d]),h.set(o,1,s[d+1]),h.set(o,2,s[d+2])}for(let o=0;o<l.length;o++){const d=o+r.length,m=3*l[o];c.set(d,0,i[m]),c.set(d,1,i[m+1]),c.set(d,2,i[m+2]),h.set(d,0,s[m]),h.set(d,1,s[m+1]),h.set(d,2,s[m+2])}const p=new Ct(e,Vt(pt),a.buffer);return new xt(e,p)}};n([u()],E.prototype,"consumes",void 0),n([u()],E.prototype,"produces",void 0),n([u()],E.prototype,"cutColor",void 0),n([u()],E.prototype,"fillColor",void 0),n([u()],E.prototype,"borderColor",void 0),E=n([M("esri.views.3d.webgl-engine.lib.CutFillColor")],E);const pt=Pt().vec3f("position").vec3f("normal").freeze();class Vs{constructor(e,i,s,r){this.vertices=e,this.indicesBottom=i,this.indicesExtruded=s,this.normals=r}}let P=class extends Z{get visible(){return this.analysisViewData.visible&&this.analysisViewData.elevationAlignedGeometry!=null&&this.analysisViewData.targetGeometry!=null}get updating(){return this.loadingMessages}get hasUnsupportedError(){const{error:t}=this.analysisViewData;return!!t&&["unsupported-coordinate-system","unsupported-layer-transparency"].includes(t.name)}constructor(t){super(t),this.unitsMessages=null,this.messages=null,this.loadingMessages=!0,this._elevationContext=ve.fromElevationInfo(new we({mode:"absolute-height"})),this._extrusionHeight=G.targetElevationRange,this._projectionLines=[]}initialize(){const{view:t}=this,e={view:t,isDecoration:!0},i=G,s={...e,width:i.geometryOutlineWidth};this._elevationAlignedGeometry=new Ze({...s,isDraped:!0,color:b.toUnitRGBA(i.geometryOutlineColor)}),this._targetGeometry=new Ze(s);const r={...e,attached:!0,width:i.projectionLineWidth,renderOccluded:4,polygonOffset:!0},l={...r,stipplePattern:ki(i.projectionLineStippleSize)},a=b.toUnitRGBA(i.cutProjectionLineColor),c=b.toUnitRGBA(i.fillProjectionLineColor);this._cutProjectionLines=new ce({...r,color:a}),this._occludedCutProjectionLines=new ce({...l,color:a}),this._fillProjectionLines=new ce({...r,color:c}),this._occludedFillProjectionLines=new ce({...l,color:c});const h={...e,attached:!0};this._cutVolumeLabel=new Qe(h),this._fillVolumeLabel=new Qe(h),this._cutFillRenderNode=new E({view:t,cutColor:i.cutColor,fillColor:i.fillColor,borderColor:i.geometryOutlineColor}),this.addHandles([w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry}),({elevationAlignedGeometry:p,targetGeometry:o})=>{this._elevationAlignedGeometry.geometry=p,this._targetGeometry.geometry=o},S),w(()=>({interactive:this.analysisViewData.interactive,measureType:this.analysis.measureType,visible:this.visible}),({visible:p,interactive:o,measureType:d})=>{this._elevationAlignedGeometry.visible=p&&!o,this._targetGeometry.visible=p&&d==="cut-fill"},S),w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry,visible:this.visible}),({elevationAlignedGeometry:p,targetGeometry:o,visible:d})=>this._updateProjectionLines(p,o,d),S),w(()=>({interactive:this.analysisViewData.interactive,accentColor:this.view.effectiveTheme.accentColor,hasResult:!!this.analysisViewData.result}),({interactive:p,accentColor:o,hasResult:d})=>{this._updateColors(p,o,d)},S),w(()=>this.analysisViewData.targetGeometry,()=>this._updateCutFillGeometry(),S),w(()=>this.visible&&!this.hasUnsupportedError,p=>this._updateCutFillVisibility(p),S),w(()=>{const{messages:p,unitsMessages:o,visible:d,analysisViewData:m}=this;return{labelAnchors:m.labelAnchors,effectiveDisplayUnits:m.effectiveDisplayUnits,messages:p,unitsMessages:o,result:m.result,visible:d&&!!m.result}},p=>this._updateLabels(p)),w(()=>this.view.state.camera,p=>this._updateProjectionLineOcclusion(p),S),vi(()=>this._updateMessageBundle())]),this._updateMessageBundle()}destroy(){this._elevationAlignedGeometry=$(this._elevationAlignedGeometry),this._targetGeometry=$(this._targetGeometry),this._cutProjectionLines=$(this._cutProjectionLines),this._occludedCutProjectionLines=$(this._occludedCutProjectionLines),this._fillProjectionLines=$(this._fillProjectionLines),this._occludedFillProjectionLines=$(this._occludedFillProjectionLines),this._cutVolumeLabel=$(this._cutVolumeLabel),this._fillVolumeLabel=$(this._fillVolumeLabel),this._cutFillRenderNode.destroy()}_updateProjectionLines(t,e,i){if(this._cutProjectionLines.visible=i,this._occludedCutProjectionLines.visible=i,this._fillProjectionLines.visible=i,this._occludedFillProjectionLines.visible=i,!t||!e)return;const{renderCoordsHelper:s}=this.view,r=[],l=t.spatialReference,a=t.rings[0],c=a.length>1&&wi(a[0],a[a.length-1]),h=a.length-(c?1:0);for(let _=0;_<h;++_){const C=a[_],L=me(y(),C[0],C[1],C[2]);s.toRenderCoords(L,l,L);const O=e.rings[0][_],F=me(y(),O[0],O[1],O[2]);s.toRenderCoords(F,l,F);const H=new Ei(L,F);r.push(H)}t.isClockwise(a)||r.reverse();const p=[],o=[],d=[],m=[],f=[],v=this.view.state.camera;for(let _=0;_<r.length;++_){const C=r[_],L=r[_===0?r.length-1:_-1],O=r[_===r.length-1?0:_+1],F=t.rings[0][_],H=e.rings[0][_],U=F[2]>H[2],D=new xs(C,L,O,U);p.push(D),D.updateOccluded(v);const Oe=D.isOccluded;U?(Oe?d:o).push(C):(Oe?f:m).push(C)}this._projectionLines=p,this._cutProjectionLines.setGeometryFromSegments(o),this._occludedCutProjectionLines.setGeometryFromSegments(d),this._fillProjectionLines.setGeometryFromSegments(m),this._occludedFillProjectionLines.setGeometryFromSegments(f)}_updateProjectionLineOcclusion(t){const e=[],i=[],s=[],r=[];let l=!1,a=!1;for(const c of this._projectionLines){c.updateOccluded(t)&&(l||=c.isCut,a||=!c.isCut);const h=c.isOccluded;(c.isCut?h?i:e:h?r:s).push(c.segment)}a&&(this._fillProjectionLines.setGeometryFromSegments(s),this._occludedFillProjectionLines.setGeometryFromSegments(r)),l&&(this._cutProjectionLines.setGeometryFromSegments(e),this._occludedCutProjectionLines.setGeometryFromSegments(i))}_updateColors(t,e,i){const{geometryOutlineColor:s,cutColor:r,fillColor:l,cutColorMuted:a,fillColorMuted:c,cutProjectionLineColor:h,fillProjectionLineColor:p}=G;if(this._cutFillRenderNode.cutColor=i?r:a,this._cutFillRenderNode.fillColor=i?l:c,t){const o=b.toUnitRGBA(e);this._targetGeometry.color=o,this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o,this._fillProjectionLines.color=o,this._occludedFillProjectionLines.color=o,this._cutFillRenderNode.borderColor=e}else{this._targetGeometry.color=b.toUnitRGBA(s);const o=b.toUnitRGBA(i?h:a);this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o;const d=b.toUnitRGBA(i?p:c);this._fillProjectionLines.color=d,this._occludedFillProjectionLines.color=d,this._cutFillRenderNode.borderColor=s}}_updateLabels(t){const{labelDistance:e}=G,{effectiveDisplayUnits:i,labelAnchors:s,messages:r,unitsMessages:l,result:a,visible:c}=t;if(this._cutVolumeLabel.visible=c,this._fillVolumeLabel.visible=c,this._cutVolumeLabel.geometry=s.cut?{type:"point",point:s.cut,callout:{distance:e,offset:0}}:null,this._fillVolumeLabel.geometry=s.fill?{type:"point",point:s.fill,callout:{distance:-e,offset:0}}:null,a==null||r==null||l==null)return this._cutVolumeLabel.text="-",void(this._fillVolumeLabel.text="-");const h=i.volume,p=Ae(r.labels.cut,{volume:dt(l,a.cutVolume,h)}),o=Ae(r.labels.fill,{volume:dt(l,a.fillVolume,h)});this._cutVolumeLabel.text=p,this._fillVolumeLabel.text=o}_updateCutFillVisibility(t){t?this._cutFillRenderNode.enable():this._cutFillRenderNode.disable()}_updateCutFillGeometry(){const{renderCoordsHelper:t}=this.view,{targetGeometry:e}=this.analysisViewData;if(!e?.extent)return;const{center:i}=e.extent,s=Tt(i.x,i.y,0),r=y();t.toRenderCoords(s,e.spatialReference,r);const l=this._getExtrudedVolumes(e,this._extrusionHeight,s),a=this._getExtrudedVolumes(e,-this._extrusionHeight,s);this._cutFillRenderNode.updateGeometries(l,a,r)}_getExtrudedVolumes(t,e,i){const{renderCoordsHelper:s,spatialReference:r,elevationProvider:l}=this.view,a=y(),c=s.viewingMode===1;c||s.worldUpAtPosition([0,0,0],a);const h=xe(t,l,s,this._elevationContext),{polygons:p,mapPositions:o,position:d}=h,m=p[0],f=m.count,v=Mt(m.mapPositions,m.holeIndices,3),_=v.length,C=6*f,L=ze(C+_),O=ze(_),F=be(3*C),H=be(3*C);ji(d,o,v,m,F,null,H,null,L,O,e,a,c);const U=z(),D=z();return Rt(r,i,U,s.spatialReference),D[12]=-U[12],D[13]=-U[13],D[14]=-U[14],Gt(F,F,D),new Vs(F,O,L,H)}async _updateMessageBundle(){this.loadingMessages=!0;try{this.unitsMessages=await Ue("esri/core/t9n/Units"),this.messages=await Ue("esri/views/3d/analysis/VolumeMeasurement/t9n/VolumeMeasurementAnalysis")}finally{this.loadingMessages=!1}}};function dt(t,e,i){if(!e||!t)return null;const s=yt(e.value,e.unit,i),r=G.labelPrecisions[s];return Vi(t,e,s,r)}n([u({constructOnly:!0})],P.prototype,"view",void 0),n([u({constructOnly:!0})],P.prototype,"analysis",void 0),n([u({constructOnly:!0})],P.prototype,"analysisViewData",void 0),n([u()],P.prototype,"unitsMessages",void 0),n([u()],P.prototype,"messages",void 0),n([u()],P.prototype,"loadingMessages",void 0),n([u({readOnly:!0})],P.prototype,"visible",null),n([u()],P.prototype,"updating",null),n([u()],P.prototype,"hasUnsupportedError",null),P=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillVisualization")],P);class xs{constructor(e,i,s,r){this.segment=e,this.previous=i,this.next=s,this.isCut=r,this._isOccluded=!1,this._n1=y(),this._n2=y();const l=W(X,J(X,e.endRenderSpace,e.startRenderSpace));W(this._n1,He(this._n1,l,W(de,J(de,i.startRenderSpace,e.startRenderSpace)))),W(this._n2,He(this._n2,l,W(de,J(de,e.startRenderSpace,s.startRenderSpace)))),this._isConvex=bi.normalize(Ci(this._n1,this._n2,l))<0}get isOccluded(){return this._isOccluded}updateOccluded(e){J(X,this.segment.startRenderSpace,e.eye);const i=qe(this._n1,X)<0,s=qe(this._n2,X)<0,r=this._isOccluded;return this._isOccluded=this._isConvex?i&&s:i||s,this._isOccluded!==r}}const X=y(),de=y();function Ps(t){return At(t?.geometry)}function At(t){return t!=null&&t.type==="polygon"}let Q=class extends Xi(Ni){constructor(t){super(t),this.type="elevation",this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.elevation]}};n([u()],Q.prototype,"type",void 0),n([u()],Q.prototype,"allFields",null),Q=n([M("esri.views.interactive.tooltip.infos.ElevationTooltipInfo")],Q);let k=class extends Bi{constructor(t){super(t),this.sketchOptions=new Lt}initialize(){const{view:t}=this;this._shiftManipulator=new zi(t,0),this._shiftManipulator.state|=Ui,this.manipulators.add(this._shiftManipulator),this.addHandles([this._createDragPipeline(),w(()=>this.analysisViewData.targetGeometry,()=>this._updateManipulatorPosition(),Ft),w(()=>[this.analysisViewData.interactive,this.analysisViewData.targetGeometry,this.analysis.measureType],()=>this._updateManipulatorVisibility(),N)]),this._initializeTooltip(),this.finishToolCreation()}_initializeTooltip(){const{view:t}=this;this.tooltip=Wi(()=>({view:t,options:this.sketchOptions.tooltips})),this._tooltipInfo=new Q({sketchOptions:this.sketchOptions}),this.sketchOptions.tooltips.placement="trailing",this._updateSketchOptions(),this.addHandles([w(()=>this.analysisViewData.effectiveTargetElevation,()=>this._updateTooltip()),w(()=>this._shouldShowTooltip,e=>{e?this._showTooltip():this._hideTooltip()}),this.tooltip.on("commit",()=>{const e=this._tooltipInfo.elevation.actual,i=Ce(this.view.spatialReference);if(e==null||i==null)return;const s=xi(e,i);this._updateValue(s,{recordUndo:this.analysis.cutFillOptions.targetElevation})}),w(()=>[this.analysis.displayUnits.elevation,this.analysis.inputUnits.elevation],()=>this._updateSketchOptions(),N)])}destroy(){this._shiftManipulator.destroy(),this.tooltip.destroy()}onInputEvent(t){if(!this.destroyed&&!Ki(t,this.tooltip))return super.onInputEvent(t)}get _shouldShowTooltip(){return this.hasFocusedManipulators||this.tooltip.mode==="input"}_createDragPipeline(){return qi(this._shiftManipulator,(t,e,i)=>{const s=Be(t.renderLocation),r=this.analysis.inputUnits.elevation??"meters",l=Ce(this.view.spatialReference);let a;e.next(Hi(this.view,s,this.view.spatialReference)).next(Ii()).next(c=>{if(c.action==="start"){const{targetElevation:h}=this.analysis.cutFillOptions;a=h&&l?Ve(h,r,l):void 0}return this._updateValue(a!=null?a+c.translationZ:c.mapEnd.z,c.action==="end"?{recordUndo:a}:void 0),c}),i.next(()=>{this._updateValue(a)})})}_updateManipulatorPosition(){const{targetGeometry:t}=this.analysisViewData,{renderCoordsHelper:e}=this.view;if(!t)return;const i=.5,s=t.rings[0],r=Ie(s[0]),l=Ie(s[1]);e.toRenderCoords(r,t.spatialReference,r),e.toRenderCoords(l,t.spatialReference,l);const a=ue.get();J(a,l,r);const c=ue.get();Pi(c,r,l,i);const h=e.worldBasisAtPosition(c,1,ue.get()),p=e.worldBasisAtPosition(c,0,ue.get()),o=Si(h,p,c,$i.get()),d=e.headingAtPosition(c,a),m=t.isClockwise(t.rings[0])?-Math.PI/2:Math.PI/2;Fi(o,o,Ti(d)+m),o[12]=0,o[13]=0,o[14]=0,this._shiftManipulator.renderLocation=Be(c),this._shiftManipulator.modelTransform=o}_updateManipulatorVisibility(){const{interactive:t,targetGeometry:e}=this.analysisViewData,{measureType:i}=this.analysis,s=t&&e!=null&&i==="cut-fill";this._shiftManipulator.available=s}_updateValue(t,e){const i=Je(t,this.view.spatialReference);if(i==null)return;const s=this.analysis.inputUnits.elevation??"meters",r=Ve(i.value,i.unit,s),l=a=>{this.analysis.cutFillOptions.targetElevation=a};if(l(r),e&&"recordUndo"in e){const a=e.recordUndo;this.emit("record-undo",{apply:()=>l(r),undo:()=>l(a)})}}_getUpdatedTooltipInfo(){const{effectiveTargetElevation:t}=this.analysisViewData;return t?(this._tooltipInfo.elevation.actual=Je(t,this.view.spatialReference),this._tooltipInfo):this._tooltipInfo}_updateTooltip(){this._shouldShowTooltip&&(this.tooltip.info=this._getUpdatedTooltipInfo())}_showTooltip(){this._updateTooltip()}_hideTooltip(){this.tooltip?.clear()}_updateSketchOptions(){const{analysis:t}=this,{displayUnits:e,inputUnits:i}=t;this.sketchOptions.values.inputUnits=new Ye({verticalLength:i.elevation}),this.sketchOptions.values.displayUnits=new Ye({verticalLength:e.elevation})}};n([u({constructOnly:!0})],k.prototype,"analysis",void 0),n([u({constructOnly:!0})],k.prototype,"view",void 0),n([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),n([u({constructOnly:!0,type:Lt})],k.prototype,"sketchOptions",void 0),n([u()],k.prototype,"_shouldShowTooltip",null),k=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementShiftTool")],k);let R=class extends Z{constructor(t){super(t),this._updatingHandles=new $t,this._operationManager=new Ji,this._onUndoRedo=()=>{this._updateGeometryFromSketchGraphic()}}initialize(){const{analysis:t,analysisViewData:e,view:i}=this;this._graphicsLayer=new Ai({listMode:"hide",internal:!0,elevationInfo:{mode:"on-the-ground"}});const s=Qi(i,{selfEnabled:!0,excludeInternal:!0});this._sketchViewModel=new Zi({layer:this._graphicsLayer,view:i,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polygonSymbol:this._polygonSymbol,snappingOptions:s.options}),this.addHandles([this._sketchViewModel.on(["undo","redo"],this._onUndoRedo),w(()=>({map:i.map,internalGraphicsLayer:this._graphicsLayer,state:this.state}),({map:r,internalGraphicsLayer:l,state:a})=>{switch($s(r,l),a){case"idle":case"reshaping-disabled":this._operationManager.stop(),this._graphicsLayer.removeAll(),this._ensureUpdatedSketchGraphic();break;case"reshaping":Ne(this._startReshape());break;case"awaiting-sketch":this.analysisViewData.interactive=!0}},N),s]),this._shiftTool=new k({analysis:t,view:i,analysisViewData:e}),this.addHandles(this._shiftTool.on("record-undo",r=>{const l=this._sketchViewModel.activeComponent;l?.type==="reshape-3d"&&l.recordUndo(r.apply,r.undo)})),i.tools.add(this._shiftTool),this.addHandles({remove:()=>i.tools.remove(this._shiftTool)})}destroy(){this._operationManager.destroy(),this._sketchViewModel.destroy();const t=this._graphicsLayer;this.view.map.remove(t),t.destroy()}get sketchGraphic(){return this._get("sketchGraphic")}set sketchGraphic(t){t!==this._get("sketchGraphic")&&(this._set("sketchGraphic",t),this._updateGeometryFromSketchGraphic())}get state(){const{geometry:t}=this.analysis,{interactive:e,visible:i}=this.analysisViewData;return i?this._sketchViewModel.createGraphic?this._sketchViewModel.createGraphic===this.sketchGraphic?"sketching":"awaiting-sketch":t?e?"reshaping":"reshaping-disabled":"idle":"idle"}get updating(){return this._sketchViewModel.updating||this._updatingHandles.updating}get _polygonSymbol(){return new Ri({color:[0,0,0,0],outline:{color:[0,0,0,0]}})}place(t){return this._operationManager.start("place",async e=>{const i=this.analysis.clone();this._ensureUpdatedSketchGraphic();const s=this._sketchViewModel.on("create",r=>{switch(r.state){case"start":this._graphicsLayer.removeAll(),this.sketchGraphic=r.graphic;break;case"active":this._updateGeometryFromSketchGraphic();break;case"complete":this._updateGeometryFromSketchGraphic(),e.stop();break;case"cancel":e.stop()}});e.handles.push(s,We(()=>(s.remove(),this._sketchViewModel.cancel(),this._updateGeometryFromSketchGraphic(),this.analysis.valid?Gi(t)||i.equals(this.analysis)?e.reject():void e.resolve({}):(this._clearGeometry(),e.reject())))),await this._updatingHandles.addPromise(this._sketchViewModel.create("polygon"))},t)}_startReshape(){return this._operationManager.start("reshape",async t=>{const e=()=>{const s=this._ensureUpdatedSketchGraphic();return s?(this._graphicsLayer.removeAll(),this._graphicsLayer.add(s),this._updatingHandles.addPromise(this._sketchViewModel.update(s,{tool:"reshape"}))):Promise.resolve()};if(!this._ensureUpdatedSketchGraphic())return;const i=this._sketchViewModel.on("update",s=>{this._updateGeometryFromSketchGraphic(),s.state==="complete"&&(this.state==="reshaping"?Ne(e()):t.resolve())});t.handles.push(i,We(()=>{i.remove(),this._sketchViewModel.cancel(),t.resolve()})),await e()})}_ensureUpdatedSketchGraphic(){const{geometry:t}=this.analysis;return At(t)?(this.sketchGraphic??=new Mi({geometry:t,symbol:this._polygonSymbol}),this.sketchGraphic.geometry=t,this.sketchGraphic):(this.sketchGraphic=null,null)}_clearGeometry(){this.sketchGraphic=null,this.analysis.geometry=null}_updateGeometryFromSketchGraphic(){const t=this.sketchGraphic;this.analysis.geometry=Ps(t)?t.geometry:null}get test(){}};function $s(t,e){e&&(e.removeFromParent(),t?.add(e))}n([u({constructOnly:!0})],R.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],R.prototype,"view",void 0),n([u({constructOnly:!0})],R.prototype,"analysis",void 0),n([u()],R.prototype,"sketchGraphic",null),n([u({nonNullable:!0})],R.prototype,"state",null),n([u()],R.prototype,"updating",null),n([u()],R.prototype,"_polygonSymbol",null),R=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementTool")],R);let x=class extends Oi{constructor(t){super(t),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null}initialize(){const{analysis:t,view:e}=this;this._analysisController=new g({view:e,analysis:t,analysisViewData:this}),this._analysisTool=new R({analysis:t,view:e,analysisViewData:this}),this._analysisVisualization=new P({view:e,analysis:t,analysisViewData:this})}destroy(){this._analysisController=$(this._analysisController),this._analysisVisualization=$(this._analysisVisualization),this._analysisTool.destroy()}get error(){return this._analysisController?.error??null}get result(){return this._analysisController?.result}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get visible(){return super.visible}set visible(t){super.visible=t}get effectiveTargetElevation(){const{cutFillOptions:t,inputUnits:e}=this.analysis,{targetElevation:i}=t,s=e?.elevation??"meters",r=Ce(this.view.spatialReference);if(i!=null&&r!=null)return Ve(i,s,r);const l=this.elevationAlignedGeometry?.extent;return l?.zmin==null||l?.zmax==null?null:(l.zmax+l.zmin)/2}get effectiveDisplayUnits(){const{displayUnits:t}=this.analysis,e=Li(this.view);return{elevation:t.elevation??e,volume:t.volume??e}}get labelAnchors(){const{elevationAlignedGeometry:t,view:e}=this,{renderCoordsHelper:i}=e;if(!t)return{cut:null,fill:null};let s=t.rings[0][0],r=t.rings[0][0];t.rings[0].forEach(o=>{o[2]>s[2]&&(s=o),o[2]<r[2]&&(r=o)});const{spatialReference:l}=t,a=new Ke({x:s[0],y:s[1],z:s[2],spatialReference:l}),c=new Ke({x:r[0],y:r[1],z:r[2],spatialReference:l}),h=y(),p=y();return i.toRenderCoords(a,h),i.toRenderCoords(c,p),{cut:h,fill:p}}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisTool.updating||this._analysisVisualization.updating}place(t){return this._analysisTool.place(t)}get test(){}};n([u()],x.prototype,"error",null),n([u({readOnly:!0})],x.prototype,"type",void 0),n([u({constructOnly:!0,nonNullable:!0})],x.prototype,"analysis",void 0),n([u({readOnly:!0})],x.prototype,"result",null),n([u()],x.prototype,"elevationAlignedGeometry",void 0),n([u({type:Number})],x.prototype,"effectiveTargetElevation",null),n([u()],x.prototype,"targetGeometry",void 0),n([u()],x.prototype,"effectiveDisplayUnits",null),n([u()],x.prototype,"labelAnchors",null),n([u()],x.prototype,"updating",null),x=n([M("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],x);const Kr=x,Fs=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:Dt},Symbol.toStringTag,{value:"Module"})),Ts=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:St},Symbol.toStringTag,{value:"Module"})),Rs=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"})),Gs=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"})),Ms=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Le,build:kt},Symbol.toStringTag,{value:"Module"}));export{Kr as default};
