const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/layersCreator-CvQyEN2b.js","assets/index-BrQW8HOS.js","assets/index-lUE0m221.css","assets/loadUtils-Cet2DhCA.js","assets/requestPresets-CKwN6OUr.js","assets/associatedFeatureServiceUtils-CcHZrAuk.js","assets/fetchService-D3LGX0Q3.js","assets/lazyLayerLoader-dABU729z.js","assets/portalLayers-DcPi3MUG.js","assets/geometryServiceUtils-C1ZYwCIg.js"])))=>i.map(i=>d[i]);
import{ch as L,aP as O,_ as n,e as s,g as y,a2 as j,U as S,a4 as w,jv as F,$ as b,ck as d,d2 as T,d3 as N,d4 as k,w1 as B,bE as J,Y as Z,fg as D,aa as V,iG as I,h4 as G,mZ as M,jN as W,w2 as C,b2 as z,j4 as q,ix as Q,ts as X,nx as Y,w3 as H,w4 as K,o7 as ee,aQ as te,B as ie,w5 as re,hb as ne,e2 as oe,O as ae,cn as h,w6 as se,cm as $,cw as le,tL as pe}from"./index-BrQW8HOS.js";import{f as ue}from"./Bookmark-CsXabddG.js";import{b as x}from"./View2D-CXXq0vs5.js";import{s as g}from"./utils-D_VO_1nP.js";var v;let c=v=class extends L{constructor(e){super(e),this.activeRange=null,this.currentRangeExtent=null,this.fullRangeExtent=null}clone(){return new v(O({activeRange:this.activeRange,currentRangeExtent:this.currentRangeExtent,fullRangeExtent:this.fullRangeExtent}))}};n([s({type:String,nonNullable:!0,json:{read:{source:"activeRangeName"},write:{target:"activeRangeName",isRequired:!0}}})],c.prototype,"activeRange",void 0),n([s({type:[Number],json:{write:!0}})],c.prototype,"currentRangeExtent",void 0),n([s({type:[Number],json:{write:!0}})],c.prototype,"fullRangeExtent",void 0),c=v=n([y("esri.webdoc.RangeInfo")],c);const P=c;function he(e,t){return t.resourceInfo?E(t,t.resourceInfo,{origin:e.origin}):t.portalItem?.id?ce(e,t,t.portalItem):Promise.resolve()}function E(e,t,i){const r={context:{...i,layerContainerType:"operational-layers"}};return e.portalItem&&(r.context.portal=e.portalItem.portal||j.getDefault()),S(async()=>{const{populateOperationalLayers:o}=await import("./layersCreator-CvQyEN2b.js");return{populateOperationalLayers:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(({populateOperationalLayers:o})=>{const a=[],p=t.operationalLayers;p?.length&&a.push(o(e.layers,p,r));const f={...r,context:{...r.context,layerContainerType:"tables"},defaultLayerType:"ArcGISFeatureLayer"},R=t.tables;return R?.length&&a.push(o(e.tables,R,f)),Promise.allSettled(a).then(()=>{})})}async function ce(e,t,i){if(await i.load().catch(p=>{throw new w(`${e.name}:load-portal-item`,"Failed to load portal item",{error:p})}),i.type!==e.itemType)throw new w(`${e.name}:invalid-portal-item`,`Invalid portal item type '${i.type}', expected '${e.itemType}'`,{type:i.type});const r=await i.fetchData();t.resourceInfo=r;const o=F(i,e.origin);await me(e,t,r,o),t.resourceReferences={portalItem:i,paths:o.readResourcePaths};const a=await ge(t.initialViewProperties,i,b.getLogger(t));if(a){const p=t.initialViewProperties?.clone()??e.createInitialViewProperties();p.viewpoint=a,t.initialViewProperties=p}}function me(e,t,i,r){const o=de(e,i);return t.read(o,r),E(t,o,r)}function de(e,t){const i=e.parseVersion(t.version||"",e.name);return e.currentVersion.validate(i),t.version=`${i.major}.${i.minor}`,t}async function ge(e,t,i){if(e?.viewpoint?.targetGeometry)return null;const o=await ye(e,t,i);return o?new d({targetGeometry:o}):null}async function ye(e,t,i){const r=e?.spatialReference,o=t?.extent;if(!r||!o)return null;if(r.isWGS84)return o.clone();if(r.isWebMercator)return T(o);const{getGeometryServiceURL:a}=await S(()=>import("./geometryServiceUtils-C1ZYwCIg.js"),__vite__mapDeps([9,1,2]));try{const p=await a(t),f=new N({geometries:[o],outSpatialReference:r});return(await k(p,f))[0]}catch(p){i.error("Error projecting item's extent:",p)}return null}var A;let m=A=class extends L{constructor(e){super(e),this.editing=null,this.offline=null,this.viewing=null}clone(){return new A(O({editing:this.editing,offline:this.offline,viewing:this.viewing}))}};n([s({json:{write:!0}})],m.prototype,"editing",void 0),n([s({json:{write:!0}})],m.prototype,"offline",void 0),n([s({type:B,json:{write:!0}})],m.prototype,"viewing",void 0),m=A=n([y("esri.webmap.ApplicationProperties")],m);const fe=m;let u=class extends J(Z){constructor(e){super(e),this.background=null,this.rangeInfo=null,this.spatialReference=null,this.timeExtent=null,this.timeZone=D,this.viewpoint=null}};n([s({type:x})],u.prototype,"background",void 0),n([s({type:P})],u.prototype,"rangeInfo",void 0),n([s({type:V})],u.prototype,"spatialReference",void 0),n([s({type:I})],u.prototype,"timeExtent",void 0),n([s({nonNullable:!0})],u.prototype,"timeZone",void 0),n([s({type:d})],u.prototype,"viewpoint",void 0),u=n([y("esri.webmap.InitialViewProperties")],u);const _=u,U=ae.ofType(ue),we=new Map([["image/jpeg","jpeg"],["image/jpg","jpg"],["image/png","png"],["image/gif","gif"]]),be="ArcGIS Pro",ve=Q.JSAPI;let l=class extends G(M(W(C))){constructor(e){super(e),this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1,this._thumbnailFilename=null,this._updateFromPromise=null,this.resourceReferences={portalItem:null,paths:[]},this.applicationProperties=null,this.bookmarks=new U,this.floorInfo=null,this.initialViewProperties=new _,this.portalItem=null,this.sourceVersion=null,this.widgets=null,this._debouncedSaveOperations=z(async(t,i,r)=>{const{save:o,saveAs:a}=await S(()=>import("./index-BrQW8HOS.js").then(p=>p.MX),__vite__mapDeps([1,2]));switch(t){case 0:return o(this.context,this,i);case 1:return a(this.context,this,r,i)}}),this.authoringApp=this.authoringAppVersion=null,this._isAuthoringAppSetByUser=this._isAuthoringAppVersionSetByUser=!1}destroy(){this.portalItem=q(this.portalItem)}initialize(){if(this.when().catch(e=>{b.getLogger(this).error("#load()","Failed to load web map",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e)}}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp=ve}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=X}readInitialViewProperties(e,t){const i=new _;t.background&&(i.background=x.fromJSON(t.background));const r=t.initialState?.timeExtent;r&&(i.timeExtent=I.fromArray(r));const o=t.initialState?.viewpoint;return o&&(o.rotation&&g.parse(t.version||"","webmap").lessThan(2,20)&&t.authoringApp===be&&(o.rotation*=-1),i.viewpoint=d.fromJSON(o)),t.mapRangeInfo&&(i.rangeInfo=P.fromJSON(t.mapRangeInfo)),t.spatialReference&&(i.spatialReference=V.fromJSON(t.spatialReference)),t.timeZone&&(i.timeZone=t.timeZone),i}writeInitialViewProperties(e,t,i,r){if(!e)return;e.background?.color&&(t.background=e.background.write({},r));const{timeExtent:o,viewpoint:a}=e;if(a||o){const p={};a&&(p.viewpoint=a.write({},r)),o&&(p.timeExtent=o.toArray()),t.initialState=p}e.rangeInfo&&(t.mapRangeInfo=e.rangeInfo.toJSON(r)),e.spatialReference&&(t.spatialReference=e.spatialReference.write({},r)),t.timeZone=e.timeZone}writeLayers(e,t,i,r){t[i]=this._writeLayers(e,r,"operational-layers")}get loaded(){return super.loaded}readSourceVersion(e,t){const[i,r]=t.version.split(".");return new g(parseInt(i,10),parseInt(r,10))}writeSourceVersion(e,t,i){t[i]=`${this.context.currentVersion.major}.${this.context.currentVersion.minor}`}writeTables(e,t,i,r){const o=this._writeLayers(e,r,"tables");o.length&&(t[i]=o)}get thumbnailUrl(){return this.portalItem?.thumbnailUrl||null}set thumbnailUrl(e){e?(this._override("thumbnailUrl",e),this._thumbnailFilename=this._generateCustomThumbnailFilename(e)):this._clearThumbnailOverride()}get updatingFromView(){return!!this._updateFromPromise}load(e){return this.addResolvingPromise(he(this.context,this)),Promise.resolve(this)}loadAll(){return Y(this,e=>{e(this.ground,this.basemap,this.layers,this.tables)})}read(e,t){t={...t,origin:this.context.origin};const i=this._getAuthoringPropsState();H(this,e,r=>super.read(e,r),t),this._restoreAuthoringPropsFromState(i)}write(e,t){if(this.loadStatus!=="loaded"){const i=new w("webmap:not-loaded","Web map must be loaded before it can be serialized");throw b.getLogger(this).error("#toJSON()","Web map must be loaded before it can be serialized",this.loadError||this.loadStatus),i}return this._removeDanglingLayerRefs(),t={...t,origin:this.context.origin,restrictedWebMapWriting:!0,webmap:this},super.write(e,t)}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}async updateFrom(e,t){const i=this._updateFromInternal(e,t);this._updateFromPromise=i,await i,i===this._updateFromPromise&&(this._updateFromPromise=null)}getLayerJSONFromResourceInfo(e){const t=this.resourceInfo;return this._collectAllLayersJSON([...t?.baseMap?.baseMapLayers||[],...t?.operationalLayers||[],...this.basemap?.resourceInfo?.data?.baseMapLayers||[]]).find(i=>i.id===e.id)}async updateItemThumbnail(){this.thumbnailUrl&&this._isOverridden("thumbnailUrl")&&(await this.portalItem?.updateThumbnail({thumbnail:this.thumbnailUrl,filename:this._thumbnailFilename}),this._clearThumbnailOverride())}getThumbnailState(){let e=this.thumbnailUrl;return e&&(e=this._isOverridden("thumbnailUrl")?e:K(e,"w","8192")),{thumbnailUrl:e,filename:this._thumbnailFilename}}restoreThumbnailFromState(e){this.thumbnailUrl=e.thumbnailUrl,this._thumbnailFilename=e.filename}_collectAllLayersJSON(e){return e.reduce((t,i)=>(t.push(i),i.layerType==="GroupLayer"&&(t=t.concat(this._collectAllLayersJSON(i.layers||[]))),t),[])}_writeLayers(e,t,i){return t={...t,layerContainerType:i},e.map(r=>ee(r,i==="tables"?null:this.getLayerJSONFromResourceInfo(r),t)).filter(te).toArray()}_validateJSON(e){const t=g.parse(e.version||"","webmap");return this.context.currentVersion.validate(t),e.version=`${t.major}.${t.minor}`,e}_removeDanglingLayerRefs(){const e=this.applicationProperties,t=e?.viewing?.search,i=a=>this.allLayers.some(p=>p.id===a);if(t?.layers&&(t.layers=t.layers.filter(a=>i(a.id))),t?.tables&&(t.tables=t.tables.filter(a=>this.tables.some(p=>p.id===a.id))),e){const a=e.editing?.locationTracking;a?.info&&!i(a.info.layerId)&&(e.editing=null)}const r="presentation"in this?this.presentation:null,o=r?.slides;o&&o.forEach(a=>{a.visibleLayers&&(a.visibleLayers=a.visibleLayers.filter(p=>i(p.id)))})}async _updateFromInternal(e,t){if(t??={},await ie(()=>e.ready),this._updateInitialViewProperties(e,t),e.map===this)for(const i of e.allLayerViews)"visible"in i&&"visible"in i.layer&&i._isOverridden("visible")&&(i.layer.visible=i.visible),"featureEffect"in i&&"featureEffect"in i.layer&&i._isOverridden("featureEffect")&&(i.layer.featureEffect=i.featureEffect);await this._updateThumbnailUrl(e,t)}_updateInitialViewProperties(e,t){if(t.backgroundExcluded||(this.initialViewProperties.background=e.background?.clone()),this.initialViewProperties.spatialReference=e.spatialReference?.clone(),this.initialViewProperties.timeZone=e.timeZone,t.viewpointExcluded||(this.initialViewProperties.viewpoint=new d({rotation:e.rotation,scale:t.scalePreserved?e.scale:null,targetGeometry:this._getViewExtent(e)})),!t.widgetsExcluded)for(const i of e.persistableViewModels)i.updateWebDocument(this)}_getViewExtent(e){const t=e.center.clone().normalize(),i=e.extent.clone(),r=i.width/2;return i.xmin=t.x-r,i.xmax=t.x+r,i}async _updateThumbnailUrl(e,t){if(t.thumbnailExcluded)return;const i=re(e,t.thumbnailSize),r=await e.takeScreenshot({format:"png",width:i.width,height:i.height});this._setAutoGeneratedThumbnail(r.dataUrl)}_setAutoGeneratedThumbnail(e){this.thumbnailUrl=e,this._thumbnailFilename=null}_clearThumbnailOverride(){this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"),this._thumbnailFilename=null}_generateCustomThumbnailFilename(e){if(ne(e)){const t=oe(e),i=t?.mediaType,r=i&&we.get(i.toLowerCase())||null,o=`thumbnail${Date.now()}`;return r?`${o}.${r}`:o}return null}_getAuthoringPropsState(){return{authoringApp:this.authoringApp,authoringAppVersion:this.authoringAppVersion,isAuthoringAppSetByUser:this._isAuthoringAppSetByUser,isAuthoringAppVersionSetByUser:this._isAuthoringAppVersionSetByUser}}_restoreAuthoringPropsFromState(e){e.isAuthoringAppSetByUser?this.authoringApp=e.authoringApp:this._isAuthoringAppSetByUser=!1,e.isAuthoringAppVersionSetByUser?this.authoringAppVersion=e.authoringAppVersion:this._isAuthoringAppVersionSetByUser=!1}};n([s()],l.prototype,"_updateFromPromise",void 0),n([s({type:fe,json:{write:!0}})],l.prototype,"applicationProperties",void 0),n([s({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],l.prototype,"authoringApp",null),n([h("authoringApp")],l.prototype,"writeAuthoringApp",null),n([s({type:String,json:{write:{allowNull:!0,ignoreOrigin:!0}}})],l.prototype,"authoringAppVersion",null),n([h("authoringAppVersion")],l.prototype,"writeAuthoringAppVersion",null),n([s({type:U,json:{write:{overridePolicy:e=>({enabled:!!(e&&e.length>0),ignoreOrigin:!0})}}})],l.prototype,"bookmarks",void 0),n([s({type:se,json:{name:"mapFloorInfo",write:!0}})],l.prototype,"floorInfo",void 0),n([s({type:_,nonNullable:!0,json:{read:{source:["background","initialState.timeExtent","initialState.viewpoint","mapRangeInfo","spatialReference","timeZone"]},write:{ignoreOrigin:!0,target:{background:{type:x},"initialState.timeExtent":{type:I},"initialState.viewpoint":{type:d},mapRangeInfo:{type:P},spatialReference:{type:V},"timeZone:":{type:String}}}}})],l.prototype,"initialViewProperties",void 0),n([$("initialViewProperties")],l.prototype,"readInitialViewProperties",null),n([h("initialViewProperties")],l.prototype,"writeInitialViewProperties",null),n([s({json:{read:!1,write:{target:"operationalLayers",ignoreOrigin:!0}}})],l.prototype,"layers",void 0),n([h("layers")],l.prototype,"writeLayers",null),n([s({type:le})],l.prototype,"portalItem",void 0),n([s()],l.prototype,"resourceInfo",void 0),n([s({readOnly:!0,type:g,json:{read:{source:"version"},write:{allowNull:!0,ignoreOrigin:!0,target:"version",isRequired:!0}}})],l.prototype,"sourceVersion",void 0),n([$("sourceVersion")],l.prototype,"readSourceVersion",null),n([h("sourceVersion")],l.prototype,"writeSourceVersion",null),n([s({json:{read:!1,write:{ignoreOrigin:!0}}})],l.prototype,"tables",void 0),n([h("tables")],l.prototype,"writeTables",null),n([s()],l.prototype,"thumbnailUrl",null),n([s()],l.prototype,"updatingFromView",null),n([s({type:pe,json:{write:!0}})],l.prototype,"widgets",void 0),l=n([y("esri.WebDocument2D")],l);const Ie=l;export{Ie as $,_ as f};
