const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/arcade-Ahk07dfV.js","assets/index-Bp3GeDhQ.js","assets/index-ni9qn0ie.css","assets/arcadeEnvironment-BCJuKHfj.js","assets/ImmutableArray-BPVd6ESQ.js","assets/arcade-99AQLfDz.js","assets/languageUtils-BHSX9xR7.js","assets/shared-Uanpa3Wf.js","assets/number-DFdmL_Vd.js","assets/Dictionary-Tx0PYkF0.js","assets/deepClone-BtQ2V1Dq.js","assets/Feature-Cwf3YKm5.js","assets/aiServices-iADzm-WB.js","assets/WhereClause-C_lDJ50U.js","assets/streamLayerUtils-DFlbJ4P1.js","assets/measures-DWa78IKg.js","assets/splitCurveAtPoint-7DF0p4EV.js","assets/unitConversion-DlAHUMuW.js","assets/hash-CcEbRgUF.js"])))=>i.map(i=>d[i]);
import{_ as x,d$ as L,e0 as S,a4 as O,df as P,cj as F,e1 as U}from"./index-Bp3GeDhQ.js";import{N as j}from"./shared-Uanpa3Wf.js";import{n as R}from"./isImageryGraphicOrigin-Ccuhb4eK.js";import{n as V}from"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import{i as C}from"./streamLayerUtils-DFlbJ4P1.js";import{applyTextFormattingHTML as D,htmlEntities as G}from"./featureUtils-C0djycCw.js";const q="esri.widgets.Feature.support.arcadeFeatureUtils",w=()=>O.getLogger(q);function ae(e){return D(G(e))}function Q(e){return"createQuery"in e&&"queryFeatures"in e}async function M({graphic:e,view:r,options:n}){const{isAggregate:t}=e,o=e.layer??e.sourceLayer;if(!t||!o||r?.type!=="2d")return[];const i=await r.whenLayerView(o);if(!Q(i))return[];const a=i.createQuery(),c=e.getObjectId();a.aggregateIds=c!=null?[c]:[];const{features:u}=await i.queryFeatures(a,n);return u}function N({layer:e,aggregatedFeatures:r,interceptor:n}){const{fields:t,objectIdField:o,geometryType:i,spatialReference:a}=e,c="displayField"in e?e.displayField:void 0;return new P({fields:t,objectIdField:o,geometryType:i,spatialReference:a,displayField:c,interceptor:n,...e.type==="feature"?{templates:e.templates,typeIdField:e.typeIdField,types:e.types}:null,source:r})}function Z(e){return e.isAggregate?"popup-feature-reduction":e.declaredClass==="esri.views.3d.layers.VoxelGraphic"?"popup-voxel":R(e.origin)||V(e.origin)?"popup-imagery":"popup"}function $(e){return{scale:e?.scale,timeProperties:{currentStart:e?.timeExtent?.start,currentEnd:e?.timeExtent?.end,startIncluded:!0,endIncluded:!0}}}function z(e){return{$voxel:e}}function H(e){let r=null;if(e.origin.layer.fields?.length>0){r=e.cloneShallow();const n=e.origin.layer.fieldsIndex;r.attributes=Object.fromEntries(Object.entries(r.attributes??{}).filter(([t])=>n.has(t)))}return{$pixel:e,$imageCollectionItem:r}}async function B(e,r,n,t,o,i,a){let c=null;if(i.has("$aggregatedfeatures")){const u=await M({graphic:r,view:n,options:t}),l=r.sourceLayer||r.layer;c=N({layer:l,aggregatedFeatures:u,interceptor:o})}return{vars:{$feature:r,$aggregatedFeatures:c,$view:$(n)},track:a?await E(e,r,n):null,[Symbol.dispose]:()=>c?.[Symbol.dispose]()}}function I(e){if(U(e))return e.getTime();if(typeof e=="number")return e;if(typeof e=="string")return new Date(e).getTime();throw new Error(`Unexpected time value: ${e}`)}async function E(e,r,n){const t=r.sourceLayer||r.layer;if(t==null||!("timeInfo"in t))return null;const o=t.timeInfo?.trackIdField;if(o==null)return null;const i=r.getAttribute(o);if(i==null)return null;let a,c;if(typeof i=="string")a=`"${o.replaceAll('"','""')}" = '${i.replaceAll("'","''")}'`;else{if(typeof i!="number")return w().warn("Expected track id to be a string or number"),null;a=`"${o.replaceAll('"','""')}" = ${i}`}if(t.type==="stream"&&n!=null){const s=await n.whenLayerView(t),d=s.createQuery();d.returnGeometry=!0,d.where=F(d.where,a),c=(await s.queryFeatures(d)).features}else{if(!("queryFeatures"in t))return null;{const s=t.createQuery();s.returnGeometry=!0,s.where=F(s.where,a),c=(await t.queryFeatures(s)).features}}const u=t.fieldsIndex.normalizeFieldName(t.timeInfo.startField)??C,l=t.timeInfo.endField?t.fieldsIndex.normalizeFieldName(t.timeInfo.endField):null,p=c.map(s=>{const d=s.getObjectId();if(d==null)throw new Error("Cannot identify observation");const v=e.ArcadeFeature.createFromGraphic(s,n?.timeZone),y=I(s.getAttribute(u));return{id:d,feature:v,startTime:y,endTime:l!=null?I(s.getAttribute(l)):y,stats:{totalDistance:void 0,distance:void 0,speed:void 0,acceleration:void 0}}}).sort((s,d)=>s.startTime-d.startTime),f=r.declaredClass==="esri.TrackGraphic"?p.length-1:p.findIndex(s=>r.getObjectId()===s.id);if(f<0)throw new Error("Couldn't locate feature in observations");return{observations:p,currentObservationIndex:f}}async function J(e,r,n,t,o,i){const a=(r.sourceLayer||r.layer)??void 0;return{vars:{$feature:r,$layer:a!=null&&j(a)?a:a?.type==="scene"&&a.associatedLayer!=null?a.associatedLayer:void 0,$map:n,$datastore:a&&"url"in a?a.url:void 0,$userInput:t,$graph:a?.type==="knowledge-graph-sublayer"?a.parentCompositeLayer?.knowledgeGraph:void 0,$view:$(o)},track:i?await E(e,r,o):null}}async function K(e,{arcade:r,graphic:n,map:t,location:o,view:i,options:a,interceptor:c,arcadeExecutor:u,usesTrack:l}){switch(e){case"popup":return{...await J(r,n,t,o,i,l),[Symbol.dispose](){}};case"popup-feature-reduction":{const p=new Set(u.variablesUsed);return await B(r,n,i,a,c,p,l)}case"popup-voxel":return{vars:z(n),track:null,[Symbol.dispose](){}};case"popup-imagery":return{vars:H(n),track:null,[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${e}`)}}async function _(){const[e,r,{Feature:n}]=await Promise.all([x(()=>import("./arcade-Ahk07dfV.js"),__vite__mapDeps([0,1,2,3,4])),x(()=>import("./arcade-99AQLfDz.js").then(t=>t.H),__vite__mapDeps([5,1,2,3,6,4,7,8,9,10,11,12,13,14,15,16,17,18])),x(()=>import("./Feature-Cwf3YKm5.js").then(t=>t.F),__vite__mapDeps([11,1,2,10,6,4,7,8,9]))]);return{executor:e,syntaxUtils:r,ArcadeFeature:n}}async function T(e,r,n){const{executor:{createArcadeProfile:t,createArcadeExecutor:o},syntaxUtils:i}=n,a=Z(r),c=t(a);let u;try{u=await o(e,c)}catch(f){return w().error("arcade-executor-error",{error:f,expression:e}),null}const l=new Set;u.variablesUsed.includes("$view")&&(i.scriptUsesViewProperties(u.syntaxTree,["scale"])&&l.add("view-scale"),i.scriptUsesViewProperties(u.syntaxTree,["timeProperties"])&&l.add("view-time-extent"));const p=i.scriptUsesTrack(u.syntaxTree);return{dependencies:l,async evaluate({graphic:f,interceptor:s,location:d,map:v,options:y,spatialReference:A,view:b}){const m={stack:[],error:void 0,hasError:!1};try{const g=L(m,await K(a,{arcade:n,graphic:f,map:v,location:d,view:b,options:y,interceptor:s,arcadeExecutor:u,usesTrack:p}),!1),k={abortSignal:y?.signal??void 0,interceptor:s??void 0,rawOutput:!0,spatialReference:A??void 0,timeZone:b?.timeZone,track:g.track,console(...h){w().info(...h)}};try{return await u.executeAsync(g.vars,k)}catch(h){return y?.signal?.aborted?void 0:void w().error("arcade-execution-error",{error:h,graphic:f,expression:e})}}catch(g){m.error=g,m.hasError=!0}finally{S(m)}}}}async function ne({expression:e,graphic:r}){return e?T(e,r,await _()):null}async function ie(e,r){if(!e?.length)return{dependencies:new Set,expressions:new Map};const n=await _(),t=new Set,o=new Map;for(const i of e){const a=await T(i.expression,r,n);o.set(`expression/${i.name}`,a),a?.dependencies.forEach(c=>t.add(c))}return{dependencies:t,expressions:o}}export{ne as A,ie as L,ae as y};
