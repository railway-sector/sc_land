import{L as $,O as b,b1 as k,f as A,f5 as E,d as p,fa as j,eX as M,dL as U,f3 as v,i as V,l as D}from"./index-BrQW8HOS.js";import{c as I,y as Q,n as B,d as P}from"./featureUtils-B-Ma4Dx6.js";import{i as T}from"./stringUtils-BTK5CX_y.js";import{s as x}from"./NetworkElement-te1zus-P.js";import G from"./QueryAssociationsParameters-7IvPRXrO.js";import{n as O}from"./FeatureViewModel-DUcUeCTn.js";import{d as q}from"./index-C1Nt58Wz.js";import"./featureUtils-D2UmGJHI.js";import"./utils-BJ7fw6dI.js";import"./typeUtils-Dszw1S4V.js";import"./throttle-CTJgdIni.js";import"./AttachmentsViewModel-BorO2JWS.js";import"./AttachmentInfo-Be-qgHMP.js";import"./executeQueryJSON-CQzDonsh.js";import"./query-D5mFMRFz.js";import"./pbfQueryUtils-PegbNvJC.js";import"./pbf-bO1aG1II.js";import"./arcadeFeatureUtils-D1_gLIP2.js";import"./shared-DBXlHENV.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./FeatureRelationshipViewModel-BmyR0OK6.js";import"./featureFormUtils-NJdl1KAp.js";import"./dateUtils-DCwqoPkL.js";import"./substitute-D-eLZ17Q.js";import"./FeatureUtilityNetworkAssociationsViewModel-bOY5P1li.js";import"./getFeatureTitle-Mrr3SXNI.js";const Z=V`.list-container{min-height:var(--calcite-spacing-xxxl)}.loading-container{display:flex;justify-content:center;padding:var(--calcite-spacing-md) 0;width:100%}.sticky-loading-container{display:flex;position:sticky;bottom:var(--calcite-spacing-sm);align-items:center;justify-content:center;z-index:2;margin:0;padding:0;height:var(--calcite-spacing-xxxl);pointer-events:none;height:500px}`,L=100,S={assetGroup:"assetgroup",assetType:"assettype"},N="{00000000-0000-0000-0000-000000000000}",F=class F extends ${constructor(){super(...arguments),this._addFlowItem=t=>{t&&this.flowItems?.push(t)},this._attachmentAssociations=new b,this._attachmentFeatureCount=0,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._connectivityAssociations=new b,this._connectivityFeatureCount=0,this._containerAssociations=new b,this._containerFeatureCount=0,this._contentAssociations=new b,this._contentFeatureCount=0,this._networkSourceIdsInUse=new Set,this._query=async t=>{if(!t)return;await this._loadUtiltyNetworks();const{_queryAbortController:e}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this._featureCount&&await this._queryAssociatedFeatures(t,{signal:e?.signal})},this._queryController=async t=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await k(this._query(t)),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await k(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=q(this._queryController,L),this._queryFeatureCountDebounced=q(this._queryFeatureCountController,L),this._structureAssociations=new b,this._structureFeatureCount=0,this._queryAssociationType=async()=>{this._activeAssociationType&&this._queryDebounced(this._activeAssociationType)},this._associationFeatures=I(),this._associationViewModels=I(),this._featureCount=0,this._loaded=!1,this._queryAbortController=null,this._queryFeatureCountAbortController=null,this._queryPageAbortController=null,this.associationTypes=null,this.autoDestroyDisabled=!1,this.flowType="feature-utility-network-associations",this.headingLevel=2,this.source="popup"}get _globalId(){return(this._globalIdField&&this.graphic?.attributes?.[this._globalIdField])??null}get _globalIdField(){return this.layer?.globalIdField}get _objectId(){return(this._objectIdField&&this.graphic?.attributes?.[this._objectIdField])??null}get _objectIdField(){return this.layer?.objectIdField}get _supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get _utilityNetwork(){const{layer:t,map:e}=this;if(!t?.loaded||!e)return null;const s=this._isSubtypeSublayer(t)?t.parent:t;return Q(e,s)}get _canLoad(){return!!this.map}get _canQuery(){return!!this.layer?.capabilities?.query?.supportsPagination}get _state(){const{_canLoad:t,_canQuery:e,_featureCount:s,_loaded:a,_queryAbortController:i,_queryFeatureCountAbortController:o,_queryPageAbortController:c,associationTypes:l}=this;return o||t&&!a?"loading":i||c?"querying":!this._globalId||!l||!e||!s?"disabled":"ready"}get heading(){return this._heading}set heading(t){this._heading=t}async destroy(){await this.manager.destroy()}loaded(){this.manager.onLifecycle(()=>[A(()=>[this.graphic,this.layer,this.map,this.associationTypes,this._canQuery,this._objectId,this._globalId],()=>{this._queryFeatureCountDebounced(),this._queryAssociationType()},{initial:!0}),A(()=>this._activeAssociationType,t=>{this._queryDebounced(t)}),A(()=>this._associationFeatures.values(),()=>{this._setUpUtilityNetworkAssociationsViewModels()})]),this.manager.onDestroy(()=>{this._cancelQuery(),this._cancelQueryFeatureCount()})}_addAssociationTypeFlowItem(){this._addFlowItem(E(p`<arcgis-feature-utility-network-association-list .associationViewModels=${this._associationViewModels} .flowItems=${this.flowItems} .flowType=${this.flowType} .messages=${this.messages} .map=${this.map} .parentFeatureViewModel=${this.parentFeatureViewModel} .state=${this._state} .spatialReference=${this.spatialReference} .timeZone=${this.timeZone} .view=${this.view}></arcgis-feature-utility-network-association-list>`))}_clearAssociations(){this._attachmentAssociations.removeAll(),this._connectivityAssociations.removeAll(),this._containerAssociations.removeAll(),this._contentAssociations.removeAll(),this._structureAssociations.removeAll()}_clearFeatures(){this._associationFeatures.forEach(t=>t.removeAll()),this._associationFeatures.clear()}_compareByFeatureTitle(t,e){return t.title.localeCompare(e.title,void 0,{numeric:!0})}async _countAssociatedFeatureCount(t,e,s,a,i){const o=this._getFeatureQueryWhereClause(t,e,s,a);return await t.queryFeatureCount({where:o,outFields:["*"],returnGeometry:!1},{signal:i?.signal})}async _countAssociatedFeatures(t,e,s,a,i){if(!e.length)return 0;const o=await this._findLayersBySourceId(t);await this._loadLayers(o);const c=o.map(l=>this._countAssociatedFeatureCount(l,e,s,a,i));return(await Promise.all(c)).reduce((l,r)=>l+r,0)}async _createAssociationFeatureObjects(t,e,s,a,i){if(!t.length)return[];const o=new Map,c=Array.from(e.entries()).map(async([r,d])=>{const u=await this._findLayersBySourceId(r);await this._loadLayers(u);const h=u.map(m=>this._queryLayer(m,d,s,a,i));(await Promise.all(h)).forEach(m=>{m.forEach(n=>{if(this.source==="popup"?n.sourceLayer&&n.getEffectivePopupTemplate():n.sourceLayer){const _=n.layer.globalIdField??"",y=n.attributes[_],w=o.get(y)??[];w.push(n),o.set(y,w)}})})});await Promise.all(c);const l=[];return await Promise.all(t.toArray().map(async r=>{const{fromNetworkElement:d,toNetworkElement:u}=r,h=d.globalId===this._globalId?u:d,m=o.get(h.globalId)??[];await Promise.all(m.map(async n=>{const _=this._utilityNetwork?.getTerminalById(h?.terminalId)?.name,y=await n.sourceLayer.getFeatureTitle(n)||this._getFeatureTitle(n);l.push({title:y,feature:n,association:r,terminalName:_})}))})),l}_destroyAssociatedFeatureViewModels(){this._associationViewModels.forEach(t=>t.destroyAll())}_equals(t,e){if(t.globalId===N&&e.globalId===N){let s=function(d,u){return d.networkSourceId===u.networkSourceId&&d.globalId===u.globalId&&d.terminalId===u.terminalId&&d.firstUnit===u.firstUnit&&d.numUnits===u.numUnits};const a=t.fromNetworkElement,i=t.toNetworkElement,o=e.fromNetworkElement,c=e.toNetworkElement,l=s(a,o),r=s(i,c);return l&&r&&t.associationType===e.associationType}return t.globalId!=null&&e.globalId!=null&&t.globalId===e.globalId}async _findLayersBySourceId(t){const{_utilityNetwork:e,map:s}=this;e?.loaded||await e?.load();const a=e.getLayerIdBySourceId(t),i=s.allLayers.filter(c=>!!e?.isUtilityLayer(c)&&c.layerId===a),o=s.allTables.filter(c=>!!e?.isUtilityLayer(c)&&c.layerId===a);return i.concat(o).toArray()}_getAssociationsByType(t){switch(t){case"attachment":return this._attachmentAssociations;case"structure":return this._structureAssociations;case"connectivity":return this._connectivityAssociations;case"container":return this._containerAssociations;case"content":return this._contentAssociations}}_getAssociationTypeTitle(t){const{messages:e}=this;if(t.title)return t.title;switch(t.type){case"attachment":return e?.associationsAttachments??this.messages?.noTitle??"";case"connectivity":return e?.associationsConnectivity??this.messages?.noTitle??"";case"structure":return e?.associationsStructure??this.messages?.noTitle??"";case"content":return e?.associationsContents??this.messages?.noTitle??"";case"container":return e?.associationsContainer??this.messages?.noTitle??""}}_getFeatureCountForAssociationType(t){switch(t){case"attachment":return this._attachmentFeatureCount;case"structure":return this._structureFeatureCount;case"content":return this._contentFeatureCount;case"container":return this._containerFeatureCount;case"connectivity":return this._connectivityFeatureCount}}_getFeatureQueryWhereClause(t,e,s,a){const i=t.globalIdField,o=t.fieldsIndex.get(S.assetGroup),c=t.fieldsIndex.get(S.assetType),l=s!=null,r=a!=null,d=i?j(i,e):null,u=l?`(${o?.name} = ${s})`:null,h=l&&r?`(${c?.name} = ${a})`:null;return[d,u,h].filter(Boolean).join(" AND ")}_getFeatureTitle(t){const e=t.attributes,s=t.sourceLayer;if(!e||!s)return"";const a="displayField"in s?s.displayField:null,i=a!=null?e[a.toString()]:null,o=i!=null?i.toString():null,c=t.getObjectId()?.toString();return o||c||""}_isSubtypeGroupLayer(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type==="subtype-group"&&"sublayers"in t}_isSubtypeSublayer(t){return t?.type==="subtype-sublayer"}async _loadUtiltyNetworks(){const t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map(s=>s.load())??[]);const e=this._utilityNetwork;if(e){const s=a=>{if("layerId"in a&&e.isUtilityLayer(a)){const i=a.layerId!=null?e.getSourceIdByLayerId(a.layerId):null;i!=null&&this._networkSourceIdsInUse.add(i)}};this._networkSourceIdsInUse=new Set,t.allLayers.forEach(s),t.allTables.forEach(s)}}async _loadLayers(t){const e=t.filter(s=>!s.loaded).map(s=>s.load());e.length&&await Promise.allSettled(e)}_matchesGlobalFeature(t,e){return this._equals(t.association,e.association)}async _queryAssociatedFeatures(t,e){const{layer:s,_globalId:a,associationTypes:i,_utilityNetwork:o,_canQuery:c,_associationFeatures:l}=this;if(await Promise.allSettled([s?.load(),o?.load()]),!c||!s||!i||!o)return;const r=this._getAssociationsByType(t.type),{associatedAssetGroup:d,associatedAssetType:u}=t,h=new Map;r.forEach(n=>{const{fromNetworkElement:_,toNetworkElement:y}=n,{networkSourceId:w,elementGlobalId:f}=_.globalId===a?{networkSourceId:y.networkSourceId,elementGlobalId:y.globalId}:{networkSourceId:_.networkSourceId,elementGlobalId:_.globalId},g=h.get(w)||[];g.push(f),h.set(w,g)});const m=await this._createAssociationFeatureObjects(r,h,d,u,e);this._parseFeatureObjects(m,l)}async _queryAssociations(t){const{layer:e,_globalId:s,associationTypes:a,_utilityNetwork:i,_canQuery:o}=this;if(await Promise.allSettled([e?.load(),i?.load()]),this._clearAssociations(),!o||!e||!a||!i||!s)return;const c=this._isSubtypeSublayer(e)?e.parent:e,l=new x({globalId:s,networkSourceId:i.getSourceIdByLayerId(c.layerId)}),r=new Set;a.forEach(n=>{switch(n.type){case"attachment":case"structure":r.add("attachment");break;case"container":case"content":r.add("containment");break;case"connectivity":r.add("connectivity"),r.add("junction-junction-connectivity"),r.add("junction-edge-from-connectivity"),r.add("junction-edge-midspan-connectivity"),r.add("junction-edge-to-connectivity");break}});const d=await i?.queryAssociations(new G({elements:[l],types:Array.from(r)}),{signal:t?.signal}),u=new Map,h=new Map;a.forEach(n=>{h.set(n.type,n),u.set(n.type,[])}),d.forEach(n=>{const{toNetworkElement:_,fromNetworkElement:y}=n;switch(n.associationType){case"attachment":if(y?.globalId===s){if(this._shouldDiscardNetworkElement(_,"attachment",h))break;u.get("attachment")?.push(_.globalId),this._attachmentAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(y,"structure",h))break;u.get("structure")?.push(y.globalId),this._structureAssociations.add(n)}break;case"connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":case"junction-junction-connectivity":if(y?.globalId===s){if(this._shouldDiscardNetworkElement(_,"connectivity",h))break;u.get("connectivity")?.push(_.globalId)}else{if(this._shouldDiscardNetworkElement(y,"connectivity",h))break;u.get("connectivity")?.push(y.globalId)}this._connectivityAssociations.add(n);break;case"containment":if(y?.globalId===s){if(this._shouldDiscardNetworkElement(_,"content",h))break;u.get("content")?.push(_.globalId),this._contentAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(y,"container",h))break;u.get("container")?.push(y.globalId),this._containerAssociations.add(n)}break}});const m=a.map(async n=>{const{associatedNetworkSourceId:_,associatedAssetGroup:y,associatedAssetType:w}=n,f=u.get(n.type),g=y!=null?await this._countAssociatedFeatures(_,f,y,w,t):f.length;switch(n.type){case"attachment":this._attachmentFeatureCount=g;break;case"connectivity":this._connectivityFeatureCount=g;break;case"container":this._containerFeatureCount=g;break;case"content":this._contentFeatureCount=g;break;case"structure":this._structureFeatureCount=g;break}});await Promise.allSettled(m)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:t,_canQuery:e}=this;if(!e){this._featureCount=0;return}await this._queryAssociations(t),this._featureCount=this._attachmentFeatureCount+this._connectivityFeatureCount+this._containerFeatureCount+this._contentFeatureCount+this._structureFeatureCount}async _queryLayer(t,e,s,a,i){const o=this._getFeatureQueryWhereClause(t,e,s,a),c=new M({where:o,outFields:["*"],cacheHint:this._supportsCacheHint}),l=U.fromJSON(await B(t,c,i));return l.features.forEach(r=>{const d=this._isSubtypeGroupLayer(t);r.layer=d?t.findSublayerForFeature(r):t,r.sourceLayer=d?t.findSublayerForFeature(r):t}),l.features}_parseFeatureObjects(t,e){const s=I();t.forEach(a=>{const i=(a?.feature).sourceLayer;P(s,i,()=>new b).add(a)});for(const[a,i]of s)this._sortFeatureObjectsByTitle(i),e.set(a,i)}_selectAssociationType(t){const{flowItems:e}=this;e&&(this._activeAssociationType=t,this._setUpUtilityNetworkAssociationsViewModels(),this._addAssociationTypeFlowItem())}_setUpUtilityNetworkAssociationsViewModels(){this._associationViewModels.forEach((i,o)=>{const c=this._associationFeatures.get(o);c?i.forEach(l=>{c.find(r=>this._matchesGlobalFeature(l,r))||(i.remove(l),i.length||this._associationViewModels.delete(o))}):(i.removeAll(),this._associationViewModels.delete(o))});const{map:t,view:e,spatialReference:s,timeZone:a}=this;this._associationFeatures.forEach((i,o)=>{const c=this._associationViewModels.get(o)||new b;i?.filter(Boolean).forEach((l,r)=>{if(!c.some(d=>this._matchesGlobalFeature(d,l))){const{association:d,feature:u,terminalName:h,title:m}=l;c.add({title:m,association:d,featureViewModel:new O({abilities:{utilityNetworkAssociationsContent:!1},map:t,view:e,spatialReference:s,timeZone:a,graphic:u}),terminalName:h},r)}}),this._associationViewModels.set(o,c)})}_shouldDiscardNetworkElement(t,e,s){if(!t)return!1;const{networkSourceId:a}=t,i=s.get(e)?.associatedNetworkSourceId,o=this._networkSourceIdsInUse.has(a);return i!=null&&i!==a||!o}_sortFeatureObjectsByTitle(t){t.sort(this._compareByFeatureTitle)}render(){const{_state:t}=this;return p`<div><arcgis-feature-element-info .heading=${this.heading} .headingLevel=${this.headingLevel} .description=${this.description}></arcgis-feature-element-info>${t==="loading"?this._renderLoading():t==="disabled"?this._renderAssociationNotFound():this._renderContent()}</div>`}_renderAssociationNotFound(){return p`<calcite-notice icon=information kind=info open scale=s width=full><div slot=message>${this.messages?.noAssociations}</div></calcite-notice>`}_renderAssociationTypeList(t){return this._getFeatureCountForAssociationType(t.type)>0?this._renderAssociationTypeListItem(t):null}_renderAssociationTypeListItem(t){const e=this._getAssociationTypeTitle(t);return v(`association-type-${t.type}`,p`<calcite-list-item .description=${T(t.description)} .label=${T(e)} .value=${t.type} @calciteListItemSelect=${()=>this._selectAssociationType(t)}><calcite-icon flip-rtl icon=chevron-right scale=s slot=content-end></calcite-icon></calcite-list-item>`)}_renderContent(){const{_state:t,associationTypes:e,messages:s}=this,a=s?.associationsList??s?.noTitle??"";return v("list-container",p`<div class="list-container">${t==="ready"?p`<div><calcite-list display-mode=flat .label=${a}>${e.map(i=>this._renderAssociationTypeList(i))}</calcite-list></div>`:null}${this._renderStickyLoading()}</div>`)}_renderLoading(){return p`<div class="loading-container">${this._renderLoadingIcon()}${this._renderStickyLoading()}</div>`}_renderLoadingIcon(){return p`<calcite-loader inline label></calcite-loader>`}_renderStickyLoading(){return this._state==="querying"?p`<div class="sticky-loading-container">${this._renderLoadingIcon()}</div>`:null}};F.properties={_activeAssociationType:16,_associationFeatures:16,_associationViewModels:16,_canLoad:16,_canQuery:16,_featureCount:16,_loaded:16,_queryAbortController:16,_queryFeatureCountAbortController:16,_queryPageAbortController:16,_state:16,associationTypes:0,autoDestroyDisabled:5,description:1,flowItems:0,flowType:1,graphic:0,heading:1,headingLevel:9,layer:0,map:0,messages:0,parentFeatureViewModel:0,source:1,spatialReference:0,timeZone:1,view:0},F.styles=Z;let C=F;D("arcgis-feature-utility-network-associations",C);export{C as ArcgisFeatureUtilityNetworkAssociations};
