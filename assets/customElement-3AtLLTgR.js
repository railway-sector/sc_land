import{L as H,f as z,y as G,b as A,d as g,i as K,ov as Q,ow as X,ox as Y,l as Z}from"./index-BrQW8HOS.js";import{e as w}from"./maybe-BQxFr9e1.js";import{P as C,H as k}from"./async-utils-Ct29LAJ6.js";import{A as ee}from"./arcadeFeatureUtils-D1_gLIP2.js";import{q as te}from"./feature-utils-BrGc70Ta.js";import"./shared-DBXlHENV.js";import"./isImageryGraphicOrigin-Ccuhb4eK.js";import"./isImageryTileGraphicOrigin-ZR-gBf9D.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./featureUtils-D2UmGJHI.js";import"./utils-BJ7fw6dI.js";import"./stringUtils-BTK5CX_y.js";const ie=ee;var ne=typeof global=="object"&&global&&global.Object===Object&&global,ae=typeof self=="object"&&self&&self.Object===Object&&self,P=ne||ae||Function("return this")(),_=P.Symbol,V=Object.prototype,re=V.hasOwnProperty,se=V.toString,y=_?_.toStringTag:void 0;function oe(e){var t=re.call(e,y),n=e[y];try{e[y]=void 0;var i=!0}catch{}var a=se.call(e);return i&&(t?e[y]=n:delete e[y]),a}var le=Object.prototype,ce=le.toString;function ue(e){return ce.call(e)}var fe="[object Null]",pe="[object Undefined]",E=_?_.toStringTag:void 0;function de(e){return e==null?e===void 0?pe:fe:E&&E in Object(e)?oe(e):ue(e)}function he(e){return e!=null&&typeof e=="object"}var ve="[object Symbol]";function me(e){return typeof e=="symbol"||he(e)&&de(e)==ve}var ge=/\s/;function ye(e){for(var t=e.length;t--&&ge.test(e.charAt(t)););return t}var Te=/^\s+/;function _e(e){return e&&e.slice(0,ye(e)+1).replace(Te,"")}function b(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var M=NaN,be=/^[-+]0x[0-9a-f]+$/i,xe=/^0b[01]+$/i,$e=/^0o[0-7]+$/i,we=parseInt;function J(e){if(typeof e=="number")return e;if(me(e))return M;if(b(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=b(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=_e(e);var n=xe.test(e);return n||$e.test(e)?we(e.slice(2),n?2:8):be.test(e)?M:+e}var j=function(){return P.Date.now()},ke="Expected a function",je=Math.max,Ie=Math.min;function Oe(e,t,n){var i,a,o,l,r,c,f=0,v=!1,p=!1,h=!0;if(typeof e!="function")throw new TypeError(ke);t=J(t)||0,b(n)&&(v=!!n.leading,p="maxWait"in n,o=p?je(J(n.maxWait)||0,t):o,h="trailing"in n?!!n.trailing:h);function u(s){var d=i,m=a;return i=a=void 0,f=s,l=e.apply(m,d),l}function U(s){return f=s,r=setTimeout(T,t),v?u(s):l}function q(s){var d=s-c,m=s-f,L=t-d;return p?Ie(L,o-m):L}function O(s){var d=s-c,m=s-f;return c===void 0||d>=t||d<0||p&&m>=o}function T(){var s=j();if(O(s))return S(s);r=setTimeout(T,q(s))}function S(s){return r=void 0,h&&i?u(s):(i=a=void 0,l)}function B(){r!==void 0&&clearTimeout(r),f=0,i=c=a=r=void 0}function D(){return r===void 0?l:S(j())}function $(){var s=j(),d=O(s);if(i=arguments,a=this,c=s,d){if(r===void 0)return U(c);if(p)return clearTimeout(r),r=setTimeout(T,t),u(c)}return r===void 0&&(r=setTimeout(T,t)),l}return $.cancel=B,$.flush=D,$}var Se="Expected a function";function N(e,t,n){var i=!0,a=!0;if(typeof e!="function")throw new TypeError(Se);return b(n)&&(i="leading"in n?!!n.leading:i,a="trailing"in n?!!n.trailing:a),Oe(e,t,{leading:i,maxWait:t,trailing:a})}const Le=K`.arcgis-feature-expression__loading-container{display:flex;justify-content:center;padding:var(--calcite-spacing-md) 0;width:100%}`,R=1,W="arcgis-feature",F={base:`${W}-expression`,loadingSpinnerContainer:`${W}__loading-container`},x=class x extends H{constructor(){super(...arguments),this._compileThrottled=N(this._startCompile,R),this._evaluateThrottled=N(this._startEvaluate,R),this.headingLevel=2}loaded(){this.manager.onLifecycle(()=>[z(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),{initial:!0}),G(()=>{if(!this._compileTask?.finished)return null;const t=this._compileTask.value,n=t?.dependencies,{view:i}=this;return[t,this.spatialReference,this.map,i,n?.has("view-scale")&&i&&"scale"in i?i.scale:null,n?.has("view-time-extent")?i?.timeExtent?.start:null,n?.has("view-time-extent")?i?.timeExtent?.end:null]},([t])=>this._evaluateThrottled(t)),{remove:()=>this._cancelThrottles()}])}_cancelThrottles(){this._compileThrottled.cancel(),this._evaluateThrottled.cancel()}_startCompile(){this._evaluateTask=w(this._evaluateTask),this._compileTask=w(this._compileTask),this._compileTask=C(async t=>{const{expressionInfo:n,graphic:i}=this,a=n?.expression;if(!a||!i)return null;const o=await ie({expression:a,graphic:i});return k(t),o})}_startEvaluate(t){this._evaluateTask=w(this._evaluateTask),this._evaluateTask=C(async n=>{const{graphic:i}=this;if(!t||!i)return null;const{interceptor:a,spatialReference:o,map:l,location:r,view:c}=this,f=await t.evaluate({graphic:i,interceptor:a,location:r,map:l,options:{signal:n},spatialReference:o,view:c});k(n);const v=f&&"castAsJsonAsync"in f&&typeof f.castAsJsonAsync=="function"?f:null;if(!v)return null;const p=await v.castAsJsonAsync(n);k(n);const h=p?.type,u=h==="media"?Q.fromJSON(p):h==="text"?X.fromJSON(p):h==="fields"?Y.fromJSON(p):null;return!u||u.type==="media"&&!u.mediaInfos||u.type==="fields"&&!u.fieldInfos||u.type==="text"&&!u.text?null:u})}render(){const t=!this._compileTask?.finished||!this._evaluateTask?.finished;return g`<div class=${A(F.base)}>${t?this._renderLoading():this._evaluateTask?.value?this._renderContent():null}</div>`}_renderContent(){const{values:t,fieldInfoMap:n}=this,i=this._evaluateTask?.value,a=i?.type;if(!a)return null;if(a==="text"){const o=te({values:t,fieldInfoMap:n??new Map,globalValues:t??{},layer:void 0,text:i.text});return g`<arcgis-feature-content .creator=${o} .graphic=${this.graphic}></arcgis-feature-content>`}else if(a==="media"){const{title:o,description:l,mediaInfos:r}=i;if(!r?.length)return null;const c={...t,...i.attributes};return g`<arcgis-feature-media .heading=${o??""} .values=${c} .formattedValues=${c} .description=${l??""} .mediaInfos=${r} .messages=${this.messages} .headingLevel=${this.headingLevel}></arcgis-feature-media>`}else if(a==="fields"){const{title:o,description:l,fieldInfos:r}=i;return r?.length?g`<arcgis-feature-fields .fieldInfos=${r} .heading=${o??""} .description=${l??""} .headingLevel=${this.headingLevel} .messages=${this.messages}></arcgis-feature-fields>`:null}return null}_renderLoading(){return g`<div class=${A(F.loadingSpinnerContainer)}><calcite-loader inline label></calcite-loader></div>`}};x.properties={_compileTask:16,_evaluateTask:16,values:0,fieldInfoMap:0,expressionInfo:0,graphic:0,headingLevel:9,interceptor:0,location:0,messages:0,spatialReference:0,map:0,view:0},x.styles=Le;let I=x;Z("arcgis-feature-expression",I);export{I as ArcgisFeatureExpression};
