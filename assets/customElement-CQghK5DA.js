import{bF as $,ch as j,_ as n,e as p,kI as B,cC as re,g as R,sA as de,g1 as z,kt as q,h8 as H,he as ye,hf as me,cm as Q,cn as Z,a5 as u,yv as we,fh as ge,ab as _,aW as b,am as ve,kJ as P,Ax as V,aq as fe,f8 as Le,ae as J,f as I,O as ke,L as Ce,v as K,Ay as be,Az as Re,AA as Ee,r as d,c as X,s2 as De,s3 as Ie,AB as _e,AC as $e,AD as Se,b as Y,s4 as ee,D as te,d as ie,s6 as ae,l as Ne}from"./index-CgzAF5Ey.js";import{$ as Me,f as Ve}from"./WebDocument2D-QiJ0XfRA.js";import{o as xe,a as Te,u as je,i as Ae,w as Ue,x as Pe}from"./supportUtils-BZj590vD.js";import{m as Fe,_ as Ge}from"./resourceSerializationUtils-BqPM7w0y.js";import{s as We,n as Oe}from"./utils-DN_jc3_L.js";import{a as Be}from"./MeasuredGrid-B5ySCGnr.js";import{n as ze}from"./GraphicsLayer-CNIUk38A.js";import{J as qe,p as He}from"./knowledgeGraphService-DdwbA4aa.js";import{p as Qe}from"./GraphQueryStreaming-5_IvnDby.js";import Ze from"./Reshape-Dva1-JhO.js";import{u as Je}from"./automaticAreaMeasurementUtils-BatsSLDN.js";import{c as Ke}from"./automaticLengthMeasurementUtils-B1DzL2GL.js";import{a as Xe}from"./View2D-Z_g1Pe0z.js";import{e as Ye,u as et}from"./euclideanLengthMeasurementUtils-CGkbgpIY.js";import{q as tt}from"./SnappingManager-C_Xw3YlC.js";import"./Bookmark-SpLkQoRE.js";import"./submitJob-C_BQYrXw.js";import"./networkEnums-Tj95fFYJ.js";import"./GPMessage-CUpfv7Q3.js";import"./apiConverter-CvNJfrRe.js";import"./Point2D-8Py_srEd.js";import"./Envelope2D-DQ3Tn1o-.js";import"./ProjectionTransformation-D72vYhR2.js";import"./Transformation2D-Ckyhe4wc.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-EjytI4Do.js";import"./SnappingVisualizer2D-D_sty-M3.js";import"./SnappingVisualizer-CfgCZJq2.js";import"./PointSnappingHint-ByJMd16p.js";import"./symbolUtils-0l5vVMbV.js";import"./gfxUtils-B1R76T6S.js";import"./cimSymbolUtils-D8zbHeXT.js";import"./svgUtils-smkwubCy.js";import"./mat2df32-Dpt2CT5P.js";import"./mat2d-DWPHXQcf.js";import"./utils-BxeCvIiv.js";import"./GraphicState-p_iGTMrc.js";import"./drawUtils-DfCzrCmO.js";import"./curveOperationUtils-Bf-6qlka.js";import"./GraphicMover-BPRGTU8v.js";import"./HighlightHelper-Dpd7BeQp.js";import"./layerUtils-C4kbKZbG.js";import"./GraphicManipulator-DC391nnv.js";import"./SketchTooltipInfo-ipmEcjXX.js";import"./coordinateFormatter-4c6X-xJV.js";import"./MeshTransform-Dit-XLCt.js";import"./a11yUtils-B0k1CDxO.js";import"./getDefaultUnitForView-DdQQf52Q.js";import"./quantityFormatUtils-hOh9vK9C.js";import"./angularMeasurementUtils-DWPIAu_Z.js";import"./geodesicUtils-Cfv0uT1u.js";import"./directionModeIcons-Br5woIHu.js";import"./SelectedVertexTooltipInfo-DnmLO_fL.js";import"./TooltipInfoWithCoordinates-Ctjrbg45.js";import"./geodesicMeasurementUtils-CD0H_C-6.js";import"./TranslateTooltipInfo-CGzhbuh0.js";import"./settings-Gl3hn1pT.js";import"./coordinateHelper-BBk0eSaI.js";import"./EditGeometryOperations-CUoPE0hp.js";import"./geometry2dUtils-DamFhDZI.js";import"./rotate-LRLOFQu1.js";import"./SketchOptions-DsWZlvNP.js";import"./SketchLabelOptions-CtWdh0ak.js";import"./SnappingContext-lR2hMWGP.js";import"./geodeticLengthOperator-CCmu1UCP.js";import"./geodeticCurveType-CirnHLSB.js";import"./geodesicAreaMeasurementUtils-CadONabs.js";import"./earcut-D9gy186-.js";import"./clippingUtils-QppW5MR2.js";import"./viewpointUtils-BuigW1az.js";import"./mat2df64-DJ_RMjZ3.js";import"./hitTestUtils-BYtV70CA.js";import"./rbush-eDLDlHie.js";import"./Tile-B-BE-ibd.js";import"./arcadeUtils-MYBE13Eg.js";import"./Timeline-Cz5T4vl1.js";let m=class extends $(j){constructor(e){super(e),this.durationLineWidth=5,this.entityPositionAtDurationRatio=1,this.eventsTicksVisualization="start-and-end",this.lineSeparationMultiplier=1,this.moveFirstBends=!0,this.secondBendRatio=.3,this.separateTimeOverlaps=!0,this.separateTimelineOverlaps=!0,this.separatedLineShapeRatio=0,this.showDurationLineForNonZeroDurationEntityEvents=!1,this.showNonZeroDurationIntervalBounds=!1,this.spaceSeparatedLinesEvenly=!1,this.timeBannerUTCOffsetInMinutes=0,this.timeDirection="right",this.useBezierCurves=!1}};n([p({type:B,range:{min:1,max:10},json:{write:!0}})],m.prototype,"durationLineWidth",void 0),n([p({type:Number,range:{min:0,max:1},json:{write:!0}})],m.prototype,"entityPositionAtDurationRatio",void 0),n([re(xe)],m.prototype,"eventsTicksVisualization",void 0),n([p({type:Number,range:{min:0},json:{write:!0}})],m.prototype,"lineSeparationMultiplier",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"moveFirstBends",void 0),n([p({type:Number,range:{min:0,max:1},json:{write:!0}})],m.prototype,"secondBendRatio",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"separateTimeOverlaps",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"separateTimelineOverlaps",void 0),n([p({type:Number,range:{min:0,max:1},json:{write:!0}})],m.prototype,"separatedLineShapeRatio",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"showDurationLineForNonZeroDurationEntityEvents",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"showNonZeroDurationIntervalBounds",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"spaceSeparatedLinesEvenly",void 0),n([p({type:B,json:{write:!0}})],m.prototype,"timeBannerUTCOffsetInMinutes",void 0),n([p({type:["bottom","left","right","top"],json:{write:!0}})],m.prototype,"timeDirection",void 0),n([p({type:Boolean,json:{write:!0}})],m.prototype,"useBezierCurves",void 0),m=n([R("esri.linkChart.ChronologicalLayoutSettings")],m);const it=m;let k=class extends $(j){constructor(e){super(e),this.absoluteIdealEdgeLength=1,this.autoRepulsionRadius=!0,this.computationBudgetTime=2,this.idealEdgeLengthType="multiplier",this.multiplicativeIdealEdgeLength=1,this.repulsionRadiusMultiplier=1}};n([p({type:Number,range:{min:0,max:360},json:{write:!0}})],k.prototype,"absoluteIdealEdgeLength",void 0),n([p({type:Boolean,json:{write:!0}})],k.prototype,"autoRepulsionRadius",void 0),n([p({type:Number,json:{write:!1}})],k.prototype,"computationBudgetTime",void 0),n([re(Te)],k.prototype,"idealEdgeLengthType",void 0),n([p({type:Number,range:{min:0,max:5},json:{write:!0}})],k.prototype,"multiplicativeIdealEdgeLength",void 0),n([p({type:Number,range:{min:1,max:99},json:{write:!0}})],k.prototype,"repulsionRadiusMultiplier",void 0),k=n([R("esri.linkChart.OrganicLayoutSettings")],k);const rt=k;let D=class extends $(j){constructor(e){super(e),this.chronologicalLayoutSettings=null,this.organicLayoutSettings=null}};n([p({type:it,json:{write:!0}})],D.prototype,"chronologicalLayoutSettings",void 0),n([p({type:rt,json:{write:!0}})],D.prototype,"organicLayoutSettings",void 0),D=n([R("esri.linkChart.LayoutSettings")],D);const se=D;let x=class extends $(j){constructor(i){super(i),this.mode="visible"}};n([p({type:["hidden","visible"],json:{write:!0}})],x.prototype,"mode",void 0),x=n([R("esri.linkChart.NonspatialDataDisplay")],x);const ne=x;let w=class extends $(de){constructor(i){super(i),this.aggregatedEntitiesUrl=null,this.aggregatedRelationshipsUrl=null,this.autoCollapseRelationships=!0,this.centralityIsUpToDate=!0,this.entitiesUrl=null,this.layoutSettings=null,this.layoutType="organic-standard",this.nonspatialDataDisplay=null,this.relationshipsUrl=null}readEntitiesUrl(i,e,t){return z(i,t)}writeEntitiesUrl(i,e,t,a){const r=a?.portalItem,o=a?.resources,h=q(a?.origin),s=a?.webmap?.activeLinkChartLayer;r&&o&&h!=null&&s&&s.membershipModified?this._saveUrlAsNewResource(e,t,o,r,s):i&&(e[t]=H(i,a))}readRelationshipsUrl(i,e,t){return z(i,t)}writeRelationshipsUrl(i,e,t,a){const r=a?.portalItem,o=a?.resources,h=q(a?.origin),s=a?.webmap?.activeLinkChartLayer;r&&o&&h!=null&&s&&s.membershipModified?this._saveUrlAsNewResource(e,t,o,r,s):i&&(e[t]=H(i,a))}_saveUrlAsNewResource(i,e,t,a,r){i[e]="<pending>";const o=(r.knowledgeGraph.dataModel.relationshipTypes??[]).map(h=>h.name).reduce((h,s)=>{if(!s)return h;const{members:l}=r.dataManager.inclusionModeDefinition.namedTypeDefinitions.get(s)||{members:void 0};if(!l)return h;for(const[c]of l)h.push({id:c,typeName:s});return h},[]);t.pendingOperations.push(new Promise(h=>{je(o,r.knowledgeGraph).then(s=>{st(r.dataManager.inclusionModeDefinition,e,r.knowledgeGraph,s).then(l=>{const c=at(a,e==="entitiesUrl"?"entitiesUrl":"relationshipsUrl");i[e]=c.itemRelativeUrl,t.toAdd.push({resource:c,content:{type:"blob",blob:l},compress:!1,finish:g=>{e==="entitiesUrl"?this.entitiesUrl=g.url:this.relationshipsUrl=g.url}}),h()})})}))}};n([p({type:String,json:{write:!0}})],w.prototype,"aggregatedEntitiesUrl",void 0),n([p({type:String,json:{write:!0}})],w.prototype,"aggregatedRelationshipsUrl",void 0),n([p({type:Boolean,json:{write:!0}})],w.prototype,"autoCollapseRelationships",void 0),n([p({type:Boolean,json:{write:!0}})],w.prototype,"centralityIsUpToDate",void 0),n([p({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],w.prototype,"entitiesUrl",void 0),n([Q("entitiesUrl")],w.prototype,"readEntitiesUrl",null),n([Z("entitiesUrl")],w.prototype,"writeEntitiesUrl",null),n([p({type:se,json:{write:!0}})],w.prototype,"layoutSettings",void 0),n([p({type:Ae,json:{write:!0}})],w.prototype,"layoutType",void 0),n([p({type:ne,json:{write:!0}})],w.prototype,"nonspatialDataDisplay",void 0),n([p({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],w.prototype,"relationshipsUrl",void 0),n([Q("relationshipsUrl")],w.prototype,"readRelationshipsUrl",null),n([Z("relationshipsUrl")],w.prototype,"writeRelationshipsUrl",null),w=n([R("esri.linkChart.LinkChartProperties")],w);const oe=w;function at(i,e){const t=`${e}-${ye()}.dat`,a=me("linkChart",t);return i.resourceFromPath(a)}async function st(i,e,t,a){let r;return r=e==="entitiesUrl"?await Fe(i,t,a):await Ge(i,t,a),new Blob([r],{type:"application/x-protobuf"})}var F;const nt={currentVersion:Oe,createInitialViewProperties:()=>new Ve,parseVersion:We.parse,itemType:"Web Link Chart",name:"linkchart",origin:"link-chart"};let L=F=class extends Me{constructor(i){super(i),this.mapType="webLinkChart",this.linkChartProperties=new oe}get activeLinkChartLayer(){return this.layers.find(({type:i})=>i==="link-chart")}get context(){return nt}async applyLayout(i="organic-standard",e){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");i!=="geographic-organic-standard"||this.basemap?.baseLayers?.length||(this.basemap=we.fromId("topo-vector"),await this.basemap?.load()),this.linkChartProperties.layoutType=i;const t=e?.layoutSettings??this.linkChartProperties.layoutSettings??new se;this.linkChartProperties.layoutSettings=t;const a={...e,layoutSettings:t};return this.activeLinkChartLayer.applyNewLinkChartLayout(i,a)}changeNonspatialDataDisplay(i){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");this.linkChartProperties.nonspatialDataDisplay||(this.linkChartProperties.nonspatialDataDisplay=new ne),this.linkChartProperties.nonspatialDataDisplay.mode=i}async addRecords(i,e){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.addRecords(i,e)}async createSublayerForNamedType(i){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.createSublayerForNamedType(i)}async removeRecords(i){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.removeRecords(i)}async expand(i,e){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return(await this.activeLinkChartLayer.expand(i,e))?.records??[]}async refreshLinkChartData(i){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.refreshLinkChartCache(i)}async connectBetweenEntities(i,e){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return(await this.activeLinkChartLayer.connectBetweenEntities(i,e))?.records??[]}async connectFromEntities(i,e){if(await this.load(),!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return(await this.activeLinkChartLayer.connectFromEntities(i,e))?.records??[]}getMemberIdsByType(i){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return Array.from(this.activeLinkChartLayer?.dataManager.sublayerCaches.get(i)?.keys()??[])}get diagramNodesExtent(){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.linkChartExtent}get entityCount(){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.entityLinkChartDiagramLookup.size}get relationshipCount(){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer.relationshipLinkChartDiagramLookup.size}get knowledgeGraph(){if(!this.activeLinkChartLayer)throw new u("WebLinkChart:no-link-chart-layer","No link chart layer found");return this.activeLinkChartLayer?.knowledgeGraph}add(i,e){if(this.activeLinkChartLayer&&"type"in i&&i.type==="link-chart")throw new u("linkchart:one-link-chart-layer","Web Link Charts can only have one Link Chart Layer, another cannot be added");if(super.add(i,e),"type"in i&&i.type==="link-chart"){const t=i.initializationLinkChartConfig?.layoutMode;t&&(this.linkChartProperties.layoutType=t);const a=i.initializationLinkChartConfig?.layoutSettings;a&&(this.linkChartProperties.layoutSettings=a)}}static fromJSON(i){if(i)return new F({resourceInfo:i});throw new u("linkchart:empty-resource","Expected a JSON resource but got nothing")}handleChronologicalOverlay(){if(!this.activeLinkChartLayer)return;const i=this.activeLinkChartLayer,e=this.findLayerById(Ue());if(e&&this.remove(e),this.linkChartProperties.layoutType==="chronological-mono-timeline"||this.linkChartProperties.layoutType==="chronological-multi-timeline"){const t=Pe(i);this.add(t,0)}}};n([p({readOnly:!0})],L.prototype,"activeLinkChartLayer",null),n([p({json:{write:{ignoreOrigin:!0}}})],L.prototype,"mapType",void 0),n([p({type:oe,nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],L.prototype,"linkChartProperties",void 0),n([p({readOnly:!0})],L.prototype,"diagramNodesExtent",null),n([p({readOnly:!0})],L.prototype,"entityCount",null),n([p({readOnly:!0})],L.prototype,"relationshipCount",null),n([p({readOnly:!0})],L.prototype,"knowledgeGraph",null),L=F=n([R("esri.WebLinkChart")],L);const he=L,ot={newReshapeWrapper:async({getFeatureReshapeProvider:i,targetGraphic:e,reshapeGraphicsLayer:t,view:a,snappingManager:r})=>new Ze({automaticAreaMeasurementUtils:await Je(),automaticLengthMeasurementUtils:await Ke(),connectedReshapeProviders:[{getFeatureReshapeProvider:i,getVertexReshapeProvider(){throw new Error("Link Charts do not support vertex (polyline) reshape at this time")}}],enableMidpoints:!1,graphic:e,layer:t,view:a,snappingManager:r})},ht=async({targetEntityId:i,targetEntityType:e,view:t,snappingManager:a})=>{await ge(_.WGS84,t.spatialReference);const r=t.map?.activeLinkChartLayer?.layers.find(y=>y.objectType.name===e);if(!r)throw new u("LinkChartView:target-layer-not-found",`No layer found for target entity type ${e}`);const o=r.createQuery();o.objectIds=[i];const h=await r.queryFeatures(o);if(h.features.length===0)throw new u("LinkChartView:no-matching-feature-found",`No feature found with ID ${i} in layer ${r.title}`);const s=h.features[0].clone(),l=s.attributes.ESRI__ID;if(!s.sourceLayer)throw new u("LinkChartView:no-source-layer",`The target graphic does not have a source layer: ${l}`);const c=new ze({listMode:"hide",internal:!0});s.geometry=b(new ve(P(s.attributes.ESRI__LayoutGeometry,"esriGeometryPoint",!1,!1)),t.spatialReference),t.map.add(c),c.add(s);const g=s.sourceLayer,f=g.parent,C=new Map([[l,[]]]),S=new Map,A=new Map,pe=await pt(i,r,t),W=new Map;for(const y of f.layers)W.set(y.objectType.name,y);const O=new Map;for(const[y,v]of f.sublayerIdsCache)f.dataManager.relationshipTypeNames.has(y)&&O.set(y,Array.from(v));const le=await lt(l,g.objectType.name,f.knowledgeGraph,O),N=f.entityLinkChartDiagramLookup.get(l);for(const y of le){let v=S.get(y.id);if(v||(v=f.relationshipLinkChartDiagramLookup.get(y.id),S.set(y.id,v??null)),v){const M=W.get(y.typeName);M&&V(v.coords[0],N.coords[0])&&V(v.coords[1],N.coords[1])?C.get(l)?.push({objectId:y.id,pathIndex:0,vertexIndex:0,associatedSublayer:M}):M&&V(v.coords.at(-2),N.coords[0])&&V(v.coords.at(-1),N.coords[1])&&C.get(l)?.push({objectId:y.id,pathIndex:0,vertexIndex:v.coords.length/2-1,associatedSublayer:M})}}const ce=y=>new ut(y,A,C,t),U=await ot.newReshapeWrapper({getFeatureReshapeProvider:ce,targetGraphic:s,reshapeGraphicsLayer:c,view:t,snappingManager:a});U.on("move-stop",y=>{t.emit("node-movement-stop",y)});const ue=fe(()=>{pe.remove(),c.removeAll(),t.map.remove(c),c.destroy(),A.clear(),S.clear(),U.destroy()});return{currentReshapeGraphic:U.graphic,localEdits:A,originalRelationshipGeometries:S,teardownHandle:ue}},pt=async(i,e,t)=>{const a=await t.whenLayerView(e);return a.setVisibility(i,!1),{remove:()=>a.setVisibility(i,!0)}},lt=async(i,e,t,a,r)=>{const o={sourceId:i},h=[],s=[];for(const[g,f]of a){const C=`${g}_ids`;o[C]=f,s.push(`Match (n:${e}) WHERE id(n) = $sourceId WITH n MATCH (n)-[r:${g}]-() WHERE ID(r) IN $${C} RETURN {id: ID(r), typeName: type(r)} as result`)}const l=s.join(" UNION "),c=(await qe.executeQueryStreaming(new He(JSON.parse(JSON.stringify(t))),new Qe({openCypherQuery:l,bindParameters:o}),r)).resultRowsStream.getReader();for(;;){const{done:g,value:f}=await c.read();if(g)break;f.forEach(C=>{h.push(C[0].properties)})}return h};let ct=class{constructor(e,t){this.modifiedFeatures=new Map,this.updating=!1,this._totalDx=0,this._totalDy=0,this._localEditsCache=e,this._view=t}async initializeModifiedFeatures(e){const t=new Map;for(const r of this._view.map?.activeLinkChartLayer?.layers??[]){const o=r;t.set(o.objectType.name,o)}const a=new Map;for(const r of e){const o=this._localEditsCache.get(r.objectId);o?this.initializeModifiedFeature(o,e):Le(a,r.associatedSublayer.objectType.name,()=>[]).push(r.objectId)}for(const[r,o]of a){const h=t.get(r),s=h.createQuery();s.outFields=["ESRI__ID"],s.objectIds=o,h.queryFeatures(s).then(l=>{for(const c of l.features)this.initializeModifiedFeature(this.makeModifiedFeature(c,h),e)})}}makeModifiedFeature(e,t){const a=e.attributes.ESRI__ID,r={graphic:e,layer:t,originalGraphic:e.clone(),uniqueId:a};return this._localEditsCache.set(a,r),r}initializeModifiedFeature(e,t){const a=t.filter(({objectId:l})=>l===e.uniqueId);this.modifiedFeatures.set(e,a);let r=e.graphic.geometry?b(e.graphic.geometry,this._view.spatialReference):void 0;const o=e.graphic.sourceLayer,h=o.parent;if(!r&&o.graphType==="relationship"){const l=h.relationshipLinkChartDiagramLookup.get(e.uniqueId);r=b(new J(P(l,"esriGeometryPolyline",!1,!1)),this._view.spatialReference)}let s=r.clone();for(const{pathIndex:l,vertexIndex:c}of a)s=this.getTranslatedGeometry(r,l,c,this._totalDx,this._totalDy);e.graphic.geometry=b(s,_.WGS84),h.relationshipLinkChartDiagramLookup.get(e.uniqueId)&&(h.relationshipLinkChartDiagramLookup.set(e.uniqueId,null),o.refreshCachedQueryEngine().then(()=>{o.emit("refresh",{dataChanged:!0})}))}translate(e,t){this._totalDx+=e,this._totalDy+=t;const a=new Set;for(const[r,o]of this.modifiedFeatures){let h=r.graphic.geometry?b(r.graphic.geometry,this._view.spatialReference):void 0;const s=r.graphic.sourceLayer,l=s.parent;if(s&&!r.graphic.geometry&&s.graphType==="relationship"){const c=l.relationshipLinkChartDiagramLookup.get(r.uniqueId);h=b(new J(P(c,"esriGeometryPolyline",!1,!1)),this._view.spatialReference)}for(const c of o){if(!h)continue;const g=this.getTranslatedGeometry(h,c.pathIndex,c.vertexIndex,e,t);r.graphic.geometry=b(g,_.WGS84),l.relationshipLinkChartDiagramLookup.get(r.uniqueId)&&(l.relationshipLinkChartDiagramLookup.set(r.uniqueId,null),a.add(s))}}for(const r of a)r.refreshCachedQueryEngine().then(()=>{r.emit("refresh",{dataChanged:!0})});return Array.from(this.modifiedFeatures.keys())}getTranslatedGeometry(e,t,a,r,o){const h=e.clone(),s=e.paths.slice();return s.at(t)?.at(a)==null||(s[t][a][0]+=r??0,s[t][a][1]+=o??0,h.paths=s),h}},ut=class extends ct{constructor(e,t,a,r){super(t,r),this._connectedVerticesLookup=a;const o=[];for(const h of e){const s=this.getConnectedVerticesForFeature(h);for(const l of s)o.push(l)}this.initializeModifiedFeatures(o)}getConnectedVerticesForFeature(e){return this._connectedVerticesLookup.get(e.graphic.attributes.ESRI__ID)??[]}},E=class extends Xe{constructor(i){super(i),this.map=null,this.view2dType="linkchart",this._isReshapeActive=!1,this._previousGridSettings=void 0,this._cachedSnappingManager=void 0;const e=a=>{this.spatialReference=a==="geographic-organic-standard"?this.map.basemap?.spatialReference??_.WebMercator:_.WGS84};let t=null;this.addHandles(I(()=>this.map,a=>{a&&(t&&t.remove(),t=I(()=>a.linkChartProperties.layoutType,e),this.addHandles(t))},{initial:!0}))}get inGeographicLayout(){return this.map?.linkChartProperties.layoutType==="geographic-organic-standard"}async startNodeMovement(i,e,t){if(this._isReshapeActive)throw new u("LinkChartView:reshape-already-active","Node movement reshape is already active");this._isReshapeActive=!0;const a=new ke;for(const r of this.map?.activeLinkChartLayer?.layers??[])if(r.graphType==="relationship"){const o=new Ye({layer:r});a.add(o)}try{let r;t?.useSnappingGrid&&(this._previousGridSettings=this.grid,this.grid||(this.grid=new Be({units:"feet",center:this.center,rotateWithMap:!0})),this._cachedSnappingManager?(r=this._cachedSnappingManager,r.options.gridEnabled=t?.useSnappingGrid):(r=new tt({options:new et({enabled:!0,featureSources:a,gridEnabled:t?.useSnappingGrid}),view:this}),this._cachedSnappingManager=r));const o=await ht({targetEntityId:i,targetEntityType:e,view:this,snappingManager:r});return{commitNodeMovement:async()=>{if(!this._isReshapeActive)throw new u("LinkChartView:reshape-not-active","Node movement reshape is not active");this._isReshapeActive=!1;const h=o.currentReshapeGraphic.sourceLayer?.parent,s=h.getCurrentNodeLocations(),l=b(o.currentReshapeGraphic.geometry,{wkid:4326});return s.set(i,l),await h.applyNewLinkChartLayout(this.map.activeLinkChartLayer?.getCurrentLayout(),{lockedNodeLocations:s}),o.teardownHandle.remove(),this.grid=this._previousGridSettings,l},cancelNodeMovement:()=>{if(!this._isReshapeActive)return;this._isReshapeActive=!1;const h=[];for(const s of o.localEdits.values())s.graphic.geometry=void 0,s.graphic.sourceLayer?.type==="knowledge-graph-sublayer"&&s.graphic.sourceLayer?.graphType==="relationship"&&(s.graphic.sourceLayer.parent.relationshipLinkChartDiagramLookup.set(s.graphic.attributes.ESRI__ID,o.originalRelationshipGeometries.get(s.graphic.attributes.ESRI__ID)??null),h.push(s.graphic.sourceLayer));for(const s of h)s.refreshCachedQueryEngine().then(()=>{s?.emit("refresh",{dataChanged:!0})});o.teardownHandle.remove(),this.grid=this._previousGridSettings}}}catch(r){throw this._isReshapeActive=!1,r}}};n([p()],E.prototype,"inGeographicLayout",null),n([p({type:he})],E.prototype,"map",void 0),n([p({readOnly:!0})],E.prototype,"view2dType",void 0),E=n([R("esri.views.LinkChartView")],E);const dt=E;const yt=ae(he),mt=ae(dt),T=class T extends Ce{constructor(){super(),this._containerRef=K(),this._mapRef=K(),this._uiController=new be(this),this.arcgisLoadError=Re(this),this.arcgisViewReadyError=Ee(this),this._map=yt(this),this.view=mt(this),this.allLayerViews=this.view.allLayerViews,this.analyses=this.view.analyses,this.autoDestroyDisabled=!1,this.animationsDisabled=this.view.animationsEnabled,this.aria=this.view.aria,this.background=this.view.background,this.basemap=this._map.basemap,this.basemapView=this.view.basemapView,this.constraints=this.view.constraints,this.displayFilterDisabled=this.view.displayFilterEnabled,this.fatalError=this.view.fatalError,this.graphics=this.view.graphics,this.highlights=this.view.highlights,this.highlightOptions=this.view.highlightOptions,this.layerViews=this.view.layerViews,this.magnifier=this.view.magnifier,this.map=this.view.map,this.navigation=this.view.navigation,this.padding=this.view.padding,this.popup=this.view.popup,this.popupDisabled=this.view.popupEnabled,this.ready=this.view.ready,this.resizeAlign=this.view.resizeAlign,this.resolution=this.view.resolution,this.rotation=this.view.rotation,this.spatialReference=this.view.spatialReference,this.suspended=this.view.suspended,this.theme=this.view.theme,this.timeExtent=this.view.timeExtent,this.timeZone=this.view.timeZone,this.updating=this.view.updating,this.arcgisViewAnalysisViewCreate=d(()=>this.view,"analysis-view-create"),this.arcgisViewAnalysisViewCreateError=d(()=>this.view,"analysis-view-create-error"),this.arcgisViewAnalysisViewDestroy=d(()=>this.view,"analysis-view-destroy"),this.arcgisViewChange=X(),this.arcgisViewClick=d(()=>this.view,"click"),this.arcgisViewDoubleClick=d(()=>this.view,"double-click"),this.arcgisViewDrag=d(()=>this.view,"drag"),this.arcgisViewHold=d(()=>this.view,"hold"),this.arcgisViewImmediateClick=d(()=>this.view,"immediate-click"),this.arcgisViewImmediateDoubleClick=d(()=>this.view,"immediate-double-click"),this.arcgisViewKeyDown=d(()=>this.view,"key-down"),this.arcgisViewKeyUp=d(()=>this.view,"key-up"),this.arcgisViewLayerviewCreate=d(()=>this.view,"layerview-create"),this.arcgisViewLayerviewCreateError=d(()=>this.view,"layerview-create-error"),this.arcgisViewLayerviewDestroy=d(()=>this.view,"layerview-destroy"),this.arcgisViewMouseWheel=d(()=>this.view,"mouse-wheel"),this.arcgisViewPointerDown=d(()=>this.view,"pointer-down"),this.arcgisViewPointerEnter=d(()=>this.view,"pointer-enter"),this.arcgisViewPointerLeave=d(()=>this.view,"pointer-leave"),this.arcgisViewPointerMove=d(()=>this.view,"pointer-move"),this.arcgisViewPointerUp=d(()=>this.view,"pointer-up"),this.arcgisViewReadyChange=X(),this.view.ui={components:["attribution"]}}get center(){return this.view.center}set center(e){const t=_e(e,this.view);t&&(this.view.center=t)}get extent(){return this.view.extent}set extent(e){this.extent?.equals(e)||(this.view.extent=e)}get focusAreas(){return this.map?this.map?.focusAreas:{areas:[],style:"bright"}}set focusAreas(e){this.map&&(this.map.focusAreas=e)}get interacting(){return this.view.interacting}get itemId(){return this._map.portalItem?.id}set itemId(e){$e(this._map,this),this._map.portalItem={id:e},this.view.map=this._map}get navigating(){return this.view.navigating}get scale(){return this.view.scale}set scale(e){this.view.scale=e}get stationary(){return this.view.stationary}get viewpoint(){return this.view.viewpoint}set viewpoint(e){Se(this.viewpoint,e)&&(this.view.viewpoint=e)}get zoom(){return this.view.zoom}set zoom(e){this.view.zoom=e}async addLayer(e,t){this.map?.add(e,t)}async addLayers(e,t){this.map?.addMany(e,t)}async closePopup(){this._uiController.closePopup()}async destroy(){await this.manager.destroy()}async goTo(e,t){return await this.view.goTo(e,t)}async openPopup(e){this._uiController.openPopup(e)}toMap(e){return this.view.toMap(e)}toScreen(e,t){return this.view.toScreen(e,t)}async tryFatalErrorRecovery(){this.view.tryFatalErrorRecovery()}async viewOnReady(e,t){return await this.componentOnReady(),await this.view.whenReady().then(()=>e?.()).catch(t)}async whenAnalysisView(e){return await this.view.whenAnalysisView(e)}async whenLayerView(e){return await this.view.whenLayerView(e)}loaded(){const e=this;e.el.childElem=this._mapRef.value,this.view.container??=e.el.childElem,this.map||=this._map,this.manager.onLifecycle(()=>[I(()=>this.map,t=>{t&&(this._map=t)},{initial:!0,sync:!0}),I(()=>this.view.stationary,()=>this.arcgisViewChange.emit(),{initial:!0}),I(()=>this.view.ready,()=>this.arcgisViewReadyChange.emit(),{initial:this.view.ready})])}renderMain(){return ie`<div class=${Y(ee.base)} ${te(this._mapRef)}></div>`}render(){return ie`<section class=${Y(ee.containerUI)} ${te(this._containerRef)}>${this._uiController.render()}</section>${this.renderMain()}`}};T.properties={_map:16,view:32,allLayerViews:0,analyses:0,autoDestroyDisabled:5,animationsDisabled:5,aria:0,background:0,basemap:1,basemapView:0,center:1,constraints:0,displayFilterDisabled:5,extent:0,fatalError:0,focusAreas:0,graphics:0,highlights:0,highlightOptions:0,interacting:32,itemId:3,layerViews:0,magnifier:0,map:0,navigating:32,navigation:0,padding:0,popup:0,popupDisabled:5,ready:4,resizeAlign:1,resolution:8,rotation:9,scale:9,spatialReference:0,stationary:32,suspended:7,theme:0,timeExtent:0,timeZone:1,updating:4,viewpoint:0,zoom:9,loadErrorSources:0},T.styles=[De,Ie];let G=T;Ne("arcgis-link-chart",G);export{G as ArcgisLinkChart};
