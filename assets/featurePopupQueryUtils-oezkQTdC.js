import{eE as z,eF as k,em as G,eh as B}from"./index-Ci9uhBCU.js";async function O(n,i,r,d){const u=new Array(i.length),l=new Map,a=new Map,b=z(n.fieldsIndex,r.outFields),F=n.capabilities?.operations?.supportsQuery===!0&&n.queryFeatures!=null,q=d?.hasRequiredFields??B;for(let e=0;e<i.length;e++){const t=i[e];if(F&&!t.isAggregate){if(r.returnGeometry||!q(t,b)){const s=t.getObjectId();if(s!=null){l.set(s,{graphic:t,index:e});continue}const c=t.getGlobalId();if(c!=null){a.set(c,{graphic:t,index:e});continue}}u[e]=t}else u[e]=t}if(!F||!n.queryFeatures||l.size===0&&a.size===0)return u.filter(Boolean);const f=[],h=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(l.size>0){const e=r.clone();h(e,n.objectIdField),"uniqueIdFields"in n&&n.uniqueIdFields?.length&&(e.outFields??=[],e.outFields.push(...n.uniqueIdFields)),e.objectIds=Array.from(l.keys()),f.push({type:"object-id",query:e,map:l})}const p="globalIdField"in n?n.globalIdField:null;if(p!=null&&a.size>0){const e=r.clone();h(e,p);const t=Array.from(a.keys());e.where=k(r.where,`${p} IN (${t.map(s=>`'${s}'`).join(",")})`),f.push({type:"global-id",query:e,map:a})}const j=d?.updateSourceAttributes??!1;for(const{type:e,query:t,map:s}of f)try{const c=await n.queryFeatures(t,d);for(const o of c.features){const I=e==="object-id"?o.getObjectId():o.getGlobalId();if(I==null)continue;const m=s.get(I);if(!m)continue;const{graphic:y,index:x}=m;if(j&&o.attributes){y.attributes??={};for(const g of b)g in o.attributes&&(y.attributes[g]=o.attributes[g])}const{geometry:A,origin:w}=y;o.geometry||=A,o.origin=w,u[x]=o}}catch{}return u.filter(Boolean)}async function $(n){if(n.expressionInfos?.length||Array.isArray(n.content)&&n.content.some(i=>i.type==="expression"))return G()}export{O as n,$ as s};
