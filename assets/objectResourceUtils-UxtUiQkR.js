const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-MKHAq-dj.js","assets/index-BrQW8HOS.js","assets/index-lUE0m221.css","assets/resourceUtils-D2afM8TH.js"])))=>i.map(i=>d[i]);
import{sY as ee,sZ as te,bt as F,pn as j,bx as G,s_ as se,s$ as re,U as oe,t0 as ne,es as ae,et as ie,kg as U,bf as le,t1 as k,gD as ue,bg as ce,aF as de,pu as H,t2 as K,kt as fe,s8 as P,gy as q,ar as O,pO as me,t3 as I,t4 as pe,t5 as xe,t6 as he,q4 as A,pN as ge,q1 as v,pw as Te,of as be,px as D,py as z,pz as ye,t7 as we,t8 as Re,t9 as N,ta as $e,tb as ve,q0 as Me,ss as Be,tc as Se,td as Ae}from"./index-BrQW8HOS.js";import{a as _e}from"./devEnvironmentUtils-8WtPGj6h.js";import{o as Ee,d as W}from"./vec4-CDOmPIEg.js";import{o as Fe,n as Oe}from"./indexUtils-ChhNYFqN.js";import{t as _}from"./resourceUtils-D2afM8TH.js";function M(t){if(t==null)return null;const s=t.offset!=null?t.offset:ee,o=t.rotation!=null?t.rotation:0,r=t.scale!=null?t.scale:te,c=F(1,0,0,0,1,0,s[0],s[1],1),f=F(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),a=F(r[0],0,0,0,r[1],0,0,0,1),i=G();return j(i,f,a),j(i,c,i),i}class Ie{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Pe{constructor(s,o,r){this.name=s,this.lodThreshold=o,this.pivotOffset=r,this.stageResources=new Ie,this.numberOfVertices=0}}async function Ce(t,s){const o=Q(_e(t));if(o.fileType==="wosr"){const l=await(s.cache?s.cache.loadWOSR(o.url,s):se(o.url,s)),{engineResources:p,referenceBoundingBox:x}=re(l,s);return{lods:p,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let r;if(s.cache)r=await s.cache.loadGLTF(o.url,s,!!s.usePBR);else{const{loadGLTF:l}=await oe(()=>import("./loader-MKHAq-dj.js"),__vite__mapDeps([0,1,2,3]));r=await l(new ne(s.streamDataRequester),o.url,s,s.usePBR)}const c=r.model.meta?.ESRI_proxyEllipsoid,f=r.meta.isEsriSymbolResource&&c!=null&&r.meta.ESRI_webstyle==="EsriRealisticTreesStyle";f&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,ke(r,c));const a=!!s.usePBR,i=r.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:f,mrrFactors:Se}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:Ae},u={...s.materialParameters,treeRendering:f},{engineResources:e,referenceBoundingBox:n}=Le(r,i,u,s,o.specifiedLodIndex,f);return{lods:e,referenceBoundingBox:n,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}}function Q(t){const s=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return s?{fileType:"gltf",url:s[1],specifiedLodIndex:s[4]!=null?Number(s[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function Le(t,s,o,r,c,f){const a=t.model,i=new Array,u=new Map,e=new Map,n=a.lods.length,l=fe();return a.lods.forEach((p,x)=>{const h=r.skipHighLods===!0&&(n>1&&x===0||n>3&&x===1)||r.skipHighLods===!1&&c!=null&&x!==c;if(h&&x!==0)return;const d=new Pe(p.name,p.lodThreshold,[0,0,0]);p.parts.forEach(g=>{const T=h?new P({},r):Ve(a,g,d,s,o,u,e,r,f),{geometry:y,vertexCount:m}=je(g,T??new P({},r)),b=y.boundingInfo;b!=null&&x===0&&(q(l,b.bbMin),q(l,b.bbMax)),T!=null&&(d.stageResources.geometries.push(y),d.numberOfVertices+=m)}),h||i.push(d)}),{engineResources:i,referenceBoundingBox:l}}function Ve(t,s,o,r,c,f,a,i,u){const e=t.materials.get(s.material);if(e==null)return null;const{normal:n,color:l,texCoord0:p,tangent:x}=s.attributes,h=s.material+(n?"_normal":"")+(l?"_color":"")+(p?"_texCoord0":"")+(x?"_tangent":""),d=s.attributes.texCoord0!=null,g=s.attributes.normal!=null,T=Ue(e.alphaMode);if(!f.has(h)){if(d){const $=(S,Z=!1,J=!1)=>{if(S!=null&&!a.has(S)){const E=t.textures.get(S);if(E){const w=E.data,X=Z&&!_(w)?i.compressionOptions:void 0;a.set(S,new Be(_(w)?w.data:w,{...E.parameters,preMultiplyAlpha:!_(w)&&J,encoding:_(w)?w.encoding:void 0,compressionOptions:X}))}}},Y=T!==1&&!u;$(e.colorTexture,Y,T!==1),$(e.normalTexture),$(e.occlusionTexture,!0),$(e.emissiveTexture),$(e.metallicRoughnessTexture,!0)}const m=I(e.color[0]),b=I(e.color[1]),C=I(e.color[2]),B=e.colorTexture!=null&&d?a.get(e.colorTexture):null,L=pe(e),V=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:xe;f.set(h,new P({...r,customDepthTest:1,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[m,b,C],ambient:[m,b,C],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?0:2,hasVertexColors:!!s.attributes.color,hasVertexTangents:!!s.attributes.tangent,normalType:g?0:2,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:B?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&d?a.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:B!=null&&!!B.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&d?a.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&d?a.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&d?a.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],mrrFactors:L?he:[e.metallicFactor,e.roughnessFactor,r.mrrFactors[2]],isSchematic:L,colorTextureTransformMatrix:M(e.colorTextureTransform),normalTextureTransformMatrix:M(e.normalTextureTransform),scale:[V[0],V[1]],occlusionTextureTransformMatrix:M(e.occlusionTextureTransform),emissiveTextureTransformMatrix:M(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M(e.metallicRoughnessTextureTransform),...c},i))}const y=f.get(h);if(o.stageResources.materials.push(y),d){const m=b=>{b!=null&&o.stageResources.textures.push(a.get(b))};m(e.colorTexture),m(e.normalTexture),m(e.occlusionTexture),m(e.emissiveTexture),m(e.metallicRoughnessTexture)}return y}function je(t,s){const o=t.attributes.position.count,r=Fe(t.indices||o,t.primitiveType),c=A(3*o),{typedBuffer:f,typedBufferStride:a}=t.attributes.position;ge(c,f,t.transform,3,a);const i=[["position",new v(c,r,3,!0)]];if(t.attributes.normal!=null){const e=A(3*o),{typedBuffer:n,typedBufferStride:l}=t.attributes.normal;Te(R,t.transform),be(e,n,R,3,l),D(R)&&z(e,e),i.push(["normal",new v(e,r,3,!0)])}if(t.attributes.tangent!=null){const e=A(4*o),{typedBuffer:n,typedBufferStride:l}=t.attributes.tangent;ye(R,t.transform),Ee(e,n,R,4,l),D(R)&&z(e,e,4),i.push(["tangent",new v(e,r,4,!0)])}if(t.attributes.texCoord0!=null){const e=A(2*o),{typedBuffer:n,typedBufferStride:l}=t.attributes.texCoord0;Oe(e,n,2,l),i.push(["uv0",new v(e,r,2,!0)])}const u=t.attributes.color;if(u!=null){const e=new Uint8Array(4*o);u.elementCount===4?u instanceof K?W(e,u,1,255):(u instanceof we||u instanceof Re)&&W(e,u,1/255,255):(e.fill(255),u instanceof H?N(e,u.typedBuffer,1,255,4,u.typedBufferStride):(t.attributes.color instanceof $e||t.attributes.color instanceof ve)&&N(e,u.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),i.push(["color",new v(e,r,4,!0)])}return{geometry:new Me(s,i),vertexCount:o}}const R=G();function Ue(t){switch(t){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function ke(t,s){for(let o=0;o<t.model.lods.length;++o){const r=t.model.lods[o];for(const c of r.parts){const f=c.attributes.normal;if(f==null)return;const a=c.attributes.position,i=a.count,u=O(),e=O(),n=O(),l=new Float32Array(4*i),p=new Float32Array(3*i),x=ae(ie(),c.transform);let h=0,d=0;for(let g=0;g<i;g++){a.getVec(g,e),f.getVec(g,u),U(e,e,c.transform),le(n,e,s.center),k(n,n,s.radius);const T=n[2],y=ue(n),m=Math.min(.45+.55*y*y,1)**me;k(n,n,s.radius),x!==null&&U(n,n,x),ce(n,n),o+1!==t.model.lods.length&&t.model.lods.length>1&&de(n,n,u,T>-1?.2:Math.min(-4*T-3.8,1)),p[h]=n[0],p[h+1]=n[1],p[h+2]=n[2],h+=3,l[d]=m,l[d+1]=m,l[d+2]=m,l[d+3]=1,d+=4}c.attributes.normal=new H(p.buffer),c.attributes.color=new K(l.buffer)}}}const Ge=Object.freeze(Object.defineProperty({__proto__:null,fetch:Ce,parseUrl:Q},Symbol.toStringTag,{value:"Module"}));export{Ge as o,M as s,Ce as z};
