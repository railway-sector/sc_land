import{f$ as z,di as p,at as m}from"./index-BrQW8HOS.js";import{Y as b}from"./CIMSymbolHelper-BlfMWOZ7.js";import{CIMSymbolRasterizer as j}from"./CIMSymbolRasterizer-Cscg1bz_.js";import{OverrideHelper as L}from"./OverrideHelper-Dz66q1dD.js";import{l as R}from"./symbolUtils-C3MaPSzp.js";import"./BidiEngine-BvER9tXK.js";import"./labelPoint-CgDrQQb-.js";import"./rasterizingUtils-Bv-DctWv.js";import"./mat2d-BbBq4Byx.js";import"./mat2df32-Dpt2CT5P.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BuUpzzb5.js";import"./CIMResourceManager-CKLYpEab.js";import"./callExpressionWithFeature-DHWn7DZ3.js";import"./gfxUtils-DDSu4Luj.js";import"./cimSymbolUtils-CmFYUdpV.js";import"./svgUtils-BB2umWtg.js";import"./utils-6_NAbAK3.js";const u=new j(null),g=m(22),x=m(120),M=m(50),E=1;async function q(a,e,n){const r=e?.size;let t=r!=null&&typeof r=="object"&&"width"in r?r.width:r,o=r!=null&&typeof r=="object"&&"height"in r?r.height:r;if(!t||!o)if(n==="esriGeometryPolygon")t=o=e.maxSize?Math.min(e.maxSize,g):g;else{const s=await D(a,e,n);s&&(t=s.width,o=s.height),n==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,M):M),t=t!=null&&isFinite(t)?Math.min(t,x):g,o=o!=null&&isFinite(o)?Math.max(Math.min(o,x),E):g}return e.style==="legend"&&n==="esriGeometryPolyline"&&(t=M),{width:t,height:o}}async function D(a,e={},n){const r=e.cimOptions||e;n??=r.geometryType||z(a?.data?.symbol);const{feature:t,fieldMap:o,viewParams:s}=r,l=await L.resolveSymbolOverrides(a.data,t,null,o,n,null,s);if(!l)return null;(a=a.clone()).data={type:"CIMSymbolReference",symbol:l},a.data.primitiveOverrides=void 0;const i=[];return b.fetchResources(l,u.resourceManager,i),b.fetchFonts(l,u.resourceManager,i),i.length>0&&await Promise.all(i),b.getEnvelope(l,null,u.resourceManager)}async function ie(a,e={}){const{node:n,opacity:r,symbolConfig:t}=e,o=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,s=e.cimOptions||e,l=s.geometryType||z(a?.data?.symbol),i=await q(a,e,l),{feature:C,fieldMap:I}=s,O=e?.geometry||o||l!=="esriGeometryPolygon"?"preview":"legend";let S=i;const v=i;if(e?.geometry&&(l==="esriGeometryPolygon"||l==="esriGeometryPolyline")&&(p(i.width)<200||p(i.height)<200)){const $=i.width>i.height?m(200)*i.height/i.width:m(200);S={width:i.width>i.height?m(200):m(200)*i.width/i.height,height:$}}const d=await u.rasterizeCIMSymbolAsync(a,C,S,O,I,l,null,s.viewParams,s.allowScalingUp,e?.geometry?.toJSON());if(!d)return null;const{width:F,height:G}=d,c=document.createElement("canvas");c.width=F,c.height=G,c.getContext("2d").putImageData(d,0,0);const f=p(v.width),w=p(v.height),h=new Image(f,w);h.src=c.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",r!=null&&(h.style.opacity=`${r}`);let y=h;if(e.cssEffectFilter){const P={shape:{type:"image",x:0,y:0,width:f,height:w,src:h.src},fill:null,stroke:null,offset:[0,0]};y=R([[P]],[f,w],e)}return n&&y&&n.appendChild(y),y}export{D as getCIMSymbolPreviewSize,ie as previewCIMSymbol};
