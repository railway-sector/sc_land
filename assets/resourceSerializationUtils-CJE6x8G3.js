import{al as K,tX as E,cf as G,er as P,bI as N,lM as ee,lF as te}from"./index-Brd6-W-v.js";import{a as A,r as k,n as F}from"./knowledgeGraphService-jE3al_K7.js";class se{constructor(){this.version="",this.queryResult=new re}}let re=class{constructor(){this.featureResult=new ae}};class ae{constructor(){this.objectIdFieldName="",this.uniqueIdField=new ie,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new ne,this.geometryType=null,this.spatialReference=new K,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new z,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}}class ie{constructor(){this.name="",this.isSystemMaintained=!1}}class ne{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}}let z=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new oe,this.translate=new le}};class oe{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}class le{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}}class ce{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}}let de=class{constructor(){this.attributes=[],this.compressedGeometry=new D,this.centroid=new D,this.aggregateGeometries=[]}},D=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};const ue=["ELEMENTUID","TYPENAME"],ye={ELEMENTUID:"ELEMENTUID",TYPENAME:"TYPENAME"},g={ELEMENTUID:"ELEMENTUID",TYPENAME:"TYPENAME",FROMUID:"FROMUID",TOUID:"TOUID"},x={upperLeft:0,lowerLeft:1},R={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function fe(t){const e=new se;e.version=t.version;const a=t.get_query_result();if(a.results_type.value!==0)throw new Error("Got a non-feature collection type");const s=a.get_feature_result(),r=e.queryResult.featureResult;r.objectIdFieldName=s.objectid_field_name,r.exceededTransferLimit=s.exceeded_transfer_limit,r.hasM=s.has_m,r.hasZ=s.has_z,r.geometryType=E(A,s.geometry_type.value),r.globalIdFieldName=s.globalid_field_name,r.geohashFieldName=s.geohash_field_name;const l=r.uniqueIdField,f=s.unique_id_field;l.name=f.name,l.isSystemMaintained=f.isSystemMaintained;const n=r.geometryProperties,o=s.geometry_properties;n.shapeAreaFieldName=o.shapeAreaFieldName,n.shapeLengthFieldName=o.shapeLengthFieldName,n.units=o.units;const y=r.spatialReference,u=s.spatial_reference;y.wkid=u.wkid,y.latestWkid=u.latestWkid,y.vcsWkid=u.vcsWkid,y.latestVcsWkid=u.latestVcsWkid,y.wkt=u.wkt,r.transform=me(s.transform);const c=r.fields,d=r.fieldNameToAttributeIndexMap,i=s.fields,T=i.size();for(let p=0;p<T;p++){const h=i.get(p),_=$(h);c.push(_),d[_.name]=p,h.delete()}i.delete();const m=r.values,b=s.values_count();for(let p=0;p<b;p++)m.push(s.get_value_at(p));const W=r.features,q=s.features,L=q.size();if(L>0){for(const p of ue)if(d[p]===void 0)throw new Error(`Feature collection missing required attribute: ${p}`)}for(let p=0;p<L;p++){const h=new de,_=q.get(p),X=h.attributes,Z=_.attributes_count();for(let w=0;w<Z;w++)X.push(_.get_attribute_at(w));const v=_.get_compressed_geometry();v&&(h.compressedGeometry=S(v),h.centroid=S(_.get_centroid()));const H=h.aggregateGeometries,I=_.aggregate_geometries,Q=I.size();for(let w=0;w<Q;w++){const U=I.get(w),J=S(U);H.push(J),U.delete()}I.delete(),W.push(h),_.delete()}q.delete();const Y=r.geometryFields,M=s.geometry_fields,B=M.size();for(let p=0;p<B;p++){const h=M.get(p),_=pe(h);Y.push(_),h.delete()}return M.delete(),e}function S(t){const e=new D;e.geometryType=E(A,t.geometry_type.value);const a=[],s=[];for(let r=0;r<t.lengths.length;r++)a.push(t.lengths[r]);for(let r=0;r<t.coords.length;r++)s.push(t.coords[r]);return e.lengths=a,e.coords=s,e}function $(t){const e=new ce;return e.name=t.name,e.alias=t.alias,e.fieldType=E(k,t.field_type.value),e.sqlType=E(R,t.sql_type.value),e.domain=t.domain,e.defaultValue=t.default_value,e}function pe(t){const e=$(t);return e.geometryType=E(A,t.geometry_type.value),e}function me(t){const e=new z;e.quantizeOriginPosition=E(x,t.quantizeOriginPosition.value);const a=e.scale,s=t.scale;a.xScale=s.xScale,a.yScale=s.yScale,a.mScale=s.mScale,a.zScale=s.zScale;const r=e.translate,l=t.translate;return r.xTranslate=l.xTranslate,r.yTranslate=l.yTranslate,r.mTranslate=l.mTranslate,r.zTranslate=l.zTranslate,e}async function he(t){const e=[],a={generateAllSublayers:!1,namedTypeDefinitions:new Map};return t.entitiesUrl&&e.push(O(t.entitiesUrl).then(s=>{C(s,a)})),t.relationshipsUrl&&e.push(O(t.relationshipsUrl).then(s=>{C(s,a)})),await Promise.all(e),a}async function Se(t,e){e??=!1;const a={generateAllSublayers:e,namedTypeDefinitions:new Map};return await Te(t).then(s=>{be(s,a)}),a}async function ke(t,e,a){const s=await F(),r=new s.FeatureCollection;try{j(r,s,t,"entities",e,a);const l=new s.FeatureCollectionEncoder,f=V(r,l),n=structuredClone(f);return l.delete(),n}finally{r.delete()}}async function De(t,e,a){const s=await F(),r=new s.FeatureCollection;try{j(r,s,t,"relationships",e,a);const l=new s.FeatureCollectionEncoder,f=V(r,l),n=structuredClone(f);return l.delete(),n}finally{r.delete()}}async function Ae(t){const e=await F(),a=new e.MapOfObjectIdentifierSets;_e(a,e,t);const s=new e.MapOfObjectIdentifierSetsEncoder;try{s.set_map_of_identifier_sets(a),s.encode();const r=s.get_encoding_result();if(r.error.error_code!==0)throw new N("knowledge-graph:layer-support-utils",r.error.error_message);const l=structuredClone(r.get_byte_buffer());return s.delete(),l}finally{a.delete()}}function j(t,e,a,s,r,l){t.version="";const f=new e.QueryResult,n=new e.FeatureResult,o=s==="entities"?ye:g;n.unique_id_field={name:o[o.ELEMENTUID],isSystemMaintained:!1},n.globalid_field_name=o[o.ELEMENTUID],n.geohash_field_name="",n.geometry_properties={shapeAreaFieldName:"",shapeLengthFieldName:"",units:""},n.spatial_reference={wkid:4326,latestWkid:4326,vcsWkid:0,latestVcsWkid:0,wkt:""},n.exceeded_transfer_limit=!1,n.has_z=!1,n.has_m=!1,n.transform={quantizeOriginPosition:{value:x.upperLeft},scale:{xScale:1e-9,yScale:1e-9,mScale:1e-4,zScale:1e-4},translate:{xTranslate:-400,yTranslate:-400,mTranslate:-1e5,zTranslate:-1e5}};for(const u of Object.keys(o).filter(c=>isNaN(Number(c)))){const c=new e.Field;if(c.name=u,c.alias=u,c.sql_type={value:R.sqlTypeBigInt},s==="entities")switch(u){case o[o.ELEMENTUID]:case o[o.TYPENAME]:c.field_type={value:k.esriFieldTypeString}}else switch(u){case o[o.ELEMENTUID]:case o[o.TYPENAME]:case g[g.FROMUID]:case g[g.TOUID]:c.field_type={value:k.esriFieldTypeString}}c.domain="",n.add_field(c),c.delete()}const y=new Map;for(const u of r.dataModel.entityTypes)y.set(u.name,"entities");for(const u of r.dataModel.relationshipTypes)y.set(u.name,"relationships");for(const[u,c]of a.namedTypeDefinitions)if(s===y.get(u))for(const d of c.members.values()){const i=new e.Feature;for(const m of Object.keys(o).filter(b=>isNaN(Number(b))))if(s==="entities")switch(m){case o[o.ELEMENTUID]:i.add_attribute(d.id,e.esriFieldType.esriFieldTypeString);break;case o[o.TYPENAME]:i.add_attribute(u,e.esriFieldType.esriFieldTypeString)}else switch(m){case o[o.ELEMENTUID]:i.add_attribute(d.id,e.esriFieldType.esriFieldTypeString);break;case g[g.FROMUID]:i.add_attribute(l.has(d.id)?l.get(d.id)[0]:"",e.esriFieldType.esriFieldTypeString);break;case g[g.TOUID]:i.add_attribute(l.has(d.id)?l.get(d.id)[1]:"",e.esriFieldType.esriFieldTypeString);break;case o[o.TYPENAME]:i.add_attribute(u,e.esriFieldType.esriFieldTypeString)}let T;if(d.linkChartLocation&&"x"in d.linkChartLocation?T=te(d.linkChartLocation):d.linkChartLocation&&(T=d.linkChartLocation),d.linkChartLocation&&T){const m=new e.FeatureCollectionGeometry;let b=!1;switch(s){case"entities":m.geometry_type=e.esriGeometryType.esriGeometryPoint,b=!0;break;case"relationships":m.geometry_type=e.esriGeometryType.esriGeometryPolyline}m.coords=new Float64Array(T.coords),m.lengths=new Uint32Array(b?[1]:T.lengths),i.set_compressed_geometry(m),m.delete()}n.add_feature(i),i.delete()}switch(s){case"entities":n.geometry_type=e.esriGeometryType.esriGeometryPoint;break;case"relationships":n.geometry_type=e.esriGeometryType.esriGeometryPolyline}return f.set_feature_result(n),t.set_query_result(f),n.delete(),f.delete(),t}function _e(t,e,a){for(const[s,r]of a.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const l=r.members.keys();let f=!1,n=!0;const o=new e.ObjectIdArray,y=new e.StringArray,u=new e.GlobalIdArray,c=new e.IdentifierArray,d=new e.ObjectIdentifierSet;for(const i of l)n&&(f=!isNaN(Number(i)),n=!1),f?o.add_objectid(Number(i)):(y.add_string(i),u.add_globalid(i)),c.add_identifier(i);d.set_oid_array(o),d.set_string_array(y),d.set_globalid_array(u),d.set_identifier_array(c),o.delete(),y.delete(),u.delete(),c.delete(),t.put_identifier_set(s,d),d.delete()}return t}async function O(t){const e=await G(t,{responseType:"array-buffer"});return ge(await e.data)}async function ge(t){const e=new(await F()).FeatureCollectionDecoder,a=e.decode(new Uint8Array(t));if(a.error_code!==0)throw new N("knowledge-graph:layer-support-utils",a.error_message);const s=e.get_feature_collection(),r=fe(s);return e.delete(),r}async function Te(t){const e=await G(t,{responseType:"array-buffer"}),a=await e.data;return we(new Uint8Array(a))}async function we(t){const e=new(await F()).MapOfObjectIdentifierSetsDecoder,a=e.decode(new Uint8Array(t)),s=new Map;if(a.error_code!==0)throw new N("knowledge-graph:layer-support-utils",a.error_message);const r=e.get_map_of_identifier_sets(),l=r.keys,f=l.size();for(let n=0;n<f;n++){const o=l.get(n),y=r.query_identifier_set(o),u=[];if(y.id_array_type.value===1){const c=y.get_globalid_array(),d=c.count();for(let i=0;i<d;i++)u.push(c.get_globalid_at(i))}else if(y.id_array_type.value===3){const c=y.get_identifier_array(),d=c.count();for(let i=0;i<d;i++)u.push(c.get_identifier_at(i).toString())}else if(y.id_array_type.value===2){const c=y.get_string_array(),d=c.count();for(let i=0;i<d;i++)u.push(c.get_string_at(i))}else{if(y.id_array_type.value!==0)throw new N("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const c=y.get_oid_array(),d=c.count();for(let i=0;i<d;i++)u.push(c.get_objectid_at(i).toString())}}s.set(o,u)}return e.delete(),s}function C(t,e){if(!t?.queryResult?.featureResult)return e;const a=t.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const s of t.queryResult.featureResult.features){const r=s.attributes[a.TYPENAME],l=P(e.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map})),f=s.attributes[a.ELEMENTUID];if(s.compressedGeometry?.coords?.length>0){let n=s.compressedGeometry.lengths;s.compressedGeometry.geometryType==="esriGeometryPoint"&&(n=[]),l.members.set(f,{id:f,linkChartLocation:new ee(n,s.compressedGeometry.coords)})}else l.members.set(f,{id:f})}return e}function be(t,e){for(const[a,s]of t){const r=P(e.namedTypeDefinitions,a,()=>({useAllData:!1,members:new Map}));for(const l of s)r.members.has(l)||r.members.set(l,{id:l})}return e}const V=(t,e)=>{e.set_feature_collection(t),e.encode();const a=e.get_encoding_result();if(a.error.error_code!==0)throw new N("knowledge-graph:layer-support-utils",a.error.error_message);return a.get_byte_buffer()},Le={fetchAndConvertSerializedLinkChart:t=>he(t)};export{Le as I,De as _,Se as f,ke as m,Ae as w};
