import{hf as g,cv as m,dq as u,iY as _,c4 as x,rI as G,rJ as K,rK as V,e1 as W,i_ as X,rL as Y,ab as Q,oh as Z,ie as ee,ds as se,dX as te,a0 as ne}from"./index-CgzAF5Ey.js";import{f as ae,b as re,y as oe,i as E,n as R}from"./External-CBuwVgCI.js";import{r as ie,n as ce,t as ue,l as le,c as $,a as pe,d as fe,u as me,p as de}from"./uploadAssetErrors-DNICV9hT.js";import{i as w,h as ye,e as v,m as ge,a as we}from"./progressUtils-Bl4eE-rl.js";import{t as he}from"./meshSpatialReferenceScaleUtils-CJPIvlPR.js";import{i as Pe,n as Te}from"./meshFeatureAttributes-CNfAfeV9.js";import"./MeshTransform-Dit-XLCt.js";const N=1e6,S=20*N,be=2e9,ve=3;async function Ae({data:e,name:t,description:s},n,a){let r=null;try{const o=g(n,"uploads"),i=g(o,"info"),{data:l}=await m(i,{query:{f:"json"},responseType:"json"});u(a);const d=_(n),y=l.maxUploadFileSize*N,f=d?be:y,c=d?Math.min(S,y):S;if(e.size>f)throw new Error("Data too large");const O=g(o,"register"),{data:A}=await m(O,{query:{f:"json",itemName:je(t),description:s},responseType:"json",method:"post"});if(u(a),!A.success)throw new Error("Registration failed");const{itemID:k}=A.item;r=g(o,k);const z=g(r,"uploadPart"),j=Math.ceil(e.size/c),h=new Array;for(let p=0;p<j;++p)h.push(e.slice(p*c,Math.min((p+1)*c,e.size)));const P=h.slice().reverse(),F=new Array,B=w(j,a?.onProgress,"uploadItem"),L=async()=>{for(;P.length!==0;){const p=h.length-P.length,T=P.pop(),b=new FormData,H=B.simulate(p,ye(T.size));try{b.append("f","json"),b.append("file",T),b.append("partId",`${p}`);const{data:J}=await m(z,{timeout:0,body:b,responseType:"json",method:"post"});if(u(a),!J.success)throw new Error("Part upload failed")}finally{H.remove()}}};for(let p=0;p<ve&&P.length!==0;++p)F.push(L());await Promise.all(F);const M=g(r,"commit"),{data:D}=await m(M,{query:{f:"json",parts:h.map((p,T)=>T).join(",")},responseType:"json",method:"post"});if(u(a),!D.success)throw new Error("Commit failed");return D.item}catch(o){if(r!=null){const i=g(r,"delete");await m(i,{query:{f:"json"},responseType:"json",method:"post"})}throw o}}function je(e){return e.replaceAll("/","_").replaceAll("\\","_")}async function Ze(e,t,s){const n=e.length;if(!n)return s?.onProgress?.(1),[];const a=w(n,s?.onProgress,"uploadAssets");return Promise.all(e.map((r,o)=>Fe(r,t,{...s,onProgress:a.makeOnProgress(o)})))}async function Fe(e,{layer:t,ongoingUploads:s},n){const a=s.get(e);if(a)return a;if(!He(t))throw new ie;if(De(e,t))return n?.onProgress?.(1),e;const r=Se(e,t,n);s.set(e,r);try{await r}finally{s.delete(e)}return e}function De(e,t){const{parsedUrl:s}=t;return s!=null&&e.metadata.externalSources.some(n=>ae(n,s))}async function Se(e,t,s){const{metadata:n}=e,{displaySource:a}=n,r=C(a?.source,t,{checkForConversionRequired:!x("disable-feature:georeferenced-uploads")}),o=r!=null?xe(r,t,s):n.externalSources.length>0?Ee(e,t,s):Re(e,t,s),i=await o;return u(s),e.addExternalSources([i]),e}async function xe(e,t,s){return{source:{type:"service",assets:await I(e,t,s)},original:!0,unitConversionDisabled:!0}}async function Ee(e,t,s){const n=q(t),{externalSources:a}=e.metadata,r=Ne(a,t);if(!r)throw new ce;const o=w(v.uploadConvertibleSource,s?.onProgress,"uploadConvertibleSource"),i={type:"service",assets:await I(r,t,{onProgress:o.makeOnProgress("uploadEditSource")})};e.addExternalSources([{source:i,original:!0}]);const l=r.reduce((y,{asset:f})=>f instanceof File?y+f.size:y,0),d=o.simulate("serviceAssetsToGlb",ge(l));try{const{source:y,transform:f,origin:c}=await ze(i,t,n);return e.transform=f,c&&(e.metadata.georeferenced=!0,s?.useAssetOrigin&&(e.vertexSpace.origin=[c.x,c.y,c.z??0],e.spatialReference=c.spatialReference)),{source:y,unitConversionDisabled:!0}}finally{d.remove()}}async function Re(e,t,s){const n=w(v.uploadLocalMesh,s?.onProgress,"uploadLocalMesh"),a=$e(e,t,{...s,onProgress:n.makeOnProgress("meshToAssetBlob")});return{source:{type:"service",assets:await U([a],t,{...s,onProgress:n.makeOnProgress("uploadAssetBlobs")})},extent:e.extent.clone(),original:!0}}async function $e(e,t,s){const n=q(t),a=await e.load(s),r=await a.toBinaryGLTF({origin:a.origin,signal:s?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return u(s),{blob:new Blob([r],{type:"model/gltf-binary"}),assetName:`${W()}.glb`,assetType:n}}function Ne(e,t){for(const s of e){const n=C(s.source,t);if(n)return n}return null}function C(e,{infoFor3D:t},s={}){if(!e)return null;const n=re(e);if(!n)return null;const{supportedFormats:a,editFormats:r}=t,o=new Array,i=G(t),l=K(t);let d=!1;for(const y of n){const f=Ce(y,a);if(!f)return null;const{assetType:c}=f;if(s.checkForConversionRequired&&(c===i||c===l))return null;r.includes(c)&&(d=!0),o.push(f)}return d?o:null}function Ce(e,t){const s=oe(e,t);return s?{asset:e,assetType:s}:null}async function I(e,t,s){return U(e.map(n=>Ie(n,s)),t,s)}async function U(e,t,s){const n=w(v.uploadAssetBlobs,s?.onProgress,"uploadAssetBlobs"),a=await qe(e,t,{...s,onProgress:n.makeOnProgress("prepareAssetItems")});u(s);const r=a.map(({item:i})=>i),{uploadResults:o}=await Oe(r,t,{...s,onProgress:n.makeOnProgress("uploadAssetItems")});return u(s),e.map((i,l)=>ke(a[l],o[l],t))}async function Ie(e,t){const{asset:s,assetType:n}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:n};const a=await s.toBlob(t);return u(t),{blob:a,assetName:s.assetName,assetType:n}}async function Ue(e,t,s){const{blob:n,assetType:a,assetName:r}=e;let o=null;try{const i=await Ae({data:n,name:r},t.url,s);u(s),o={assetType:a,assetUploadId:i.itemID}}catch(i){se(i),Je().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!o){const i=await te(n);if(u(s),!i.isBase64)throw new me;o={assetType:a,assetData:i.data}}if(!o)throw new de;return{item:o,assetName:r}}function qe(e,t,s){const n=w(e.length,s?.onProgress,"prepareAssetItems");return Promise.all(e.map(async(a,r)=>{const o=Ue(await a,t,{...s,onProgress:n.makeOnProgress(r)});return u(s),o}))}async function Oe(e,t,s){const n=we(s?.onProgress);try{const a=await m(g(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if(u(s),a.data.uploadResults.length!==e.length)throw new pe(e.length,a.data.uploadResults.length);return a.data}finally{n.remove()}}function ke(e,t,s){const{success:n}=t;if(!n){const{error:d}=t;throw new fe(e.assetName,d)}const{assetHash:a}=t,{assetName:r,item:{assetType:o}}=e,{infoFor3D:{supportedFormats:i}}=s,l=Z(o,i);if(!l)throw new $(o);return new E(r,l,[new R(`${s.parsedUrl.path}/assets/${a}`,a)])}async function ze({assets:e},t,s){const n=e.map(({assetName:r,parts:o})=>({assetName:r,assetHash:o[0].partHash}));let a;try{const r=g(t.parsedUrl.path,"convert3D"),o=t.capabilities?.operations.supportsAsyncConvert3D;a=(await(o?Me:Le)(r,{query:{f:"json",assets:JSON.stringify(n),transportType:"esriTransportTypeUrl",targetFormat:s,async:o},responseType:"json",timeout:0})).data}catch{throw new le}return Be(t,a)}function Be(e,t){const s={source:{type:"service",assets:t.assets.map(n=>{const a=Y(n.contentType,e.infoFor3D.supportedFormats);if(!a)throw new $(a);return new E(n.assetName,n.contentType,[new R(n.assetURL,n.assetHash)])})},origin:void 0,transform:void 0};if(!x("disable-feature:georeferenced-uploads")&&t.transform){if(s.transform=Pe(t.transform),t.spatialReference){const n=Q.fromJSON(t.spatialReference);s.origin=Te(t.transform,n)}}else s.transform=he(e.spatialReference);return s}function Le(e,t){return m(e,t)}async function Me(e,t){const s=(await m(e,t)).data.statusUrl;for(;;){const n=(await m(s,{query:{f:"json"},responseType:"json"})).data;switch(n.status){case"Completed":return m(n.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(n.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}await X(_e)}}function He(e){return!!e.infoFor3D&&!!e.url}function q({infoFor3D:e}){const t=V(e);if(!t)throw new ue;return t}function Je(){return ne.getLogger("esri.layers.graphics.sources.support.uploadAssets")}const _e=ee(1e3);export{Ze as uploadAssets};
